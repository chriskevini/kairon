{"data":[{"updatedAt":"2025-12-26T06:27:53.321Z","createdAt":"2025-12-23T09:30:27.792Z","id":"tpkLfvOCAeN5YzMR","name":"Generate_Daily_Summary","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[144,1856],"id":"workflow-trigger","name":"WhenCalledByAnotherWorkflow"},{"parameters":{"jsCode":"// Extract trigger_reason from caller, prepare event data\nconst input = $json;\nconst triggerReason = input.trigger_reason || 'cron';\nconst today = $now.toFormat('yyyy-MM-dd');\n\nreturn { json: { should_run: true, today: today, trigger_reason: triggerReason } };","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[368,1856],"id":"prepare-event-data","name":"PrepareEventData"},{"parameters":{"operation":"executeQuery","query":"-- Insert system event for daily summary\nINSERT INTO events (idempotency_key, event_type, payload)\nVALUES (\n  $1,\n  'system',\n  jsonb_build_object(\n    'trigger_type', 'daily_summary',\n    'trigger_reason', $2,\n    'scheduled_date', $3\n  )\n)\nON CONFLICT (event_type, idempotency_key) DO UPDATE SET id = events.id\nRETURNING id, idempotency_key;","options":{"values":"=scheduled:daily_summary:{{ $json.today }}:{{ $json.trigger_reason }},={{ $json.trigger_reason }},={{ $json.today }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[592,1856],"id":"insert-event","name":"InsertEvent","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Initialize ctx with event_id and prepare db_queries for Execute_Queries\nconst eventResult = $json;\nconst checkResult = $(\"PrepareEventData\").first().json;\n\nconst db_queries = [\n  {\n    key: 'north_star',\n    sql: `SELECT value FROM config WHERE key = 'north_star'`\n  },\n  {\n    key: 'activities',\n    sql: `SELECT \n            (p.data->>'timestamp')::timestamptz as timestamp,\n            p.data->>'category' as category,\n            p.data->>'description' as description\n          FROM projections p\n          WHERE p.projection_type = 'activity'\n            AND p.status IN ('auto_confirmed', 'confirmed')\n            AND DATE((p.data->>'timestamp')::timestamptz) = CURRENT_DATE\n          ORDER BY (p.data->>'timestamp')::timestamptz`\n  },\n  {\n    key: 'notes',\n    sql: `SELECT \n            (p.data->>'timestamp')::timestamptz as timestamp,\n            p.data->>'category' as category,\n            p.data->>'text' as text\n          FROM projections p\n          WHERE p.projection_type = 'note'\n            AND p.status IN ('auto_confirmed', 'confirmed')\n            AND DATE((p.data->>'timestamp')::timestamptz) = CURRENT_DATE\n          ORDER BY (p.data->>'timestamp')::timestamptz`\n  },\n  {\n    key: 'breakdown',\n    sql: `SELECT \n            p.data->>'category' as category,\n            COUNT(*) as count\n          FROM projections p\n          WHERE p.projection_type = 'activity'\n            AND p.status IN ('auto_confirmed', 'confirmed')\n            AND DATE((p.data->>'timestamp')::timestamptz) = CURRENT_DATE\n          GROUP BY p.data->>'category'\n          ORDER BY count DESC`\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      event: {\n        event_id: eventResult.id,\n        trigger_type: \"daily_summary\",\n        trigger_reason: checkResult.trigger_reason,\n        today: checkResult.today,\n        trace_chain: [eventResult.id]\n      },\n      db_queries\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[816,1856],"id":"init-ctx","name":"InitializeCtx"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1040,1856],"id":"execute-query-db","name":"ExecuteQueries(read)"},{"parameters":{"jsCode":"// Build LLM context from Execute_Queries results\nconst ctx = $json.ctx;\nconst db = ctx.db || {};\n\n// Extract north star (use .row for single result)\nconst northStar = db.north_star?.row?.value || 'Not set';\n\n// Extract activities (use .rows for arrays)\nconst activityItems = db.activities?.rows || [];\n\n// Extract notes\nconst noteItems = db.notes?.rows || [];\n\n// Extract breakdown\nconst breakdownItems = db.breakdown?.rows || [];\n\n// Format activities list\nlet activitiesList = '';\nif (activityItems.length === 0) {\n  activitiesList = '(No activities logged today)';\n} else {\n  activityItems.forEach(item => {\n    const time = new Date(item.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });\n    activitiesList += `- ${time} [${item.category}] ${item.description}\\n`;\n  });\n}\n\n// Format notes list\nlet notesList = '';\nif (noteItems.length === 0) {\n  notesList = '(No notes captured today)';\n} else {\n  noteItems.forEach(item => {\n    const time = new Date(item.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });\n    notesList += `- ${time} [${item.category}] ${item.text}\\n`;\n  });\n}\n\n// Format category breakdown\nlet categoryBreakdown = '';\nif (breakdownItems.length === 0) {\n  categoryBreakdown = '(No data)';\n} else {\n  breakdownItems.forEach(item => {\n    categoryBreakdown += `- ${item.category}: ${item.count}\\n`;\n  });\n}\n\nreturn {\n  json: {\n    ctx,\n    north_star: northStar,\n    activities_list: activitiesList,\n    notes_list: notesList,\n    category_breakdown: categoryBreakdown,\n    activity_count: activityItems.length,\n    note_count: noteItems.length,\n    inference_start: Date.now(),\n    llm_input: {\n      north_star: northStar,\n      activity_count: activityItems.length,\n      note_count: noteItems.length\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1264,1856],"id":"e29ca6f7-efbc-418c-b9cd-e61fa111e178","name":"PrepareSummaryData"},{"parameters":{"promptType":"define","text":"=You are a life coach reviewing a new client's daily logging data. Current date: {{ $now.format('yyyy-MM-dd') }}\n\n**Client's North Star:** {{ $json.north_star }}\n\n**Today's Activities ({{ $json.activity_count }} logged):**\n{{ $json.activities_list }}\n\n**Today's Notes ({{ $json.note_count }} logged):**\n{{ $json.notes_list }}\n\n**Category Breakdown:**\n{{ $json.category_breakdown }}\n\n---\n\n## Your Task\nProvide meta-feedback about HOW the client is logging, not just WHAT they logged. You're helping them become better at self-tracking.\n\n**Consider:**\n1. **Logging frequency** - Are they logging consistently? Gaps that suggest untracked time?\n2. **Detail quality** - Are descriptions rich enough to be useful later? Too terse? Too verbose?\n3. **Category usage** - Are they using categories effectively? Missing obvious ones?\n4. **Note vs Activity** - Are they distinguishing observations from actions well?\n5. **Alignment signals** - Does the day's shape move toward their north star?\n\n**Output Format:**\nStart with `# Daily Review - {{ $now.format('MMM d') }}`\n\nThen 2-3 short paragraphs:\n- First: One specific observation about their logging patterns today\n- Second: One concrete suggestion to improve their tracking (be specific!)\n- Third (optional): Brief encouragement or connection to their north star\n\n**Tone:** Warm but direct. A coach who cares about their growth, not a cheerleader.\n\n**If minimal data:** Note the gap honestly. Suggest what they might track tomorrow. Don't fill silence with generic encouragement.","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[1488,1856],"id":"4c73ad0b-072b-41c5-a6a7-5e3069f63663","name":"GenerateSummaryWithLlm"},{"parameters":{"jsCode":"// Parse LLM response and prepare write queries for trace + projection\nconst prepareData = $('PrepareSummaryData').first().json;\nconst llmText = $json.text?.trim() || '';\nconst durationMs = Date.now() - prepareData.inference_start;\nconst ctx = prepareData.ctx;\n\n// Build projection data\nconst projectionData = {\n  timestamp: new Date().toISOString(),\n  summary_date: ctx.event.today,\n  text: llmText,\n  activity_count: prepareData.llm_input?.activity_count || 0,\n  note_count: prepareData.llm_input?.note_count || 0\n};\n\n// Prepare db_queries for Execute_Queries (Write)\nconst db_queries = [\n  {\n    key: 'trace',\n    sql: `INSERT INTO traces (event_id, step_name, data, trace_chain)\n          VALUES ($1::uuid, 'daily_summary', \n            jsonb_build_object(\n              'input', $2::jsonb,\n              'prompt', 'daily-summary-prompt',\n              'completion', $3,\n              'result', jsonb_build_object('summary', $3),\n              'duration_ms', $4::integer\n            ), $5::uuid[])\n          RETURNING id, trace_chain || id AS updated_trace_chain`,\n    params: [\n      ctx.event.event_id,\n      prepareData.llm_input,\n      llmText,\n      durationMs,\n      ctx.event.trace_chain || []\n    ]\n  },\n  {\n    key: 'projection',\n    sql: `INSERT INTO projections (trace_id, event_id, trace_chain, projection_type, data, status, timezone)\n          VALUES ($1::uuid, $2::uuid, $3::uuid[], 'daily_summary', $4::jsonb, 'auto_confirmed',\n            (SELECT value FROM config WHERE key = 'timezone'))\n          RETURNING id`,\n    params: [\n      '$results.trace.row.id',\n      ctx.event.event_id,\n      '$results.trace.row.updated_trace_chain',\n      projectionData\n    ]\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries\n    },\n    summary_text: llmText\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1712,1856],"id":"parse-llm-response","name":"PrepareWriteQueries"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1936,1856],"id":"execute-write-queries","name":"ExecuteQueries(write)"},{"parameters":{"jsCode":"// Prepare for Discord - extract projection_id from write results\nconst ctx = $json.ctx;\nconst projectionId = ctx.db?.projection?.row?.id;\n\nreturn {\n  json: {\n    ctx,\n    projection_id: projectionId,\n    summary_text: $('PrepareWriteQueries').first().json.summary_text\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2160,1856],"id":"prepare-for-discord","name":"PrepareForDiscord"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $env.DISCORD_GUILD_ID }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $env.DISCORD_CHANNEL_OBSIDIAN_BOARD }}","mode":"id"},"content":"={{ $json.summary_text }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[2384,1856],"id":"2d3ec420-6f75-49e0-8851-af9ba845977d","name":"PostTo#obsidianBoard","webhookId":"58ab7668-0a2a-4b1e-8245-a70e0ae0054d","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"jsCode":"// Prepare final update queries after Discord post\nconst discordResult = $json;\nconst prepData = $('PrepareForDiscord').first().json;\nconst ctx = prepData.ctx;\n\nconst db_queries = [\n  {\n    key: 'update_projection',\n    sql: `UPDATE projections \n          SET data = data || jsonb_build_object(\n            'discord_message_id', $1,\n            'discord_channel_id', $2,\n            'discord_guild_id', $3\n          )\n          WHERE id = $4::uuid\n          RETURNING id`,\n    params: [\n      discordResult.id,\n      $env.DISCORD_CHANNEL_OBSIDIAN_BOARD || '',\n      $env.DISCORD_GUILD_ID || '',\n      prepData.projection_id\n    ]\n  },\n  {\n    key: 'update_config',\n    sql: `INSERT INTO config (key, value) VALUES ('last_summary_date', $1) \n          ON CONFLICT (key) DO UPDATE SET value = $1 \n          RETURNING *`,\n    params: [ctx.event.today]\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2608,1856],"id":"prepare-final-updates","name":"PrepareFinalUpdates"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2832,1856],"id":"execute-final-updates","name":"ExecuteQueries(final)"},{"parameters":{"model":"nvidia/nemotron-nano-9b-v2:free","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1496,2080],"id":"c8b0b429-e702-4351-8fdd-72d096e1898b","name":"NemotronNano9b","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"model":"xiaomi/mimo-v2-flash:free","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1624,2080],"id":"e496385a-60a2-4122-a8b3-ede7452fc36d","name":"MimoV2Flash","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}}],"connections":{"WhenCalledByAnotherWorkflow":{"main":[[{"node":"PrepareEventData","type":"main","index":0}]]},"PrepareEventData":{"main":[[{"node":"InsertEvent","type":"main","index":0}]]},"InsertEvent":{"main":[[{"node":"InitializeCtx","type":"main","index":0}]]},"InitializeCtx":{"main":[[{"node":"ExecuteQueries(read)","type":"main","index":0}]]},"ExecuteQueries(read)":{"main":[[{"node":"PrepareSummaryData","type":"main","index":0}]]},"PrepareSummaryData":{"main":[[{"node":"GenerateSummaryWithLlm","type":"main","index":0}]]},"GenerateSummaryWithLlm":{"main":[[{"node":"PrepareWriteQueries","type":"main","index":0}]]},"PrepareWriteQueries":{"main":[[{"node":"ExecuteQueries(write)","type":"main","index":0}]]},"ExecuteQueries(write)":{"main":[[{"node":"PrepareForDiscord","type":"main","index":0}]]},"PrepareForDiscord":{"main":[[{"node":"PostTo#obsidianBoard","type":"main","index":0}]]},"PostTo#obsidianBoard":{"main":[[{"node":"PrepareFinalUpdates","type":"main","index":0}]]},"PrepareFinalUpdates":{"main":[[{"node":"ExecuteQueries(final)","type":"main","index":0}]]},"NemotronNano9b":{"ai_languageModel":[[{"node":"GenerateSummaryWithLlm","type":"ai_languageModel","index":0}]]},"MimoV2Flash":{"ai_languageModel":[[{"node":"GenerateSummaryWithLlm","type":"ai_languageModel","index":1}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":null,"versionId":"5a53317c-0ce2-46bc-b51c-cc0ed96ba018","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:27.792Z","createdAt":"2025-12-23T09:30:27.792Z","role":"workflow:owner","workflowId":"tpkLfvOCAeN5YzMR","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:53.925Z","createdAt":"2025-12-23T09:30:29.200Z","id":"887fJOHvjP78PQoO","name":"Handle_Quality_Rating","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-400,300],"id":"trigger-quality-rating","name":"ReceiveEvent"},{"parameters":{"jsCode":"// Parse quality rating from emoji\nconst ctx = $json.ctx;\nconst emoji = ctx.event.emoji;\n\n// Map emoji to quality score\nconst qualityMap = {\n  'ðŸ‘': 1.0,\n  'ðŸ‘Ž': 0.0\n};\n\nconst qualityScore = qualityMap[emoji];\n\nif (qualityScore === undefined) {\n  throw new Error(`Unknown quality emoji: ${emoji}`);\n}\n\nreturn {\n  json: {\n    ctx,\n    quality_score: qualityScore,\n    emoji\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-180,300],"id":"parse-quality","name":"ParseQualityRating"},{"parameters":{"operation":"executeQuery","query":"-- Find projections by either the original user message or the bot reply message\nWITH target_projections AS (\n  -- Option 1: User message that triggered projections\n  SELECT p.id\n  FROM projections p\n  JOIN events e ON p.event_id = e.id\n  WHERE e.payload->>'discord_message_id' = $3\n    AND e.event_type = 'discord_message'\n    AND p.status IN ('auto_confirmed', 'confirmed')\n  UNION\n  -- Option 2: Bot reply message (projection stores the message ID)\n  SELECT p.id\n  FROM projections p\n  WHERE (p.data->>'discord_message_id' = $3\n     OR p.metadata->>'message_id' = $3)\n    AND p.status IN ('auto_confirmed', 'confirmed')\n)\nUPDATE projections\nSET \n  quality_score = $1,\n  metadata = COALESCE(metadata, '{}'::jsonb) || jsonb_build_object(\n    'quality_rated_at', NOW(),\n    'quality_emoji', $2\n  )\nWHERE id IN (SELECT id FROM target_projections)\nRETURNING id, projection_type, quality_score;","options":{"values":"={{ [  $json.quality_score ,  $json.emoji ,  $json.ctx.event.message_id  ] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[40,300],"id":"update-quality-score","name":"UpdateQualityScore","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"runOnceForAllItems","jsCode":"const result = $json;\nconst rating = result.rating;\nconst projectionId = result.projection_id;\nconst qualityScore = result.quality_score;\nconst userFeedback = result.user_feedback;\n\nconst response = `âœ… Quality rating recorded!`;\n\nif (userFeedback) {\n  response += `\\n\\n**Your feedback:** ${userFeedback}`;\n}\n\nresponse += `\\n\\n**Rating Summary:**\\n- Rating: ${rating}/5\\n- Projection: ${projectionId}\\n- Score: ${qualityScore}`;\n\nreturn {\n  json: {\n    response: response,\n    channel_id: result.ctx.event.channel_id\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[260,300],"id":"format-response","name":"FormatResponse"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"content":"={{ $json.response.content }}","options":{"messageReference":"={{ $json.ctx.event.message_id }}"}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[480,300],"id":"send-response","name":"SendResponse","webhookId":"quality-rating-response","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}}],"connections":{"ReceiveEvent":{"main":[[{"node":"ParseQualityRating","type":"main","index":0}]]},"ParseQualityRating":{"main":[[{"node":"UpdateQualityScore","type":"main","index":0}]]},"UpdateQualityScore":{"main":[[{"node":"FormatResponse","type":"main","index":0}]]},"FormatResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":null,"versionId":"defac4f6-eebc-4819-a962-bc4367b79c7c","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:29.200Z","createdAt":"2025-12-23T09:30:29.200Z","role":"workflow:owner","workflowId":"887fJOHvjP78PQoO","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:52.825Z","createdAt":"2025-12-23T09:30:25.763Z","id":"mbX1lCt14Yi75gTE","name":"Continue_Thread","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[6656,624],"id":"cf49146a-7b65-4fe1-8882-9190f8ac80f3","name":"ExecuteWorkflowTrigger"},{"parameters":{"jsCode":"// Prepare batch database queries for Execute_Queries sub-workflow\nconst ctx = $json.ctx;\n\nconst db_queries = [\n  {\n    key: 'history',\n    sql: `SELECT timestamp, role, text FROM thread_history \n          WHERE thread_id = $1 AND NOT (role = 'user' AND text = $2) \n          ORDER BY timestamp ASC LIMIT 20`,\n    params: [ctx.event.thread_id, ctx.event.clean_text]\n  },\n  {\n    key: 'north_star',\n    sql: `SELECT value FROM config WHERE key = 'north_star'`\n  },\n  {\n    key: 'activities',\n    sql: `SELECT \n            (data->>'timestamp')::timestamptz as timestamp,\n            data->>'category' as category,\n            data->>'description' as description\n          FROM projections\n          WHERE projection_type = 'activity'\n            AND status IN ('auto_confirmed', 'confirmed')\n          ORDER BY (data->>'timestamp')::timestamptz DESC\n          LIMIT 20`\n  },\n  {\n    key: 'notes',\n    sql: `SELECT \n            (data->>'timestamp')::timestamptz as timestamp,\n            data->>'category' as category,\n            data->>'text' as text\n          FROM projections\n          WHERE projection_type = 'note'\n            AND status IN ('auto_confirmed', 'confirmed')\n          ORDER BY (data->>'timestamp')::timestamptz DESC\n          LIMIT 10`\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[6880,624],"id":"prepare-db-queries","name":"PrepareDbQueries"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[7104,624],"id":"execute-queries-read","name":"ExecuteQueries(read)"},{"parameters":{"jsCode":"// Build LLM context from Execute_Queries results\nconst ctx = $json.ctx;\nconst db = ctx.db || {};\n\n// Extract and sort conversation history\nconst history = (db.history?.rows || [])\n  .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))\n  .map(item => ({\n    role: item.role,\n    text: item.text\n  }));\n\n// Extract north star\nconst northStar = db.north_star?.row?.value || 'Not set';\n\n// Extract activities\nconst activities = (db.activities?.rows || []).map(item => ({\n  timestamp: item.timestamp,\n  category: item.category,\n  description: item.description\n}));\n\n// Extract notes  \nconst notes = (db.notes?.rows || []).map(item => ({\n  timestamp: item.timestamp,\n  category: item.category,\n  text: item.text\n}));\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      llm: {\n        ...ctx.llm,\n        north_star: northStar,\n        inference_start: Date.now(),\n        history: history,\n        activities: activities,\n        notes: notes\n      }\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[7328,624],"id":"66722f6e-f428-4136-bc15-f60097699a36","name":"BuildContext"},{"parameters":{"promptType":"define","text":"=You are an AI life coach helping the user reflect, plan, and think deeply.\n\n## Context Available\n\n**User's Guiding Principle:** {{ $json.ctx.llm.north_star }}\n\nKeep this in mind when helping them, but don't mention it unless directly relevant to the conversation.\n\n**Recent Activities (Last 20)**\n{{ $json.ctx.llm.activities.map(act => `${DateTime.fromISO(act.timestamp).format(\"yyyy-MM-dd hh:mm\")} - ${act.description}`).join('\\n') }}\n\n**Recent Notes (Last 10)**\n{{ $json.ctx.llm.notes.map(n => `[${n.category}] ${n.text}`).join('\\n') }}\n\n## Instructions\n\n1. **Consider the full context**: conversation history, activities, and notes\n2. **Provide grounded insights**: Reference specific activities or notes when relevant\n3. **Be conversational**: This is an ongoing dialogue, not a new conversation\n4. **Ask clarifying questions**: Help them think deeper when appropriate\n5. **Be concise**: 3-5 sentences, respect their time\n6. **Don't force connections**: Only mention the guiding principle if it's naturally relevant to what they're asking about\n\n## Style\n- Warm and supportive\n- Natural and conversational\n- Focus on what they're asking, not on fitting everything into a grand narrative\n\n## Conversation History\n{{ $json.ctx.llm.history.map(msg => `${msg.role.toUpperCase()}: ${msg.text}`).join('\\n\\n') }}\n\nUSER: {{ $json.ctx.event.clean_text }}\n\nASSISTANT:","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[7552,748],"id":"4119f733-a0a8-4c97-bcf3-a67ab535c4b5","name":"GenerateResponse"},{"parameters":{"model":"xiaomi/mimo-v2-flash:free","options":{"temperature":0.7}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[7560,972],"id":"120ceee9-00cb-4175-8df8-57f862e218fd","name":"MimoV2Flash","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"model":"nvidia/nemotron-nano-9b-v2:free","options":{"temperature":0.7}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[7688,972],"id":"9c28edb3-a048-474e-8217-915ddee94e23","name":"NemotronNano9b","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.thread_id }}","mode":"id"},"content":"={{ $json.ctx.llm.completion_text }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[8352,528],"id":"742d2510-b9ca-4252-9f4e-4d2c485050a9","name":"PostToThread","webhookId":"a65d6a4d-1d64-4ef4-b3b6-a4fe185b4957","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"resource":"message","operation":"react","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"messageId":"={{ $json.ctx.event.message_id }}","emoji":"=ðŸ’­"},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[6880,96],"id":"3d6f0aee-f86f-437e-aa57-0683b80c2ced","name":"ReactWithðŸ’­","webhookId":"3ebf8398-5c0b-41c5-b3e7-3a3fb5cd8e67","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/ðŸ”µ/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6880,1152],"id":"remove-blue-reaction-continue-chat","name":"RemoveðŸ”µReaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Prepare write queries for Execute_Queries (trace + projection)\nconst ctx = $json.ctx || {};\nconst response = ctx.llm?.completion_text || '';\nconst inferenceStart = ctx.llm?.inference_start || Date.now();\nconst durationMs = Date.now() - inferenceStart;\n\n// Build filled prompt (reconstructed from template)\nconst promptText = `You are an AI life coach helping the user reflect, plan, and think deeply.\n\n## Context Available\n\n**User's Guiding Principle:** ${ctx.llm?.north_star || '(not set)'}\n\n**Recent Activities (Last 20)**\n${(ctx.llm?.activities || []).map(act => `${act.timestamp} - ${act.description}`).join('\\n')}\n\n**Recent Notes (Last 10)**\n${(ctx.llm?.notes || []).map(n => `[${n.category}] ${n.text}`).join('\\n')}\n\n## Instructions\n...\n\n## Conversation History\n${(ctx.llm?.history || []).map(msg => `${msg.role.toUpperCase()}: ${msg.text}`).join('\\n\\n')}\n\n## Current Message\nThe user just said: \"${ctx.event?.clean_text || ''}\"\n\nRespond to their message now.`;\n\n// Format trace_chain for PostgreSQL uuid[] type\nconst traceChain = ctx.event?.trace_chain || [];\n\n// Build write queries with chaining\nconst db_queries = [\n  {\n    key: 'trace',\n    sql: `INSERT INTO traces (event_id, step_name, data, trace_chain)\n          VALUES (\n            $1::uuid,\n            'thread_response',\n            jsonb_build_object(\n              'input', jsonb_build_object(\n                'text', $2,\n                'thread_id', $3::text,\n                'history_length', $4::integer\n              ),\n              'prompt', $5,\n              'completion', $6,\n              'result', jsonb_build_object(\n                'response_length', $7::integer,\n                'referenced_activities', $8::integer,\n                'referenced_notes', $9::integer\n              ),\n              'model', 'xiaomi/mimo-v2-flash:free',\n              'duration_ms', $10::integer\n            ),\n            $11::uuid[]\n          )\n          RETURNING id, $11::uuid[] || id AS updated_trace_chain`,\n    params: [\n      ctx.event?.event_id,\n      ctx.event?.clean_text || '',\n      ctx.event?.thread_id,\n      (ctx.llm?.history || []).length,\n      promptText,\n      response,\n      response.length,\n      (ctx.llm?.activities || []).length,\n      (ctx.llm?.notes || []).length,\n      durationMs,\n      traceChain\n    ]\n  },\n  {\n    key: 'projection',\n    sql: `INSERT INTO projections (\n            event_id,\n            trace_id,\n            trace_chain,\n            projection_type,\n            status,\n            data,\n            timezone\n          )\n          VALUES (\n            $1::uuid,\n            $2::uuid,\n            $3::uuid[],\n            'thread_response',\n            'auto_confirmed',\n            jsonb_build_object(\n              'thread_id', $4,\n              'response_text', $5,\n              'role', 'assistant',\n              'timestamp', $6::timestamptz\n            ),\n            $7\n          )\n          RETURNING id`,\n    params: [\n      ctx.event?.event_id,\n      '$results.trace.row.id',\n      '$results.trace.row.updated_trace_chain',\n      ctx.event?.thread_id,\n      response,\n      ctx.event?.timestamp,\n      ctx.event?.timezone\n    ]\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[8352,720],"id":"prepare-write-queries","name":"PrepareWriteQueries"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[8576,720],"id":"execute-queries-write","name":"ExecuteQueries(write)"},{"parameters":{"assignments":{"assignments":[{"id":"llm-completion","name":"ctx.llm.completion_text","value":"={{ $json.text }}","type":"string"}]},"options":{"includeOtherFields":true}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[7904,748],"id":"set-llm-completion","name":"SetLlmCompletion"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[8128,624],"id":"merge-llm-result","name":"MergeLlmResult"}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"PrepareDbQueries","type":"main","index":0},{"node":"ReactWithðŸ’­","type":"main","index":0},{"node":"RemoveðŸ”µReaction","type":"main","index":0}]]},"PrepareDbQueries":{"main":[[{"node":"ExecuteQueries(read)","type":"main","index":0}]]},"ExecuteQueries(read)":{"main":[[{"node":"BuildContext","type":"main","index":0}]]},"BuildContext":{"main":[[{"node":"GenerateResponse","type":"main","index":0},{"node":"MergeLlmResult","type":"main","index":0}]]},"GenerateResponse":{"main":[[{"node":"SetLlmCompletion","type":"main","index":0}]]},"MimoV2Flash":{"ai_languageModel":[[{"node":"GenerateResponse","type":"ai_languageModel","index":0}]]},"NemotronNano9b":{"ai_languageModel":[[{"node":"GenerateResponse","type":"ai_languageModel","index":1}]]},"PostToThread":{"main":[[]]},"PrepareWriteQueries":{"main":[[{"node":"ExecuteQueries(write)","type":"main","index":0}]]},"ExecuteQueries(write)":{"main":[[]]},"SetLlmCompletion":{"main":[[{"node":"MergeLlmResult","type":"main","index":1}]]},"MergeLlmResult":{"main":[[{"node":"PrepareWriteQueries","type":"main","index":0},{"node":"PostToThread","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":null,"versionId":"12327d0a-43e8-492e-a776-222fcb9ccaa8","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:25.763Z","createdAt":"2025-12-23T09:30:25.763Z","role":"workflow:owner","workflowId":"mbX1lCt14Yi75gTE","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:54.493Z","createdAt":"2025-12-23T09:30:30.116Z","id":"lnxlZ8AFe7LhMMEA","name":"Proactive_Agent","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowId":{"__rl":true,"value":"={{ $env.WORKFLOW_ID_EXECUTE_QUERIES }}","mode":"id"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[0,0],"id":"workflow-trigger","name":"WhenCalledByAnotherWorkflow"},{"parameters":{"jsCode":"// Extract trigger_reason from caller, default to 'cron'\nconst input = $json;\nconst triggerReason = input.trigger_reason || 'cron';\nconst now = new Date();\nconst idempotencyKey = `scheduled:proactive:${now.toISOString().slice(0, 16)}:${triggerReason}`;\n\nreturn {\n  json: {\n    idempotency_key: idempotencyKey,\n    trigger_reason: triggerReason,\n    timestamp: now.toISOString()\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0],"id":"prepare-event","name":"PrepareEvent"},{"parameters":{"operation":"executeQuery","query":"-- Insert system event for proactive agent\nINSERT INTO events (idempotency_key, event_type, payload, timezone)\nVALUES (\n  $1,\n  'system',\n  jsonb_build_object(\n    'trigger_type', 'proactive_agent',\n    'trigger_reason', $2\n  ),\n  COALESCE((SELECT value FROM config WHERE key = 'timezone'), 'UTC')\n)\nON CONFLICT (event_type, idempotency_key) DO UPDATE SET id = events.id, timezone = EXCLUDED.timezone\nRETURNING id, timezone;","options":{"values":"{{ $json.idempotency_key }},{{ $json.trigger_reason }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"id":"insert-event","name":"InsertEvent","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Initialize ctx with event_id\nconst eventResult = $json;\nconst prepareData = $('PrepareEvent').first().json;\n\nreturn {\n  json: {\n    ctx: {\n      event: {\n        event_id: eventResult.id,\n        trigger_type: 'proactive_agent',\n        trigger_reason: prepareData.trigger_reason,\n        timestamp: prepareData.timestamp,\n        timezone: eventResult.timezone || 'UTC',\n        trace_chain: [eventResult.id],\n        trace_chain_pg: `{${eventResult.id}}`\n      },\n      db_queries: [{\n        key: 'history',\n        sql: `\n          (SELECT 'user' as role, payload->>'clean_text' as content, received_at as timestamp\n           FROM events \n           WHERE event_type = 'discord_message'\n           ORDER BY received_at DESC LIMIT 5)\n          UNION ALL\n          (SELECT 'assistant' as role, data->>'message' as content, created_at as timestamp\n           FROM projections\n           WHERE projection_type IN ('nudge', 'pulse')\n           ORDER BY created_at DESC LIMIT 5)\n          ORDER BY timestamp DESC\n          LIMIT 5;\n        `,\n        params: []\n      }]\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0],"id":"init-ctx","name":"InitializeCtx"},{"parameters":{"operation":"executeQuery","query":"-- Get active prompt modules, ordered by priority\nSELECT id, name, content, module_type, tags, priority\nFROM prompt_modules\nWHERE active = true\nORDER BY priority ASC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[896,-288],"id":"get-prompt-modules","name":"FetchHistory","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT value FROM config WHERE key = 'north_star';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[896,-96],"id":"get-north-star","name":"GetNorthStar","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n  (p.data->>'timestamp')::timestamptz as timestamp,\n  p.data->>'category' as category,\n  p.data->>'description' as description\nFROM projections p\nWHERE p.projection_type = 'activity'\n  AND p.status IN ('auto_confirmed', 'confirmed')\n  AND (p.data->>'timestamp')::timestamptz >= NOW() - INTERVAL '24 hours'\nORDER BY (p.data->>'timestamp')::timestamptz DESC\nLIMIT 20;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[896,96],"id":"get-recent-activities","name":"GetRecentActivities(24h)","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n  (p.data->>'timestamp')::timestamptz as timestamp,\n  p.data->>'category' as category,\n  p.data->>'text' as text\nFROM projections p\nWHERE p.projection_type = 'note'\n  AND p.status IN ('auto_confirmed', 'confirmed')\n  AND (p.data->>'timestamp')::timestamptz >= NOW() - INTERVAL '7 days'\nORDER BY (p.data->>'timestamp')::timestamptz DESC\nLIMIT 5;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[896,288],"id":"get-recent-notes","name":"GetRecentNotes(7d)","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n  p.id,\n  p.data->>'text' as text,\n  p.data->>'status' as status,\n  p.created_at,\n  EXTRACT(DAY FROM NOW() - p.created_at) as days_pending\nFROM projections p\nWHERE p.projection_type = 'todo'\n  AND p.status IN ('auto_confirmed', 'confirmed')\n  AND COALESCE(p.data->>'status', 'pending') = 'pending'\nORDER BY p.created_at ASC\nLIMIT 10;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[896,480],"id":"get-pending-todos","name":"GetPendingTodos","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"append","numberInputs":6},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[1120,0],"id":"merge-query-results","name":"MergeQueryResults"},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Build context summary for semantic module selection\nconst allItems = $input.all();\n\n// Extract ctx\nlet ctx = null;\nfor (const item of allItems) {\n  if (item.json.ctx) {\n    ctx = item.json.ctx;\n    break;\n  }\n}\n\nif (!ctx) {\n  throw new Error('ctx not found in merged items');\n}\n\n// Extract activities, notes, todos\nconst activities = allItems.filter(item => \n  item.json.description !== undefined && !item.json.error\n);\nconst notes = allItems.filter(item => \n  item.json.text !== undefined && \n  item.json.description === undefined &&\n  item.json.days_pending === undefined &&\n  !item.json.error\n);\nconst todos = allItems.filter(item => \n  item.json.days_pending !== undefined && !item.json.error\n);\n\n// Extract technique modules for semantic selection\nconst techniques = allItems.filter(item => \n  item.json.module_type === 'technique'\n).map(item => item.json.content);\n\n// Check for stuck todos (pending > 3 days)\nconst stuckTodos = todos.filter(t => t.json.days_pending > 3);\n\n// Build a context summary for semantic search\nconst summaryParts = [];\n\nif (activities.length > 0) {\n  const recentActivities = activities.slice(0, 3).map(a => a.json.description).join(', ');\n  summaryParts.push(`Recent activities: ${recentActivities}`);\n}\n\nif (notes.length > 0) {\n  const recentNotes = notes.slice(0, 2).map(n => n.json.text.substring(0, 100)).join('; ');\n  summaryParts.push(`Notes: ${recentNotes}`);\n}\n\nif (stuckTodos.length > 0) {\n  summaryParts.push(`Stuck todos: ${stuckTodos.map(t => t.json.text).join(', ')}`);\n} else if (todos.length > 0) {\n  summaryParts.push(`Pending todos: ${todos.slice(0, 3).map(t => t.json.text).join(', ')}`);\n}\n\nif (summaryParts.length === 0) {\n  summaryParts.push('No recent activity logged. User may need a gentle check-in.');\n}\n\nconst contextSummary = summaryParts.join('. ');\n\n// Pass through all items plus the context summary\nreturn [{\n  json: {\n    ctx,\n    context_summary: contextSummary,\n    technique_candidates: techniques,\n    has_stuck_todos: stuckTodos.length > 0,\n    has_activities: activities.length > 0,\n    has_notes: notes.length > 0,\n    all_items: allItems.map(i => i.json)\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1344,0],"id":"build-context-summary","name":"BuildContextSummary"},{"parameters":{"method":"POST","url":"={{ $env.EMBEDDING_SERVICE_URL }}/search","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"query\": {{ JSON.stringify($json.context_summary) }},\n  \"table\": \"prompt_modules\",\n  \"filter\": {\"module_type\": \"technique\"},\n  \"top_k\": 1\n}","options":{"timeout":10000}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1568,0],"id":"semantic-select-techniques","name":"SemanticSelectTechniques","continueOnFail":true},{"parameters":{"method":"POST","url":"={{ $env.EMBEDDING_SERVICE_URL }}/embed","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"texts\": [{{ JSON.stringify($json.context_summary) }}]\n}","options":{"timeout":10000}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1568,192],"id":"embed-context-for-rag","name":"EmbedContextForRag","continueOnFail":true},{"parameters":{"jsCode":"// Prepare embedding for pgvector query\nconst contextData = $('BuildContextSummary').first().json;\nconst embedResult = $json;\n\n// Extract the embedding vector\nlet embedding = null;\nif (embedResult.embeddings && embedResult.embeddings.length > 0) {\n  embedding = embedResult.embeddings[0];\n}\n\n// Format as pgvector array string\nlet embeddingPg = null;\nif (embedding) {\n  embeddingPg = '[' + embedding.join(',') + ']';\n}\n\nreturn {\n  json: {\n    ctx: contextData.ctx,\n    context_summary: contextData.context_summary,\n    all_items: contextData.all_items,\n    embedding_pg: embeddingPg,\n    has_embedding: embedding !== null\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1792,192],"id":"prepare-embedding-for-rag","name":"PrepareEmbeddingForRag"},{"parameters":{"operation":"executeQuery","query":"-- RAG: Find similar projections using pgvector\nSELECT \n  p.projection_type,\n  COALESCE(p.data->>'description', p.data->>'text') as content,\n  p.data->>'category' as category,\n  (p.data->>'timestamp')::timestamptz as timestamp,\n  e.embedding <=> $1::vector as distance\nFROM embeddings e\nJOIN projections p ON e.projection_id = p.id\nWHERE p.status IN ('auto_confirmed', 'confirmed')\n  AND p.created_at > NOW() - INTERVAL '30 days'\n  AND p.projection_type IN ('activity', 'note')\n  AND e.embedding IS NOT NULL\nORDER BY e.embedding <=> $1::vector\nLIMIT 5;","options":{"values":"{{ $json.embedding_pg }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2016,192],"id":"rag-similar-projections","name":"RagSimilarProjections","alwaysOutputData":true,"continueOnFail":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"append","numberInputs":2},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[1792,96],"id":"merge-semantic-results","name":"MergeSemanticResults"},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Assemble prompt from modules and context with semantic selection\nconst allItems = $input.all();\n\n// Find the context summary item (has ctx and all_items)\nlet contextData = null;\nfor (const item of allItems) {\n  if (item.json.ctx && item.json.all_items) {\n    contextData = item.json;\n    break;\n  }\n}\n\nif (!contextData) {\n  throw new Error('Context data not found in merged items');\n}\n\nconst ctx = contextData.ctx;\nconst originalItems = contextData.all_items;\nconst timezone = ctx.event.timezone || 'UTC';\n\n// Extract semantic selection results\nlet semanticMatches = [];\nfor (const item of allItems) {\n  if (item.json.results) {\n    semanticMatches = item.json.results;\n    break;\n  }\n}\n\n// Extract conversational history\nlet history = [];\nfor (const item of allItems) {\n  if (item.json.ctx && item.json.ctx.db && item.json.ctx.db.history) {\n    history = item.json.ctx.db.history.rows || [];\n    break;\n  }\n}\n\n// Extract RAG results (similar projections)\nlet ragResults = [];\nfor (const item of allItems) {\n  if (item.json.projection_type !== undefined && item.json.distance !== undefined) {\n    ragResults.push(item.json);\n  }\n}\n\n// Helper to format time in user's timezone\nconst formatTime = (isoString) => {\n  try {\n    return new Date(isoString).toLocaleTimeString('en-US', { \n      timeZone: timezone, \n      hour: 'numeric', \n      minute: '2-digit' \n    });\n  } catch (e) {\n    return new Date(isoString).toLocaleTimeString('en-US', { \n      hour: 'numeric', \n      minute: '2-digit' \n    });\n  }\n};\n\nconst formatDate = (isoString) => {\n  try {\n    return new Date(isoString).toLocaleDateString('en-US', { \n      timeZone: timezone, \n      weekday: 'short',\n      month: 'short', \n      day: 'numeric' \n    });\n  } catch (e) {\n    return new Date(isoString).toLocaleDateString('en-US', { \n      weekday: 'short',\n      month: 'short', \n      day: 'numeric' \n    });\n  }\n};\n\n// Get current hour in user's timezone\nconst now = new Date();\nlet currentHour;\ntry {\n  currentHour = parseInt(now.toLocaleTimeString('en-US', { \n    timeZone: timezone, \n    hour: 'numeric', \n    hour12: false \n  }));\n} catch (e) {\n  currentHour = now.getHours();\n}\n\n// Determine time of day for fallback technique selection\nconst isMorning = currentHour >= 6 && currentHour <= 9;\nconst isEvening = currentHour >= 20 && currentHour <= 23;\n\n// Extract prompt modules from original items\nconst modules = originalItems.filter(item => \n  item.module_type !== undefined\n);\n\n// Extract north star\nlet northStar = 'To determine my north star from deep introspection';\nconst northStarItems = originalItems.filter(item => \n  item.value !== undefined && \n  item.module_type === undefined\n);\nif (northStarItems.length > 0 && northStarItems[0].value) {\n  northStar = northStarItems[0].value;\n}\n\n// Extract activities\nconst activityItems = originalItems.filter(item => \n  item.description !== undefined && \n  !item.error\n);\n\n// Extract notes\nconst noteItems = originalItems.filter(item => \n  item.text !== undefined && \n  item.description === undefined &&\n  item.days_pending === undefined &&\n  !item.error\n);\n\n// Extract todos\nconst todoItems = originalItems.filter(item => \n  item.days_pending !== undefined && \n  !item.error\n);\n\n// Check for stuck todos (pending > 3 days)\nconst stuckTodos = todoItems.filter(t => t.days_pending > 3);\nconst hasStuckTodos = stuckTodos.length > 0;\n\n// Assemble prompt from modules\nconst promptParts = [];\n\n// 1. Always include persona modules (priority 0-10)\nconst personaModules = modules.filter(m => m.module_type === 'persona');\npersonaModules.forEach(m => promptParts.push(m.content));\n\n// 2. Select technique - prefer semantic matches, fall back to time/context based\nlet selectedTechniques = [];\nlet techniqueSource = 'none';\n\nif (semanticMatches.length > 0 && semanticMatches[0].score > 0.3) {\n  // Use semantically selected techniques (top 2 with score > 0.3)\n  selectedTechniques = semanticMatches\n    .filter(m => m.score > 0.3)\n    .slice(0, 2)\n    .map(m => m.text);\n  techniqueSource = 'semantic';\n} else {\n  // Fallback to time-based selection\n  if (isMorning) {\n    const morningTechnique = modules.find(m => m.name === 'technique_morning');\n    if (morningTechnique) selectedTechniques.push(morningTechnique.content);\n    techniqueSource = 'morning';\n  } else if (isEvening) {\n    const eveningTechnique = modules.find(m => m.name === 'technique_evening');\n    if (eveningTechnique) selectedTechniques.push(eveningTechnique.content);\n    techniqueSource = 'evening';\n  } else if (hasStuckTodos) {\n    const stuckTechnique = modules.find(m => m.name === 'technique_stuck_todo');\n    if (stuckTechnique) selectedTechniques.push(stuckTechnique.content);\n    techniqueSource = 'stuck_todo';\n  }\n}\n\nselectedTechniques.forEach(t => promptParts.push(t));\n\n// 3. Build context section\nlet contextSection = '## Current Context\\n\\n';\ncontextSection += `**Time:** ${formatDate(now.toISOString())} ${formatTime(now.toISOString())}\\n`;\ncontextSection += `**North Star:** ${northStar}\\n\\n`;\n\n// Add conversational history\nif (history.length > 0) {\n  contextSection += '### Recent Conversation\\n';\n  history.reverse().forEach(h => {\n    const role = h.role === 'user' ? 'User' : 'Kairon';\n    contextSection += `**${role}:** ${h.content}\\n`;\n  });\n  contextSection += '\\n';\n}\n\n// Format activities\ncontextSection += '### Recent Activities (last 24h)\\n';\nif (activityItems.length === 0) {\n  contextSection += '(No logged activity)\\n';\n} else {\n  activityItems.slice(0, 10).forEach(item => {\n    const time = formatTime(item.timestamp);\n    contextSection += `- ${time}: ${item.description} [${item.category}]\\n`;\n  });\n}\ncontextSection += '\\n';\n\n// Format notes\ncontextSection += '### Recent Notes\\n';\nif (noteItems.length === 0) {\n  contextSection += '(No recent notes)\\n';\n} else {\n  noteItems.forEach(item => {\n    const date = formatDate(item.timestamp);\n    const preview = item.text.substring(0, 100) + (item.text.length > 100 ? '...' : '');\n    contextSection += `- ${date}: ${preview}\\n`;\n  });\n}\ncontextSection += '\\n';\n\n// Format todos\ncontextSection += '### Pending Todos\\n';\nif (todoItems.length === 0) {\n  contextSection += '(No pending todos)\\n';\n} else {\n  todoItems.forEach(item => {\n    const daysStr = item.days_pending > 0 ? ` (${Math.floor(item.days_pending)} days)` : '';\n    contextSection += `- ${item.text}${daysStr}\\n`;\n  });\n}\n\n// 4. Add RAG context if available (similar past entries)\nif (ragResults.length > 0) {\n  contextSection += '\\n### Related Past Entries (for context)\\n';\n  ragResults.slice(0, 3).forEach(item => {\n    const date = item.timestamp ? formatDate(item.timestamp) : 'Unknown';\n    const content = item.content?.substring(0, 80) || 'No content';\n    contextSection += `- ${date}: ${content}${item.content?.length > 80 ? '...' : ''} [${item.projection_type}]\\n`;\n  });\n}\n\npromptParts.push(contextSection);\n\n// 5. Include format module\nconst formatModule = modules.find(m => m.module_type === 'format');\nif (formatModule) {\n  promptParts.push(formatModule.content);\n}\n\n// 6. Always include guardrail modules (priority 200+)\nconst guardrailModules = modules.filter(m => m.module_type === 'guardrail');\nguardrailModules.forEach(m => promptParts.push(m.content));\n\n// Assemble final prompt\nconst assembledPrompt = promptParts.join('\\n\\n---\\n\\n');\n\n// Determine the context description for the agent\nlet contextDescription = 'general check-in';\nif (isMorning) contextDescription = 'morning check-in';\nelse if (isEvening) contextDescription = 'evening reflection';\nelse if (hasStuckTodos) contextDescription = 'stuck todo nudge';\nelse if (activityItems.length === 0) contextDescription = 'no recent activity';\n\n// Format trace_chain for PostgreSQL\nconst traceChain = ctx.event.trace_chain || [];\nconst traceChainPg = '{' + traceChain.join(',') + '}';\n\nreturn [{\n  json: {\n    ctx,\n    assembled_prompt: assembledPrompt,\n    context_description: contextDescription,\n    technique_source: techniqueSource,\n    techniques_used: selectedTechniques.length,\n    semantic_scores: semanticMatches.map(m => m.score),\n    rag_count: ragResults.length,\n    inference_start: Date.now(),\n    trace_chain_pg: traceChainPg,\n    // Metadata for trace storage\n    input_summary: {\n      activity_count: activityItems.length,\n      note_count: noteItems.length,\n      todo_count: todoItems.length,\n      stuck_todo_count: stuckTodos.length,\n      current_hour: currentHour,\n      is_morning: isMorning,\n      is_evening: isEvening,\n      technique_source: techniqueSource,\n      semantic_match_count: semanticMatches.length,\n      rag_result_count: ragResults.length\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2016,96],"id":"assemble-prompt","name":"AssemblePrompt"},{"parameters":{"promptType":"define","text":"={{ $json.assembled_prompt }}\n\n---\n\n## Your Task\n\nBased on the context above, compose a proactive message to the user. This is a {{ $json.context_description }}.\n\nYour message should be helpful, personal, and timely. Reference their specific activities, notes, or todos when relevant.\n\nRespond with ONLY the message you would send to the user. No preamble, no explanation - just the message itself.","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[2240,96],"id":"generate-message-llm","name":"GenerateMessageWithLlm"},{"parameters":{"model":"nvidia/nemotron-nano-9b-v2:free","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2248,320],"id":"nemotron-nano-9b","name":"NemotronNano9b","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"model":"xiaomi/mimo-v2-flash:free","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2376,320],"id":"mimo-v2-flash","name":"MimoV2Flash","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"jsCode":"// Parse LLM response\nconst assembleData = $('AssemblePrompt').first().json;\nconst llmText = $json.text?.trim() || '';\nconst durationMs = Date.now() - assembleData.inference_start;\nconst ctx = assembleData.ctx;\n\nlet message = '';\nlet nextPulseMinutes = 120;\nlet reasoning = '';\n\ntry {\n  // Extract JSON from response (handling potential markdown blocks)\n  const jsonMatch = llmText.match(/\\{[\\s\\S]*\\}/);\n  const data = JSON.parse(jsonMatch ? jsonMatch[0] : llmText);\n  message = data.message || '';\n  nextPulseMinutes = parseInt(data.next_pulse_minutes) || 120;\n  reasoning = data.reasoning || '';\n} catch (e) {\n  // Fallback for non-JSON or malformed responses\n  message = llmText.replace(/^```[a-z]*\\n?/, '').replace(/\\n?```$/, '').trim();\n}\n\n// Check if message is empty or too short\nconst isEmpty = !message || message.length < 10;\n\nreturn {\n  json: {\n    ctx,\n    message: message,\n    next_pulse_minutes: nextPulseMinutes,\n    reasoning: reasoning,\n    is_empty: isEmpty,\n    duration_ms: durationMs,\n    trace_chain_pg: assembleData.trace_chain_pg,\n    llm_response: llmText,\n    assembled_prompt: assembleData.assembled_prompt,\n    context_description: assembleData.context_description,\n    technique_source: assembleData.technique_source,\n    input_summary: assembleData.input_summary\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2464,96],"id":"parse-llm-response","name":"ParseLlmResponse"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO traces (event_id, step_name, data, trace_chain)\nVALUES (\n  $1::uuid,\n  'proactive_agent',\n  jsonb_build_object(\n    'prompt', $2,\n    'completion', $3,\n    'context_description', $4,\n    'technique_source', $5,\n    'input_summary', $6::jsonb,\n    'duration_ms', $7::integer\n  ),\n  $8::uuid[]\n)\nRETURNING id, trace_chain || id AS updated_trace_chain;","options":{"values":"{{ $json.ctx.event.event_id }},{{ $json.assembled_prompt }},{{ $json.llm_response }},{{ $json.context_description }},{{ $json.technique_source }},{{ JSON.stringify($json.input_summary) }},{{ $json.duration_ms }},{{ $json.trace_chain_pg }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2688,96],"id":"store-trace","name":"StoreTrace","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Merge trace result with parsed LLM data\nconst traceResult = $json;\nconst parseData = $('ParseLlmResponse').first().json;\n\nconst updatedTraceChain = traceResult.updated_trace_chain || [];\nconst updatedTraceChainPg = '{' + updatedTraceChain.join(',') + '}';\n\n// Pre-stringify projection data for Postgres\nconst projectionData = {\n  timestamp: new Date().toISOString(),\n  text: parseData.message,\n  context_description: parseData.context_description,\n  technique_source: parseData.technique_source\n};\n\nreturn {\n  json: {\n    ctx: parseData.ctx,\n    trace_id: traceResult.id,\n    trace_chain_pg: updatedTraceChainPg,\n    message: parseData.message,\n    is_empty: parseData.is_empty,\n    projection_data_json: JSON.stringify(projectionData)\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2912,96],"id":"merge-trace-result","name":"MergeTraceResult"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-empty","leftValue":"={{ $json.is_empty }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[3136,96],"id":"if-empty","name":"IfEmptyMessage"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO projections (trace_id, event_id, trace_chain, projection_type, data, status, timezone)\nVALUES (\n  $1::uuid,\n  $2::uuid,\n  $3::uuid[],\n  'nudge',\n  $4::jsonb,\n  'auto_confirmed',\n  $5\n)\nRETURNING id;","options":{"values":"{{ $json.trace_id }},{{ $json.ctx.event.event_id }},{{ $json.trace_chain_pg }},{{ $json.projection_data_json }},{{ $json.ctx.event.timezone }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[3360,176],"id":"store-projection","name":"StoreProjection","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Merge projection result for Discord\nconst projResult = $json;\nconst mergeData = $('MergeTraceResult').first().json;\n\nreturn {\n  json: {\n    ctx: mergeData.ctx,\n    projection_id: projResult.id,\n    message: mergeData.message\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3584,176],"id":"merge-for-discord","name":"MergeForDiscord"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $env.DISCORD_GUILD_ID }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $env.DISCORD_CHANNEL_ARCANE_SHELL }}","mode":"id"},"content":"={{ $json.message }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[3808,176],"id":"send-message","name":"SendMessage","credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"retryOnFail":true,"maxTries":3,"waitBetweenTries":1000},{"parameters":{"operation":"executeQuery","query":"-- Update projection with Discord message ID for void support\nUPDATE projections \nSET data = data || jsonb_build_object(\n  'discord_message_id', $1,\n  'discord_channel_id', $2,\n  'discord_guild_id', $3\n)\nWHERE id = $4::uuid\nRETURNING id;","options":{"values":"{{ $json.id }},{{ $env.DISCORD_CHANNEL_ARCANE_SHELL }},{{ $env.DISCORD_GUILD_ID }},{{ $('Merge for Discord').first().json.projection_id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[4032,176],"id":"update-projection-message-id","name":"UpdateProjectionWithMessageId","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE config \nSET value = (NOW() + ($1 || ' minutes')::interval)::text, updated_at = NOW()\nWHERE key = 'next_pulse';","options":{"values":"={{ $json.next_pulse_minutes }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2688,288],"id":"update-next-pulse","name":"UpdateNextPulse","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"resource":"reaction","operation":"add","guildId":{"__rl":true,"value":"={{ $env.DISCORD_GUILD_ID }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $env.DISCORD_CHANNEL_ARCANE_SHELL }}","mode":"id"},"messageId":"={{ $json.id }}","emoji":"â“","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[4256,176],"id":"add-diagnostic-reaction","name":"AddDiagnosticReaction","credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT value FROM config WHERE key = 'verbose';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[4480,176],"id":"check-verbose-config","name":"CheckVerboseConfig","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"is-verbose","leftValue":"={{ $json.value }}","rightValue":"true","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[4704,176],"id":"if-verbose","name":"IfVerbose?"},{"parameters":{"workflowId":{"__rl":true,"value":"wVpslhMBnrsgDaOR","mode":"list","cachedResultName":"Show_Projection_Details","cachedResultUrl":"/workflow/wVpslhMBnrsgDaOR"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $('Merge for Discord').first().json.ctx }}","emoji":"â“"},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[4928,256],"id":"trigger-show-details","name":"TriggerShowDetails"}],"connections":{"WhenCalledByAnotherWorkflow":{"main":[[{"node":"PrepareEvent","type":"main","index":0}]]},"PrepareEvent":{"main":[[{"node":"InsertEvent","type":"main","index":0}]]},"InsertEvent":{"main":[[{"node":"InitializeCtx","type":"main","index":0}]]},"InitializeCtx":{"main":[[{"node":"FetchHistory","type":"main","index":0}]]},"FetchHistory":{"main":[[{"node":"GetNorthStar","type":"main","index":0},{"node":"GetRecentActivities(24h)","type":"main","index":0},{"node":"GetRecentNotes(7d)","type":"main","index":0},{"node":"GetPendingTodos","type":"main","index":0},{"node":"MergeQueryResults","type":"main","index":0}]]},"GetNorthStar":{"main":[[{"node":"MergeQueryResults","type":"main","index":2}]]},"GetRecentActivities(24h)":{"main":[[{"node":"MergeQueryResults","type":"main","index":3}]]},"GetRecentNotes(7d)":{"main":[[{"node":"MergeQueryResults","type":"main","index":4}]]},"GetPendingTodos":{"main":[[{"node":"MergeQueryResults","type":"main","index":5}]]},"MergeQueryResults":{"main":[[{"node":"BuildContextSummary","type":"main","index":0}]]},"BuildContextSummary":{"main":[[{"node":"SemanticSelectTechniques","type":"main","index":0},{"node":"EmbedContextForRag","type":"main","index":0}]]},"EmbedContextForRag":{"main":[[{"node":"PrepareEmbeddingForRag","type":"main","index":0}]]},"PrepareEmbeddingForRag":{"main":[[{"node":"RagSimilarProjections","type":"main","index":0}]]},"SemanticSelectTechniques":{"main":[[{"node":"MergeSemanticResults","type":"main","index":0}]]},"RagSimilarProjections":{"main":[[{"node":"MergeSemanticResults","type":"main","index":1}]]},"MergeSemanticResults":{"main":[[{"node":"AssemblePrompt","type":"main","index":0}]]},"AssemblePrompt":{"main":[[{"node":"GenerateMessageWithLlm","type":"main","index":0}]]},"GenerateMessageWithLlm":{"main":[[{"node":"ParseLlmResponse","type":"main","index":0}]]},"ParseLlmResponse":{"main":[[{"node":"StoreTrace","type":"main","index":0},{"node":"UpdateNextPulse","type":"main","index":0}]]},"UpdateNextPulse":{"main":[[]]},"StoreTrace":{"main":[[{"node":"MergeTraceResult","type":"main","index":0}]]},"MergeTraceResult":{"main":[[{"node":"IfEmptyMessage","type":"main","index":0}]]},"IfEmptyMessage":{"main":[[],[{"node":"StoreProjection","type":"main","index":0}]]},"StoreProjection":{"main":[[{"node":"MergeForDiscord","type":"main","index":0}]]},"MergeForDiscord":{"main":[[{"node":"SendMessage","type":"main","index":0}]]},"SendMessage":{"main":[[{"node":"UpdateProjectionWithMessageId","type":"main","index":0}]]},"UpdateProjectionWithMessageId":{"main":[[{"node":"AddDiagnosticReaction","type":"main","index":0}]]},"AddDiagnosticReaction":{"main":[[{"node":"CheckVerboseConfig","type":"main","index":0}]]},"CheckVerboseConfig":{"main":[[{"node":"IfVerbose?","type":"main","index":0}]]},"IfVerbose?":{"main":[[],[{"node":"TriggerShowDetails","type":"main","index":0}]]},"TriggerShowDetails":{"main":[[]]},"NemotronNano9b":{"ai_languageModel":[[{"node":"GenerateMessageWithLlm","type":"ai_languageModel","index":0}]]},"MimoV2Flash":{"ai_languageModel":[[{"node":"GenerateMessageWithLlm","type":"ai_languageModel","index":1}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":null,"versionId":"7ce0df21-89e2-41a0-a90c-35d03c1e0274","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:30.116Z","createdAt":"2025-12-23T09:30:30.116Z","role":"workflow:owner","workflowId":"lnxlZ8AFe7LhMMEA","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:52.069Z","createdAt":"2025-12-23T12:17:03.830Z","id":"qfwF87c3wub8oujg","name":"Auto_Backfill","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0],"id":"cron-trigger","name":"CronTrigger"},{"parameters":{"operation":"executeQuery","query":"-- Find projections missing embeddings\nSELECT \n  p.id as projection_id,\n  p.projection_type,\n  p.data->>'description' as description,\n  p.data->>'text' as text\nFROM projections p\nLEFT JOIN embeddings e ON p.id = e.projection_id\nWHERE e.id IS NULL\n  AND p.status IN ('auto_confirmed', 'confirmed')\nLIMIT 20;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[256,-96],"id":"find-missing-embeddings","name":"FindMissingEmbeddings","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[512,-96],"id":"loop-embeddings","name":"LoopEmbeddings","continueOnFail":true},{"parameters":{"method":"POST","url":"={{ $env.EMBEDDING_SERVICE_URL }}/embed","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"texts\": [{{ JSON.stringify($json.description || $json.text || \"\") }}]\n}","options":{"timeout":10000}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[752,-96],"id":"embed-text","name":"EmbedText","continueOnFail":true},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1008,-96],"id":"insert-embedding","name":"InsertEmbedding","continueOnFail":true},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $json;\nconst projectionId = item.projection_id;\nconst text = item.description || item.text || \"\";\nconst embeddings = $(\"EmbedText\").first().json.embeddings;\n\nif (!embeddings || !embeddings[0]) return {};\n\nconst vector = \"[\" + embeddings[0].join(\",\") + \"]\";\n\nreturn {\n  json: {\n    ctx: {\n      db_queries: [{\n        key: \"embedding\",\n        sql: \"INSERT INTO embeddings (projection_id, model, embedding_data, embedded_text, embedding) SELECT $1, \\u0027all-MiniLM-L6-v2\\u0027, \\u0027{}\\u0027, $2, $3::vector WHERE NOT EXISTS (SELECT 1 FROM embeddings WHERE projection_id = $1) ON CONFLICT DO NOTHING;\",\n        params: [projectionId, text, vector]\n      }]\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,64],"id":"prepare-embedding-query","name":"PrepareEmbeddingQuery"},{"parameters":{"operation":"executeQuery","query":"-- Find traces with missing projections\nSELECT \n  t.id as trace_id,\n  t.event_id,\n  t.data->>'completion' as completion,\n  t.trace_chain,\n  e.timezone\nFROM traces t\nJOIN events e ON t.event_id = e.id\nWHERE t.step_name = 'multi_capture'\n  AND (t.data->>'capture_count')::int > (\n    SELECT COUNT(*) FROM projections p WHERE p.trace_id = t.id\n  )\nLIMIT 5;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[256,304],"id":"find-incomplete-traces","name":"FindIncompleteTraces","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const trace = item.json;\n  let parsed;\n  try {\n    parsed = JSON.parse(trace.completion);\n  } catch (e) {\n    console.error(`Failed to parse completion for trace ${trace.trace_id}: ${e.message}`);\n    continue;\n  }\n\n  const types = ['activity', 'note', 'todo'];\n  for (const type of types) {\n    const data = parsed[type];\n    if (data && data.confidence >= 0.5) {\n      results.push({\n        json: {\n          trace_id: trace.trace_id,\n          event_id: trace.event_id,\n          trace_chain: trace.trace_chain,\n          timezone: trace.timezone,\n          type: type,\n          data: data\n        }\n      });\n    }\n  }\n}\nreturn results;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[512,304],"id":"parse-missing-projections","name":"ParseMissingProjections"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[752,304],"id":"insert-missing-projections","name":"InsertMissingProjections","continueOnFail":true},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $json;\nreturn {\n  json: {\n    ctx: {\n      db_queries: [{\n        key: \"projection\",\n        sql: \"INSERT INTO projections (trace_id, event_id, trace_chain, projection_type, data, status, timezone) SELECT $1::uuid, $2::uuid, $3::uuid[], $4, $5::jsonb, \\u0027auto_confirmed\\u0027, $6 WHERE NOT EXISTS (SELECT 1 FROM projections WHERE trace_id = $1 AND projection_type = $4);\",\n        params: [\n          item.trace_id,\n          item.event_id,\n          \"{\" + item.trace_chain.join(\",\") + \"}\",\n          item.type,\n          JSON.stringify(item.data),\n          item.timezone\n        ]\n      }]\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[640,464],"id":"prepare-projection-query","name":"PrepareProjectionQuery"}],"connections":{"CronTrigger":{"main":[[{"node":"FindMissingEmbeddings","type":"main","index":0},{"node":"FindIncompleteTraces","type":"main","index":0}]]},"FindMissingEmbeddings":{"main":[[{"node":"LoopEmbeddings","type":"main","index":0}]]},"LoopEmbeddings":{"main":[[],[{"node":"EmbedText","type":"main","index":0}]]},"EmbedText":{"main":[[{"node":"PrepareEmbeddingQuery","type":"main","index":0}]]},"PrepareEmbeddingQuery":{"main":[[{"node":"InsertEmbedding","type":"main","index":0}]]},"InsertEmbedding":{"main":[[{"node":"LoopEmbeddings","type":"main","index":0}]]},"FindIncompleteTraces":{"main":[[{"node":"ParseMissingProjections","type":"main","index":0}]]},"ParseMissingProjections":{"main":[[{"node":"PrepareProjectionQuery","type":"main","index":0}]]},"PrepareProjectionQuery":{"main":[[{"node":"InsertMissingProjections","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{"node:CronTrigger":{"recurrenceRules":[]}},"meta":null,"pinData":{"CronTrigger":[{"json":{"timestamp":"2025-12-24T03:00:31.019-08:00","Readable date":"December 24th 2025, 3:00:31 am","Readable time":"3:00:31 am","Day of week":"Wednesday","Year":"2025","Month":"December","Day of month":"24","Hour":"03","Minute":"00","Second":"31","Timezone":"America/Vancouver (UTC-08:00)"},"pairedItem":{"item":0}}]},"versionId":"15ed0a90-f90b-48c4-84d4-53a61a5ac054","activeVersionId":"15ed0a90-f90b-48c4-84d4-53a61a5ac054","triggerCount":1,"shared":[{"updatedAt":"2025-12-23T12:17:03.830Z","createdAt":"2025-12-23T12:17:03.830Z","role":"workflow:owner","workflowId":"qfwF87c3wub8oujg","projectId":"erM3nntdLL53noWi"}],"activeVersion":{"updatedAt":"2025-12-26T06:27:52.073Z","createdAt":"2025-12-26T06:27:52.073Z","versionId":"15ed0a90-f90b-48c4-84d4-53a61a5ac054","workflowId":"qfwF87c3wub8oujg","nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0],"id":"cron-trigger","name":"CronTrigger"},{"parameters":{"operation":"executeQuery","query":"-- Find projections missing embeddings\nSELECT \n  p.id as projection_id,\n  p.projection_type,\n  p.data->>'description' as description,\n  p.data->>'text' as text\nFROM projections p\nLEFT JOIN embeddings e ON p.id = e.projection_id\nWHERE e.id IS NULL\n  AND p.status IN ('auto_confirmed', 'confirmed')\nLIMIT 20;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[256,-96],"id":"find-missing-embeddings","name":"FindMissingEmbeddings","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[512,-96],"id":"loop-embeddings","name":"LoopEmbeddings","continueOnFail":true},{"parameters":{"method":"POST","url":"={{ $env.EMBEDDING_SERVICE_URL }}/embed","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"texts\": [{{ JSON.stringify($json.description || $json.text || \"\") }}]\n}","options":{"timeout":10000}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[752,-96],"id":"embed-text","name":"EmbedText","continueOnFail":true},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1008,-96],"id":"insert-embedding","name":"InsertEmbedding","continueOnFail":true},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $json;\nconst projectionId = item.projection_id;\nconst text = item.description || item.text || \"\";\nconst embeddings = $(\"EmbedText\").first().json.embeddings;\n\nif (!embeddings || !embeddings[0]) return {};\n\nconst vector = \"[\" + embeddings[0].join(\",\") + \"]\";\n\nreturn {\n  json: {\n    ctx: {\n      db_queries: [{\n        key: \"embedding\",\n        sql: \"INSERT INTO embeddings (projection_id, model, embedding_data, embedded_text, embedding) SELECT $1, \\u0027all-MiniLM-L6-v2\\u0027, \\u0027{}\\u0027, $2, $3::vector WHERE NOT EXISTS (SELECT 1 FROM embeddings WHERE projection_id = $1) ON CONFLICT DO NOTHING;\",\n        params: [projectionId, text, vector]\n      }]\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,64],"id":"prepare-embedding-query","name":"PrepareEmbeddingQuery"},{"parameters":{"operation":"executeQuery","query":"-- Find traces with missing projections\nSELECT \n  t.id as trace_id,\n  t.event_id,\n  t.data->>'completion' as completion,\n  t.trace_chain,\n  e.timezone\nFROM traces t\nJOIN events e ON t.event_id = e.id\nWHERE t.step_name = 'multi_capture'\n  AND (t.data->>'capture_count')::int > (\n    SELECT COUNT(*) FROM projections p WHERE p.trace_id = t.id\n  )\nLIMIT 5;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[256,304],"id":"find-incomplete-traces","name":"FindIncompleteTraces","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const trace = item.json;\n  let parsed;\n  try {\n    parsed = JSON.parse(trace.completion);\n  } catch (e) {\n    console.error(`Failed to parse completion for trace ${trace.trace_id}: ${e.message}`);\n    continue;\n  }\n\n  const types = ['activity', 'note', 'todo'];\n  for (const type of types) {\n    const data = parsed[type];\n    if (data && data.confidence >= 0.5) {\n      results.push({\n        json: {\n          trace_id: trace.trace_id,\n          event_id: trace.event_id,\n          trace_chain: trace.trace_chain,\n          timezone: trace.timezone,\n          type: type,\n          data: data\n        }\n      });\n    }\n  }\n}\nreturn results;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[512,304],"id":"parse-missing-projections","name":"ParseMissingProjections"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[752,304],"id":"insert-missing-projections","name":"InsertMissingProjections","continueOnFail":true},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $json;\nreturn {\n  json: {\n    ctx: {\n      db_queries: [{\n        key: \"projection\",\n        sql: \"INSERT INTO projections (trace_id, event_id, trace_chain, projection_type, data, status, timezone) SELECT $1::uuid, $2::uuid, $3::uuid[], $4, $5::jsonb, \\u0027auto_confirmed\\u0027, $6 WHERE NOT EXISTS (SELECT 1 FROM projections WHERE trace_id = $1 AND projection_type = $4);\",\n        params: [\n          item.trace_id,\n          item.event_id,\n          \"{\" + item.trace_chain.join(\",\") + \"}\",\n          item.type,\n          JSON.stringify(item.data),\n          item.timezone\n        ]\n      }]\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[640,464],"id":"prepare-projection-query","name":"PrepareProjectionQuery"}],"connections":{"CronTrigger":{"main":[[{"node":"FindMissingEmbeddings","type":"main","index":0},{"node":"FindIncompleteTraces","type":"main","index":0}]]},"FindMissingEmbeddings":{"main":[[{"node":"LoopEmbeddings","type":"main","index":0}]]},"LoopEmbeddings":{"main":[[],[{"node":"EmbedText","type":"main","index":0}]]},"EmbedText":{"main":[[{"node":"PrepareEmbeddingQuery","type":"main","index":0}]]},"PrepareEmbeddingQuery":{"main":[[{"node":"InsertEmbedding","type":"main","index":0}]]},"InsertEmbedding":{"main":[[{"node":"LoopEmbeddings","type":"main","index":0}]]},"FindIncompleteTraces":{"main":[[{"node":"ParseMissingProjections","type":"main","index":0}]]},"ParseMissingProjections":{"main":[[{"node":"PrepareProjectionQuery","type":"main","index":0}]]},"PrepareProjectionQuery":{"main":[[{"node":"InsertMissingProjections","type":"main","index":0}]]}},"authors":"Chris Irineo","name":null,"description":null},"tags":[]},{"updatedAt":"2025-12-26T06:27:55.969Z","createdAt":"2025-12-23T09:30:31.825Z","id":"dzbXvPNPoYdpaXGT","name":"Save_Extraction","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-1792,608],"id":"c14595cb-2101-462a-a7f3-8179adcb9a48","name":"ExecuteWorkflowTrigger"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse emoji to determine action type\n// Input is ctx pattern from Route_Reaction\nconst ctx = $json.ctx;\nconst event = ctx.event;\nconst emoji = event.emoji;\n\n// Number emoji map\nconst emojiMap = {\n  '1ï¸âƒ£': 1, '2ï¸âƒ£': 2, '3ï¸âƒ£': 3, '4ï¸âƒ£': 4, '5ï¸âƒ£': 5,\n  '6ï¸âƒ£': 6, '7ï¸âƒ£': 7, '8ï¸âƒ£': 8, '9ï¸âƒ£': 9, 'ðŸ”Ÿ': 10\n};\n\nconst displayOrder = emojiMap[emoji];\n\nlet actionType = 'unknown';\n\nif (displayOrder) {\n  actionType = 'save_item';\n} else if (emoji === 'âŒ') {\n  actionType = 'dismiss';\n} else if (emoji === 'ðŸ—‘ï¸') {\n  actionType = 'delete_thread';\n}\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      action: {\n        type: actionType,\n        display_order: displayOrder,\n        emoji: emoji\n      }\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1568,608],"id":"cf81fc06-c1a9-4b0b-9ad6-4b11f4db7f78","name":"ParseEmojiType"},{"parameters":{"operation":"executeQuery","query":"SELECT id FROM projections WHERE projection_type = 'thread_extraction' AND data->>'summary_message_id' = $1 AND status = 'pending' LIMIT 1;","options":{"queryReplacement":"={{ $json.ctx.event.message_id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1344,688],"id":"check-summary-message","name":"CheckIfSummaryMessage","alwaysOutputData":false,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[-1120,608],"id":"merge-after-check","name":"RestoreCtx"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.action.type }}","rightValue":"save_item","operator":{"type":"string","operation":"equals"},"id":"54e06574-e0c8-4af0-a9eb-087988e52cbe"}],"combinator":"and"},"renameOutput":true,"outputKey":"Save"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"f6c15010-c1d3-4a8c-89eb-46ef5a2eb3a6","leftValue":"={{ $json.ctx.action.type }}","rightValue":"dismiss","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Dismiss"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"2f9ef712-182c-40b7-b550-b66951bdecd2","leftValue":"={{ $json.ctx.action.type }}","rightValue":"delete_thread","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Delete Thread"}]},"options":{"fallbackOutput":"none"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-896,592],"id":"17c95810-f72f-46ff-8f0e-c84eed006985","name":"WhatAction"},{"parameters":{"operation":"executeQuery","query":"SELECT id, data->>'thread_id' AS thread_id, data->>'item_type' AS item_type, data->>'text' AS text FROM projections WHERE projection_type = 'thread_extraction' AND data->>'summary_message_id' = $1 AND (data->>'display_order')::int = $2 AND status = 'pending' LIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-672,272],"id":"b35330b9-f750-4616-9b84-ce6d19b84ab6","name":"GetExtractionItem","alwaysOutputData":false,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[-448,304],"id":"merge-extraction-ctx","name":"MergeExtractionWithCtx"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.item_type }}","rightValue":"todo","operator":{"type":"string","operation":"equals"},"id":"is-todo"}],"combinator":"and"},"renameOutput":true,"outputKey":"Todo"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-224,304],"id":"70fe2723-8181-4e57-98e7-d3fc4484f4c7","name":"IsTodo?"},{"parameters":{"operation":"executeQuery","query":"UPDATE projections SET projection_type = 'note', status = 'confirmed', confirmed_at = NOW(), data = data || jsonb_build_object('category', data->>'item_type', 'promoted_from', 'thread_extraction', 'confirmed_via', 'reaction') WHERE id = $1::uuid AND projection_type = 'thread_extraction' RETURNING id, data->>'text' AS text;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[0,272],"id":"81de3319-4c05-48cc-9cb8-f4e8278bfad9","name":"PromoteToNote","alwaysOutputData":false,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE projections SET projection_type = 'todo', status = 'confirmed', confirmed_at = NOW(), data = data || jsonb_build_object('promoted_from', 'thread_extraction', 'confirmed_via', 'reaction', 'todo_status', 'pending') WHERE id = $1::uuid AND projection_type = 'thread_extraction' RETURNING id, data->>'text' AS text;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[0,544],"id":"87dbb168-a1c3-4e8c-8547-dbcc69a33849","name":"PromoteToTodo","alwaysOutputData":false,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"append","numberInputs":2},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[224,304],"id":"d87f449e-a026-4d48-aa08-e9489c352b51","name":"AfterPromote"},{"parameters":{"method":"POST","url":"={{ $env.EMBEDDING_SERVICE_URL }}/embed","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"texts\": [{{ JSON.stringify($json.text || '') }}]\n}","options":{"timeout":10000}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,80],"id":"embed-projection-text","name":"EmbedProjectionText","continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"-- Insert embedding for the saved projection (fire-and-forget)\nINSERT INTO embeddings (projection_id, model, embedding_data, embedded_text, embedding)\nSELECT \n  $1::uuid,\n  'all-MiniLM-L6-v2',\n  '{}',\n  $2,\n  $3::vector\nWHERE $3 IS NOT NULL\nON CONFLICT DO NOTHING;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,80],"id":"insert-embedding","name":"InsertEmbedding","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}},"continueOnFail":true},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $('What Action').item.json.ctx.event.channel_id }}/messages/{{ $('What Action').item.json.ctx.event.message_id }}/reactions/{{ encodeURIComponent($('What Action').item.json.ctx.action.emoji) }}/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,304],"id":"51af8a9d-7ace-4b47-a579-4efa1886e799","name":"RemoveNumberEmoji","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"SELECT COUNT(*) as unsaved FROM projections WHERE projection_type = 'thread_extraction' AND data->>'summary_message_id' = $1 AND status = 'pending' HAVING COUNT(*) = 0;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[672,304],"id":"6c50df92-a223-416d-87c6-7f7aa5841f48","name":"CheckAllSaved","alwaysOutputData":false,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"method":"PATCH","url":"=https://discord.com/api/v10/channels/{{ $('What Action').item.json.ctx.event.channel_id }}/messages/{{ $('What Action').item.json.ctx.event.message_id }}","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","sendBody":true,"specifyBody":"json","jsonBody":"={{ { \"content\": \"âœ… All items saved!\\n\\nðŸ—‘ï¸ Delete thread â€¢ âŒ Dismiss\" } }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[896,304],"id":"90af10c8-1c74-467e-ae4e-dbd793ddd892","name":"UpdateSummary(allSaved)","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-672,560],"id":"8e521696-abc7-42b6-b5fd-74c679809412","name":"DeleteSummary(dismiss)","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"SELECT data->>'thread_id' AS discord_thread_id FROM projections WHERE projection_type = 'thread_extraction' AND data->>'summary_message_id' = $1 LIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-672,752],"id":"f0bf81d2-b00c-4009-a86b-a7f48ae744fc","name":"GetDiscordThreadId","alwaysOutputData":false,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.discord_thread_id }}","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-448,944],"id":"1b798d04-8f99-4a90-b37d-81b891a35c8b","name":"DeleteDiscordThread","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[-448,752],"id":"merge-thread-ctx","name":"RestoreCtxForThread"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[-224,944],"id":"merge-status-ctx","name":"RestoreCtxForDeleteMsg"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,944],"id":"45c43642-ffd9-45a0-9c83-f10fdc226336","name":"DeleteSummaryMessage","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"ParseEmojiType","type":"main","index":0}]]},"ParseEmojiType":{"main":[[{"node":"CheckIfSummaryMessage","type":"main","index":0},{"node":"RestoreCtx","type":"main","index":0}]]},"CheckIfSummaryMessage":{"main":[[{"node":"RestoreCtx","type":"main","index":1}]]},"RestoreCtx":{"main":[[{"node":"WhatAction","type":"main","index":0}]]},"WhatAction":{"main":[[{"node":"GetExtractionItem","type":"main","index":0},{"node":"MergeExtractionWithCtx","type":"main","index":1}],[{"node":"DeleteSummary(dismiss)","type":"main","index":0}],[{"node":"GetDiscordThreadId","type":"main","index":0},{"node":"RestoreCtxForThread","type":"main","index":1},{"node":"RestoreCtxForDeleteMsg","type":"main","index":1}]]},"GetExtractionItem":{"main":[[{"node":"MergeExtractionWithCtx","type":"main","index":0}]]},"MergeExtractionWithCtx":{"main":[[{"node":"IsTodo?","type":"main","index":0}]]},"IsTodo?":{"main":[[{"node":"PromoteToTodo","type":"main","index":0}],[{"node":"PromoteToNote","type":"main","index":0}]]},"PromoteToNote":{"main":[[{"node":"AfterPromote","type":"main","index":0}]]},"PromoteToTodo":{"main":[[{"node":"AfterPromote","type":"main","index":1}]]},"AfterPromote":{"main":[[{"node":"RemoveNumberEmoji","type":"main","index":0},{"node":"EmbedProjectionText","type":"main","index":0}]]},"EmbedProjectionText":{"main":[[{"node":"InsertEmbedding","type":"main","index":0}]]},"RemoveNumberEmoji":{"main":[[{"node":"CheckAllSaved","type":"main","index":0}]]},"CheckAllSaved":{"main":[[{"node":"UpdateSummary(allSaved)","type":"main","index":0}]]},"GetDiscordThreadId":{"main":[[{"node":"DeleteDiscordThread","type":"main","index":0},{"node":"RestoreCtxForThread","type":"main","index":0}]]},"DeleteDiscordThread":{"main":[[]]},"RestoreCtxForThread":{"main":[[{"node":"RestoreCtxForDeleteMsg","type":"main","index":0}]]},"RestoreCtxForDeleteMsg":{"main":[[{"node":"DeleteSummaryMessage","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"ExecuteWorkflowTrigger":[{"json":{"ctx":{"event":{"event_id":"c5903e9f-e94a-4ead-a445-3967abef3ae5","event_type":"discord_reaction","timestamp":"2025-12-24T11:24:59.000Z","guild_id":"754207117157859388","channel_id":"1453335033665556654","message_id":"test-msg-1766575496454518620","author_login":"12345","thread_id":null,"emoji":"âŒ","extraction_index":null,"action":"add","trace_chain":["c5903e9f-e94a-4ead-a445-3967abef3ae5"],"trace_chain_pg":"{c5903e9f-e94a-4ead-a445-3967abef3ae5}"}},"route":"extraction","emoji":"âŒ","config":{"types":{"âœ…":{"type":"todo"},"ðŸ’»":{"tag":"::","type":"command"},"ðŸ“":{"tag":"..","type":"note"},"ðŸ”˜":{"tag":"!!","type":"activity"},"ðŸ—¨ï¸":{"tag":"++","type":"chat"}},"status":{"âœ…":"complete","ðŸ”„":"progress","ðŸ”²":"pending"},"actions":{"ðŸ—‘ï¸":"void"},"corrections":["ðŸ”˜","ðŸ“","ðŸ—‘ï¸"]}},"pairedItem":{"item":0}}]},"versionId":"7f8e5ac7-34ec-4d77-820d-0a330afce9b8","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:31.825Z","createdAt":"2025-12-23T09:30:31.825Z","role":"workflow:owner","workflowId":"dzbXvPNPoYdpaXGT","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:54.064Z","createdAt":"2025-12-23T09:30:29.501Z","id":"NCt9DcriuZwLwFLA","name":"Handle_Todo_Status","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-160,400],"id":"trigger-todo-status","name":"ExecuteWorkflowTrigger"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"content":"=Todo status changes are WIP. Reacted with {{ $json.ctx.event.emoji }} on message `{{ $json.ctx.event.message_id }}`","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[80,400],"id":"send-wip-message","name":"SendWipMessage","webhookId":"todo-status-wip","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"SendWipMessage","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":null,"versionId":"4357ff16-4fc0-498e-a1b1-4459e5751096","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:29.501Z","createdAt":"2025-12-23T09:30:29.501Z","role":"workflow:owner","workflowId":"NCt9DcriuZwLwFLA","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-24T15:28:27.718Z","createdAt":"2025-12-23T09:27:14.552Z","id":"YBAOnCpqUBa5ZsSa","name":"My workflow","active":false,"isArchived":true,"nodes":[],"connections":{},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"165b31ad-e6a5-45f5-84de-96bf1a5fde2a","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:27:14.552Z","createdAt":"2025-12-23T09:27:14.552Z","role":"workflow:owner","workflowId":"YBAOnCpqUBa5ZsSa","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:55.341Z","createdAt":"2025-12-23T09:30:31.267Z","id":"G0XzfbZiT3P98B4S","name":"Route_Message","active":true,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-12848,8080],"id":"91f732dd-8250-4342-ae01-365e0b336809","name":"ReceiveEvent"},{"parameters":{"operation":"executeQuery","query":"-- Reset next_pulse to NOW so proactive agent can respond after user activity\nUPDATE config \nSET value = NOW()::text, updated_at = NOW()\nWHERE key = 'next_pulse';\n\n-- Insert if not exists\nINSERT INTO config (key, value)\nVALUES ('next_pulse', NOW()::text)\nON CONFLICT (key) DO NOTHING;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-12624,8400],"id":"reset-next-pulse","name":"ResetNextPulse","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"message","operation":"react","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"messageId":"={{ $json.ctx.event.message_id }}","emoji":"=ðŸ”µ"},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[-12624,7984],"id":"476cc1ef-8e72-4df6-ab57-42bda8f06403","name":"ReactWithðŸ”µ","webhookId":"react-processing","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"has-tag","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-12400,8400],"id":"c3c18343-a082-4961-8b41-20c2af7240dc","name":"HasTag?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"in-thread","leftValue":"={{ $json.ctx.event.thread_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-12624,8176],"id":"6f431c36-8c0b-4d84-9d44-a78ab41eadd1","name":"InThread?"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Add projection type to ctx for Capture_Projection workflow\n// Derive type from tag (!! = activity, .. = note, $$ = todo)\nconst tag = $json.ctx.event.tag;\nconst tagToType = { '!!': 'activity', '..': 'note', '$$': 'todo' };\nconst projectionType = tagToType[tag] || 'activity';\n\nreturn  {\n      ctx: {\n        ...$json.ctx,\n        projection: {\n          type: projectionType\n        }\n      }\n    }\n  \n;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-11952,8080],"id":"a1b2c3d4-prep-proj-type-node","name":"PrepareProjection"},{"parameters":{"workflowId":{"__rl":true,"value":"Gu9mVRTwvJCq0Fpf","mode":"list","cachedResultUrl":"/workflow/Gu9mVRTwvJCq0Fpf","cachedResultName":"Capture_Projection"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-11728,8080],"id":"e5f6g7h8-capture-projection-node","name":"CaptureProjection"},{"parameters":{"workflowId":{"__rl":true,"value":"9z0gv8DzdPC76trq","mode":"list","cachedResultUrl":"/workflow/9z0gv8DzdPC76trq","cachedResultName":"Start_Thread"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-11952,8272],"id":"4f5dbc85-1925-42ca-9d48-7cfdb8bc862f","name":"StartThread"},{"parameters":{"workflowId":{"__rl":true,"value":"ZwuxCuNFykFxgD3e","mode":"list","cachedResultUrl":"/workflow/ZwuxCuNFykFxgD3e","cachedResultName":"Execute_Command"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-11952,8464],"id":"be0f00ad-4e2f-4338-bfef-8816cee4777f","name":"ExecuteCommand"},{"parameters":{"workflowId":{"__rl":true,"value":"yj2EUpsI7s3mLlRH","mode":"list","cachedResultUrl":"/workflow/yj2EUpsI7s3mLlRH","cachedResultName":"Capture_Thread"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-12176,7840],"id":"15a4061b-cde3-4fce-89b9-8d2864c1ad53","name":"CaptureThread"},{"parameters":{"workflowId":{"__rl":true,"value":"mbX1lCt14Yi75gTE","mode":"list","cachedResultUrl":"/workflow/mbX1lCt14Yi75gTE","cachedResultName":"Continue_Thread"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-12176,8032],"id":"c2a931b5-275e-4fbc-bd3c-4ad40bfcca18","name":"ContinueThread"},{"parameters":{"workflowId":{"__rl":true,"value":"DX0m48INGS7vEwbu","mode":"list","cachedResultUrl":"/workflow/DX0m48INGS7vEwbu","cachedResultName":"Multi_Capture"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-12176,8512],"id":"multi-extract-node","name":"MultiCapture"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"0ceb9e91-e374-4346-8706-97df7d95cfe6","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"--","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-12400,7936],"id":"aebd154b-14e4-4927-b668-9adf8d7107f4","name":"TagIs"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-activity","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"!!","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"!!"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-note","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"..","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":".."},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-todo","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"$$","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"$$"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-chat","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"++","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"++"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-command","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"::","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"::"}]},"options":{"fallbackOutput":"extra"}},"id":"52b76dff-86bf-4376-896a-ffd61ade887b","name":"RouteByTag","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-12176,8224]}],"connections":{"ReceiveEvent":{"main":[[{"node":"ReactWithðŸ”µ","type":"main","index":0},{"node":"InThread?","type":"main","index":0},{"node":"ResetNextPulse","type":"main","index":0}]]},"HasTag?":{"main":[[{"node":"RouteByTag","type":"main","index":0}],[{"node":"MultiCapture","type":"main","index":0}]]},"InThread?":{"main":[[{"node":"TagIs","type":"main","index":0}],[{"node":"HasTag?","type":"main","index":0}]]},"PrepareProjection":{"main":[[{"node":"CaptureProjection","type":"main","index":0}]]},"TagIs":{"main":[[{"node":"CaptureThread","type":"main","index":0}],[{"node":"ContinueThread","type":"main","index":0}]]},"RouteByTag":{"main":[[{"node":"PrepareProjection","type":"main","index":0}],[{"node":"PrepareProjection","type":"main","index":0}],[{"node":"PrepareProjection","type":"main","index":0}],[{"node":"StartThread","type":"main","index":0}],[{"node":"ExecuteCommand","type":"main","index":0}],[{"node":"MultiCapture","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"ReceiveEvent":[{"json":{"ctx":{"event":{"event_id":"74d8976e-b5e1-421b-b799-05c6d3700702","event_type":"discord_message","timestamp":"2025-12-24T09:19:20.810000+00:00","guild_id":"754207117157859388","channel_id":"1450406231146496132","message_id":"1453316105295630366","author_login":"chr15","thread_id":null,"message_url":"https://discord.com/channels/754207117157859388/1450406231146496132/1453316105295630366","raw_text":".. test","clean_text":"test","tag":"..","trace_chain":["74d8976e-b5e1-421b-b799-05c6d3700702"],"trace_chain_pg":"{74d8976e-b5e1-421b-b799-05c6d3700702}"}}},"pairedItem":{"item":0}}]},"versionId":"bafee17b-23e8-4949-a9a8-76d34c4c2294","activeVersionId":"bafee17b-23e8-4949-a9a8-76d34c4c2294","triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:31.267Z","createdAt":"2025-12-23T09:30:31.267Z","role":"workflow:owner","workflowId":"G0XzfbZiT3P98B4S","projectId":"erM3nntdLL53noWi"}],"activeVersion":{"updatedAt":"2025-12-26T06:27:55.353Z","createdAt":"2025-12-26T06:27:55.353Z","versionId":"bafee17b-23e8-4949-a9a8-76d34c4c2294","workflowId":"G0XzfbZiT3P98B4S","nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-12848,8080],"id":"91f732dd-8250-4342-ae01-365e0b336809","name":"ReceiveEvent"},{"parameters":{"operation":"executeQuery","query":"-- Reset next_pulse to NOW so proactive agent can respond after user activity\nUPDATE config \nSET value = NOW()::text, updated_at = NOW()\nWHERE key = 'next_pulse';\n\n-- Insert if not exists\nINSERT INTO config (key, value)\nVALUES ('next_pulse', NOW()::text)\nON CONFLICT (key) DO NOTHING;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-12624,8400],"id":"reset-next-pulse","name":"ResetNextPulse","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"message","operation":"react","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"messageId":"={{ $json.ctx.event.message_id }}","emoji":"=ðŸ”µ"},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[-12624,7984],"id":"476cc1ef-8e72-4df6-ab57-42bda8f06403","name":"ReactWithðŸ”µ","webhookId":"react-processing","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"has-tag","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-12400,8400],"id":"c3c18343-a082-4961-8b41-20c2af7240dc","name":"HasTag?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"in-thread","leftValue":"={{ $json.ctx.event.thread_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-12624,8176],"id":"6f431c36-8c0b-4d84-9d44-a78ab41eadd1","name":"InThread?"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Add projection type to ctx for Capture_Projection workflow\n// Derive type from tag (!! = activity, .. = note, $$ = todo)\nconst tag = $json.ctx.event.tag;\nconst tagToType = { '!!': 'activity', '..': 'note', '$$': 'todo' };\nconst projectionType = tagToType[tag] || 'activity';\n\nreturn  {\n      ctx: {\n        ...$json.ctx,\n        projection: {\n          type: projectionType\n        }\n      }\n    }\n  \n;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-11952,8080],"id":"a1b2c3d4-prep-proj-type-node","name":"PrepareProjection"},{"parameters":{"workflowId":{"__rl":true,"value":"Gu9mVRTwvJCq0Fpf","mode":"list","cachedResultUrl":"/workflow/Gu9mVRTwvJCq0Fpf","cachedResultName":"Capture_Projection"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-11728,8080],"id":"e5f6g7h8-capture-projection-node","name":"CaptureProjection"},{"parameters":{"workflowId":{"__rl":true,"value":"9z0gv8DzdPC76trq","mode":"list","cachedResultUrl":"/workflow/9z0gv8DzdPC76trq","cachedResultName":"Start_Thread"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-11952,8272],"id":"4f5dbc85-1925-42ca-9d48-7cfdb8bc862f","name":"StartThread"},{"parameters":{"workflowId":{"__rl":true,"value":"ZwuxCuNFykFxgD3e","mode":"list","cachedResultUrl":"/workflow/ZwuxCuNFykFxgD3e","cachedResultName":"Execute_Command"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-11952,8464],"id":"be0f00ad-4e2f-4338-bfef-8816cee4777f","name":"ExecuteCommand"},{"parameters":{"workflowId":{"__rl":true,"value":"yj2EUpsI7s3mLlRH","mode":"list","cachedResultUrl":"/workflow/yj2EUpsI7s3mLlRH","cachedResultName":"Capture_Thread"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-12176,7840],"id":"15a4061b-cde3-4fce-89b9-8d2864c1ad53","name":"CaptureThread"},{"parameters":{"workflowId":{"__rl":true,"value":"mbX1lCt14Yi75gTE","mode":"list","cachedResultUrl":"/workflow/mbX1lCt14Yi75gTE","cachedResultName":"Continue_Thread"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-12176,8032],"id":"c2a931b5-275e-4fbc-bd3c-4ad40bfcca18","name":"ContinueThread"},{"parameters":{"workflowId":{"__rl":true,"value":"DX0m48INGS7vEwbu","mode":"list","cachedResultUrl":"/workflow/DX0m48INGS7vEwbu","cachedResultName":"Multi_Capture"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-12176,8512],"id":"multi-extract-node","name":"MultiCapture"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"0ceb9e91-e374-4346-8706-97df7d95cfe6","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"--","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-12400,7936],"id":"aebd154b-14e4-4927-b668-9adf8d7107f4","name":"TagIs"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-activity","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"!!","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"!!"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-note","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"..","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":".."},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-todo","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"$$","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"$$"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-chat","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"++","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"++"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"intent-command","leftValue":"={{ $json.ctx.event.tag }}","rightValue":"::","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"::"}]},"options":{"fallbackOutput":"extra"}},"id":"52b76dff-86bf-4376-896a-ffd61ade887b","name":"RouteByTag","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-12176,8224]}],"connections":{"ReceiveEvent":{"main":[[{"node":"ReactWithðŸ”µ","type":"main","index":0},{"node":"InThread?","type":"main","index":0},{"node":"ResetNextPulse","type":"main","index":0}]]},"HasTag?":{"main":[[{"node":"RouteByTag","type":"main","index":0}],[{"node":"MultiCapture","type":"main","index":0}]]},"InThread?":{"main":[[{"node":"TagIs","type":"main","index":0}],[{"node":"HasTag?","type":"main","index":0}]]},"PrepareProjection":{"main":[[{"node":"CaptureProjection","type":"main","index":0}]]},"TagIs":{"main":[[{"node":"CaptureThread","type":"main","index":0}],[{"node":"ContinueThread","type":"main","index":0}]]},"RouteByTag":{"main":[[{"node":"PrepareProjection","type":"main","index":0}],[{"node":"PrepareProjection","type":"main","index":0}],[{"node":"PrepareProjection","type":"main","index":0}],[{"node":"StartThread","type":"main","index":0}],[{"node":"ExecuteCommand","type":"main","index":0}],[{"node":"MultiCapture","type":"main","index":0}]]}},"authors":"Chris Irineo","name":null,"description":null},"tags":[]},{"updatedAt":"2025-12-26T06:27:52.636Z","createdAt":"2025-12-23T09:30:25.218Z","id":"yj2EUpsI7s3mLlRH","name":"Capture_Thread","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-2096,640],"id":"eab3a9d4-6d3a-4560-8e60-612e6f5c9df3","name":"ExecuteWorkflowTrigger"},{"parameters":{"jsCode":"// Build query to get thread history\nconst ctx = $json.ctx;\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries: [{\n        key: 'thread_history',\n        sql: 'SELECT timestamp, role, text FROM thread_history WHERE thread_id = $1 ORDER BY timestamp ASC;',\n        params: [ctx.event.thread_id]\n      }]\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1872,544],"id":"build-thread-history-query","name":"BuildThreadHistoryQuery"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-1648,544],"id":"execute-thread-history","name":"GetThreadHistory"},{"parameters":{"jsCode":"// Merge DB results into ctx pattern\nconst ctx = $json.ctx;\n\n// Get thread messages from db results\nconst messages = ctx.db.thread_history.rows || [];\n\n// Format thread history for LLM (reversed for chronological order)\nconst threadHistory = messages.toReversed().map(msg => {\n  return `${msg.role.toUpperCase()}: ${msg.text}`;\n}).join('\\n');\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db: {\n        ...ctx.db,\n        thread_id: ctx.event.thread_id,\n        thread_history: threadHistory,\n        message_count: messages.length\n      }\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1424,544],"id":"eb096fdc-babc-49e4-9213-36f22ae98b6e","name":"PrepareContext"},{"parameters":{"promptType":"define","text":"=You are analyzing a conversation thread to extract key insights and actionable items.\n\n## Thread History\n{{ $json.ctx.db.thread_history }}\n\n## Task\nExtract and classify the most important items from the thread into **exactly one** category each:\n\n**reflection** - Internal knowledge about the user (personal insights, patterns, preferences, decisions, or commitments)  \n**fact** - External knowledge about the world, people, events, or things (objective information not tied to the user's internal state)  \n**todo** - Concrete, actionable tasks or next steps (specific and doable)\n\n## Few-Shot Examples\n\n**Example Thread 1:**\n\"I realized I get my best work done in the mornings right after coffee. My mom's birthday is coming up on June 12th, I need to get her a gift. John told me he really likes dark roast with no sugar. I've decided to stop scheduling meetings before noon. Also, I should probably block out 2-hour chunks for deep work. Sarah mentioned she's allergic to peanuts.\"\n\n**Good Extraction:**\nreflection|I get my best work done in the mornings right after coffee\nreflection|I've decided to stop scheduling meetings before noon\ntodo|Get mom a gift for her June 12th birthday\ntodo|Block out 2-hour chunks for deep work\nfact|Mom's birthday is June 12th\nfact|John really likes dark roast with no sugar\nfact|Sarah is allergic to peanuts\n\n**Example Thread 2:**\n\"Maybe I should try walking more, it might help with focus. Dad prefers calls in the evening. I'm going to switch to async updates for the team. Don't forget to send the report by Friday. The office WiFi password is 'guest123'. I tend to lose steam after lunch if I eat carbs.\"\n\n**Good Extraction:**\nreflection|I'm going to switch to async updates for the team\nreflection|I tend to lose steam after lunch if I eat carbs\ntodo|Send the report by Friday\nfact|Dad prefers calls in the evening\nfact|The office WiFi password is 'guest123'\nreflection|Walking more might help with focus (tentative insight)\n\n**Bad Examples (Do NOT do these):**\n- âŒ `reflection|Send the report by Friday` (action = todo, not reflection)\n- âŒ `fact|I realized I work best in the morning` (user insight = reflection, not fact)\n- âŒ `todo|Dad prefers calls in the evening` (info about another person = fact, not todo)\n- âŒ Including both a reflection AND a todo for the same item\n- âŒ Creating tasks that are vague or not actionable (e.g., \"think about...\")\n\n## Output Format\nReturn one line per item:\n`type|text`\n\nReturn ONLY the categorized items, no explanations.","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-976,544],"id":"f10c50b2-ae2f-463b-8378-6b36c12d2b21","name":"ExtractItemsLlm"},{"parameters":{"jsCode":"// Parse LLM output in pipe format: \"type|text\"\nlet llmOutput = $json.text.trim();\nconst ctx = $('PrepareContext').first().json.ctx;\n\ntry {\n  const lines = llmOutput.split('\\n').filter(line => line.includes('|'));\n  const extractions = [];\n  let displayOrder = 1;\n  \n  lines.forEach(line => {\n    const parts = line.split('|');\n    if (parts.length < 2) return;\n    \n    const itemType = parts[0].trim();\n    const text = parts.slice(1).join('|').trim(); // Handle pipes in text\n    \n    // Validate item_type\n    if (!['reflection', 'fact', 'todo'].includes(itemType)) {\n      console.error(`Invalid item_type: ${itemType}`);\n      return;\n    }\n    \n    extractions.push({\n      thread_id: ctx.db.thread_id,\n      item_type: itemType,\n      text: text,\n      display_order: displayOrder++\n    });\n  });\n  \n  // Return ctx with llm namespace added\n  return {\n    json: {\n      ctx: {\n        ...ctx,\n        llm: {\n          raw_output: llmOutput,\n          extractions: extractions,\n          has_extractions: extractions.length > 0\n        }\n      }\n    }\n  }];\n} catch (error) {\n  // On error, return empty extractions\n  return {\n    json: {\n      ctx: {\n        ...ctx,\n        llm: {\n          raw_output: llmOutput,\n          extractions: [],\n          has_extractions: false,\n          parse_error: error.message\n        }\n      }\n    }\n  }];\n}","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-624,544],"id":"93bcf029-9040-466f-957c-2a9c8d87a451","name":"ParseExtractions"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"e3ae6cd9-7b12-406f-b233-afdc77ea403e","leftValue":"={{ $json.ctx.llm.extractions }}","rightValue":"","operator":{"type":"array","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2,"position":[-176,544],"id":"3a3d0695-4532-4b46-bbd1-6fc531e8ad12","name":"HasExtractions?"},{"parameters":{"jsCode":"// Build query for trace and void old extractions\nconst ctx = $('SetInferenceStart').first().json.ctx;\nconst inferenceStart = ctx.timing?.inference_start || Date.now();\nconst durationMs = Date.now() - inferenceStart;\nconst llmOutput = $('ExtractItemsLlm').first().json.text;\nconst parsedCtx = $json.ctx;\n\n// Build filled prompt\nconst promptText = `You are analyzing a conversation thread to extract key insights and actionable items.\n\n## Thread History\n${ctx.db.thread_history}\n\n## Task\nExtract and classify the most important items from the thread...`;\n\n// Format trace_chain for PostgreSQL uuid[] type\nconst traceChain = ctx.event.trace_chain || [];\nconst traceChainPg = '{' + traceChain.join(',') + '}';\n\nreturn {\n  json: {\n    ctx: {\n      ...parsedCtx,\n      db_queries: [\n        {\n          key: 'trace',\n          sql: `WITH new_trace AS (\n  INSERT INTO traces (event_id, step_name, data, trace_chain)\n  VALUES (\n    $1::uuid,\n    'thread_extraction',\n    jsonb_build_object(\n      'input', jsonb_build_object(\n        'thread_history', $2,\n        'conversation_id', $3::text\n      ),\n      'prompt', $4,\n      'completion', $5,\n      'result', jsonb_build_object(\n        'extraction_count', $6::integer,\n        'has_extractions', true\n      ),\n      'model', 'nvidia/nemotron-nano-9b-v2:free',\n      'duration_ms', $7::integer\n    ),\n    $8::uuid[]\n  )\n  RETURNING id\n)\nSELECT \n  new_trace.id as trace_id,\n  $8::uuid[] || new_trace.id as updated_trace_chain\nFROM new_trace;`,\n          params: [\n            ctx.event.event_id,\n            ctx.db.thread_history,\n            ctx.db.thread_id,\n            promptText,\n            llmOutput,\n            parsedCtx.llm.extractions?.length || 0,\n            durationMs,\n            traceChainPg\n          ]\n        },\n        {\n          key: 'void_old',\n          sql: `UPDATE projections SET status = 'voided', voided_at = NOW(), voided_reason = 'replaced_by_new_extraction' WHERE projection_type = 'thread_extraction' AND data->>'thread_id' = $1 AND status = 'pending';`,\n          params: [ctx.db.thread_id]\n        }\n      ]\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,544],"id":"prepare-trace-data-save-chat","name":"PrepareTraceData"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[48,448],"id":"write-thread-extraction-trace","name":"WriteThreadExtractionTrace"},{"parameters":{"jsCode":"// Build SQL query to insert extractions as projections\nconst ctx = $json.ctx;\nconst extractions = ctx.llm.extractions;\nconst extractionTraceId = ctx.db.trace.row.trace_id;\n\nif (!extractions || extractions.length === 0) {\n  return [];\n}\n\n// Format trace_chain for PostgreSQL uuid[] type\nconst traceChain = ctx.event.trace_chain || [];\nconst updatedTraceChain = [...traceChain, extractionTraceId];\nconst traceChainPg = '{' + updatedTraceChain.join(',') + '}';\n\n// 7 parameters per row: event_id, trace_id, trace_chain, projection_type, data (jsonb), status, timezone\nconst values = extractions.map((ext, idx) => {\n  const offset = idx * 7;\n  return `($${offset + 1}::uuid, $${offset + 2}::uuid, $${offset + 3}::uuid[], $${offset + 4}, $${offset + 5}::jsonb, $${offset + 6}, $${offset + 7})`;\n}).join(', ');\n\nconst insertSql = `\nINSERT INTO projections (\n  event_id,\n  trace_id,\n  trace_chain,\n  projection_type,\n  data,\n  status,\n  timezone\n)\nVALUES ${values}\nRETURNING *;\n`;\n\n// The params array matches the $1, $2, $3, $4, $5, $6, $7... sequence (7 per extraction)\nconst params = [];\nextractions.forEach(ext => {\n  params.push(ctx.event.event_id);  // event_id\n  params.push(extractionTraceId);    // trace_id\n  params.push(traceChainPg);         // trace_chain\n  params.push('thread_extraction');  // projection_type\n  params.push(JSON.stringify({       // data as JSONB\n    thread_id: ext.thread_id,\n    item_type: ext.item_type,\n    text: ext.text,\n    display_order: ext.display_order\n  }));\n  params.push('pending');            // status\n  params.push(ctx.event.timezone || null);  // timezone\n});\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db: {\n        ...ctx.db,\n        trace_id: extractionTraceId\n      },\n      db_queries: [{\n        key: 'extractions',\n        sql: insertSql,\n        params: params\n      }]\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[272,448],"id":"6f856663-e8d6-4f8c-9c9c-41a6eab0d27b","name":"BuildInsertQuery"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[496,448],"id":"48cebe42-d9c8-4de1-a10a-d1e09935ad25","name":"SaveExtractionsToDb"},{"parameters":{"jsCode":"// Build Discord summary message\nconst ctx = $json.ctx;\nconst extractions = ctx.llm.extractions;\n\nconst numberEmojis = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ðŸ”Ÿ'];\n\nconst notes = extractions.filter(e => \n  e.item_type === 'reflection' || e.item_type === 'fact'\n);\nconst todos = extractions.filter(e => e.item_type === 'todo');\n\nlet content = 'ðŸ“Š **Thread Summary**\\n\\n';\n\nif (notes.length > 0) {\n  content += 'ðŸ’¡ **Insights & Facts**\\n';\n  notes.forEach(item => {\n    const emoji = numberEmojis[item.display_order - 1] || 'â€¢';\n    content += `${emoji} ${item.text}\\n`;\n  });\n  content += '\\n';\n}\n\nif (todos.length > 0) {\n  content += 'ðŸ“‹ **Action Items**\\n';\n  todos.forEach(item => {\n    const emoji = numberEmojis[item.display_order - 1] || 'â€¢';\n    content += `${emoji} ${item.text}\\n`;\n  });\n  content += '\\n';\n}\n\ncontent += '---\\n';\ncontent += 'Tap number emoji to save\\n';\ncontent += 'âŒ Dismiss â€¢ ðŸ—‘ï¸ Delete thread';\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      response: {\n        summary_content: content,\n        emoji_count: extractions.length\n      }\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[720,448],"id":"8cfff2da-39dd-4c84-abab-f5a723655499","name":"BuildSummaryMessage"},{"parameters":{"jsCode":"// Get summary message ID from Discord response\nconst summaryMessage = $json;\nconst summaryMessageId = summaryMessage.id;\n\nconst ctx = $('BuildSummaryMessage').first().json.ctx;\nconst extractions = ctx.llm.extractions;\n\nconst numberEmojis = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ðŸ”Ÿ'];\n\n// Build emoji reaction URLs\nconst reactionUrls = [];\n\n// Add number emojis for each extraction\nextractions.forEach(ext => {\n  const emoji = numberEmojis[ext.display_order - 1];\n  if (emoji) {\n    // URL encode the emoji\n    const encoded = encodeURIComponent(emoji);\n    reactionUrls.push({\n      url: `https://discord.com/api/v10/channels/${ctx.event.channel_id}/messages/${summaryMessageId}/reactions/${encoded}/@me`,\n      emoji: emoji\n    });\n  }\n});\n\n// Add control emojis\nreactionUrls.push(\n  {\n    url: `https://discord.com/api/v10/channels/${ctx.event.channel_id}/messages/${summaryMessageId}/reactions/%E2%9D%8C/@me`,\n    emoji: 'âŒ'\n  },\n  {\n    url: `https://discord.com/api/v10/channels/${ctx.event.channel_id}/messages/${summaryMessageId}/reactions/%F0%9F%97%91%EF%B8%8F/@me`,\n    emoji: 'ðŸ—‘ï¸'\n  }\n);\n\nreturn reactionUrls.map(r => ({\n  json: {\n    ctx: ctx,\n    summary_message_id: summaryMessageId,\n    reaction_url: r.url,\n    emoji: r.emoji\n  }\n}));","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1168,448],"id":"d7ff0aa4-b3d1-42f5-a10d-37aad4ec2f56","name":"PrepareEmojiReactions"},{"parameters":{"method":"PUT","url":"={{ $json.reaction_url }}","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1616,448],"id":"124efe0a-5911-42ba-bd1f-4478da67fdff","name":"AddEmojiReactions","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Build query to update summary message ID on projections\nconst ctx = $('PrepareEmojiReactions').first().json.ctx;\nconst summaryMessageId = $('PrepareEmojiReactions').first().json.summary_message_id;\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries: [{\n        key: 'update_summary',\n        sql: `UPDATE projections SET data = data || jsonb_build_object('summary_message_id', $1) WHERE projection_type = 'thread_extraction' AND data->>'thread_id' = $2 AND status = 'pending';`,\n        params: [summaryMessageId, ctx.db.thread_id]\n      }]\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1616,256],"id":"build-update-summary-query","name":"BuildUpdateSummaryQuery"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1840,256],"id":"cc84e221-84fb-49bb-b72b-e0589a531893","name":"UpdateSummaryMessageId"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $('Build Summary Message').first().json.ctx.event.channel_id }}/messages/{{ $('Build Summary Message').first().json.ctx.event.message_id }}/reactions/ðŸ’­/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1872,928],"id":"3a889796-3250-4fef-af78-7b779e545595","name":"RemoveðŸ’­Reaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.thread_id }}","mode":"id"},"content":"âŒ No items extracted from this thread. You must have had quite an interesting conversation.","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[48,640],"id":"db0c5fb7-27f3-460d-b931-d0610a934431","name":"PostNoExtractionsMessage","webhookId":"no-extractions-webhook","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/ðŸ”µ/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1872,736],"id":"remove-blue-reaction-save-chat-no-extract","name":"RemoveðŸ”µReaction(noExtract)","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"model":"nvidia/nemotron-nano-9b-v2:free","options":{"timeout":10000}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-840,768],"id":"1021e602-7ef3-4c22-bc16-74a99d6e8c30","name":"NemotronNano9b","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"model":"xiaomi/mimo-v2-flash:free","options":{"timeout":10000}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-968,768],"id":"aff3ef03-d804-40a6-98d9-b498298f4b69","name":"MimoV2Flash","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"resource":"message","operation":"react","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"messageId":"={{ $json.ctx.event.message_id }}","emoji":"ðŸ’­"},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[-1872,352],"id":"ee2bc94f-b03b-4d5c-a04e-3e80e8e3acf1","name":"ReactWithðŸ’­","webhookId":"2af02bbb-3f0b-490a-b0c9-234c0e9013ae","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"content":"={{ $json.ctx.response.summary_content }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[944,448],"id":"59068362-0e97-4e90-90c3-98373b60e25f","name":"SendAMessage","webhookId":"b9ec412c-e54b-4542-a3ad-41a388512da2","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1392,448],"id":"ebfeb17a-a211-4a67-adf9-ec9c26e418cc","name":"LoopOverItems"},{"parameters":{"amount":1},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1840,520],"id":"9a504ad1-2ee7-435b-9c81-ff106ef75821","name":"Wait1S","webhookId":"1803ab0e-bd94-42cf-8843-a2178b590fa6"},{"parameters":{"assignments":{"assignments":[{"id":"start-time","name":"ctx.timing.inference_start","value":"={{ Date.now() }}","type":"number"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1200,544],"id":"set-inference-start-save-chat","name":"SetInferenceStart"}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"BuildThreadHistoryQuery","type":"main","index":0},{"node":"ReactWithðŸ’­","type":"main","index":0},{"node":"RemoveðŸ’­Reaction","type":"main","index":0},{"node":"RemoveðŸ”µReaction(noExtract)","type":"main","index":0}]]},"BuildThreadHistoryQuery":{"main":[[{"node":"GetThreadHistory","type":"main","index":0}]]},"GetThreadHistory":{"main":[[{"node":"PrepareContext","type":"main","index":0}]]},"PrepareContext":{"main":[[{"node":"SetInferenceStart","type":"main","index":0}]]},"ExtractItemsLlm":{"main":[[{"node":"ParseExtractions","type":"main","index":0}]]},"ParseExtractions":{"main":[[{"node":"PrepareTraceData","type":"main","index":0}]]},"PrepareTraceData":{"main":[[{"node":"HasExtractions?","type":"main","index":0}]]},"HasExtractions?":{"main":[[{"node":"WriteThreadExtractionTrace","type":"main","index":0}],[{"node":"PostNoExtractionsMessage","type":"main","index":0}]]},"WriteThreadExtractionTrace":{"main":[[{"node":"BuildInsertQuery","type":"main","index":0}]]},"BuildInsertQuery":{"main":[[{"node":"SaveExtractionsToDb","type":"main","index":0}]]},"SaveExtractionsToDb":{"main":[[{"node":"BuildSummaryMessage","type":"main","index":0}]]},"BuildSummaryMessage":{"main":[[{"node":"SendAMessage","type":"main","index":0}]]},"PrepareEmojiReactions":{"main":[[{"node":"LoopOverItems","type":"main","index":0}]]},"AddEmojiReactions":{"main":[[{"node":"Wait1S","type":"main","index":0}]]},"UpdateSummaryMessageId":{"main":[[]]},"RemoveðŸ’­Reaction":{"main":[[]]},"NemotronNano9b":{"ai_languageModel":[[{"node":"ExtractItemsLlm","type":"ai_languageModel","index":1}]]},"MimoV2Flash":{"ai_languageModel":[[{"node":"ExtractItemsLlm","type":"ai_languageModel","index":0}]]},"ReactWithðŸ’­":{"main":[[]]},"SendAMessage":{"main":[[{"node":"PrepareEmojiReactions","type":"main","index":0}]]},"LoopOverItems":{"main":[[{"node":"BuildUpdateSummaryQuery","type":"main","index":0}],[{"node":"AddEmojiReactions","type":"main","index":0}]]},"BuildUpdateSummaryQuery":{"main":[[{"node":"UpdateSummaryMessageId","type":"main","index":0}]]},"Wait1S":{"main":[[{"node":"LoopOverItems","type":"main","index":0}]]},"SetInferenceStart":{"main":[[{"node":"ExtractItemsLlm","type":"main","index":0}]]},"PostNoExtractionsMessage":{"main":[[]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":null,"versionId":"5f4fcee5-265e-4e5c-bd9a-32eef241b681","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:25.218Z","createdAt":"2025-12-23T09:30:25.218Z","role":"workflow:owner","workflowId":"yj2EUpsI7s3mLlRH","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:54.632Z","createdAt":"2025-12-23T09:30:30.422Z","id":"DvrsLMcIGlPThoeS","name":"Proactive_Agent_Cron","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":5}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0],"id":"schedule-trigger","name":"Every5Minutes"},{"parameters":{"operation":"executeQuery","query":"-- Get next_pulse timestamp and current time\nSELECT \n  COALESCE(\n    (SELECT value::timestamptz FROM config WHERE key = 'next_pulse'),\n    NOW() - INTERVAL '1 minute'\n  ) as next_pulse,\n  NOW() as current_time,\n  COALESCE(\n    (SELECT value::timestamptz FROM config WHERE key = 'next_pulse'),\n    NOW() - INTERVAL '1 minute'\n  ) <= NOW() as should_run;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[224,0],"id":"check-next-pulse","name":"CheckNextPulse","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-should-run","leftValue":"={{ $json.should_run }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[448,0],"id":"if-should-run","name":"ShouldRun?"},{"parameters":{"operation":"executeQuery","query":"-- Set next_pulse to 2 hours from now (default interval)\n-- The Proactive_Agent can override this via its response\nUPDATE config \nSET value = (NOW() + INTERVAL '2 hours')::text, updated_at = NOW()\nWHERE key = 'next_pulse';\n\n-- If no row exists, insert one\nINSERT INTO config (key, value)\nVALUES ('next_pulse', (NOW() + INTERVAL '2 hours')::text)\nON CONFLICT (key) DO NOTHING;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[672,-80],"id":"set-next-pulse","name":"SetNextPulse(default)","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Prepare data for Proactive_Agent\nreturn [{\n  json: {\n    trigger_reason: 'cron'\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[896,-80],"id":"prepare-trigger-data","name":"PrepareTriggerData"},{"parameters":{"workflowId":{"__rl":true,"value":"lnxlZ8AFe7LhMMEA","mode":"list","cachedResultName":"Proactive_Agent","cachedResultUrl":"/workflow/lnxlZ8AFe7LhMMEA"},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1120,-80],"id":"execute-proactive-agent","name":"ExecuteProactiveAgent"}],"connections":{"Every5Minutes":{"main":[[{"node":"CheckNextPulse","type":"main","index":0}]]},"CheckNextPulse":{"main":[[{"node":"ShouldRun?","type":"main","index":0}]]},"ShouldRun?":{"main":[[{"node":"SetNextPulse(default)","type":"main","index":0}],[]]},"SetNextPulse(default)":{"main":[[{"node":"PrepareTriggerData","type":"main","index":0}]]},"PrepareTriggerData":{"main":[[{"node":"ExecuteProactiveAgent","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":{"node:Every5Minutes":{"recurrenceRules":[]}},"meta":null,"pinData":null,"versionId":"988a5933-cbc5-49a8-a7f7-af2ce1d5f8e1","activeVersionId":"988a5933-cbc5-49a8-a7f7-af2ce1d5f8e1","triggerCount":1,"shared":[{"updatedAt":"2025-12-23T09:30:30.422Z","createdAt":"2025-12-23T09:30:30.422Z","role":"workflow:owner","workflowId":"DvrsLMcIGlPThoeS","projectId":"erM3nntdLL53noWi"}],"activeVersion":{"updatedAt":"2025-12-26T06:27:54.633Z","createdAt":"2025-12-26T06:27:54.633Z","versionId":"988a5933-cbc5-49a8-a7f7-af2ce1d5f8e1","workflowId":"DvrsLMcIGlPThoeS","nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":5}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0],"id":"schedule-trigger","name":"Every5Minutes"},{"parameters":{"operation":"executeQuery","query":"-- Get next_pulse timestamp and current time\nSELECT \n  COALESCE(\n    (SELECT value::timestamptz FROM config WHERE key = 'next_pulse'),\n    NOW() - INTERVAL '1 minute'\n  ) as next_pulse,\n  NOW() as current_time,\n  COALESCE(\n    (SELECT value::timestamptz FROM config WHERE key = 'next_pulse'),\n    NOW() - INTERVAL '1 minute'\n  ) <= NOW() as should_run;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[224,0],"id":"check-next-pulse","name":"CheckNextPulse","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-should-run","leftValue":"={{ $json.should_run }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[448,0],"id":"if-should-run","name":"ShouldRun?"},{"parameters":{"operation":"executeQuery","query":"-- Set next_pulse to 2 hours from now (default interval)\n-- The Proactive_Agent can override this via its response\nUPDATE config \nSET value = (NOW() + INTERVAL '2 hours')::text, updated_at = NOW()\nWHERE key = 'next_pulse';\n\n-- If no row exists, insert one\nINSERT INTO config (key, value)\nVALUES ('next_pulse', (NOW() + INTERVAL '2 hours')::text)\nON CONFLICT (key) DO NOTHING;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[672,-80],"id":"set-next-pulse","name":"SetNextPulse(default)","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Prepare data for Proactive_Agent\nreturn [{\n  json: {\n    trigger_reason: 'cron'\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[896,-80],"id":"prepare-trigger-data","name":"PrepareTriggerData"},{"parameters":{"workflowId":{"__rl":true,"value":"lnxlZ8AFe7LhMMEA","mode":"list","cachedResultName":"Proactive_Agent","cachedResultUrl":"/workflow/lnxlZ8AFe7LhMMEA"},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1120,-80],"id":"execute-proactive-agent","name":"ExecuteProactiveAgent"}],"connections":{"Every5Minutes":{"main":[[{"node":"CheckNextPulse","type":"main","index":0}]]},"CheckNextPulse":{"main":[[{"node":"ShouldRun?","type":"main","index":0}]]},"ShouldRun?":{"main":[[{"node":"SetNextPulse(default)","type":"main","index":0}],[]]},"SetNextPulse(default)":{"main":[[{"node":"PrepareTriggerData","type":"main","index":0}]]},"PrepareTriggerData":{"main":[[{"node":"ExecuteProactiveAgent","type":"main","index":0}]]}},"authors":"Chris Irineo","name":null,"description":null},"tags":[]},{"updatedAt":"2025-12-26T06:27:54.779Z","createdAt":"2025-12-23T09:30:30.697Z","id":"5HGb0EQGtOj85F3c","name":"Query_DB","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[0,0],"id":"trigger-execute-query","name":"ExecuteWorkflowTrigger"},{"parameters":{"jsCode":"// Validate input and initialize loop state\nconst ctx = $json.ctx;\n\nif (!ctx?.db_queries || !Array.isArray(ctx.db_queries) || ctx.db_queries.length === 0) {\n  throw new Error('Query_DB requires ctx.db_queries array with at least one query');\n}\n\n// Validate each query has required fields\nfor (const q of ctx.db_queries) {\n  if (!q.key || !q.sql) {\n    throw new Error('Each query in ctx.db_queries must have key and sql fields');\n  }\n}\n\n// Initialize loop state\nreturn {\n  json: {\n    original_ctx: ctx,\n    queries: ctx.db_queries,\n    current_index: 0,\n    results: {}  // Will accumulate {key: {results, count}}\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[220,0],"id":"initialize-loop","name":"InitializeLoop"},{"parameters":{"jsCode":"// Prepare current query for execution\nconst state = $json;\nconst query = state.queries[state.current_index];\n\nreturn {\n  json: {\n    ...state,\n    current_query: query,\n    sql: query.sql,\n    params: query.params || []\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[440,0],"id":"prepare-query","name":"PrepareQuery"},{"parameters":{"operation":"executeQuery","query":"={{ $json.sql }}","options":{"values":"={{ $json.params }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[660,0],"id":"execute-postgres-query","name":"ExecuteQuery","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}},"alwaysOutputData":true},{"parameters":{"mode":"append","numberInputs":2,"options":{}},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[880,0],"id":"merge-results","name":"MergeResults"},{"parameters":{"mode":"runOnceForAllItems","jsCode":"// Collect query results and check if more queries remain\nconst items = $input.all();\n\n// Find state from merge (has original_ctx)\nlet state = null;\nconst queryResults = [];\n\nfor (const item of items) {\n  if (item.json.original_ctx) {\n    state = item.json;\n  } else {\n    // This is a Postgres result row\n    queryResults.push(item.json);\n  }\n}\n\nif (!state) {\n  throw new Error('Query_DB: Lost loop state');\n}\n\n// Store results for current query\nconst currentKey = state.current_query.key;\nstate.results[currentKey] = {\n  results: queryResults,\n  count: queryResults.length\n};\n\n// Move to next query\nstate.current_index++;\n\n// Check if more queries remain\nconst hasMore = state.current_index < state.queries.length;\n\nreturn [{\n  json: {\n    ...state,\n    has_more: hasMore\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1100,0],"id":"collect-results","name":"CollectResults"},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"conditions":[{"id":"has-more","leftValue":"={{ $json.has_more }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1320,0],"id":"check-more-queries","name":"MoreQueries?"},{"parameters":{"jsCode":"// Restore ctx with all query results in ctx.db namespace\nconst state = $json;\n\n// Remove db_queries since it was consumed\nconst { db_queries, ...restCtx } = state.original_ctx;\n\nreturn {\n  json: {\n    ctx: {\n      ...restCtx,\n      db: {\n        ...(restCtx.db || {}),\n        ...state.results\n      }\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1540,100],"id":"finalize-context","name":"FinalizeContext"}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"InitializeLoop","type":"main","index":0}]]},"InitializeLoop":{"main":[[{"node":"PrepareQuery","type":"main","index":0}]]},"PrepareQuery":{"main":[[{"node":"ExecuteQuery","type":"main","index":0},{"node":"MergeResults","type":"main","index":1}]]},"ExecuteQuery":{"main":[[{"node":"MergeResults","type":"main","index":0}]]},"MergeResults":{"main":[[{"node":"CollectResults","type":"main","index":0}]]},"CollectResults":{"main":[[{"node":"MoreQueries?","type":"main","index":0}]]},"MoreQueries?":{"main":[[{"node":"PrepareQuery","type":"main","index":0}],[{"node":"FinalizeContext","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"22603b50-691e-4816-b04e-8b326698050e","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:30.697Z","createdAt":"2025-12-23T09:30:30.697Z","role":"workflow:owner","workflowId":"5HGb0EQGtOj85F3c","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:53.171Z","createdAt":"2025-12-23T09:30:27.014Z","id":"CgUAxK0i4YhrZ2Wp","name":"Execute_Queries","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[0,0],"id":"trigger-execute-queries","name":"ExecuteWorkflowTrigger"},{"parameters":{"jsCode":"// Validate input and initialize loop state\n// Execute_Queries: Unified sub-workflow for all database operations\n// - Executes queries sequentially (supports chaining via $results)\n// - Preserves ctx throughout\n// - Stores results in ctx.db[key] = { row, rows, count }\n\nconst item = $input.first();\nconst ctx = item.json.ctx;\n\n// If no queries or empty array, return state that will skip the loop gracefully\nif (!ctx?.db_queries || !Array.isArray(ctx.db_queries) || ctx.db_queries.length === 0) {\n  return [{\n    json: {\n      original_ctx: ctx || {},\n      queries: [],\n      current_index: 0,\n      results: {},\n      has_more: false\n    }\n  }];\n}\n\n// Validate each query has required fields\nfor (let i = 0; i < ctx.db_queries.length; i++) {\n  const q = ctx.db_queries[i];\n  if (!q.key) {\n    throw new Error(`Execute_Queries: Query at index ${i} missing 'key' field`);\n  }\n  if (!q.sql) {\n    throw new Error(`Execute_Queries: Query '${q.key}' at index ${i} missing 'sql' field`);\n  }\n}\n\n// Initialize loop state\nreturn [{\n  json: {\n    original_ctx: ctx,\n    queries: ctx.db_queries,\n    current_index: 0,\n    results: {},\n    has_more: true\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0],"id":"initialize-loop","name":"InitializeLoop"},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"loose"},"conditions":[{"id":"has-more","leftValue":"={{ $json.has_more }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[336,-96],"id":"has-queries","name":"HasQueries?"},{"parameters":{"jsCode":"// Prepare current query for execution\n// Supports $results.key.field references in params for chaining\n// Also formats arrays as PostgreSQL array literals when needed\nconst item = $input.first();\nconst state = item.json;\nconst query = state.queries[state.current_index];\n\n// Helper to format JS arrays as PostgreSQL array literals\n// Handles special characters: commas, braces, quotes, backslashes\nfunction formatPgArray(arr) {\n  if (!Array.isArray(arr)) return arr;\n  \n  const formatted = arr.map(item => {\n    if (Array.isArray(item)) {\n      return formatPgArray(item); // Recursive for nested arrays\n    }\n    if (typeof item === 'string') {\n      // Escape and quote strings with special characters\n      if (item.includes(',') || item.includes('{') || item.includes('}') || \n          item.includes('\"') || item.includes('\\\\') || item.includes(' ')) {\n        return '\"' + item.replace(/\\\\/g, '\\\\\\\\').replace(/\"/g, '\\\\\"') + '\"';\n      }\n    }\n    return item;\n  });\n  \n  return '{' + formatted.join(',') + '}';\n}\n\n// Process params to resolve $results references\nlet params = query.params || [];\n\nif (params.length > 0) {\n  params = params.map(param => {\n    if (typeof param === 'string' && param.startsWith('$results.')) {\n      // Parse reference like \"$results.trace.row.id\"\n      const path = param.substring('$results.'.length).split('.');\n      let value = state.results;\n      for (const key of path) {\n        if (value && typeof value === 'object') {\n          value = value[key];\n        } else {\n          value = undefined;\n          break;\n        }\n      }\n      if (value === undefined) {\n        throw new Error(`Execute_Queries: Could not resolve reference ${param}`);\n      }\n      // Auto-format arrays for PostgreSQL\n      return formatPgArray(value);\n    }\n    // Also format arrays that aren't references\n    if (Array.isArray(param)) {\n      return formatPgArray(param);\n    }\n    return param;\n  });\n}\n\nreturn [{\n  json: {\n    ...state,\n    current_query: query,\n    sql: query.sql,\n    params: params\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0],"id":"prepare-query","name":"PrepareQuery"},{"parameters":{"operation":"executeQuery","query":"{{ $json.sql }}","options":{"queryReplacement":"={{ $json.params }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[672,0],"id":"execute-postgres-query","name":"ExecuteQuery","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"append","numberInputs":2},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[880,0],"id":"merge-results","name":"MergeResults"},{"parameters":{"jsCode":"// Collect query results and check if more queries remain\nconst items = $input.all();\n\n// Find state from merge (has original_ctx)\nlet state = null;\nconst queryResults = [];\n\nfor (const item of items) {\n  if (item.json.original_ctx) {\n    state = item.json;\n  } else {\n    // This is a Postgres result row\n    queryResults.push(item.json);\n  }\n}\n\nif (!state) {\n  throw new Error('Execute_Queries: Lost loop state');\n}\n\n// Store results for current query\nconst currentKey = state.current_query.key;\nstate.results[currentKey] = {\n  row: queryResults[0] || null,  // First row (common for RETURNING or single-row SELECT)\n  rows: queryResults,             // All rows\n  count: queryResults.length      // Row count\n};\n\n// Move to next query\nstate.current_index++;\n\n// Check if more queries remain\nconst hasMore = state.current_index < state.queries.length;\n\nreturn [{\n  json: {\n    ...state,\n    has_more: hasMore\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0],"id":"collect-results","name":"CollectResults"},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"loose"},"conditions":[{"id":"has-more","leftValue":"={{ $json.has_more }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1328,0],"id":"check-more-queries","name":"MoreQueries?"},{"parameters":{"jsCode":"// Restore ctx with all query results in ctx.db namespace\nconst item = $input.first();\nconst state = item.json;\n\n// Remove db_queries since it was consumed\nconst { db_queries, ...restCtx } = state.original_ctx;\n\nreturn [{\n  json: {\n    ctx: {\n      ...restCtx,\n      db: {\n        ...(restCtx.db || {}),\n        ...state.results\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,112],"id":"finalize-context","name":"FinalizeContext"}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"InitializeLoop","type":"main","index":0}]]},"InitializeLoop":{"main":[[{"node":"HasQueries?","type":"main","index":0}]]},"HasQueries?":{"main":[[{"node":"PrepareQuery","type":"main","index":0}],[{"node":"FinalizeContext","type":"main","index":0}]]},"PrepareQuery":{"main":[[{"node":"ExecuteQuery","type":"main","index":0},{"node":"MergeResults","type":"main","index":1}]]},"ExecuteQuery":{"main":[[{"node":"MergeResults","type":"main","index":0}]]},"MergeResults":{"main":[[{"node":"CollectResults","type":"main","index":0}]]},"CollectResults":{"main":[[{"node":"MoreQueries?","type":"main","index":0}]]},"MoreQueries?":{"main":[[{"node":"PrepareQuery","type":"main","index":0}],[{"node":"FinalizeContext","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{"ExecuteWorkflowTrigger":[{"json":{"ctx":{"webhook_data":{"event_type":"message","guild_id":"754207117157859388","channel_id":"1450406231146496132","parent_id":null,"message_id":"1453310583922491412","thread_id":null,"author":{"login":"chr15","id":"183458868817297409","display_name":"chr15"},"content":"!!testing","timestamp":"2025-12-24T08:57:24.412000+00:00","tag":"!!","clean_text":"testing"},"db_queries":[{"key":"message_event","sql":"INSERT INTO events (\n  event_type,\n  payload,\n  idempotency_key\n) VALUES (\n  'discord_message',\n  jsonb_build_object(\n    'content', $7,\n    'clean_text', $8,\n    'tag', $9,\n    'discord_guild_id', $1,\n    'discord_channel_id', $2,\n    'discord_message_id', $3,\n    'message_url', $4,\n    'author_login', $5,\n    'thread_id', $6,\n    'timestamp', $10::timestamptz\n  ),\n  $3\n)\nON CONFLICT (event_type, idempotency_key) DO UPDATE\nSET payload = EXCLUDED.payload\nRETURNING *;","params":["754207117157859388","1450406231146496132","1453310583922491412","https://discord.com/channels/754207117157859388/1450406231146496132/1453310583922491412","chr15",null,"!!testing","testing","!!","2025-12-24T08:57:24.412000+00:00"]}]}},"pairedItem":{"item":0}}]},"versionId":"ea693155-9f44-4ffc-9a1c-1d81f6fa9bd9","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:27.014Z","createdAt":"2025-12-23T09:30:27.014Z","role":"workflow:owner","workflowId":"CgUAxK0i4YhrZ2Wp","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:53.486Z","createdAt":"2025-12-23T09:30:28.256Z","id":"ujGErhNkQv4hkJxB","name":"Generate_Nudge","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[0,0],"id":"workflow-trigger","name":"WhenCalledByAnotherWorkflow"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Extract trigger_reason from caller, default to 'cron'\nconst input = $json;\nconst triggerReason = input.trigger_reason || 'cron';\nconst now = new Date();\nconst idempotencyKey = `scheduled:nudge:${now.toISOString().slice(0, 16)}:${triggerReason}`;\n\nreturn {\n  json: {\n    idempotency_key: idempotencyKey,\n    trigger_reason: triggerReason,\n    timestamp: now.toISOString()\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0],"id":"prepare-event","name":"PrepareEvent"},{"parameters":{"operation":"executeQuery","query":"-- Insert system event for nudge\nINSERT INTO events (idempotency_key, event_type, payload, timezone)\nVALUES (\n  $1,\n  'system',\n  jsonb_build_object(\n    'trigger_type', 'nudge',\n    'trigger_reason', $2\n  ),\n  COALESCE((SELECT value FROM config WHERE key = 'timezone'), 'UTC')\n)\nON CONFLICT (event_type, idempotency_key) DO UPDATE SET id = events.id, timezone = EXCLUDED.timezone\nRETURNING id, timezone;","options":{"queryReplacement":"={{ $json.idempotency_key }},{{ $json.trigger_reason }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"id":"insert-event","name":"InsertEvent","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Initialize ctx with event_id and prepare batch database queries\nconst eventResult = $json;\nconst prepareData = $(\"PrepareEvent\").first().json;\n\nconst db_queries = [\n  {\n    key: 'north_star',\n    sql: `SELECT value FROM config WHERE key = 'north_star'`\n  },\n  {\n    key: 'activities',\n    sql: `SELECT \n            (p.data->>'timestamp')::timestamptz as timestamp,\n            p.data->>'category' as category,\n            p.data->>'description' as description\n          FROM projections p\n          WHERE p.projection_type = 'activity'\n            AND p.status IN ('auto_confirmed', 'confirmed')\n            AND (p.data->>'timestamp')::timestamptz >= NOW() - INTERVAL '4 hours'\n          ORDER BY (p.data->>'timestamp')::timestamptz DESC`\n  },\n  {\n    key: 'last_note',\n    sql: `SELECT \n            (p.data->>'timestamp')::timestamptz as timestamp,\n            p.data->>'category' as category,\n            p.data->>'text' as text\n          FROM projections p\n          WHERE p.projection_type = 'note'\n            AND p.status IN ('auto_confirmed', 'confirmed')\n          ORDER BY (p.data->>'timestamp')::timestamptz DESC\n          LIMIT 1`\n  },\n  {\n    key: 'timezone',\n    sql: `SELECT value as timezone FROM config WHERE key = 'timezone'`\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      event: {\n        event_id: eventResult.id,\n        trigger_type: \"nudge\",\n        trigger_reason: prepareData.trigger_reason,\n        timestamp: prepareData.timestamp,\n        timezone: eventResult.timezone || 'UTC',\n        trace_chain: [eventResult.id]\n      },\n      db_queries\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0],"id":"init-ctx","name":"InitializeCtx"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[896,0],"id":"execute-query-db","name":"ExecuteQueries(read)"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Build LLM prompt context from Execute_Queries results\nconst ctx = $json.ctx;\nconst db = ctx.db || {};\n\n// Extract timezone from db results, fallback to event timezone or UTC\nconst timezone = db.timezone?.row?.timezone || ctx.event.timezone || 'UTC';\n\n// Helper to format time in user's timezone\nconst formatTime = (isoString) => {\n  try {\n    return new Date(isoString).toLocaleTimeString('en-US', { \n      timeZone: timezone, \n      hour: 'numeric', \n      minute: '2-digit' \n    });\n  } catch (e) {\n    // Fallback if timezone is invalid\n    return new Date(isoString).toLocaleTimeString('en-US', { \n      hour: 'numeric', \n      minute: '2-digit' \n    });\n  }\n};\n\n// Extract north star (fallback to introspection prompt)\nconst northStar = db.north_star?.row?.value || 'To determine my north star from deep introspection';\n\n// Extract activities from db results (use .rows for arrays)\nconst activityItems = db.activities?.rows || [];\n\n// Extract last note from db results (use .row for LIMIT 1)\nconst lastNote = db.last_note?.row;\n\n// Format activities list with user's timezone\nlet activitiesList = '';\nif (activityItems.length === 0) {\n  activitiesList = '(No logged activity)';\n} else {\n  activityItems.forEach(item => {\n    const time = formatTime(item.timestamp);\n    activitiesList += `- ${time}: [${item.category}] ${item.description}\\n`;\n  });\n}\n\n// Format last note\nlet lastNoteText = '(No recent notes)';\nif (lastNote) {\n  const time = formatTime(lastNote.timestamp);\n  lastNoteText = `${time}: [${lastNote.category}] ${lastNote.text}`;\n}\n\n// Get current time in user's timezone\nlet currentTime;\ntry {\n  currentTime = new Date().toLocaleString('en-US', {\n    timeZone: timezone,\n    weekday: 'long',\n    hour: 'numeric',\n    minute: '2-digit'\n  });\n} catch (e) {\n  currentTime = new Date().toLocaleString('en-US', {\n    weekday: 'long',\n    hour: 'numeric',\n    minute: '2-digit'\n  });\n}\n\nreturn {\n  json: {\n    ctx,\n    north_star: northStar,\n    recent_activities: activitiesList.trim(),\n    last_note: lastNoteText,\n    timestamp: currentTime,\n    activity_count: activityItems.length,\n    inference_start: Date.now()\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,0],"id":"prepare-prompt-data","name":"PreparePromptData"},{"parameters":{"promptType":"define","text":"=You are a life coach checking in on your client. Current time: {{ $json.timestamp }}\n\n## Context (for your understanding only - do not mention directly)\nClient's guiding principle: {{ $json.north_star }}\n\n## Recent Activity (last 4 hours)\n{{ $json.recent_activities }}\n\n## Last Note\n{{ $json.last_note }}\n\n## Your Task\nDecide whether to nudge the client right now. You have three options:\n\n**SKIP** - Say nothing. Use when:\n- They're clearly in deep work (recent focused activity)\n- It's late night/early morning (let them sleep)\n- Recent activity shows good momentum\n- A nudge would interrupt more than help\n\n**ENCOURAGE** - Affirm what they're doing. Use when:\n- They're making good progress\n- They're on a good streak\n- They might need a small boost to keep going\n\n**REDIRECT** - Gently suggest a shift. Use when:\n- They've been on one thing too long (3+ hours)\n- Time of day suggests a transition (morning focus -> lunch break)\n- They seem stuck or scattered\n- A break or change would serve them\n\n## Output Format\nFirst line: SKIP, ENCOURAGE, or REDIRECT\nIf not SKIP, second line onward: Your message (1-2 sentences, warm but concise)\n\n## Important\n- Never mention \"north star\", \"guiding principle\", or similar phrases\n- Focus on the concrete activity and practical observations\n- Be natural and conversational\n\n## Examples\n\nSKIP\n\n---\n\nENCOURAGE\nNice flow on the router work - keep going.\n\n---\n\nREDIRECT\nYou've been heads-down for 3 hours. Quick stretch or refill water before the next push?\n\n---\n\nSKIP\n\n---\n\nENCOURAGE\nMorning deep work paying off. This is the kind of focus that compounds.\n\n---\n\nREDIRECT\nIt's 11pm and you're still coding. Tomorrow-you will thank tonight-you for sleeping.","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[1344,0],"id":"generate-nudge-llm","name":"GenerateNudgeWithLlm"},{"parameters":{"model":"nvidia/nemotron-nano-9b-v2:free","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1352,224],"id":"nemotron-nano-9b","name":"NemotronNano9b","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"model":"xiaomi/mimo-v2-flash:free","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1480,224],"id":"mimo-v2-flash","name":"MimoV2Flash","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse LLM response and prepare trace write query\nconst prepareData = $('PreparePromptData').first().json;\nconst llmText = $json.text?.trim() || '';\nconst durationMs = Date.now() - prepareData.inference_start;\nconst ctx = prepareData.ctx;\n\n// Parse the decision from first line\nconst lines = llmText.split('\\n').filter(l => l.trim());\nconst decision = (lines[0] || '').trim().toUpperCase();\n\n// Extract message (everything after first line)\nconst message = lines.slice(1).join('\\n').trim();\n\n// Determine if we should skip\nconst shouldSkip = decision === 'SKIP' || !['ENCOURAGE', 'REDIRECT'].includes(decision);\n\n// Prepare db_queries for trace INSERT\nconst db_queries = [\n  {\n    key: 'trace',\n    sql: `INSERT INTO traces (event_id, step_name, data, trace_chain)\n          VALUES ($1::uuid, 'nudge',\n            jsonb_build_object(\n              'input', $2::jsonb,\n              'prompt', 'nudge-prompt',\n              'completion', $3,\n              'result', jsonb_build_object(\n                'decision', $4,\n                'message', $5,\n                'should_skip', $6::boolean\n              ),\n              'duration_ms', $7::integer\n            ), $8::uuid[])\n          RETURNING id, trace_chain || id AS updated_trace_chain`,\n    params: [\n      ctx.event.event_id,\n      {\n        north_star: prepareData.north_star,\n        recent_activities: prepareData.recent_activities,\n        last_note: prepareData.last_note,\n        timestamp: prepareData.timestamp,\n        activity_count: prepareData.activity_count\n      },\n      llmText,\n      decision,\n      message,\n      shouldSkip,\n      durationMs,\n      ctx.event.trace_chain || []\n    ]\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries\n    },\n    decision,\n    message,\n    should_skip: shouldSkip\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1696,0],"id":"prepare-trace-query","name":"PrepareTraceQuery"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-skip","leftValue":"={{ $json.should_skip }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[2368,0],"id":"if-should-skip","name":"IfShouldSkip"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $env.DISCORD_GUILD_ID }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $env.DISCORD_CHANNEL_ARCANE_SHELL }}","mode":"id"},"content":"={{ $json.message }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[3264,0],"id":"send-nudge","name":"SendNudge","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"webhookId":"cc71b2ab-c6db-4b95-b420-d02fec8c7aeb","credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1920,0],"id":"execute-trace-query","name":"ExecuteQueries(trace)"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check if should skip and prepare for projection branch\nconst ctx = $json.ctx;\nconst traceRow = ctx.db?.trace?.row;\nconst prepData = $('PrepareTraceQuery').first().json;\n\nreturn {\n  json: {\n    ctx,\n    trace_id: traceRow?.id,\n    updated_trace_chain: traceRow?.updated_trace_chain || [],\n    decision: prepData.decision,\n    message: prepData.message,\n    should_skip: prepData.should_skip\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2144,0],"id":"check-skip","name":"CheckSkip"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Prepare projection + final update queries\nconst checkData = $json;\nconst ctx = checkData.ctx;\n\nconst projectionData = {\n  timestamp: new Date().toISOString(),\n  decision: checkData.decision,\n  text: checkData.message\n};\n\nconst db_queries = [\n  {\n    key: 'projection',\n    sql: `INSERT INTO projections (trace_id, event_id, trace_chain, projection_type, data, status, timezone)\n          VALUES ($1::uuid, $2::uuid, $3::uuid[], 'nudge', $4::jsonb, 'auto_confirmed', $5)\n          RETURNING id`,\n    params: [\n      checkData.trace_id,\n      ctx.event.event_id,\n      checkData.updated_trace_chain,\n      projectionData,\n      ctx.event.timezone\n    ]\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries\n    },\n    message: checkData.message,\n    decision: checkData.decision\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2592,0],"id":"prepare-projection-query","name":"PrepareProjectionQuery"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2816,0],"id":"execute-projection-query","name":"ExecuteQueries(projection)"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Prepare for Discord post\nconst ctx = $json.ctx;\nconst projectionId = ctx.db?.projection?.row?.id;\nconst prepData = $('PrepareProjectionQuery').first().json;\n\nreturn {\n  json: {\n    ctx,\n    projection_id: projectionId,\n    message: prepData.message\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3040,0],"id":"prepare-for-discord","name":"PrepareForDiscord"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Prepare final update query with Discord message ID\nconst discordResult = $json;\nconst prepData = $('PrepareForDiscord').first().json;\nconst ctx = prepData.ctx;\n\nconst db_queries = [\n  {\n    key: 'update_projection',\n    sql: `UPDATE projections \n          SET data = data || jsonb_build_object(\n            'discord_message_id', $1,\n            'discord_channel_id', $2,\n            'discord_guild_id', $3\n          )\n          WHERE id = $4::uuid\n          RETURNING id`,\n    params: [\n      discordResult.id,\n      $env.DISCORD_CHANNEL_ARCANE_SHELL || '',\n      $env.DISCORD_GUILD_ID || '',\n      prepData.projection_id\n    ]\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3488,0],"id":"prepare-final-update","name":"PrepareFinalUpdate"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3712,0],"id":"execute-final-update","name":"ExecuteQueries(final)"}],"connections":{"WhenCalledByAnotherWorkflow":{"main":[[{"node":"PrepareEvent","type":"main","index":0}]]},"PrepareEvent":{"main":[[{"node":"InsertEvent","type":"main","index":0}]]},"InsertEvent":{"main":[[{"node":"InitializeCtx","type":"main","index":0}]]},"InitializeCtx":{"main":[[{"node":"ExecuteQueries(read)","type":"main","index":0}]]},"ExecuteQueries(read)":{"main":[[{"node":"PreparePromptData","type":"main","index":0}]]},"PreparePromptData":{"main":[[{"node":"GenerateNudgeWithLlm","type":"main","index":0}]]},"GenerateNudgeWithLlm":{"main":[[{"node":"PrepareTraceQuery","type":"main","index":0}]]},"PrepareTraceQuery":{"main":[[{"node":"ExecuteQueries(trace)","type":"main","index":0}]]},"ExecuteQueries(trace)":{"main":[[{"node":"CheckSkip","type":"main","index":0}]]},"CheckSkip":{"main":[[{"node":"IfShouldSkip","type":"main","index":0}]]},"IfShouldSkip":{"main":[[],[{"node":"PrepareProjectionQuery","type":"main","index":0}]]},"PrepareProjectionQuery":{"main":[[{"node":"ExecuteQueries(projection)","type":"main","index":0}]]},"ExecuteQueries(projection)":{"main":[[{"node":"PrepareForDiscord","type":"main","index":0}]]},"PrepareForDiscord":{"main":[[{"node":"SendNudge","type":"main","index":0}]]},"SendNudge":{"main":[[{"node":"PrepareFinalUpdate","type":"main","index":0}]]},"PrepareFinalUpdate":{"main":[[{"node":"ExecuteQueries(final)","type":"main","index":0}]]},"NemotronNano9b":{"ai_languageModel":[[{"node":"GenerateNudgeWithLlm","type":"ai_languageModel","index":0}]]},"MimoV2Flash":{"ai_languageModel":[[{"node":"GenerateNudgeWithLlm","type":"ai_languageModel","index":1}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"WhenCalledByAnotherWorkflow":[{"json":{"timestamp":"2025-12-24T02:30:08.006-08:00","Readable date":"December 24th 2025, 2:30:08 am","Readable time":"2:30:08 am","Day of week":"Wednesday","Year":"2025","Month":"December","Day of month":"24","Hour":"02","Minute":"30","Second":"08","Timezone":"America/Vancouver (UTC-08:00)","trigger_reason":"cron"},"pairedItem":{"item":0}}]},"versionId":"53bcd15d-4c74-41f4-8acb-7c568fde90ef","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:28.256Z","createdAt":"2025-12-23T09:30:28.256Z","role":"workflow:owner","workflowId":"ujGErhNkQv4hkJxB","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:53.795Z","createdAt":"2025-12-23T09:30:28.917Z","id":"NOJ7FqVhVLqw0n8D","name":"Handle_Error","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.errorTrigger","typeVersion":1,"position":[-400,224],"id":"error-trigger-handle-error","name":"ErrorTrigger"},{"parameters":{"jsCode":"// Filter: Skip if this is a parent workflow wrapping a child error\n// Parent errors have errorResponse (the wrapped child error)\nconst errorData = $input.first().json;\nconst error = errorData.execution?.error || {};\n\n// If this error is just wrapping a sub-workflow error, skip it\nif (error.errorResponse) {\n  return []; // Return empty to stop flow\n}\n\n// Continue processing - this is the root cause error\nreturn { json: errorData };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-176,224],"id":"filter-duplicates-handle-error","name":"FilterDuplicateErrors"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  id,\n  payload->>'discord_guild_id' as guild_id,\n  payload->>'discord_channel_id' as channel_id,\n  payload->>'discord_message_id' as message_id,\n  payload->>'clean_text' as clean_text\nFROM events \nWHERE received_at > NOW() - interval '30 seconds'\n  AND event_type = 'discord_message'\nORDER BY received_at DESC \nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[48,224],"id":"get-recent-event-handle-error","name":"GetRecentEvent","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Extract error details and merge with event context\nconst errorData = $('FilterDuplicateErrors').first().json;\nconst eventData = $json || {};\n\nconst execution = errorData.execution || {};\nconst workflow = errorData.workflow || {};\nconst error = execution.error || {};\n\n// Get the node that failed\nconst failedNode = error.node?.name || execution.lastNodeExecuted || 'Unknown';\nconst errorMessage = error.message || 'No error message';\n\n// Get workflow info\nconst workflowName = workflow.name || 'Unknown';\nconst executionId = execution.id || 'N/A';\n\n// Get Discord context from recent event\nconst guildId = eventData.guild_id || null;\nconst channelId = eventData.channel_id || null;\nconst messageId = eventData.message_id || null;\nconst cleanText = eventData.clean_text || '';\n\n// Try to extract from error URL if available\nlet extractedChannelId = channelId;\nlet extractedMessageId = messageId;\n\nif (!channelId && error.context?.request?.uri) {\n  const uri = error.context.request.uri;\n  // Parse: https://discord.com/api/v10/channels/{channel_id}/messages/{message_id}/...\n  const match = uri.match(/channels\\/([0-9]+)\\/messages\\/([0-9]+)/);\n  if (match) {\n    extractedChannelId = match[1];\n    extractedMessageId = match[2];\n  }\n}\n\n// Build condensed Discord message\nlet content = `âŒ **${workflowName}** â†’ ${failedNode}\\n`;\ncontent += `${errorMessage}`;\n\nif (cleanText) {\n  const preview = cleanText.length > 50 ? cleanText.substring(0, 50) + '...' : cleanText;\n  content += `\\nðŸ“ \"${preview}\"`;\n}\n\ncontent += `\\n\\`exec:${executionId}\\``;\n\n// Truncate if needed (Discord 2000 char limit)\nif (content.length > 1900) {\n  content = content.substring(0, 1900) + '...';\n}\n\nreturn {\n  json: {\n    content: content,\n    guild_id: guildId || process.env.DISCORD_GUILD_ID,\n    channel_id: extractedChannelId,\n    message_id: extractedMessageId,\n    can_react: !!(extractedChannelId && extractedMessageId)\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[272,224],"id":"format-error-handle-error","name":"FormatErrorMessage"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"can-react-condition","leftValue":"={{ $json.can_react }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2,"position":[496,224],"id":"check-can-react-handle-error","name":"CanReact?"},{"parameters":{"method":"PUT","url":"=https://discord.com/api/v10/channels/{{ $json.channel_id }}/messages/{{ $json.message_id }}/reactions/%E2%9D%8C/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,144],"id":"add-error-reaction-handle-error","name":"AddâŒReaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"continueOnFail":true},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.channel_id }}/messages/{{ $json.message_id }}/reactions/%F0%9F%94%B5/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[944,144],"id":"remove-blue-reaction-handle-error","name":"RemoveðŸ”µReaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"continueOnFail":true},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $env.DISCORD_GUILD_ID }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $env.DISCORD_CHANNEL_KAIRON_LOGS }}","mode":"id"},"content":"={{ $('FormatErrorMessage').item.json.content }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[1392,224],"id":"send-error-discord-handle-error","name":"SendErrorToLogs","webhookId":"error-notification-webhook","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"mode":"append","numberInputs":2},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[1168,224],"id":"merge-paths-handle-error","name":"MergePaths"}],"connections":{"ErrorTrigger":{"main":[[{"node":"FilterDuplicateErrors","type":"main","index":0}]]},"FilterDuplicateErrors":{"main":[[{"node":"GetRecentEvent","type":"main","index":0}]]},"GetRecentEvent":{"main":[[{"node":"FormatErrorMessage","type":"main","index":0}]]},"FormatErrorMessage":{"main":[[{"node":"CanReact?","type":"main","index":0}]]},"CanReact?":{"main":[[{"node":"AddâŒReaction","type":"main","index":0}],[{"node":"MergePaths","type":"main","index":1}]]},"AddâŒReaction":{"main":[[{"node":"RemoveðŸ”µReaction","type":"main","index":0}]]},"RemoveðŸ”µReaction":{"main":[[{"node":"MergePaths","type":"main","index":0}]]},"MergePaths":{"main":[[{"node":"SendErrorToLogs","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{"ErrorTrigger":[{"json":{"execution":{"id":"1425","url":"n8n.chrisirineo.com/workflow/G0XzfbZiT3P98B4S/executions/1425","error":{"level":"error","tags":{},"description":"An array of objects was returned. If you need to output multiple items, please use the 'Run Once for All Items' mode instead.","itemIndex":0,"context":{"itemIndex":0},"node":{"parameters":{"mode":"runOnceForEachItem","language":"javaScript","jsCode":"// Add projection type to ctx for Capture_Projection workflow\n// Derive type from tag (!! = activity, .. = note, $$ = todo)\nconst tag = $json.ctx.event.tag;\nconst tagToType = { '!!': 'activity', '..': 'note', '$$': 'todo' };\nconst projectionType = tagToType[tag] || 'activity';\n\nreturn [\n  {\n    json: {\n      ctx: {\n        ...$json.ctx,\n        projection: {\n          type: projectionType\n        }\n      }\n    }\n  }\n];","notice":""},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-11952,8080],"id":"a1b2c3d4-prep-proj-type-node","name":"PrepareProjection"},"message":"Code doesn't return a single object [item 0]","stack":"Error: Code doesn't return a single object [item 0]\n    at validateRunCodeEachItem (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-nodes-base@file+packages+nodes-base_@aws-sdk+credential-providers@3.808.0_asn1.js@5_8da18263ca0574b0db58d4fefd8173ce/node_modules/n8n-nodes-base/nodes/Code/result-validation.ts:107:9)\n    at JavaScriptSandbox.validateRunCodeEachItem (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-nodes-base@file+packages+nodes-base_@aws-sdk+credential-providers@3.808.0_asn1.js@5_8da18263ca0574b0db58d4fefd8173ce/node_modules/n8n-nodes-base/nodes/Code/Sandbox.ts:63:33)\n    at JavaScriptSandbox.runCodeEachItem (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-nodes-base@file+packages+nodes-base_@aws-sdk+credential-providers@3.808.0_asn1.js@5_8da18263ca0574b0db58d4fefd8173ce/node_modules/n8n-nodes-base/nodes/Code/JavaScriptSandbox.ts:121:15)\n    at ExecuteContext.execute (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-nodes-base@file+packages+nodes-base_@aws-sdk+credential-providers@3.808.0_asn1.js@5_8da18263ca0574b0db58d4fefd8173ce/node_modules/n8n-nodes-base/nodes/Code/Code.node.ts:235:14)\n    at WorkflowExecute.executeNode (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/workflow-execute.ts:1045:8)\n    at WorkflowExecute.runNode (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/workflow-execute.ts:1226:11)\n    at /usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/workflow-execute.ts:1662:27\n    at /usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/workflow-execute.ts:2274:11"},"lastNodeExecuted":"PrepareProjection","mode":"integrated","executionContext":{"version":1,"establishedAt":1766567825615,"source":"integrated","parentExecutionId":"1423"}},"workflow":{"id":"G0XzfbZiT3P98B4S","name":"Route_Message"}},"pairedItem":{"item":0}}]},"versionId":"b660314b-a6ab-4cb8-b4de-e8d6d414dd17","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:28.917Z","createdAt":"2025-12-23T09:30:28.917Z","role":"workflow:owner","workflowId":"NOJ7FqVhVLqw0n8D","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:56.199Z","createdAt":"2025-12-23T09:30:32.073Z","id":"wVpslhMBnrsgDaOR","name":"Show_Projection_Details","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-400,240],"id":"trigger-projection-details","name":"ReceiveEvent"},{"parameters":{"operation":"executeQuery","query":"WITH target_event AS (\n  -- Find the event for this Discord message\n  SELECT id, payload, received_at, payload->>'message_url' as message_url\n  FROM events\n  WHERE payload->>'discord_message_id' = $1\n    AND event_type = 'discord_message'\n  ORDER BY received_at DESC\n  LIMIT 1\n),\nbot_reply_projections AS (\n  -- Find projections for a bot reply message (no LIMIT - one message can have multiple)\n  SELECT p.id, p.trace_id, p.event_id, p.projection_type, p.data, p.status, p.quality_score, p.created_at, p.timezone\n  FROM projections p\n  WHERE (p.metadata->>'message_id' = $1 \n     OR p.data->>'discord_message_id' = $1\n     OR p.data->>'summary_message_id' = $1)\n    AND p.status IN ('auto_confirmed', 'confirmed', 'pending')\n),\nrelevant_projections AS (\n  -- Get projections either from the event or the bot reply\n  SELECT p.id as projection_id, p.trace_id, p.event_id, p.projection_type, p.data, p.status, p.quality_score, p.created_at, p.timezone\n  FROM projections p\n  WHERE p.event_id = (SELECT id FROM target_event)\n    AND p.status IN ('auto_confirmed', 'confirmed', 'pending')\n  UNION\n  SELECT id, trace_id, event_id, projection_type, data, status, quality_score, created_at, timezone\n  FROM bot_reply_projections\n),\nrelevant_traces AS (\n  -- Get ONLY the traces linked to these projections (not all traces for the event)\n  SELECT DISTINCT ON (t.id)\n    t.id as trace_id,\n    t.event_id,\n    COALESCE(t.data->>'prompt', t.data->>'input') as prompt_text,\n    t.data->>'completion' as output_text,\n    t.data->>'model' as model,\n    (t.data->>'duration_ms')::numeric as duration_ms,\n    t.created_at as trace_created_at\n  FROM traces t\n  WHERE t.id IN (SELECT trace_id FROM relevant_projections WHERE trace_id IS NOT NULL)\n  ORDER BY t.id, t.created_at DESC\n)\nSELECT \n  COALESCE((SELECT id FROM target_event), (SELECT event_id FROM bot_reply_projections LIMIT 1)) as event_id,\n  (SELECT payload->>'original_text' FROM target_event) as original_text,\n  (SELECT payload->>'tag' FROM target_event) as tag,\n  COALESCE((SELECT received_at FROM target_event), (SELECT created_at FROM bot_reply_projections LIMIT 1)) as event_time,\n  CASE WHEN EXISTS (SELECT 1 FROM target_event) THEN 'user_message' ELSE 'bot_reply' END as source,\n  COALESCE(\n    (SELECT message_url FROM target_event),\n    (SELECT e.payload->>'message_url' FROM events e WHERE e.id = (SELECT event_id FROM bot_reply_projections LIMIT 1))\n  ) as message_url,\n  (SELECT json_agg(jsonb_build_object(\n    'trace_id', t.trace_id,\n    'model', t.model,\n    'duration_ms', t.duration_ms,\n    'prompt', t.prompt_text,\n    'output_preview', LEFT(t.output_text, 200)\n  )) FROM relevant_traces t) as traces,\n  (SELECT json_agg(jsonb_build_object(\n    'projection_id', p.projection_id,\n    'trace_id', p.trace_id,\n    'projection_type', p.projection_type,\n    'status', p.status,\n    'quality_score', p.quality_score,\n    'data', p.data\n  )) FROM relevant_projections p) as projections;","options":{"queryReplacement":"={{ $json.ctx.event.message_id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-176,240],"id":"lookup-projection-chain","name":"LookupProjectionChain","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Merge ctx from trigger with db results\nconst ctx = $('ReceiveEvent').first().json.ctx;\nconst db = $json || {};\n\nreturn {\n  json: {\n    ctx,\n    db\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[48,240],"id":"merge-ctx-db","name":"MergeCtx+Db"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Format projection chain details for Discord\n// â” (grey) = projections only\n// â“ (red) = prompt message + projections message (two separate messages)\n// verbose mode = no emoji, automatic trigger, simple view\nconst ctx = $json.ctx;\nconst result = $json.db;\nconst emoji = ctx.event?.emoji || 'â”'; // Default to grey for verbose mode\nconst isDetailedView = emoji === 'â“';\nconst isVerboseMode = ctx.verbose === true || ctx.verbose === 'true';\n\n// Standard emoji mapping\nconst typeEmojis = {\n  'activity': 'ðŸ”˜',\n  'note': 'ðŸ“',\n  'command': 'ðŸ’»',\n  'todo': 'ðŸ”²',\n  'nudge': 'ðŸ’¡',\n  'daily_summary': 'ðŸ“Š',\n  'thread_response': 'ðŸ—¨ï¸',\n  'thread_extraction': 'ðŸ”'\n};\n\nif (!result || !result.event_id) {\n  return {\n    json: {\n      ctx,\n      content: `${emoji} No projection data found for this message.`,\n      isLast: true\n    }\n  };\n}\n\nconst projections = result.projections || [];\nconst validProjections = projections.filter(p => p && p.projection_id);\n\nif (validProjections.length === 0) {\n  return { json: { ctx, content: `${emoji} No saved projections.`, isLast: true } };\n}\n\n// Build projections content (used by both views)\nlet projectionsContent = '';\nfor (const proj of validProjections) {\n  const projEmoji = typeEmojis[proj.projection_type] || 'ðŸ“¦';\n  let text = '';\n  \n  if (proj.projection_type === 'activity') {\n    text = proj.data?.description || '(no description)';\n  } else if (proj.projection_type === 'note') {\n    text = proj.data?.text || '(no text)';\n  } else if (proj.projection_type === 'todo') {\n    text = proj.data?.description || proj.data?.text || '(no description)';\n  } else if (proj.projection_type === 'nudge') {\n    text = proj.data?.text || '(no text)';\n  } else if (proj.projection_type === 'daily_summary') {\n    text = '(daily summary)';\n  } else if (proj.projection_type === 'thread_response') {\n    const respText = proj.data?.response_text || '';\n    text = respText.length > 60 ? respText.slice(0, 60) + '...' : respText;\n  } else if (proj.projection_type === 'thread_extraction') {\n    text = `[${proj.data?.item_type}] ${proj.data?.text || ''}`;\n  } else {\n    text = JSON.stringify(proj.data).slice(0, 60) + '...';\n  }\n  \n  projectionsContent += `${projEmoji} ${text}\\n`;\n}\nprojectionsContent = projectionsContent.trim();\n\n// === SIMPLE VIEW (â”) - projections only ===\nif (!isDetailedView) {\n  return { json: { ctx, content: projectionsContent, isLast: true } };\n}\n\n// === DETAILED VIEW (â“) - prompt + projections (two messages) ===\nconst traces = result.traces || [];\nconst messageUrl = result.message_url;\nconst validTraces = traces.filter(t => t && t.trace_id);\nconst outputs = [];\n\n// Message 1: Prompt(s)\nif (validTraces.length === 0) {\n  outputs.push({ json: { ctx, content: '(no prompt found)', isLast: false } });\n} else {\n  for (let i = 0; i < validTraces.length; i++) {\n    const trace = validTraces[i];\n    const isLastTrace = i === validTraces.length - 1;\n    \n    let content = '';\n    \n    // Show full prompt\n    if (trace.prompt) {\n      let promptText = trace.prompt;\n      \n      // Check if it's JSON (old format) or full text (new format)\n      try {\n        const parsed = JSON.parse(promptText);\n        if (parsed.text) {\n          promptText = parsed.text;\n        } else {\n          const lines = [];\n          if (parsed.timestamp) lines.push(`Time: ${parsed.timestamp}`);\n          if (parsed.north_star) lines.push(`North star: ${parsed.north_star}`);\n          if (parsed.recent_activities) lines.push(`Recent activities:\\n${parsed.recent_activities}`);\n          if (parsed.last_note) lines.push(`Last note: ${parsed.last_note}`);\n          promptText = lines.join('\\n') || JSON.stringify(parsed, null, 2);\n        }\n      } catch {\n        // Already a string (new format) - use as-is\n      }\n      \n      // Truncate if too long\n      if (promptText.length > 1800) {\n        promptText = promptText.slice(0, 1800) + '\\n... (truncated)';\n      }\n      \n      content += '```\\n' + promptText + '\\n```';\n    }\n    \n    // Duration and link after prompt\n    let footer = '';\n    if (trace.duration_ms) {\n      footer += `${trace.duration_ms}ms`;\n    }\n    if (messageUrl && i === 0) {\n      footer += footer ? ' ' : '';\n      footer += `[â†’](${messageUrl})`;\n    }\n    if (footer) {\n      content += '\\n' + footer;\n    }\n    \n    // This is NOT the last message - projections come after\n    outputs.push({ json: { ctx, content: content.trim(), isLast: false } });\n  }\n}\n\n// Message 2: Projections (last message)\noutputs.push({ json: { ctx, content: projectionsContent, isLast: true } });\n\nreturn outputs;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[272,240],"id":"format-details","name":"FormatDetails"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"content":"={{ $json.content }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[496,240],"id":"send-details","name":"SendDetails","webhookId":"projection-details-response","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Restore ctx after Discord node (which overwrites $json)\nconst formatOutput = $('FormatDetails').all();\nconst currentIndex = $itemIndex;\nconst item = formatOutput[currentIndex]?.json || {};\nconst ctx = item.ctx || {};\n\nreturn {\n  json: {\n    ctx: ctx,\n    isLast: item.isLast,\n    isVerboseMode: ctx.verbose === true || ctx.verbose === 'true' || !ctx.event?.emoji\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[720,240],"id":"restore-ctx","name":"RestoreCtx"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"is-last-message","leftValue":"={{ $json.isLast }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}},{"id":"not-verbose-mode","leftValue":"={{ $json.isVerboseMode }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[944,240],"id":"if-last-message","name":"IfLastMessage"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/{{ $json.ctx.event.emoji === \"â“\" ? \"%E2%9D%93\" : \"%E2%9D%94\" }}/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,240],"id":"remove-info-reaction","name":"RemoveInfoReaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"continueOnFail":true}],"connections":{"ReceiveEvent":{"main":[[{"node":"LookupProjectionChain","type":"main","index":0}]]},"LookupProjectionChain":{"main":[[{"node":"MergeCtx+Db","type":"main","index":0}]]},"MergeCtx+Db":{"main":[[{"node":"FormatDetails","type":"main","index":0}]]},"FormatDetails":{"main":[[{"node":"SendDetails","type":"main","index":0}]]},"SendDetails":{"main":[[{"node":"RestoreCtx","type":"main","index":0}]]},"RestoreCtx":{"main":[[{"node":"IfLastMessage","type":"main","index":0}]]},"IfLastMessage":{"main":[[{"node":"RemoveInfoReaction","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"ReceiveEvent":[{"json":{"ctx":{"event":{"event_id":"9e64ca8c-1410-41d8-b53d-348246bd9775","event_type":"discord_message","timestamp":"2025-12-24T09:35:49.123000+00:00","guild_id":"754207117157859388","channel_id":"1450406231146496132","message_id":"1453320250581061652","author_login":"chr15","thread_id":null,"message_url":"https://discord.com/channels/754207117157859388/1450406231146496132/1453320250581061652","raw_text":"retesting projections. I need to buy wrapping paper. today I was fixing broken prod. so many problems in server. this is hard","clean_text":"retesting projections. I need to buy wrapping paper. today I was fixing broken prod. so many problems in server. this is hard","tag":null,"trace_chain":["9e64ca8c-1410-41d8-b53d-348246bd9775"],"trace_chain_pg":"{9e64ca8c-1410-41d8-b53d-348246bd9775}"},"db":{"verbose_config":{"row":{"value":"true"},"rows":[{"value":"true"}],"count":1}},"verbose":true},"emojis":["ðŸ”˜","ðŸ“","ðŸ”²"],"duration_ms":18738,"projection_count":3},"pairedItem":{"item":0}}]},"versionId":"9bfdef14-381e-4495-8ea6-da11c0637113","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:32.073Z","createdAt":"2025-12-23T09:30:32.073Z","role":"workflow:owner","workflowId":"wVpslhMBnrsgDaOR","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:54.220Z","createdAt":"2025-12-23T09:30:29.836Z","id":"DX0m48INGS7vEwbu","name":"Multi_Capture","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-1600,944],"id":"trigger-multi-extract","name":"ExecuteWorkflowTrigger"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Prepare for multi-capture\nconst ctx = $json.ctx;\n\nreturn  {\n      ctx: ctx,\n      inference_start: Date.now()\n    }"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1376,848],"id":"prepare-extraction","name":"PrepareCapture"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/ðŸ”µ/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1376,1040],"id":"remove-blue-reaction","name":"RemoveðŸ”µReaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"promptType":"define","text":"=You are an extraction agent for a life-tracking system. Analyze the message and extract all relevant items.\n\n## Message to Analyze\n\n\"{{ $json.ctx.event.clean_text }}\"\n\n## Extraction Types\n\n### Activity (what the user is doing NOW)\nExtract if the message describes a CURRENT or RECENT action by the user.\n- **Categories:** work, leisure, study, health, sleep, relationships, admin\n- **Indicators:** \"I am\", \"I'm\", \"-ing verbs\", \"just did\", present/recent past tense\n\n### Note (observation, insight, or fact worth remembering)\nExtract if the message contains knowledge, observations, or reflections.\n- **Categories:** reflection (about self), fact (about world/others)\n- **Indicators:** observations about things/people, realizations, ideas, decisions\n\n### Todo (actionable task to complete)\nExtract if the message contains a clear task to do later.\n- **Priority:** high, medium, low\n- **Indicators:** \"need to\", \"should\", \"have to\", \"TODO\", future tasks\n\n## Key Rules\n\n1. A message can have 0, 1, 2, or 3 extractions\n2. Set confidence 0.0-1.0 based on how clearly the message indicates each type\n3. Only include extractions with confidence >= 0.5\n4. Prefer fewer high-confidence extractions over many low-confidence ones\n5. Activity describes what I'M doing; Note describes observations about anything else\n\n## Output Format\n\nOutput ONLY valid JSON, no explanation:\n\n{\"activity\": {\"category\": \"work\", \"description\": \"debugging auth\", \"confidence\": 0.92}, \"note\": {\"category\": \"reflection\", \"text\": \"noticed pattern in logs\", \"confidence\": 0.78}, \"todo\": null}","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-1152,848],"id":"multi-extractor","name":"MultiCapturer"},{"parameters":{"model":"xiaomi/mimo-v2-flash:free","options":{"timeout":15000}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-1152,1072],"id":"mimo-v2-flash","name":"MimoV2Flash","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"model":"nvidia/nemotron-nano-9b-v2:free","options":{"timeout":15000}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-1024,1072],"id":"nemotron-nano-9b","name":"NemotronNano9b","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"jsCode":"// Parse LLM response, filter by confidence, build trace query\nconst EMOJI = { activity: 'ðŸ”˜', note: 'ðŸ“', todo: 'âœ…' };\nconst CONFIDENCE_THRESHOLD = 0.5;\n\nconst llmText = $json.text?.trim() || '';\nconst prepareItem = $('PrepareCapture').first().json;\nconst ctx = prepareItem.ctx;\nconst durationMs = Date.now() - prepareItem.inference_start;\n\n// Full rendered prompt (template + input)\nconst fullPrompt = `You are an extraction agent for a life-tracking system. Analyze the message and extract all relevant items.\n\n## Message to Analyze\n\n\"${ctx.event.clean_text}\"\n\n## Extraction Types\n\n### Activity (what the user is doing NOW)\nExtract if the message describes a CURRENT or RECENT action by the user.\n- **Categories:** work, leisure, study, health, sleep, relationships, admin\n- **Indicators:** \"I am\", \"I'm\", \"-ing verbs\", \"just did\", present/recent past tense\n\n### Note (observation, insight, or fact worth remembering)\nExtract if the message contains knowledge, observations, or reflections.\n- **Categories:** reflection (about self), fact (about world/others)\n- **Indicators:** observations about things/people, realizations, ideas, decisions\n\n### Todo (actionable task to complete)\nExtract if the message contains a clear task to do later.\n- **Priority:** high, medium, low\n- **Indicators:** \"need to\", \"should\", \"have to\", \"TODO\", future tasks\n\n## Key Rules\n\n1. A message can have 0, 1, 2, or 3 extractions\n2. Set confidence 0.0-1.0 based on how clearly the message indicates each type\n3. Only include extractions with confidence >= 0.5\n4. Prefer fewer high-confidence extractions over many low-confidence ones\n5. Activity describes what I'M doing; Note describes observations about anything else\n\n## Output Format\n\nOutput ONLY valid JSON, no explanation:\n\n{\"activity\": {\"category\": \"work\", \"description\": \"debugging auth\", \"confidence\": 0.92}, \"note\": {\"category\": \"reflection\", \"text\": \"noticed pattern in logs\", \"confidence\": 0.78}, \"todo\": null}`;\n\n// Format trace_chain for PostgreSQL\nconst traceChain = ctx.event.trace_chain || [];\nconst traceChainPg = '{' + traceChain.join(',') + '}';\n\n// Parse JSON from LLM output\nlet parsed = { activity: null, note: null, todo: null };\nlet parseError = null;\n\ntry {\n  let jsonStr = llmText;\n  const codeBlock = llmText.match(/```(?:json)?\\s*([\\s\\S]*?)```/);\n  if (codeBlock) jsonStr = codeBlock[1].trim();\n  const objMatch = jsonStr.match(/\\{[\\s\\S]*\\}/);\n  if (objMatch) jsonStr = objMatch[0];\n  parsed = JSON.parse(jsonStr);\n} catch (e) {\n  parseError = e.message;\n}\n\n// Build captures array\nconst captures = [];\nconst emojis = [];\n\nif (parsed.activity?.confidence >= CONFIDENCE_THRESHOLD) {\n  captures.push({\n    type: 'activity',\n    emoji: EMOJI.activity,\n    data: {\n      timestamp: new Date().toISOString(),\n      category: parsed.activity.category || 'work',\n      description: parsed.activity.description || ctx.event.clean_text,\n      message_url: ctx.event.message_url,\n      confidence: parsed.activity.confidence\n    }\n  });\n  emojis.push(EMOJI.activity);\n}\n\nif (parsed.note?.confidence >= CONFIDENCE_THRESHOLD) {\n  captures.push({\n    type: 'note',\n    emoji: EMOJI.note,\n    data: {\n      timestamp: new Date().toISOString(),\n      category: parsed.note.category || 'reflection',\n      text: parsed.note.text || ctx.event.clean_text,\n      message_url: ctx.event.message_url,\n      confidence: parsed.note.confidence\n    }\n  });\n  emojis.push(EMOJI.note);\n}\n\nif (parsed.todo?.confidence >= CONFIDENCE_THRESHOLD) {\n  captures.push({\n    type: 'todo',\n    emoji: EMOJI.todo,\n    data: {\n      timestamp: new Date().toISOString(),\n      priority: parsed.todo.priority || 'medium',\n      text: parsed.todo.text || ctx.event.clean_text,\n      message_url: ctx.event.message_url,\n      confidence: parsed.todo.confidence\n    }\n  });\n  emojis.push(EMOJI.todo);\n}\n\n// Fallback: if nothing captured, create low-confidence note\nif (captures.length === 0) {\n  captures.push({\n    type: 'note',\n    emoji: EMOJI.note,\n    data: {\n      timestamp: new Date().toISOString(),\n      category: 'reflection',\n      text: ctx.event.clean_text,\n      message_url: ctx.event.message_url,\n      confidence: 0.3\n    }\n  });\n  emojis.push(EMOJI.note);\n}\n\n// Pre-stringify the result for postgres jsonb\nconst resultJson = JSON.stringify(captures.map(c => ({ type: c.type, confidence: c.data.confidence })));\n\n// Return with ctx.db_queries for Execute_Queries\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries: [{\n        key: 'trace',\n        sql: `INSERT INTO traces (event_id, step_name, data, trace_chain)\nVALUES (\n  $1::uuid,\n  'multi_capture',\n  jsonb_build_object(\n    'prompt', $2,\n    'input', jsonb_build_object('text', $3),\n    'completion', $4,\n    'result', $5::jsonb,\n    'model', 'xiaomi/mimo-v2-flash:free',\n    'duration_ms', $6::integer,\n    'capture_count', $7::integer\n  ),\n  $8::uuid[]\n)\nRETURNING id, trace_chain || id AS updated_trace_chain;`,\n        params: [\n          ctx.event.event_id,\n          fullPrompt,\n          ctx.event.clean_text,\n          llmText,\n          resultJson,\n          durationMs,\n          captures.length,\n          traceChainPg\n        ]\n      }]\n    },\n    captures,\n    emojis,\n    total_captures: captures.length,\n    raw_response: llmText,\n    parse_error: parseError,\n    duration_ms: durationMs\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-800,848],"id":"parse-and-split","name":"ParseResponse"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-576,848],"id":"store-llm-trace","name":"StoreLlmTrace"},{"parameters":{"jsCode":"// Split captures into individual items for projection storage\n// Input: Store LLM Trace result (ctx with db.trace)\n// Output: One item per capture, each with trace_id attached\n\nconst ctx = $json.ctx;\nconst parseResult = $('ParseResponse').first().json;\n\nconst llmTraceId = ctx.db?.trace?.row?.id;\nconst updatedTraceChain = ctx.db?.trace?.row?.updated_trace_chain || [];\nconst updatedTraceChainPg = '{' + updatedTraceChain.join(',') + '}';\n\n// Split captures array into individual items, each with its own db_queries\nreturn parseResult.captures.map(capture => ({\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries: [{\n        key: 'projection',\n        sql: `INSERT INTO projections (trace_id, event_id, trace_chain, projection_type, data, status, timezone)\nVALUES (\n  $1::uuid,\n  $2::uuid,\n  $3::uuid[],\n  $4,\n  $5::jsonb,\n  'auto_confirmed',\n  $6\n)\nRETURNING *;`,\n        params: [\n          llmTraceId,\n          ctx.event.event_id,\n          updatedTraceChainPg,\n          capture.type,\n          JSON.stringify(capture.data),\n          ctx.event.timezone\n        ]\n      }]\n    },\n    capture\n  }\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-352,848],"id":"prepare-projections","name":"SplitCaptures"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[128,848],"id":"store-projection","name":"StoreProjection"},{"parameters":{"jsCode":"// Collect results for logging with standard emojis\nconst parseResult = $('ParseResponse').first().json;\n\n// Standard emoji mapping\nconst typeEmojis = {\n  'activity': 'ðŸ”˜',\n  'note': 'ðŸ“',\n  'todo': 'ðŸ”²'\n};\n\n// Map capture types to standard emojis\nconst emojis = parseResult.captures.map(c => typeEmojis[c.type] || 'ðŸ“¦');\n\n// Build verbose config query\nreturn [{\n  json: {\n    ctx: {\n      ...parseResult.ctx,\n      db_queries: [{\n        key: 'verbose_config',\n        sql: `SELECT value FROM config WHERE key = 'verbose'`,\n        params: []\n      }]\n    },\n    emojis: emojis,\n    duration_ms: parseResult.duration_ms,\n    projection_count: parseResult.total_captures\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-576,1040],"id":"collect-results","name":"CollectResults"},{"parameters":{"method":"PUT","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/{{ $json.emoji }}/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-128,528],"id":"add-emoji-reactions","name":"AddEmojiReactions","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $env.DISCORD_CHANNEL_KAIRON_LOGS }}","mode":"id"},"content":"={{ $json.ctx.event.clean_text }} {{ $json.duration_ms }}ms âž¡ï¸ {{ $json.emojis.join(' ') }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[-352,1232],"id":"log-to-kairon-logs","name":"LogToKaironLogs","webhookId":"multi-capture-log","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"amount":1},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[96,560],"id":"wait-rate-limit","name":"Wait1s","webhookId":"471830ad-77d3-4266-9eca-bf75cfee85a2"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-352,560],"id":"2741faa1-e8ab-4588-b3b5-bc67839680a3","name":"LoopOverItems"},{"parameters":{"jsCode":"// Convert emojis array to individual items for batch processing\nconst parseResult = $('ParseResponse').first().json;\n\n// Standard emoji mapping\nconst typeEmojis = {\n  'activity': 'ðŸ”˜',\n  'note': 'ðŸ“',\n  'todo': 'ðŸ”²'\n};\n\n// Map capture types to standard emojis\nconst emojis = parseResult.captures.map(c => typeEmojis[c.type] || 'ðŸ“¦');\n\nreturn emojis.map(emoji => ({\n  json: {\n    ctx: parseResult.ctx,\n    emoji: emoji\n  }\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-576,560],"id":"prepare-emoji-items","name":"PrepareEmojiItems"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-352,1040],"id":"query-verbose-setting","name":"QueryVerboseSetting"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"f55070f3-80b6-4076-a05d-6799052b6555","leftValue":"={{ $json.ctx.verbose }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[96,1040],"id":"if-verbose-true","name":"IfVerboseTrue"},{"parameters":{"workflowId":{"__rl":true,"value":"wVpslhMBnrsgDaOR","mode":"list","cachedResultName":"Show_Projection_Details","cachedResultUrl":"/workflow/wVpslhMBnrsgDaOR"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[320,1040],"id":"trigger-show-details","name":"TriggerShowDetails"},{"parameters":{"jsCode":"// Merge verbose config result into ctx\nconst collectResults = $('CollectResults').first().json;\nconst ctx = $json.ctx;\nconst verboseValue = ctx.db?.verbose_config?.row?.value;\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      verbose: verboseValue === 'true' || verboseValue === true\n    },\n    emojis: collectResults.emojis,\n    duration_ms: collectResults.duration_ms,\n    projection_count: collectResults.projection_count\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-128,1040],"id":"merge-ctx-verbose","name":"MergeCtxForVerbose"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Extract text for embedding from projection data\nconst ctx = $json.ctx;\nconst projection = ctx.db?.projection?.row || {};\nconst data = projection.data || {};\nconst embeddingText = data.description || data.text || '';\n\nreturn {\n      projection_id: projection.id,\n      embedding_text: embeddingText\n    }"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[352,848],"id":"prepare-embedding-text","name":"PrepareEmbeddingText"},{"parameters":{"method":"POST","url":"={{ $env.EMBEDDING_SERVICE_URL }}/embed","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"texts\": [{{ JSON.stringify($json.embedding_text || '') }}]\n}","options":{"timeout":10000}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[576,848],"id":"embed-projection-text","name":"EmbedProjectionText","continueOnFail":true},{"parameters":{"jsCode":"// Build embedding insert query for Execute_Queries\nconst prepareData = $(\"PrepareEmbeddingText\").first().json;\nconst embeddings = $json.embeddings;\n\n// Check if we have a valid embedding\nif (!embeddings || !embeddings[0]) {\n  // Return a pass-through item to keep the loop going\n  return [{\n    json: {\n      ctx: {\n        ...($json.ctx || {}),\n        db_queries: []  // Empty queries = no-op in Execute_Queries\n      }\n    }\n  }];\n}\n\nconst embeddingVector = \"[\" + embeddings[0].join(\",\") + \"]\";\n\nreturn [{\n  json: {\n    ctx: {\n      ...($json.ctx || {}),\n      db_queries: [{\n        key: \"embedding\",\n        sql: `-- Insert embedding for the projection (fire-and-forget)\nINSERT INTO embeddings (projection_id, model, embedding_data, embedded_text, embedding)\nSELECT \n  $1::uuid,\n  \"all-MiniLM-L6-v2\",\n  \"{}\",\n  $2,\n  $3::vector\nWHERE $3 IS NOT NULL\nON CONFLICT DO NOTHING;`,\n        params: [\n          prepareData.projection_id,\n          prepareData.embedding_text,\n          embeddingVector\n        ]\n      }]\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[800,848],"id":"build-embedding-query","name":"BuildEmbeddingQuery"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1024,848],"id":"insert-embedding","name":"InsertEmbedding","continueOnFail":true},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-128,848],"id":"projection-loop","name":"ProjectionLoop"}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"PrepareCapture","type":"main","index":0},{"node":"RemoveðŸ”µReaction","type":"main","index":0}]]},"PrepareCapture":{"main":[[{"node":"MultiCapturer","type":"main","index":0}]]},"MultiCapturer":{"main":[[{"node":"ParseResponse","type":"main","index":0}]]},"StoreLlmTrace":{"main":[[{"node":"SplitCaptures","type":"main","index":0}]]},"StoreProjection":{"main":[[{"node":"PrepareEmbeddingText","type":"main","index":0}]]},"PrepareEmbeddingText":{"main":[[{"node":"EmbedProjectionText","type":"main","index":0}]]},"EmbedProjectionText":{"main":[[{"node":"BuildEmbeddingQuery","type":"main","index":0}]]},"BuildEmbeddingQuery":{"main":[[{"node":"InsertEmbedding","type":"main","index":0}]]},"CollectResults":{"main":[[{"node":"LogToKaironLogs","type":"main","index":0},{"node":"QueryVerboseSetting","type":"main","index":0}]]},"AddEmojiReactions":{"main":[[{"node":"Wait1s","type":"main","index":0}]]},"MimoV2Flash":{"ai_languageModel":[[{"node":"MultiCapturer","type":"ai_languageModel","index":0}]]},"NemotronNano9b":{"ai_languageModel":[[{"node":"MultiCapturer","type":"ai_languageModel","index":1}]]},"Wait1s":{"main":[[{"node":"LoopOverItems","type":"main","index":0}]]},"LoopOverItems":{"main":[[],[{"node":"AddEmojiReactions","type":"main","index":0}]]},"ParseResponse":{"main":[[{"node":"StoreLlmTrace","type":"main","index":0},{"node":"CollectResults","type":"main","index":0},{"node":"PrepareEmojiItems","type":"main","index":0}]]},"SplitCaptures":{"main":[[{"node":"ProjectionLoop","type":"main","index":0}]]},"PrepareEmojiItems":{"main":[[{"node":"LoopOverItems","type":"main","index":0}]]},"LogToKaironLogs":{"main":[[]]},"QueryVerboseSetting":{"main":[[{"node":"MergeCtxForVerbose","index":0,"type":"main"}]]},"IfVerboseTrue":{"main":[[{"node":"TriggerShowDetails","index":0,"type":"main"}]]},"MergeCtxForVerbose":{"main":[[{"node":"IfVerboseTrue","index":0,"type":"main"}]]},"ProjectionLoop":{"main":[[],[{"node":"StoreProjection","type":"main","index":0}]]},"InsertEmbedding":{"main":[[{"node":"ProjectionLoop","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"ExecuteWorkflowTrigger":[{"json":{"ctx":{"event":{"event_id":"8328becb-038a-4a3b-8955-a15ac1d60a8c","event_type":"discord_message","timestamp":"2025-12-24T09:33:35.559000+00:00","guild_id":"754207117157859388","channel_id":"1450406231146496132","message_id":"1453319690372907141","author_login":"chr15","thread_id":null,"message_url":"https://discord.com/channels/754207117157859388/1450406231146496132/1453319690372907141","raw_text":"testing fixes. need to go to store","clean_text":"testing fixes. need to go to store","tag":null,"trace_chain":["8328becb-038a-4a3b-8955-a15ac1d60a8c"],"trace_chain_pg":"{8328becb-038a-4a3b-8955-a15ac1d60a8c}"}}},"pairedItem":{"item":0}}]},"versionId":"641a28e1-a600-44b8-b89b-f252ad4e92cc","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:29.836Z","createdAt":"2025-12-23T09:30:29.836Z","role":"workflow:owner","workflowId":"DX0m48INGS7vEwbu","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:53.641Z","createdAt":"2025-12-23T09:30:28.601Z","id":"baPcss9BKwIpEZQU","name":"Handle_Correction","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-800,400],"id":"trigger-correction","name":"ExecuteWorkflowTrigger"},{"parameters":{"jsCode":"// Build lookup query for Execute_Queries\nconst ctx = $json.ctx;\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries: [{\n        key: 'original',\n        sql: `-- Look up the original event that created projections for this message\n-- Also get the emoji mapping config for correction types\nWITH original AS (\n  SELECT \n    e.id as event_id,\n    e.payload->>'discord_message_id' as message_id,\n    e.payload->>'clean_text' as clean_text,\n    e.payload->>'discord_channel_id' as channel_id,\n    e.payload->>'discord_guild_id' as guild_id,\n    e.payload->>'author_login' as author_login,\n    e.payload as original_payload\n  FROM events e\n  WHERE e.payload->>'discord_message_id' = $1\n    AND e.event_type = 'discord_message'\n  ORDER BY e.received_at DESC\n  LIMIT 1\n),\nemoji_config AS (\n  SELECT value FROM config WHERE key = 'emoji_mapping'\n)\nSELECT \n  o.*,\n  ec.value as emoji_mapping\nFROM original o\nCROSS JOIN emoji_config ec;`,\n        params: [ctx.event.message_id]\n      }]\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-576,400],"id":"build-lookup-query","name":"BuildLookupQuery"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-352,400],"id":"lookup-original-event","name":"LookupOriginalEvent"},{"parameters":{"jsCode":"// Prepare correction context from lookup result\nconst ctx = $json.ctx;\nconst original = ctx.db?.original?.row;\n\nif (!original || !original.event_id) {\n  return {\n    json: {\n      ctx,\n      has_original: false,\n      error: 'No original event found for this message'\n    }\n  };\n}\n\n// Parse emoji mapping - Postgres returns JSON as string\nconst rawMapping = original.emoji_mapping;\nconst emojiMapping = typeof rawMapping === 'string' ? JSON.parse(rawMapping) : (rawMapping || {});\nconst types = emojiMapping.types || {};\nconst actions = emojiMapping.actions || {};\nconst emoji = ctx.event.emoji;\n\n// Determine correction type\nlet correctionType = null;\nlet correctionTag = null;\nlet isVoidOnly = false;\n\nif (types[emoji]) {\n  correctionType = types[emoji].type;\n  correctionTag = types[emoji].tag;\n} else if (actions[emoji] === 'void') {\n  isVoidOnly = true;\n}\n\n// Pre-compute values for Postgres queries to avoid n8n expression parsing issues\nconst messageUrl = `https://discord.com/channels/${original.guild_id}/${original.channel_id}/${original.message_id}`;\nconst idempotencyKey = `correction_${original.message_id}_${Date.now()}`;\n\nreturn {\n  json: {\n    ctx,\n    has_original: true,\n    original: {\n      event_id: original.event_id,\n      message_id: original.message_id,\n      clean_text: original.clean_text,\n      channel_id: original.channel_id,\n      guild_id: original.guild_id,\n      author_login: original.author_login,\n      payload: original.original_payload,\n      message_url: messageUrl\n    },\n    correction: {\n      emoji: emoji,\n      type: correctionType,\n      tag: correctionTag,\n      is_void_only: isVoidOnly,\n      idempotency_key: idempotencyKey\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-128,400],"id":"prepare-correction","name":"PrepareCorrection"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"has-original","leftValue":"={{ $json.has_original }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2,"position":[96,400],"id":"has-original-check","name":"HasOriginal?"},{"parameters":{"jsCode":"// Build queries for correction event creation and voiding projections\n// Uses $results chaining: correction event id -> void projections\nconst data = $json;\nconst ctx = data.ctx;\nconst original = data.original;\nconst correction = data.correction;\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries: [\n        {\n          key: 'correction_event',\n          sql: `-- Create correction event for audit trail\nINSERT INTO events (idempotency_key, event_type, payload)\nVALUES (\n  $1,\n  'user_correction',\n  jsonb_build_object(\n    'original_event_id', $2,\n    'original_message_id', $3,\n    'correction_emoji', $4,\n    'correction_type', $5,\n    'is_void_only', $6,\n    'triggered_by_event_id', $7\n  )\n)\nON CONFLICT (event_type, idempotency_key) DO NOTHING\nRETURNING id;`,\n          params: [\n            correction.idempotency_key,\n            original.event_id,\n            original.message_id,\n            correction.emoji,\n            correction.type || 'void',\n            correction.is_void_only,\n            ctx.event.event_id\n          ]\n        },\n        {\n          key: 'voided',\n          sql: `-- Void ALL projections for this Discord message (by message_url)\n-- This catches both original projections and any corrected ones\nUPDATE projections\nSET \n  status = 'voided',\n  voided_at = NOW(),\n  voided_reason = 'user_correction',\n  voided_by_event_id = $1::uuid\nWHERE data->>'message_url' = $2\n  AND status IN ('pending', 'auto_confirmed', 'confirmed')\nRETURNING id, projection_type, data->>'description' as description, data->>'text' as text;`,\n          params: [\n            '$results.correction_event.row.id',\n            original.message_url\n          ]\n        }\n      ]\n    },\n    original: original,\n    correction: correction\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[320,336],"id":"build-correction-queries","name":"BuildCorrectionQueries"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[544,336],"id":"execute-correction-queries","name":"ExecuteCorrectionQueries"},{"parameters":{"jsCode":"// Build list of emojis to remove based on voided projection types\nconst ctx = $json.ctx;\nconst original = $('BuildCorrectionQueries').first().json.original;\nconst channelId = original.channel_id;\nconst messageId = original.message_id;\n\n// Get voided projection types from Execute_Queries result\nconst voidedRows = ctx.db?.voided?.rows || [];\nconst voidedTypes = voidedRows.map(item => item.projection_type).filter(Boolean);\n\n// Map projection types to their emojis\nconst typeToEmoji = {\n  'activity': 'ðŸ”˜',\n  'note': 'ðŸ“',\n  'todo': 'âœ…'\n};\n\n// Only remove emojis for the projection types that were actually voided\nconst emojisToRemove = [...new Set(voidedTypes.map(t => typeToEmoji[t]).filter(Boolean))];\n\nif (emojisToRemove.length === 0) {\n  // No emojis to remove, return skip marker\n  return { json: { skip: true, ctx } };\n}\n\nreturn emojisToRemove.map(emoji => ({\n  json: {\n    channel_id: channelId,\n    message_id: messageId,\n    emoji: emoji,\n    encoded_emoji: encodeURIComponent(emoji),\n    skip: false,\n    ctx\n  }\n}));","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[768,336],"id":"build-emoji-remove-list","name":"BuildEmojiRemoveList"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"not-skip","leftValue":"={{ $json.skip }}","rightValue":false,"operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2,"position":[880,336],"id":"filter-skip","name":"HasEmojiToRemove?"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.channel_id }}/messages/{{ $json.message_id }}/reactions/{{ $json.encoded_emoji }}/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1104,272],"id":"remove-bot-emojis","name":"RemoveBotEmojis","retryOnFail":false,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// After removing emojis, check if we need to re-extract or just void\nconst prepareData = $('BuildCorrectionQueries').first().json;\nconst ctx = $('ExecuteCorrectionQueries').first().json.ctx;\n\n// Get correction event ID from Execute_Queries result\nconst correctionEventId = ctx.db?.correction_event?.row?.id;\n\n// Collect voided projection IDs for linking to new projection\nconst voidedRows = ctx.db?.voided?.rows || [];\nconst voidedProjectionIds = voidedRows.map(item => item.id).filter(Boolean);\n\nreturn {\n  ctx,\n  original: prepareData.original,\n  correction: prepareData.correction,\n  correction_event_id: correctionEventId,\n  voided_projection_ids: voidedProjectionIds,\n  should_reextract: !prepareData.correction.is_void_only && !!prepareData.correction.type\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,336],"id":"check-reextract","name":"CheckReExtract"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"should-reextract","leftValue":"={{ $json.should_reextract }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2,"position":[1552,336],"id":"should-reextract-check","name":"ShouldReExtract?"},{"parameters":{"jsCode":"// Build ctx for Capture_Projection, reusing original event data\nconst data = $json;\nconst original = data.original;\nconst correction = data.correction;\nconst existingCtx = data.ctx || {};\n\n// Map correction type to projection type\nconst typeMap = {\n  'activity': 'activity',\n  'note': 'note',\n  'todo': 'todo'\n};\n\nconst projectionType = typeMap[correction.type] || 'note';\n\n// Build new trace chain starting from correction event\nconst traceChain = [data.correction_event_id];\nconst traceChainPg = '{' + traceChain.join(',') + '}';\n\n// Construct message_url from original data\nconst messageUrl = `https://discord.com/channels/${original.guild_id}/${original.channel_id}/${original.message_id}`;\n\n// Pass voided projection IDs for supersedes linking\nconst voidedProjectionIds = data.voided_projection_ids || [];\n\nreturn {\n  json: {\n    ctx: {\n      ...existingCtx,\n      event: {\n        event_id: data.correction_event_id,\n        event_type: 'user_correction',\n        timestamp: new Date().toISOString(),\n        timezone: existingCtx.event?.timezone,\n        guild_id: original.guild_id,\n        channel_id: original.channel_id,\n        message_id: original.message_id,\n        message_url: messageUrl,\n        author_login: original.author_login,\n        raw_text: original.clean_text,\n        clean_text: original.clean_text,\n        tag: correction.tag,\n        trace_chain: traceChain,\n        trace_chain_pg: traceChainPg\n      },\n      projection: {\n        type: projectionType\n      },\n      correction: {\n        original_event_id: original.event_id,\n        emoji: correction.emoji,\n        voided_projection_ids: voidedProjectionIds\n      }\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1776,272],"id":"build-capture-ctx","name":"BuildCaptureCtx"},{"parameters":{"workflowId":{"__rl":true,"value":"Gu9mVRTwvJCq0Fpf","mode":"list","cachedResultName":"Capture_Projection","cachedResultUrl":"/workflow/Gu9mVRTwvJCq0Fpf"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[2000,272],"id":"execute-capture","name":"ExecuteCaptureProjection"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $('Build Correction Queries').first().json.original.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $env.DISCORD_CHANNEL_KAIRON_LOGS }}","mode":"id"},"content":"=**[Correction]** {{ $('Build Correction Queries').first().json.correction.is_void_only ? 'Voided' : 'Re-extracted as ' + $('Build Correction Queries').first().json.correction.type }} for message `{{ $('Build Correction Queries').first().json.original.message_id }}`","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[2000,464],"id":"log-correction","name":"LogCorrection","webhookId":"correction-log","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $env.DISCORD_CHANNEL_KAIRON_LOGS }}","mode":"id"},"content":"=**[Correction]** No original event found for message `{{ $json.ctx.event.message_id }}`","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[320,560],"id":"log-no-original","name":"LogNoOriginal","webhookId":"no-original-log","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"BuildLookupQuery","type":"main","index":0}]]},"BuildLookupQuery":{"main":[[{"node":"LookupOriginalEvent","type":"main","index":0}]]},"LookupOriginalEvent":{"main":[[{"node":"PrepareCorrection","type":"main","index":0}]]},"PrepareCorrection":{"main":[[{"node":"HasOriginal?","type":"main","index":0}]]},"HasOriginal?":{"main":[[{"node":"BuildCorrectionQueries","type":"main","index":0}],[{"node":"LogNoOriginal","type":"main","index":0}]]},"BuildCorrectionQueries":{"main":[[{"node":"ExecuteCorrectionQueries","type":"main","index":0}]]},"ExecuteCorrectionQueries":{"main":[[{"node":"BuildEmojiRemoveList","type":"main","index":0}]]},"BuildEmojiRemoveList":{"main":[[{"node":"HasEmojiToRemove?","type":"main","index":0}]]},"HasEmojiToRemove?":{"main":[[{"node":"RemoveBotEmojis","type":"main","index":0}],[{"node":"CheckReExtract","type":"main","index":0}]]},"RemoveBotEmojis":{"main":[[{"node":"CheckReExtract","type":"main","index":0}]]},"CheckReExtract":{"main":[[{"node":"ShouldReExtract?","type":"main","index":0}]]},"ShouldReExtract?":{"main":[[{"node":"BuildCaptureCtx","type":"main","index":0}],[{"node":"LogCorrection","type":"main","index":0}]]},"BuildCaptureCtx":{"main":[[{"node":"ExecuteCaptureProjection","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":null,"versionId":"b89b1035-c2e8-4386-ba4b-84480b3932b3","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:28.601Z","createdAt":"2025-12-23T09:30:28.601Z","role":"workflow:owner","workflowId":"baPcss9BKwIpEZQU","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:56.378Z","createdAt":"2025-12-23T09:30:32.352Z","id":"9z0gv8DzdPC76trq","name":"Start_Thread","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[18496,-2320],"id":"a929c09f-94de-42dc-a2ff-923accc5e9ab","name":"ExecuteWorkflowTrigger"},{"parameters":{"method":"POST","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/threads","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","sendBody":true,"specifyBody":"json","jsonBody":"={{ { \"name\": $json.ctx.event.clean_text.slice(0, 100) } }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[18720,-2320],"id":"85fce562-824f-47c1-83cf-ea4d7e807ea4","name":"CreateDiscordThread","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"promptType":"define","text":"=You are an AI life coach helping the user reflect, plan, and think deeply.\n\n## Context Available\n\n**User's Guiding Principle:** {{ $json.ctx.db.north_star }}\n\nKeep this in mind when helping them, but don't mention it unless directly relevant to the conversation.\n\n## Current Situation\n\nThe user just started a conversation thread with: {{ $json.ctx.event.clean_text }}\n\nThey are coming to you for help thinking through something.\n\n## Instructions\n\n**Assess the question type:**\n\n**Simple/direct question** (what's X?, how do I Y?) â†’ Answer directly if you can. Be concise (2-3 sentences).\n\n**Planning/reflection/decision** (what should I focus on?, help me think about X) â†’ Signal that you're gathering context, then ask 1 clarifying question. Total 2-3 sentences.\n\n## Style\n\n- Warm and conversational\n- Natural and specific to their words\n- Not robotic or generic\n- Don't force connections to the guiding principle\n- Focus on what they're asking, not on fitting everything into a grand narrative\n\n## Example Responses (for planning/reflection questions)\n\n**User:** what should I focus on today?\n**Good response:** Let me check what you've been working on lately. Are you thinking about what to prioritize right now, or planning for the whole day?\n\n**User:** help me think through this project decision\n**Good response:** I'll look at your recent activities to give you a grounded perspective. What's the core tradeoff you're trying to navigate?\n\n**User:** feeling scattered, what's going on?\n**Good response:** Let me pull up your week so far. When did you first notice feeling scattered - today or has it been building?\n\n**User:** am I making progress on my goals?\n**Good response:** Looking at your recent work to see the patterns. Which goal are you most curious about?\n\nNotice how each response:\n1. Signals gathering context in a natural, varied way\n2. Asks a clarifying question that's conversational and specific, not generic\n\nRespond to their initial message now.","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[19616,-2320],"id":"f6f390a8-c453-4cee-8d6d-2b9a415e3a29","name":"GenerateInitialResponse"},{"parameters":{"model":"nvidia/nemotron-nano-9b-v2:free","options":{"temperature":0.7}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[19624,-2096],"id":"0c6a309d-86ff-4aa3-b02f-33230ae4f092","name":"NemotronNano9b","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"model":"xiaomi/mimo-v2-flash:free","options":{"temperature":0.7}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[19752,-2096],"id":"60963dec-c78a-4918-8b32-12e1a0f25d8b","name":"MimoV2Flash","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"jsCode":"// Prepare db_queries for trace + projection storage\nconst ctx = $json.ctx || {};\n\nconst response = ctx.llm?.completion_text || '';\nconst inferenceStart = ctx.llm?.inference_start || Date.now();\nconst durationMs = Date.now() - inferenceStart;\n\n// Build filled prompt (reconstructed from template)\nconst northStar = ctx.llm?.north_star || '(not set)';\nconst cleanText = ctx.event?.clean_text || '';\nconst promptText = `You are an AI life coach...\\n\\nUser's Guiding Principle: ${northStar}\\n\\nThe user started with: ${cleanText}`;\n\n// Prepare db_queries for Execute_Queries\nconst db_queries = [\n  {\n    key: 'trace',\n    sql: `WITH new_trace AS (\n            INSERT INTO traces (event_id, step_name, data, trace_chain)\n            VALUES ($1::uuid, 'thread_initial_response',\n              jsonb_build_object(\n                'input', jsonb_build_object('text', $2, 'thread_id', $3::text),\n                'prompt', $4,\n                'completion', $5,\n                'result', jsonb_build_object('response_length', $6::integer),\n                'model', 'nvidia/nemotron-nano-9b-v2:free',\n                'duration_ms', $7::integer\n              ), $8::uuid[])\n            RETURNING id\n          )\n          SELECT new_trace.id as trace_id, $8::uuid[] || new_trace.id as updated_trace_chain\n          FROM new_trace`,\n    params: [\n      ctx.event?.event_id,\n      cleanText,\n      ctx.thread?.id,\n      promptText,\n      response,\n      response.length,\n      durationMs,\n      ctx.event?.trace_chain || []\n    ]\n  },\n  {\n    key: 'projection',\n    sql: `INSERT INTO projections (event_id, trace_id, trace_chain, projection_type, status, data, timezone)\n          VALUES ($1::uuid, $2::uuid, $3::uuid[], 'thread_response', 'auto_confirmed',\n            jsonb_build_object(\n              'thread_id', $4,\n              'response_text', $5,\n              'role', 'assistant',\n              'timestamp', $6::timestamptz\n            ), $7)\n          RETURNING id`,\n    params: [\n      ctx.event?.event_id,\n      '$results.trace.row.trace_id',\n      '$results.trace.row.updated_trace_chain',\n      ctx.thread?.id,\n      response,\n      ctx.event?.timestamp,\n      ctx.event?.timezone\n    ]\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[20288,-2320],"id":"prepare-write-queries","name":"PrepareWriteQueries"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.thread.id }}","mode":"id"},"content":"={{ $json.ctx.llm.completion_text.trim().replace(/^[\"']|[\"']$/g, '') }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[20064,-2320],"id":"a5785f29-feef-42f4-8da5-d5eaeb9fd055","name":"SendResponseToThread","webhookId":"b265fcc0-4670-437b-9913-59b5d32bc95b","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"resource":"message","operation":"react","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"messageId":"={{ $json.ctx.event.message_id }}","emoji":"=ðŸ—¨ï¸"},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[18720,-2560],"id":"1e7b0d2a-54ee-4607-bcd9-7872585cb7c1","name":"ReactWithðŸ—¨ï¸","webhookId":"d9babcdf-8243-4adb-83c8-bbaf038fbfc7","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/ðŸ”µ/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[18720,-2080],"id":"remove-blue-reaction-start-chat","name":"RemoveðŸ”µReaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[20512,-2320],"id":"execute-write-queries","name":"ExecuteQueries(write)"},{"parameters":{"jsCode":"// Prepare north_star query and build initial ctx\nconst triggerData = $json;\nconst ctx = triggerData.ctx || {};\n\nconst db_queries = [\n  {\n    key: 'north_star',\n    sql: \"SELECT value FROM config WHERE key = 'north_star'\"\n  }\n];\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[18944,-2320],"id":"prepare-read-queries","name":"PrepareReadQueries"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[19168,-2320],"id":"execute-read-queries","name":"ExecuteQueries(read)"},{"parameters":{"jsCode":"// Build context for LLM from thread and db results\nconst ctx = $json.ctx || {};\nconst threadData = $('CreateDiscordThread').first().json;\n\n// Get north_star from Execute_Queries result\nconst northStar = ctx.db?.north_star?.row?.value || '(not set)';\n\n// Preserve all ctx.event fields and add thread + llm context\nreturn {\n  json: {\n    ctx: {\n      event: {\n        event_id: ctx.event?.event_id,\n        channel_id: ctx.event?.channel_id,\n        message_id: ctx.event?.message_id,\n        guild_id: ctx.event?.guild_id,\n        clean_text: ctx.event?.clean_text,\n        timestamp: ctx.event?.timestamp,\n        timezone: ctx.event?.timezone,\n        trace_chain: ctx.event?.trace_chain\n      },\n      thread: {\n        id: threadData.id\n      },\n      db: {\n        north_star: northStar\n      },\n      llm: {\n        inference_start: Date.now(),\n        north_star: northStar\n      }\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[19392,-2320],"id":"build-llm-context","name":"BuildLlmContext"},{"parameters":{"jsCode":"// Add LLM response to ctx\nconst prevData = $('BuildLlmContext').first().json;\nconst ctx = prevData.ctx;\nconst llmResponse = $json.text || '';\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      llm: {\n        ...ctx.llm,\n        completion_text: llmResponse\n      }\n    }\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[19840,-2320],"id":"set-llm-response","name":"SetLlmResponse"}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"CreateDiscordThread","type":"main","index":0},{"node":"ReactWithðŸ—¨ï¸","type":"main","index":0},{"node":"RemoveðŸ”µReaction","type":"main","index":0}]]},"CreateDiscordThread":{"main":[[{"node":"PrepareReadQueries","type":"main","index":0}]]},"PrepareReadQueries":{"main":[[{"node":"ExecuteQueries(read)","type":"main","index":0}]]},"ExecuteQueries(read)":{"main":[[{"node":"BuildLlmContext","type":"main","index":0}]]},"BuildLlmContext":{"main":[[{"node":"GenerateInitialResponse","type":"main","index":0}]]},"GenerateInitialResponse":{"main":[[{"node":"SetLlmResponse","type":"main","index":0}]]},"SetLlmResponse":{"main":[[{"node":"SendResponseToThread","type":"main","index":0}]]},"SendResponseToThread":{"main":[[{"node":"PrepareWriteQueries","type":"main","index":0}]]},"PrepareWriteQueries":{"main":[[{"node":"ExecuteQueries(write)","type":"main","index":0}]]},"ReactWithðŸ—¨ï¸":{"main":[[]]},"RemoveðŸ”µReaction":{"main":[[]]},"NemotronNano9b":{"ai_languageModel":[[{"node":"GenerateInitialResponse","type":"ai_languageModel","index":0}]]},"MimoV2Flash":{"ai_languageModel":[[{"node":"GenerateInitialResponse","type":"ai_languageModel","index":1}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":null,"versionId":"4a4d8ce9-403e-48ae-bfe1-651e9ca7b6b9","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:32.352Z","createdAt":"2025-12-23T09:30:32.352Z","role":"workflow:owner","workflowId":"9z0gv8DzdPC76trq","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:52.229Z","createdAt":"2025-12-23T21:46:04.499Z","id":"eRoAFDm0UWls8AJd","name":"Backup_Workflow","active":true,"isArchived":false,"nodes":[{"parameters":{"cronExpression":"0 2 * * *","timezone":"UTC"},"id":"1","name":"Cron","type":"n8n-nodes-base.cron","typeVersion":1,"position":[-600,0]},{"parameters":{"jsCode":"const fs = require('fs');\nconst path = require('path');\nconst { execSync } = require('child_process');\n\n// Get current timestamp\nconst timestamp = new Date().toISOString().replace(/[:.]/g, '-');\nconst backupDir = `/tmp/n8n-backup-${timestamp}`;\n\n// Ensure backup directory exists\nexecSync(`mkdir -p ${backupDir}`);\n\n// Files to backup\nconst files = [\n  'n8n-workflows',\n  'n8n-workflows-dev',\n  'scripts',\n  '.env',\n  'DEPLOYMENT.md',\n  'README.md'\n];\n\nconst results = [];\n\nfor (const file of files) {\n  try {\n    if (fs.existsSync(file)) {\n      const dest = path.join(backupDir, file);\n      execSync(`cp -r ${file} ${dest}`);\n      results.push({ file, status: 'success', path: dest });\n    } else {\n      results.push({ file, status: 'not_found' });\n    }\n  } catch (error) {\n    results.push({ file, status: 'error', error: error.message });\n  }\n}\n\n// Create backup info file\nconst backupInfo = {\n  timestamp,\n  backupDir,\n  results,\n  createdAt: new Date().toISOString()\n};\n\nfs.writeFileSync(path.join(backupDir, 'backup-info.json'), JSON.stringify(backupInfo, null, 2));\n\nreturn {\n  json: {\n    ctx: {\n      event: {\n        event_id: $json.id || 'backup-' + timestamp,\n        event_type: 'backup_workflow',\n        clean_text: 'Backup workflow execution',\n        trace_chain: [timestamp],\n        author_login: 'system',\n        timestamp: new Date().toISOString()\n      },\n      backup: {\n        results,\n        backupDir,\n        timestamp\n      }\n    }\n  }\n};","mode":"runOnceForEachItem"},"id":"2","name":"CreateBackup","type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO traces (event_id, event_type, trace_chain, author_login, timestamp, duration_ms, model, completion_text, confidence, prompt, response, status) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12) RETURNING id","values":["={{$json.ctx.event.event_id}}","backup_workflow","={{JSON.stringify($json.ctx.event.trace_chain)}}","system","={{$json.ctx.event.timestamp}}",0,"system","Backup created successfully",1,"Create backup","Backup completed","completed"]},"id":"3","name":"StoreTrace","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-200,0],"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO projections (trace_id, projection_type, projection_data, confidence, category) VALUES ($1, $2, $3, $4, $5)","values":["={{$json.ctx.db.trace.id}}","backup","={{JSON.stringify($json.ctx.backup)}}",1,"system"]},"id":"4","name":"StoreBackupProjection","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[0,0],"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"const backupDir = $json.ctx.event.backup.backupDir;\nconst results = $json.ctx.event.backup.results;\n\nconst successCount = results.filter(r => r.status === 'success').length;\nconst errorCount = results.filter(r => r.status === 'error').length;\nconst notFoundCount = results.filter(r => r.status === 'not_found').length;\n\nconst message = `Backup completed successfully!\\n\\nðŸ“ Backup Directory: ${backupDir}\\nâœ… Successfully backed up: ${successCount} items\\nâŒ Failed to backup: ${errorCount} items\\nâš ï¸  Not found: ${notFoundCount} items\\n\\nDetails:\\n${results.map(r => `  - ${r.file}: ${r.status}${r.error ? ' (' + r.error + ')' : ''}`).join('\\n')}`;\n\nreturn {\n  json: {\n    ctx: {\n      ...$json.ctx,\n      message: message\n    }\n  }\n};","mode":"runOnceForEachItem"},"id":"5","name":"FormatSuccessMessage","type":"n8n-nodes-base.code","typeVersion":2,"position":[200,0]},{"parameters":{"jsCode":"const message = $json.ctx.event.message;\n\n// Send success message to Discord\nconst webhookUrl = process.env.DISCORD_WEBHOOK_URL;\nif (webhookUrl) {\n  const payload = {\n    content: message,\n    username: 'Kairon Backup Bot',\n    avatar_url: 'https://cdn.discordapp.com/emojis/123456789012345678.png' // Kairon logo\n  };\n  \n  await $node['HTTP Request'].run({\n    method: 'POST',\n    url: webhookUrl,\n    body: JSON.stringify(payload),\n    headers: {\n      'Content-Type': 'application/json'\n    }\n  });\n}\n\nreturn {\n  json: {\n    ctx: {\n      ...$json.ctx,\n      discord_sent: true\n    }\n  }\n};","mode":"runOnceForEachItem"},"id":"6","name":"SendDiscordSuccess","type":"n8n-nodes-base.code","typeVersion":2,"position":[400,0]},{"parameters":{"url":"={{$json.ctx.discord_sent ? '' : ''}}","method":"POST","jsonParameters":true,"options":{}},"id":"7","name":"HttpRequest","type":"n8n-nodes-base.httpRequest","typeVersion":2,"position":[400,200]}],"connections":{"Cron":{"main":[[{"node":"CreateBackup","type":"main","index":0}]]},"CreateBackup":{"main":[[{"node":"StoreTrace","type":"main","index":0}]]},"StoreTrace":{"main":[[{"node":"StoreBackupProjection","type":"main","index":0}]]},"StoreBackupProjection":{"main":[[{"node":"FormatSuccessMessage","type":"main","index":0}]]},"FormatSuccessMessage":{"main":[[{"node":"SendDiscordSuccess","type":"main","index":0}]]},"SendDiscordSuccess":{"main":[[{"node":"HttpRequest","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"ee37618c-08f8-4fb0-a871-83c6f22753e3","activeVersionId":"ee37618c-08f8-4fb0-a871-83c6f22753e3","triggerCount":1,"shared":[{"updatedAt":"2025-12-23T21:46:04.499Z","createdAt":"2025-12-23T21:46:04.499Z","role":"workflow:owner","workflowId":"eRoAFDm0UWls8AJd","projectId":"erM3nntdLL53noWi"}],"activeVersion":{"updatedAt":"2025-12-26T06:27:52.231Z","createdAt":"2025-12-26T06:27:52.231Z","versionId":"ee37618c-08f8-4fb0-a871-83c6f22753e3","workflowId":"eRoAFDm0UWls8AJd","nodes":[{"parameters":{"cronExpression":"0 2 * * *","timezone":"UTC"},"id":"1","name":"Cron","type":"n8n-nodes-base.cron","typeVersion":1,"position":[-600,0]},{"parameters":{"jsCode":"const fs = require('fs');\nconst path = require('path');\nconst { execSync } = require('child_process');\n\n// Get current timestamp\nconst timestamp = new Date().toISOString().replace(/[:.]/g, '-');\nconst backupDir = `/tmp/n8n-backup-${timestamp}`;\n\n// Ensure backup directory exists\nexecSync(`mkdir -p ${backupDir}`);\n\n// Files to backup\nconst files = [\n  'n8n-workflows',\n  'n8n-workflows-dev',\n  'scripts',\n  '.env',\n  'DEPLOYMENT.md',\n  'README.md'\n];\n\nconst results = [];\n\nfor (const file of files) {\n  try {\n    if (fs.existsSync(file)) {\n      const dest = path.join(backupDir, file);\n      execSync(`cp -r ${file} ${dest}`);\n      results.push({ file, status: 'success', path: dest });\n    } else {\n      results.push({ file, status: 'not_found' });\n    }\n  } catch (error) {\n    results.push({ file, status: 'error', error: error.message });\n  }\n}\n\n// Create backup info file\nconst backupInfo = {\n  timestamp,\n  backupDir,\n  results,\n  createdAt: new Date().toISOString()\n};\n\nfs.writeFileSync(path.join(backupDir, 'backup-info.json'), JSON.stringify(backupInfo, null, 2));\n\nreturn {\n  json: {\n    ctx: {\n      event: {\n        event_id: $json.id || 'backup-' + timestamp,\n        event_type: 'backup_workflow',\n        clean_text: 'Backup workflow execution',\n        trace_chain: [timestamp],\n        author_login: 'system',\n        timestamp: new Date().toISOString()\n      },\n      backup: {\n        results,\n        backupDir,\n        timestamp\n      }\n    }\n  }\n};","mode":"runOnceForEachItem"},"id":"2","name":"CreateBackup","type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO traces (event_id, event_type, trace_chain, author_login, timestamp, duration_ms, model, completion_text, confidence, prompt, response, status) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12) RETURNING id","values":["={{$json.ctx.event.event_id}}","backup_workflow","={{JSON.stringify($json.ctx.event.trace_chain)}}","system","={{$json.ctx.event.timestamp}}",0,"system","Backup created successfully",1,"Create backup","Backup completed","completed"]},"id":"3","name":"StoreTrace","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-200,0],"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO projections (trace_id, projection_type, projection_data, confidence, category) VALUES ($1, $2, $3, $4, $5)","values":["={{$json.ctx.db.trace.id}}","backup","={{JSON.stringify($json.ctx.backup)}}",1,"system"]},"id":"4","name":"StoreBackupProjection","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[0,0],"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"const backupDir = $json.ctx.event.backup.backupDir;\nconst results = $json.ctx.event.backup.results;\n\nconst successCount = results.filter(r => r.status === 'success').length;\nconst errorCount = results.filter(r => r.status === 'error').length;\nconst notFoundCount = results.filter(r => r.status === 'not_found').length;\n\nconst message = `Backup completed successfully!\\n\\nðŸ“ Backup Directory: ${backupDir}\\nâœ… Successfully backed up: ${successCount} items\\nâŒ Failed to backup: ${errorCount} items\\nâš ï¸  Not found: ${notFoundCount} items\\n\\nDetails:\\n${results.map(r => `  - ${r.file}: ${r.status}${r.error ? ' (' + r.error + ')' : ''}`).join('\\n')}`;\n\nreturn {\n  json: {\n    ctx: {\n      ...$json.ctx,\n      message: message\n    }\n  }\n};","mode":"runOnceForEachItem"},"id":"5","name":"FormatSuccessMessage","type":"n8n-nodes-base.code","typeVersion":2,"position":[200,0]},{"parameters":{"jsCode":"const message = $json.ctx.event.message;\n\n// Send success message to Discord\nconst webhookUrl = process.env.DISCORD_WEBHOOK_URL;\nif (webhookUrl) {\n  const payload = {\n    content: message,\n    username: 'Kairon Backup Bot',\n    avatar_url: 'https://cdn.discordapp.com/emojis/123456789012345678.png' // Kairon logo\n  };\n  \n  await $node['HTTP Request'].run({\n    method: 'POST',\n    url: webhookUrl,\n    body: JSON.stringify(payload),\n    headers: {\n      'Content-Type': 'application/json'\n    }\n  });\n}\n\nreturn {\n  json: {\n    ctx: {\n      ...$json.ctx,\n      discord_sent: true\n    }\n  }\n};","mode":"runOnceForEachItem"},"id":"6","name":"SendDiscordSuccess","type":"n8n-nodes-base.code","typeVersion":2,"position":[400,0]},{"parameters":{"url":"={{$json.ctx.discord_sent ? '' : ''}}","method":"POST","jsonParameters":true,"options":{}},"id":"7","name":"HttpRequest","type":"n8n-nodes-base.httpRequest","typeVersion":2,"position":[400,200]}],"connections":{"Cron":{"main":[[{"node":"CreateBackup","type":"main","index":0}]]},"CreateBackup":{"main":[[{"node":"StoreTrace","type":"main","index":0}]]},"StoreTrace":{"main":[[{"node":"StoreBackupProjection","type":"main","index":0}]]},"StoreBackupProjection":{"main":[[{"node":"FormatSuccessMessage","type":"main","index":0}]]},"FormatSuccessMessage":{"main":[[{"node":"SendDiscordSuccess","type":"main","index":0}]]},"SendDiscordSuccess":{"main":[[{"node":"HttpRequest","type":"main","index":0}]]}},"authors":"Chris Irineo","name":null,"description":null},"tags":[]},{"updatedAt":"2025-12-26T06:27:52.447Z","createdAt":"2025-12-23T09:30:18.636Z","id":"Gu9mVRTwvJCq0Fpf","name":"Capture_Projection","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-1600,704],"id":"trigger-capture-projection","name":"ExecuteWorkflowTrigger"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Determine emoji based on projection type and prepare for routing\nconst ctx = $json.ctx;\nconst projectionType = ctx.projection?.type || 'note';\n\nconst emojiMap = {\n  'activity': 'ðŸ”˜',\n  'note': 'ðŸ“',\n  'todo': 'âœ…'\n};\n\nconst emoji = emojiMap[projectionType] || 'ðŸ“';\n\nreturn {\n  json: {\n    ctx: ctx,\n    projection_type: projectionType,\n    emoji: emoji,\n    inference_start: Date.now()\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1376,704],"id":"prepare-routing","name":"PrepareRouting"},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/ðŸ”µ/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1152,912],"id":"remove-blue-reaction","name":"RemoveðŸ”µReaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"method":"PUT","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/{{ encodeURIComponent($json.emoji) }}/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1152,496],"id":"add-type-reaction","name":"AddTypeReaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"is-activity","leftValue":"={{ $json.projection_type }}","rightValue":"activity","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"activity"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"is-note","leftValue":"={{ $json.projection_type }}","rightValue":"note","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"note"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"is-todo","leftValue":"={{ $json.projection_type }}","rightValue":"todo","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"todo"}]},"options":{"fallbackOutput":"extra"}},"id":"route-by-type","name":"RouteByType","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-1152,688]},{"parameters":{"promptType":"define","text":"=You are an activity classifier for a life-tracking system.\n\nAssign probability scores (0-100) to each category. Scores must add up to exactly 100.\n\n## Categories\n\nwork â†’ Productive, focused effort on projects, coding, building, debugging, refining systems, testing, or task-oriented development.\nleisure â†’ Relaxed, non-productive enjoyment: scrolling, watching videos, browsing, casual reading, coffee breaks.\nstudy â†’ Intentional learning or skill-building not directly tied to immediate project work.\nhealth â†’ Physical or mental self-care: exercise, eating meals, hygiene, mindfulness.\nsleep â†’ Going to bed, waking up, napping, or sleep transitions.\nrelationships â†’ Social interaction: chatting with friends/family/partners, or personal/social AI conversations.\nadmin â†’ Organizational/maintenance tasks: planning schedules, managing todos, fixing tools/setup, meta work on tracking system.\n\n## Key Guidelines\n- Heavily favor the most dominant theme.\n- Sleep-related messages â†’ give sleep the highest score.\n- Project-related AI chats â†’ work.\n- Eating/drinking â†’ health (split with leisure if combined).\n- Meta work on tracking system â†’ admin (or work if core building).\n- Omit any category with score â‰¤5 (treat as 0).\n\nOutput ONLY lines for categories with score >5, in any order:\ncategory_name|X\n\n(Printed scores must sum to exactly 100, integers only)\n\n## Examples\nworking on the router agent implementation\nwork|98\nadmin|2\n\nsipping coffee while scrolling social media\nleisure|88\nhealth|12\n\ngoing to bed after a long day\nsleep|93\nhealth|7\n\nhaving lunch\nhealth|92\nleisure|8\n\n## Message to classify:\n{{ $json.ctx.event.clean_text }}","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-928,496],"id":"activity-classifier","name":"ActivityClassifier"},{"parameters":{"promptType":"define","text":"=You are a note classifier for a life-tracking system.\n\nClassify notes into exactly 2 categories. Assign probability scores (0-100) that add up to exactly 100.\n\n# Categories\n\nfact â†’ External, objective, declarative knowledge about the world or people (birthdays, preferences, allergies, likes/dislikes, factual statements about others).\n\nreflection â†’ Internal, subjective knowledge (insights, decisions, observations, realizations, thoughts, self-analysis, patterns, emotional states, personal commitments).\n\n# The Core Distinction\n- fact = \"Things about the world/others\" (external reality)\n- reflection = \"Things about me/my mind\" (internal experience)\n\n# Key Guidelines\n- Declarative statements about others â†’ fact (\"John loves coffee\", \"Sarah is allergic to nuts\")\n- Dates, birthdays, preferences of others â†’ fact\n- Personal insights, realizations â†’ reflection (\"I work better in mornings\")\n- Decisions, commitments â†’ reflection (\"decided to switch to async\")\n- Self-observations â†’ reflection (\"I've been more focused lately\")\n- When in doubt: Is it about THEM or about ME? â†’ fact vs reflection\n\nOutput format (only lines with score >5):\ncategory_name|score\n\n(Scores must sum to exactly 100, integers only)\n\n# Examples\n\nJohn loves dark roast coffee\nfact|95\nreflection|5\n\nMom's birthday is June 12\nfact|98\nreflection|2\n\nnoticed an interesting pattern in my productivity\nreflection|94\nfact|6\n\nI work better in the mornings\nreflection|88\nfact|12\n\n## Message to classify:\n{{ $json.ctx.event.clean_text }}","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-928,704],"id":"note-classifier","name":"NoteClassifier"},{"parameters":{"promptType":"define","text":"=You are a todo priority classifier for a life-tracking system.\n\nAssign probability scores (0-100) to each priority level. Scores must add up to exactly 100.\n\n# Priority Levels\n\nhigh â†’ Urgent, time-sensitive, blocking other work, or has significant consequences if delayed.\nmedium â†’ Important but not urgent, should be done soon, normal priority.\nlow â†’ Nice to have, can be deferred, no immediate impact if delayed.\n\n# Key Guidelines\n- Explicit urgency words (\"ASAP\", \"urgent\", \"today\", \"now\") â†’ high\n- Deadlines mentioned â†’ high if soon, medium if later\n- \"Should\", \"need to\", \"have to\" without urgency â†’ medium\n- \"Maybe\", \"sometime\", \"eventually\", \"would be nice\" â†’ low\n- Bug fixes, blockers â†’ high\n- Regular tasks, maintenance â†’ medium\n- Ideas, improvements, \"someday\" items â†’ low\n\nOutput format (only lines with score >5):\npriority_name|score\n\n(Scores must sum to exactly 100, integers only)\n\n# Examples\n\nneed to fix the auth bug before demo tomorrow\nhigh|92\nmedium|8\n\nshould update the documentation\nmedium|85\nlow|15\n\nmaybe add dark mode someday\nlow|88\nmedium|12\n\nurgent: server is down\nhigh|98\nmedium|2\n\n## Message to classify:\n{{ $json.ctx.event.clean_text }}","needsFallback":true,"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-928,896],"id":"todo-classifier","name":"TodoClassifier"},{"parameters":{"model":"xiaomi/mimo-v2-flash:free","options":{"timeout":10000}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-928,1296],"id":"mimo-v2-flash","name":"MimoV2Flash","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"model":"nvidia/nemotron-nano-9b-v2:free","options":{"timeout":10000}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-784,1232],"id":"nemotron-nano-9b","name":"NemotronNano9b","credentials":{"openRouterApi":{"id":"nB20cMgvlwePo3oC","name":"OpenRouter account"}}},{"parameters":{"mode":"append","numberInputs":2},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[-576,688],"id":"merge-classifiers","name":"MergeClassifiers"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse LLM classification output and build query for Execute_Queries\nconst llmText = $json.text?.trim() || '';\nconst routingItem = $('PrepareRouting').first().json;\nconst ctx = routingItem.ctx;\nconst projectionType = routingItem.projection_type;\nconst inferenceStart = routingItem.inference_start;\nconst durationMs = Date.now() - inferenceStart;\n\n// Format trace_chain for PostgreSQL uuid[] type\nconst traceChain = ctx.event.trace_chain || [];\nconst traceChainPg = '{' + traceChain.join(',') + '}';\n\n// Get voided projection IDs from correction context (if this is a correction)\nconst voidedProjectionIds = ctx.correction?.voided_projection_ids || [];\nconst voidedProjectionIdsPg = voidedProjectionIds.length > 0 \n  ? '{' + voidedProjectionIds.join(',') + '}' \n  : null;\n\n// Default categories/priorities per type\nconst defaults = {\n  activity: 'work',\n  note: 'reflection',\n  todo: 'medium'\n};\n\n// Parse scores from LLM output\nconst scores = {};\nlet topResult = null;\nlet topScore = 0;\n\ntry {\n  const lines = llmText.split('\\n').filter(line => line.includes('|'));\n  lines.forEach(line => {\n    const [key, scoreStr] = line.split('|').map(s => s.trim());\n    const score = parseInt(scoreStr);\n    if (!isNaN(score)) {\n      scores[key] = score;\n      if (score > topScore) {\n        topScore = score;\n        topResult = key;\n      }\n    }\n  });\n} catch (e) {\n  // Use default on parse error\n}\n\nif (!topResult) {\n  topResult = defaults[projectionType];\n  topScore = 50;\n}\n\n// Build projection data based on type\nlet projectionData;\nif (projectionType === 'activity') {\n  projectionData = {\n    timestamp: new Date().toISOString(),\n    category: topResult,\n    description: ctx.event.clean_text,\n    message_url: ctx.event.message_url,\n    confidence: topScore / 100,\n    all_scores: scores\n  };\n} else if (projectionType === 'note') {\n  projectionData = {\n    timestamp: new Date().toISOString(),\n    category: topResult,\n    text: ctx.event.clean_text,\n    message_url: ctx.event.message_url,\n    confidence: topScore / 100,\n    all_scores: scores\n  };\n} else if (projectionType === 'todo') {\n  projectionData = {\n    timestamp: new Date().toISOString(),\n    priority: topResult,\n    description: ctx.event.clean_text,\n    message_url: ctx.event.message_url,\n    confidence: topScore / 100,\n    all_scores: scores,\n    status: 'pending'\n  };\n}\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      llm: {\n        result: topResult,\n        confidence: topScore / 100,\n        all_scores: scores,\n        completion_text: llmText,\n        duration_ms: durationMs\n      },\n      db_queries: [{\n        key: 'projection',\n        sql: `WITH new_trace AS (\n  INSERT INTO traces (event_id, step_name, data, trace_chain)\n  VALUES (\n    $1::uuid,\n    $2 || '_classification',\n    jsonb_build_object(\n      'input', jsonb_build_object('text', $3),\n      'completion', $4,\n      'result', jsonb_build_object(\n        'value', $5,\n        'confidence', $6::numeric,\n        'all_scores', $7::jsonb\n      ),\n      'model', 'xiaomi/mimo-v2-flash:free',\n      'duration_ms', $8::integer\n    ),\n    $9::uuid[]\n  )\n  RETURNING id, event_id\n),\nnew_projection AS (\n  INSERT INTO projections (\n    trace_id,\n    event_id,\n    trace_chain,\n    projection_type,\n    data,\n    status,\n    timezone,\n    supersedes_projection_id\n  )\n  SELECT\n    new_trace.id,\n    new_trace.event_id,\n    $9::uuid[] || new_trace.id,\n    $2,\n    $10::jsonb,\n    'auto_confirmed',\n    $11,\n    CASE WHEN $12::uuid[] IS NOT NULL AND array_length($12::uuid[], 1) > 0 THEN ($12::uuid[])[1] ELSE NULL END\n  FROM new_trace\n  RETURNING *\n),\nupdate_voided AS (\n  UPDATE projections\n  SET superseded_by_projection_id = (SELECT id FROM new_projection)\n  WHERE id = ANY($12::uuid[])\n  RETURNING id\n)\nSELECT np.*, COALESCE((SELECT array_agg(id) FROM update_voided), ARRAY[]::uuid[]) as linked_voided_ids\nFROM new_projection np;`,\n        params: [\n          ctx.event.event_id,\n          projectionType,\n          ctx.event.clean_text,\n          llmText,\n          topResult,\n          topScore / 100,\n          JSON.stringify(scores),\n          durationMs,\n          traceChainPg,\n          JSON.stringify(projectionData),\n          ctx.event.timezone,\n          voidedProjectionIdsPg\n        ]\n      }]\n    },\n    projection_type: projectionType,\n    projection_data: projectionData\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-352,704],"id":"parse-classification","name":"ParseClassification"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-128,704],"id":"store-projection","name":"StoreProjection"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $('ParseClassification').item.json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $env.DISCORD_CHANNEL_KAIRON_LOGS }}","mode":"id"},"content":"=**[{{ $('ParseClassification').item.json.projection_type.charAt(0).toUpperCase() + $('ParseClassification').item.json.projection_type.slice(1) }} Classification]**\n**Message:** {{ $('ParseClassification').item.json.ctx.event.clean_text }}\n**Result:** {{ $('ParseClassification').item.json.ctx.llm.result }}\n**Confidence:** [ {{ Object.entries($('ParseClassification').item.json.ctx.llm.all_scores || {}).sort((a, b) => b[1] - a[1]).map(([k, v]) => `${k}:${v}%`).join(' | ') }} ]","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[96,704],"id":"log-to-kairon-logs","name":"LogToKaironLogs","webhookId":"capture-projection-log","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Extract text for embedding from projection data\n// Activity uses 'description', Note/Todo use 'text'\nconst ctx = $json.ctx;\nconst projection = ctx.db?.projection?.row || {};\nconst data = projection.data || {};\nconst embeddingText = data.description || data.text || '';\n\nreturn {\n  json: {\n    projection_id: projection.id,\n    embedding_text: embeddingText\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[96,496],"id":"prepare-embedding-text","name":"PrepareEmbeddingText"},{"parameters":{"method":"POST","url":"={{ $env.EMBEDDING_SERVICE_URL }}/embed","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"texts\": [{{ JSON.stringify($json.embedding_text || '') }}]\n}","options":{"timeout":10000}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[320,496],"id":"embed-projection-text","name":"EmbedProjectionText","continueOnFail":true},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Build embedding insert query for Execute_Queries\nconst prepareData = $('PrepareEmbeddingText').first().json;\nconst embeddings = $json.embeddings;\n\n// Check if we have a valid embedding\nif (!embeddings || !embeddings[0]) {\n  return {};  // Skip if no embedding\n}\n\nconst embeddingVector = '[' + embeddings[0].join(',') + ']';\n\nreturn {\n  json: {\n    ctx: {\n      db_queries: [{\n        key: 'embedding',\n        sql: `-- Insert embedding for the projection (fire-and-forget)\nINSERT INTO embeddings (projection_id, model, embedding_data, embedded_text, embedding)\nSELECT \n  $1::uuid,\n  'all-MiniLM-L6-v2',\n  '{}',\n  $2,\n  $3::vector\nWHERE $3 IS NOT NULL\nON CONFLICT DO NOTHING;`,\n        params: [\n          prepareData.projection_id,\n          prepareData.embedding_text,\n          embeddingVector\n        ]\n      }]\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[544,496],"id":"build-embedding-query","name":"BuildEmbeddingQuery"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[768,496],"id":"insert-embedding","name":"InsertEmbedding","continueOnFail":true}],"connections":{"ExecuteWorkflowTrigger":{"main":[[{"node":"PrepareRouting","type":"main","index":0}]]},"PrepareRouting":{"main":[[{"node":"RouteByType","type":"main","index":0},{"node":"AddTypeReaction","type":"main","index":0},{"node":"RemoveðŸ”µReaction","type":"main","index":0}]]},"RouteByType":{"main":[[{"node":"ActivityClassifier","type":"main","index":0}],[{"node":"NoteClassifier","type":"main","index":0}],[{"node":"TodoClassifier","type":"main","index":0}],[{"node":"NoteClassifier","type":"main","index":0}]]},"ActivityClassifier":{"main":[[{"node":"MergeClassifiers","type":"main","index":0}]]},"NoteClassifier":{"main":[[{"node":"MergeClassifiers","type":"main","index":1}]]},"TodoClassifier":{"main":[[{"node":"MergeClassifiers","type":"main","index":2}]]},"MergeClassifiers":{"main":[[{"node":"ParseClassification","type":"main","index":0}]]},"ParseClassification":{"main":[[{"node":"StoreProjection","type":"main","index":0}]]},"StoreProjection":{"main":[[{"node":"PrepareEmbeddingText","type":"main","index":0},{"node":"LogToKaironLogs","type":"main","index":0}]]},"PrepareEmbeddingText":{"main":[[{"node":"EmbedProjectionText","type":"main","index":0}]]},"EmbedProjectionText":{"main":[[{"node":"BuildEmbeddingQuery","type":"main","index":0}]]},"BuildEmbeddingQuery":{"main":[[{"node":"InsertEmbedding","type":"main","index":0}]]},"MimoV2Flash":{"ai_languageModel":[[{"node":"ActivityClassifier","type":"ai_languageModel","index":0}],[{"node":"NoteClassifier","type":"ai_languageModel","index":0}],[{"node":"TodoClassifier","type":"ai_languageModel","index":0}]]},"NemotronNano9b":{"ai_languageModel":[[{"node":"ActivityClassifier","type":"ai_languageModel","index":1}],[{"node":"NoteClassifier","type":"ai_languageModel","index":1}],[{"node":"TodoClassifier","type":"ai_languageModel","index":1}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"ExecuteWorkflowTrigger":[{"json":{"ctx":{"event":{"event_id":"a67d2dd1-19b1-4ad2-9905-8612b88eee1d","event_type":"discord_message","timestamp":"2025-12-24T09:29:01.706000+00:00","guild_id":"754207117157859388","channel_id":"1450406231146496132","message_id":"1453318541750046741","author_login":"chr15","thread_id":null,"message_url":"https://discord.com/channels/754207117157859388/1450406231146496132/1453318541750046741","raw_text":"..note","clean_text":"note","tag":"..","trace_chain":["a67d2dd1-19b1-4ad2-9905-8612b88eee1d"],"trace_chain_pg":"{a67d2dd1-19b1-4ad2-9905-8612b88eee1d}"},"projection":{"type":"note"}}},"pairedItem":{"item":0}}]},"versionId":"4f350778-fa24-4a92-bc07-afb503c8a1e7","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:18.636Z","createdAt":"2025-12-23T09:30:18.636Z","role":"workflow:owner","workflowId":"Gu9mVRTwvJCq0Fpf","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:53.018Z","createdAt":"2025-12-23T09:30:26.164Z","id":"ZwuxCuNFykFxgD3e","name":"Execute_Command","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-1584,9616],"id":"de6befd4-4882-4e2c-97b1-62f920df6d66","name":"WhenExecutedByAnotherWorkflow"},{"parameters":{"assignments":{"assignments":[{"id":"command","name":"ctx.command.name","value":"={{ $json.ctx.event.clean_text.trim().split(/\\s+/)[0] }}","type":"string"},{"id":"args","name":"ctx.command.args","value":"={{ $json.ctx.event.clean_text.trim().split(/\\s+/).slice(1) }}","type":"array"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1360,9616],"id":"c204a8a7-abe4-45a8-ac75-2d842f69bbd3","name":"ParseCommandAndArgs"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"get","operator":{"type":"string","operation":"equals"},"id":"33cb86c7-ccaf-4e61-bc6a-e8ed32676451"}],"combinator":"and"},"renameOutput":true,"outputKey":"get"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"set","operator":{"type":"string","operation":"equals"},"id":"2150078e-a4bb-4872-bfdb-36245afa5701"}],"combinator":"and"},"renameOutput":true,"outputKey":"set"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"recent","operator":{"type":"string","operation":"equals"},"id":"a807c42d-404f-419d-8129-d7c71ed6051c"}],"combinator":"and"},"renameOutput":true,"outputKey":"recent"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"delete","operator":{"type":"string","operation":"equals"},"id":"d8a3f1e9-2c4b-4d7e-9a1f-3e5c7b9d1a2b"}],"combinator":"and"},"renameOutput":true,"outputKey":"delete"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"stats","operator":{"type":"string","operation":"equals"},"id":"fe31fc91-b7dc-4554-97bf-8024d8f6af25"}],"combinator":"and"},"renameOutput":true,"outputKey":"stats"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"status","operator":{"type":"string","operation":"equals"},"id":"5094be05-8bc0-4702-a6da-ecbd5913c93f"}],"combinator":"and"},"renameOutput":true,"outputKey":"status"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"ping","operator":{"type":"string","operation":"equals"},"id":"9e2a0d1b-6254-4b67-a743-3e5b2367a01c"}],"combinator":"and"},"renameOutput":true,"outputKey":"ping"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"generate","operator":{"type":"string","operation":"equals"},"id":"generate-cmd-id"}],"combinator":"and"},"renameOutput":true,"outputKey":"generate"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"pulse","operator":{"type":"string","operation":"equals"},"id":"pulse-cmd-id"}],"combinator":"and"},"renameOutput":true,"outputKey":"pulse"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"help","operator":{"type":"string","operation":"equals"},"id":"c42b06ed-ca87-489d-a4d8-d2e861db2239"}],"combinator":"and"},"renameOutput":true,"outputKey":"help"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.ctx.command.name }}","rightValue":"modules","operator":{"type":"string","operation":"equals"},"id":"modules-cmd-id"}],"combinator":"and"},"renameOutput":true,"outputKey":"modules"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1136,9504],"id":"82eda145-e9cb-43da-a242-e7bf654ca38e","name":"Switch"},{"parameters":{"jsCode":"// Handle ping command\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\n\nreturn {\n  ctx: {\n    ...ctx,\n    response: {\n      content: 'ðŸ“ pong'\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,10000],"id":"a07e31ae-ae03-4838-b91e-13e3c2f52c86","name":"HandlePing"},{"parameters":{"operation":"executeQuery","query":"SELECT key, value FROM config WHERE key = COALESCE($1, '')","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-464,8816],"id":"c04cc95d-922c-48fb-9004-faf36ff52204","name":"QueryGetConfig","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO config (key, value, updated_at)\nVALUES ($1, $2, NOW())\nON CONFLICT (key) DO UPDATE\nSET value = EXCLUDED.value, updated_at = NOW()\nRETURNING key, value","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-464,9040],"id":"2296ca6d-1789-4986-a245-f2f16e88a92f","name":"QuerySetConfig","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n  (SELECT COUNT(*) FROM projections WHERE projection_type = 'activity' AND status IN ('auto_confirmed', 'confirmed') AND (data->>'timestamp')::timestamptz >= CURRENT_DATE) as activities_today,\n  (SELECT COUNT(*) FROM projections WHERE projection_type = 'note' AND status IN ('auto_confirmed', 'confirmed') AND (data->>'timestamp')::timestamptz >= DATE_TRUNC('week', CURRENT_DATE)) as notes_this_week,\n  (SELECT COUNT(*) FROM events WHERE event_type = 'discord_message') as total_events,\n  (SELECT MAX(received_at) FROM events) as last_activity","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-464,9616],"id":"c1663df9-a24b-4805-aed0-9946a2e5a9cc","name":"QueryStats","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"WITH activities_data AS (\n  SELECT \n    'activity' as type,\n    p.id,\n    (p.data->>'timestamp')::timestamptz as timestamp,\n    p.data->>'category' as category,\n    p.data->>'description' as text,\n    p.data->>'message_url' as message_url\n  FROM projections p\n  WHERE p.projection_type = 'activity'\n    AND p.status IN ('auto_confirmed', 'confirmed')\n    AND ($1::text = '' OR $1::text IN ('activities', 'activity'))\n  ORDER BY (p.data->>'timestamp')::timestamptz DESC\n  LIMIT $2::int\n),\nnotes_data AS (\n  SELECT \n    'note' as type,\n    p.id,\n    (p.data->>'timestamp')::timestamptz as timestamp,\n    p.data->>'category' as category,\n    p.data->>'text' as text,\n    p.data->>'message_url' as message_url\n  FROM projections p\n  WHERE p.projection_type = 'note'\n    AND p.status IN ('auto_confirmed', 'confirmed')\n    AND ($1::text = '' OR $1::text IN ('notes', 'note'))\n  ORDER BY (p.data->>'timestamp')::timestamptz DESC\n  LIMIT $2::int\n),\ntodos_data AS (\n  SELECT \n    'todo' as type,\n    p.id,\n    (p.data->>'timestamp')::timestamptz as timestamp,\n    COALESCE(p.data->>'status', 'pending') as category,\n    p.data->>'text' as text,\n    p.data->>'message_url' as message_url\n  FROM projections p\n  WHERE p.projection_type = 'todo'\n    AND p.status IN ('auto_confirmed', 'confirmed')\n    AND ($1::text = '' OR $1::text IN ('todos', 'todo'))\n  ORDER BY (p.data->>'timestamp')::timestamptz DESC\n  LIMIT $2::int\n)\nSELECT * FROM activities_data\nUNION ALL\nSELECT * FROM notes_data\nUNION ALL\nSELECT * FROM todos_data\nORDER BY timestamp DESC\nLIMIT $2::int;","options":{"queryReplacement":"={{ $json.ctx.validation.normalized_type }},{{ $json.ctx.validation.normalized_limit }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-464,9232],"id":"cdd4aab7-7649-4dd9-9574-3003796f3d3b","name":"QueryRecentEvents","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"WITH user_events AS (\n  SELECT \n    payload->>'author_login' as user_login,\n    MAX(received_at) as last_observation_at\n  FROM events\n  WHERE payload->>'author_login' IS NOT NULL\n  GROUP BY payload->>'author_login'\n  LIMIT 1\n)\nSELECT \n  ue.user_login,\n  ue.last_observation_at,\n  p.data->>'category' as last_activity_category,\n  EXTRACT(EPOCH FROM (NOW() - ue.last_observation_at))/60 as minutes_since_activity\nFROM user_events ue\nLEFT JOIN projections p ON p.projection_type = 'activity' \n  AND p.data->>'timestamp' = (\n    SELECT MAX(data->>'timestamp') \n    FROM projections \n    WHERE projection_type = 'activity'\n  )","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-464,9808],"id":"ace9000d-af6f-4eb7-90ac-6169a08148e9","name":"QueryUserStatus","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Handle help command\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\n\nconst helpText = `ðŸ“š **Kairon Help**\n\n**Message Tags**\nTag your messages to classify them:\n\n\\`!! <message>\\` or \\`act <message>\\` - Log an activity\n\\`.. <message>\\` or \\`note <message>\\` - Capture a note\n\\`++ <message>\\` or \\`chat <message>\\` - Start a conversation thread\n\\`-- <message>\\` or \\`save <message>\\` - Save thread insights (coming soon)\n\\`:: <command>\\` or \\`cmd <command>\\` - Execute a command\n\\`$$ <message>\\` or \\`todo <message>\\` - Create a todo (coming soon)\n\n**Semantic Tagging**\nNo tag? Kairon uses AI to classify your message:\n- First-person actions â†’ !! (activity)\n- Observations/notes â†’ .. (note)\n- Questions/requests â†’ ++ (conversation)\n\n**Commands**\n\n**Configuration:**\n\\`::get <key>\\` - Get a config value\n\\`::set <key> <value>\\` - Set a config value\n\n**Prompt Modules:**\n\\`::modules\\` - List all prompt modules\n\\`::get module <name>\\` - View module details\n\\`::set module <name> on\\` - Enable module\n\\`::set module <name> off\\` - Disable module\n\\`::set module <name> <content>\\` - Update content\n\n**Information:**\n\\`::stats\\` - Show activity statistics\n\\`::recent [type] [N]\\` - Show recent items\n\\`::status\\` - Show your current state\n\n**Data Management:**\n\\`::delete activity <number>\\` - Delete activity by index\n\\`::delete note <number>\\` - Delete note by index\n\n**Generation:**\n\\`::generate summary\\` - Generate daily summary now\n\\`::pulse\\` - Send a pulse message now\n\n**System:**\n\\`::ping\\` - Test if system is working\n\\`::help\\` - Show this message\n\n**Config Keys:**\n- \\`north_star\\` - Your guiding principle\n- \\`summary_time\\` - Daily summary time (HH:MM)\n- \\`timezone\\` - Your timezone (e.g. \\`pacific\\`, \\`vancouver\\`)\n- \\`verbose\\` - Always show projection details (true/false)\n\n**Examples:**\n\\`!! working on the router\\`\n\\`.. John loves dark roast coffee\\`\n\\`::set timezone vancouver\\`\n\\`::modules\\`\n\\`::get module base_persona\\`\n\\`::set module base_persona off\\``;\n\nreturn {\n  ctx: {\n    ...ctx,\n    response: {\n      content: helpText\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,10192],"id":"08ba42dd-9ee4-40fe-bb1a-3f6bf264f200","name":"HandleHelp"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Format get command response - merge DB result into ctx\nconst ctx = $('IfValidGet').first().json.ctx;\nconst result = $input.item?.json;\n\n// Check if query returned data\nif (!result || !result.key || !result.value) {\n  const key = ctx.validation.normalized_key;\n  return {\n    json: {\n        ctx: {\n          ...ctx,\n          response: {\n            content: `âŒ Config key \\`${key}\\` not found.\\n\\nUse \\`::set ${key} <value>\\` to set it first.\\n\\nAvailable keys: north_star, summary_time, verbose`\n          }\n        }\n    }\n  };\n}\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db: { config_key: result.key, config_value: result.value },\n      response: {\n        content: `**${result.key}:** ${result.value}`\n      }\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,8816],"id":"ed79c164-c1c3-40b9-adfb-6cb9d3ca307d","name":"FormatGetResponse"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Format set command response - merge DB result into ctx\nconst ctx = $('IfValidSet').first().json.ctx;\nconst result = $input.item?.json;\n\n// Check if database operation succeeded\nif (!result || !result.key) {\n  return {\n    json: {\n        ctx: {\n          ...ctx,\n          response: {\n            content: `âŒ Failed to set config value. Please try again.`\n          }\n        }\n    }\n  };\n}\n\n// Special confirmation for timezone - show current time\nlet content = `âœ… Set **${result.key}** = ${result.value}`;\nif (result.key === 'timezone') {\n  try {\n    const now = new Date();\n    const timeStr = now.toLocaleString('en-US', { \n      timeZone: result.value, \n      hour: 'numeric', \n      minute: '2-digit',\n      hour12: true \n    });\n    content += `\\n\\nðŸ• Current time: **${timeStr}**`;\n  } catch (e) {\n    // Timezone validation should catch this, but just in case\n  }\n}\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db: { config_key: result.key, config_value: result.value },\n      response: {\n        content\n      }\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,9040],"id":"8e523999-62d1-4f38-8fd3-22e5708e9325","name":"FormatSetResponse"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Format stats response - merge DB result into ctx\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\nconst stats = $input.item?.json;\n\nif (!stats) {\n  return {\n    json: {\n        ctx: {\n          ...ctx,\n          response: {\n            content: `âŒ Unable to retrieve statistics. Please try again.`\n          }\n        }\n    }\n  };\n}\n\nconst lastActivity = stats.last_activity \n  ? new Date(stats.last_activity).toLocaleString()\n  : 'Never';\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db: { stats },\n      response: {\n        content: `ðŸ“Š **Statistics**\\n\\n` +\n          `Activities today: ${stats.activities_today || 0}\\n` +\n          `Notes this week: ${stats.notes_this_week || 0}\\n` +\n          `Total events: ${stats.total_events || 0}\\n` +\n          `Last activity: ${lastActivity}`\n      }\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,9616],"id":"fba83474-329f-4db6-9939-11cfe17a7a3d","name":"FormatStatsResponse"},{"parameters":{"jsCode":"// Format recent items response (numbered list for easy deletion)\nconst ctx = $('IfValidRecent').first().json.ctx;\nconst items = $input.all();\nconst itemType = ctx.validation.normalized_type;\nconst MAX_LENGTH = 1900; // Discord limit is 2000, leave margin for safety\n\nif (!items || items.length === 0) {\n  const typeLabel = itemType || 'projections';\n  return {\n    ctx: {\n      ...ctx,\n      response: {\n        content: `ðŸ“­ No recent ${typeLabel} found`\n      }\n    }\n  };\n}\n\n// Determine if mixed types or single type\nconst types = [...new Set(items.map(i => i.json.type))];\nconst isMixed = types.length > 1 || itemType === '';\n\n// Icons for each type (match bot confirmation emojis)\nconst icons = { activity: 'ðŸ”˜', note: 'ðŸ“', todo: 'âœ…' };\nconst titles = { activity: 'Activities', note: 'Notes', todo: 'Todos' };\n\nlet title, icon;\nif (isMixed) {\n  icon = 'ðŸ“‹';\n  title = 'Recent Projections';\n} else {\n  const firstType = items[0].json.type;\n  icon = icons[firstType] || 'ðŸ“‹';\n  title = titles[firstType] || 'Items';\n}\n\nlet responseText = `${icon} **${title} (${items.length})**\n\n`;\nlet itemsShown = 0;\nlet truncated = false;\n\nfor (let i = 0; i < items.length; i++) {\n  const data = items[i].json;\n  const dt = DateTime.fromISO(data.timestamp, { zone: 'utc' }).setZone('America/Los_Angeles');\n  const dateStr = dt.toFormat('MMM d');\n  const timeStr = dt.toFormat('HH:mm');\n  \n  const text = data.text && data.text.length > 50 \n    ? data.text.substring(0, 50) + '...' \n    : (data.text || '(no text)');\n  \n  // Build Discord message link from message_url in projection data\n  let link = '';\n  if (data.message_url) {\n    link = ` [â†—](${data.message_url})`;\n  }\n  \n  // Type indicator for mixed view\n  const typeIcon = isMixed ? `${icons[data.type] || 'â€¢'} ` : '';\n  \n  const line = `${i + 1}. ${typeIcon}${dateStr} ${timeStr} - **${data.category}** - ${text}${link}\n`;\n  \n  // Check if adding this line would exceed limit\n  if (responseText.length + line.length > MAX_LENGTH - 100) {\n    truncated = true;\n    break;\n  }\n  \n  responseText += line;\n  itemsShown++;\n}\n\n// Add truncation notice if needed\nif (truncated) {\n  responseText += `\n... and ${items.length - itemsShown} more (use a smaller limit)`;\n}\n\n// Add delete hint based on type\nif (!isMixed && !truncated) {\n  const deleteType = items[0].json.type;\n  responseText += `\nðŸ’¡ Use \\`::delete ${deleteType} <number>\\` to delete items`;\n}\n\nreturn {\n  ctx: {\n    ...ctx,\n    db: { recent_items: items.map(i => i.json) },\n    response: {\n      content: responseText\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,9232],"id":"a38c0645-066f-4591-b097-de21fb82b1c1","name":"FormatRecentResponse"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Format status response - merge DB result into ctx\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\nconst status = $input.item?.json;\n\nif (!status) {\n  return {\n    json: {\n        ctx: {\n          ...ctx,\n          response: {\n            content: `âŒ Unable to retrieve status. Please try again.`\n          }\n        }\n    }\n  };\n}\n\nconst isSleeping = status.last_activity_category === 'sleep';\nconst sleepIcon = isSleeping ? 'ðŸ˜´' : 'ðŸ‘ï¸';\nconst sleepStatus = isSleeping ? 'Sleeping' : 'Awake';\nconst lastActivity = status.last_observation_at\n  ? new Date(status.last_observation_at).toLocaleString()\n  : 'Never';\nconst minutesAgo = Math.round(status.minutes_since_activity || 0);\nconst lastCategory = status.last_activity_category || 'unknown';\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      db: { user_status: status },\n      response: {\n        content: `${sleepIcon} **Status**\\n\\n` +\n          `State: ${sleepStatus}\\n` +\n          `Last activity: ${lastActivity}\\n` +\n          `Last category: ${lastCategory}\\n` +\n          `Time since: ${minutesAgo} minutes ago`\n      }\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,9808],"id":"6e1f0ee3-6930-49e6-a76a-3a5b85d942f3","name":"FormatStatusResponse"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Unknown command handler\nconst ctx = $json.ctx;\nconst command = ctx.command?.name || 'unknown';\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      response: {\n        content: `âŒ Unknown command: \\`${command}\\`\\n\\nUse \\`::help\\` to see available commands.`\n      }\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,10384],"id":"f76de764-c075-42cc-95e3-538852ab8b22","name":"HandleUnknownCommand"},{"parameters":{"operation":"executeQuery","query":"-- Void projection by index (1-based position in recent list) - NEVER DELETE\nWITH input_array AS (\n  SELECT ARRAY[\n    NULLIF($2, '')::int,\n    NULLIF($3, '')::int,\n    NULLIF($4, '')::int,\n    NULLIF($5, '')::int,\n    NULLIF($6, '')::int,\n    NULLIF($7, '')::int,\n    NULLIF($8, '')::int,\n    NULLIF($9, '')::int,\n    NULLIF($10, '')::int\n  ] as indices\n),\ntarget_indices AS (\n  SELECT (unnest(indices) - 1) AS idx\n  FROM input_array\n),\nrecent_activities AS (\n  SELECT \n    p.id,\n    (p.data->>'timestamp')::timestamptz as timestamp,\n    p.data->>'description' as text,\n    'activity' as type,\n    (ROW_NUMBER() OVER (ORDER BY (p.data->>'timestamp')::timestamptz DESC) - 1) as idx\n  FROM projections p\n  WHERE p.projection_type = 'activity'\n    AND p.status IN ('auto_confirmed', 'confirmed')\n    AND $1::text = 'activity'\n  ORDER BY (p.data->>'timestamp')::timestamptz DESC\n  LIMIT 100\n),\nrecent_notes AS (\n  SELECT \n    p.id,\n    (p.data->>'timestamp')::timestamptz as timestamp,\n    p.data->>'text' as text,\n    'note' as type,\n    (ROW_NUMBER() OVER (ORDER BY (p.data->>'timestamp')::timestamptz DESC) - 1) as idx\n  FROM projections p\n  WHERE p.projection_type = 'note'\n    AND p.status IN ('auto_confirmed', 'confirmed')\n    AND $1::text = 'note'\n  ORDER BY (p.data->>'timestamp')::timestamptz DESC\n  LIMIT 100\n),\nvoided_activities AS (\n  UPDATE projections\n  SET status = 'voided',\n      voided_at = NOW(),\n      voided_reason = 'user_deleted'\n  WHERE id IN (\n    SELECT ra.id FROM recent_activities ra\n    INNER JOIN target_indices ti ON ra.idx = ti.idx\n  )\n  RETURNING id, (data->>'timestamp')::timestamptz as timestamp, data->>'description' as text, 'activity' as type\n),\nvoided_notes AS (\n  UPDATE projections\n  SET status = 'voided',\n      voided_at = NOW(),\n      voided_reason = 'user_deleted'\n  WHERE id IN (\n    SELECT rn.id FROM recent_notes rn\n    INNER JOIN target_indices ti ON rn.idx = ti.idx\n  )\n  RETURNING id, (data->>'timestamp')::timestamptz as timestamp, data->>'text' as text, 'note' as type\n)\nSELECT * FROM voided_activities\nUNION ALL\nSELECT * FROM voided_notes;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-464,9424],"id":"9eca4f90-6b61-48e7-8fd6-295adcdca359","name":"VoidProjections","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Format void response (index-based soft-delete)\nconst ctx = $('IfValidDelete').first().json.ctx;\nconst voided = $input.all();\nconst itemType = ctx.validation.normalized_item_type || 'activity';\nconst indices = ctx.validation.indices || [];\n\n// Check if any items were actually voided\nif (!voided || voided.length === 0) {\n  const indexStr = indices.join(', ');\n  return {\n    ctx: {\n      ...ctx,\n      response: {\n        content: `âŒ No ${itemType}s found at position(s): ${indexStr}\\n\\nUse \\`::recent ${itemType}s\\` to see the current numbered list.`\n      }\n    }\n  };\n}\n\nif (voided.length === 1) {\n  const item = voided[0].json;\n  const text = item.text.length > 60 ? item.text.substring(0, 60) + '...' : item.text;\n  return {\n    ctx: {\n      ...ctx,\n      db: { voided_items: [item] },\n      response: {\n        content: `âœ… Removed ${item.type} #${indices[0]}: \"${text}\"`\n      }\n    }\n  };\n}\n\nconst typeLabel = voided[0].json.type === 'activity' ? 'activities' : 'notes';\nreturn {\n  ctx: {\n    ...ctx,\n    db: { voided_items: voided.map(d => d.json) },\n    response: {\n      content: `âœ… Removed ${voided.length} ${typeLabel} at positions: ${indices.join(', ')}`\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,9424],"id":"1bc87344-c616-42bd-8fe4-8882e2174430","name":"FormatVoidResponse"},{"parameters":{"jsCode":"// Validate GET command\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\nconst args = $('ParseCommandAndArgs').first()?.json?.ctx?.command?.args || [];\n\n// Check for module subcommand: ::get module <name>\nif (args[0] === 'module' || args[0] === 'modules') {\n  const moduleName = args[1];\n  \n  if (!moduleName) {\n    return {\n      ctx: {\n        ...ctx,\n        validation: {\n          valid: false,\n          error_message: `âŒ Missing module name. Syntax: \\`::get module <name>\\`\\n\\nUse \\`::modules\\` to see available modules.`\n        }\n      }\n    };\n  }\n  \n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: true,\n        target: 'module',\n        module_name: moduleName\n      }\n    }\n  };\n}\n\n// Standard config get\nconst key = args.join('_');\n\nif (!key || key.trim() === '') {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Missing config key. Syntax: \\`::get <key>\\`\\n\\nAvailable keys: north_star, summary_time, timezone, verbose\\nFor modules: \\`::get module <name>\\`\\nUse \\`::help\\` for more info.`\n      }\n    }\n  };\n}\n\nreturn {\n  ctx: {\n    ...ctx,\n    validation: {\n      valid: true,\n      target: 'config',\n      normalized_key: key\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-912,8768],"id":"b665e2c9-44f1-48ed-a0dc-5ab2cae4e2ed","name":"ValidateGet"},{"parameters":{"jsCode":"// Validate SET command\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\nconst args = $('ParseCommandAndArgs').first()?.json?.ctx?.command?.args || [];\n\n// Check for module subcommand: ::set module <name> <on|off|content>\nif (args[0] === 'module' || args[0] === 'modules') {\n  const moduleName = args[1];\n  const action = args[2];\n  \n  if (!moduleName) {\n    return {\n      ctx: {\n        ...ctx,\n        validation: {\n          valid: false,\n          error_message: `âŒ Missing module name. Syntax:\\n\\`::set module <name> on\\` - Enable module\\n\\`::set module <name> off\\` - Disable module\\n\\`::set module <name> <content>\\` - Update content\\n\\nUse \\`::modules\\` to see available modules.`\n        }\n      }\n    };\n  }\n  \n  if (!action) {\n    return {\n      ctx: {\n        ...ctx,\n        validation: {\n          valid: false,\n          error_message: `âŒ Missing action. Syntax:\\n\\`::set module ${moduleName} on\\` - Enable\\n\\`::set module ${moduleName} off\\` - Disable\\n\\`::set module ${moduleName} <content>\\` - Update content`\n        }\n      }\n    };\n  }\n  \n  // Check for on/off toggle\n  if (action.toLowerCase() === 'on') {\n    return {\n      ctx: {\n        ...ctx,\n        validation: {\n          valid: true,\n          target: 'module',\n          operation: 'toggle',\n          module_name: moduleName,\n          new_active: true\n        }\n      }\n    };\n  }\n  \n  if (action.toLowerCase() === 'off') {\n    return {\n      ctx: {\n        ...ctx,\n        validation: {\n          valid: true,\n          target: 'module',\n          operation: 'toggle',\n          module_name: moduleName,\n          new_active: false\n        }\n      }\n    };\n  }\n  \n  // Otherwise it's a content update - join all remaining args\n  const newContent = args.slice(2).join(' ');\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: true,\n        target: 'module',\n        operation: 'update',\n        module_name: moduleName,\n        new_content: newContent\n      }\n    }\n  };\n}\n\n// Standard config set - need at least 2 args (key and value)\nif (!args || args.length < 2) {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Missing arguments. Syntax: \\`::set <key> <value>\\`\\n\\nExample: \\`::set north_star Be present and intentional\\`\\nFor modules: \\`::set module <name> on|off|<content>\\`\\n\\nAvailable keys: north_star, summary_time, timezone, verbose`\n      }\n    }\n  };\n}\n\nconst key = args[0];\nif (!key || key.trim() === '') {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Invalid config key (empty string).\\n\\nExample: \\`::set north_star <your principle>\\``\n      }\n    }\n  };\n}\n\nlet valToSet = args.slice(1).join(' ');\n\n// Special handling for verbose key\nif (key === 'verbose') {\n  const val = valToSet.toLowerCase().trim();\n  if (val !== 'true' && val !== 'false') {\n    return {\n      ctx: {\n        ...ctx,\n        validation: {\n          valid: false,\n          error_message: `âŒ Invalid value for \\`verbose\\`. Use \\`true\\` or \\`false\\`.`\n        }\n      }\n    };\n  }\n  valToSet = val;\n}\n\n// Special handling for timezone key\nif (key === 'timezone' || key === 'tz') {\n  const input = valToSet.toLowerCase().trim();\n  \n  const aliases = {\n    'pacific': 'America/Los_Angeles',\n    'pst': 'America/Los_Angeles',\n    'pdt': 'America/Los_Angeles',\n    'la': 'America/Los_Angeles',\n    'los angeles': 'America/Los_Angeles',\n    'vancouver': 'America/Vancouver',\n    'seattle': 'America/Los_Angeles',\n    'sf': 'America/Los_Angeles',\n    'mountain': 'America/Denver',\n    'mst': 'America/Denver',\n    'mdt': 'America/Denver',\n    'denver': 'America/Denver',\n    'central': 'America/Chicago',\n    'cst': 'America/Chicago',\n    'cdt': 'America/Chicago',\n    'chicago': 'America/Chicago',\n    'eastern': 'America/New_York',\n    'est': 'America/New_York',\n    'edt': 'America/New_York',\n    'new york': 'America/New_York',\n    'nyc': 'America/New_York',\n    'toronto': 'America/Toronto',\n    'utc': 'UTC',\n    'gmt': 'UTC',\n    'london': 'Europe/London',\n    'uk': 'Europe/London',\n    'paris': 'Europe/Paris',\n    'berlin': 'Europe/Berlin',\n    'tokyo': 'Asia/Tokyo',\n    'sydney': 'Australia/Sydney',\n    'melbourne': 'Australia/Melbourne'\n  };\n  \n  const resolved = aliases[input] || valToSet;\n  \n  try {\n    const testDate = new Date();\n    testDate.toLocaleString('en-US', { timeZone: resolved });\n    valToSet = resolved;\n  } catch (e) {\n    return {\n      ctx: {\n        ...ctx,\n        validation: {\n          valid: false,\n          error_message: `âŒ Invalid timezone: \\`${valToSet}\\`\\n\\nExamples: \\`pacific\\`, \\`vancouver\\`, \\`America/Los_Angeles\\``\n        }\n      }\n    };\n  }\n}\n\nreturn {\n  ctx: {\n    ...ctx,\n    validation: {\n      valid: true,\n      target: 'config',\n      normalized_key: key === 'tz' ? 'timezone' : key,\n      normalized_value: valToSet\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-912,8960],"id":"14603be3-d751-4be9-a5a1-46ad5f7249a7","name":"ValidateSet"},{"parameters":{"jsCode":"// Validate DELETE command (uses indices, not short IDs)\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\nconst args = $('ParseCommandAndArgs').first()?.json?.ctx?.command?.args || [];\nconst itemType = args[0];\n\n// Validation: need item type (activity/note)\nif (!itemType || !['activity', 'note', 'activities', 'notes'].includes(itemType)) {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Invalid item type. Syntax: \\`::delete activity <index>\\` or \\`::delete note <index>\\`\\n\\nUse \\`::recent activities\\` or \\`::recent notes\\` to see numbered list.`\n      }\n    }\n  };\n}\n\n// Validation: need at least one index\nif (args.length < 2 || !args[1]) {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Missing index. Syntax: \\`::delete ${itemType} <index>\\`\\n\\nExample: \\`::delete ${itemType} 1\\` (deletes first item)\\nUse \\`::recent ${itemType === 'activity' || itemType === 'activities' ? 'activities' : 'notes'}\\` to see numbered list.`\n      }\n    }\n  };\n}\n\n// Validation: check indices are valid numbers (1-100)\nconst indices = args.slice(1).filter(arg => arg !== null && arg !== undefined);\nconst invalidIndices = [];\nconst validIndices = [];\n\nfor (const idx of indices) {\n  const num = parseInt(idx);\n  if (isNaN(num) || num < 1 || num > 100) {\n    invalidIndices.push(idx);\n  } else {\n    validIndices.push(num);\n  }\n}\n\nif (invalidIndices.length > 0) {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Invalid index: ${invalidIndices.join(', ')}\\n\\nIndices must be numbers between 1 and 100.\\nUse \\`::recent ${itemType === 'activity' || itemType === 'activities' ? 'activities' : 'notes'}\\` to see numbered list.`\n      }\n    }\n  };\n}\n\nif (validIndices.length === 0) {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ No valid indices provided.\\n\\nExample: \\`::delete ${itemType} 1 2 3\\``\n      }\n    }\n  };\n}\n\n// Normalize type to singular form\nconst normalizedItemType = itemType === 'activities' ? 'activity' : (itemType === 'notes' ? 'note' : itemType);\n\n// Valid - pass normalized values and indices\nreturn {\n  ctx: {\n    ...ctx,\n    validation: {\n      valid: true,\n      normalized_item_type: normalizedItemType,\n      indices: validIndices\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-912,9344],"id":"99805555-a99c-4559-b170-f18f40233457","name":"ValidateDelete"},{"parameters":{"jsCode":"// Validate RECENT command\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\nconst args = $('ParseCommandAndArgs').first()?.json?.ctx?.command?.args || [];\n\n// Default values - empty string means show all projections\nconst itemType = args[0] || '';\nconst limit = args[1] ? parseInt(args[1]) : 10;\n\n// Validation: check item type is valid\nconst validTypes = ['activities', 'activity', 'notes', 'note', 'todos', 'todo', ''];\nif (!validTypes.includes(itemType)) {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Invalid item type: \\`${itemType}\\`\\n\\nValid types: activities, notes, todos (or blank for all)\\nSyntax: \\`::recent [activities|notes|todos] [limit]\\`\\n\\nExample: \\`::recent todos 20\\``\n      }\n    }\n  };\n}\n\n// Validation: check limit is a valid number (1-100)\nif (isNaN(limit) || limit < 1 || limit > 100) {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Invalid limit: \\`${args[1]}\\`\\n\\nLimit must be a number between 1 and 100.\\nExample: \\`::recent activities 20\\``\n      }\n    }\n  };\n}\n\n// Normalize type to plural form for query\nlet normalizedType = itemType;\nif (itemType === 'activity') normalizedType = 'activities';\nelse if (itemType === 'note') normalizedType = 'notes';\nelse if (itemType === 'todo') normalizedType = 'todos';\n\n// Valid - pass normalized values\nreturn {\n  ctx: {\n    ...ctx,\n    validation: {\n      valid: true,\n      normalized_type: normalizedType,\n      normalized_limit: limit\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-912,9152],"id":"4bf45858-8e0b-4aca-8713-44bf3f9627ab","name":"ValidateRecent"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"valid-check-recent","leftValue":"={{ $json.ctx.validation.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-688,9152],"id":"db6e02d4-93be-4ebf-b85a-96aade6217dd","name":"IfValidRecent"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"valid-check","leftValue":"={{ $json.ctx.validation.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-688,8768],"id":"0cb57d2d-bb81-4fd9-a1c8-6d4b3d2f8868","name":"IfValidGet"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"valid-check","leftValue":"={{ $json.ctx.validation.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-688,8960],"id":"dbbb373a-e421-44cb-acdf-9ddd121a659d","name":"IfValidSet"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"valid-check","leftValue":"={{ $json.ctx.validation.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-688,9344],"id":"f2b3226c-7f08-4e93-9684-8467d9fd3458","name":"IfValidDelete"},{"parameters":{"resource":"message","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.response.channel_id || $json.ctx.event.channel_id }}","mode":"id"},"content":"={{ $json.ctx.response.content }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[-16,9664],"id":"4ed54e00-c7e3-4db6-94c0-c525d95534e3","name":"SendResponse","webhookId":"26f551ce-e3bd-40ae-953b-33588a9edcd8","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"method":"DELETE","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/ðŸ”µ/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1360,9808],"id":"remove-blue-reaction-execute-cmd","name":"RemoveðŸ”µReaction","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"message","operation":"react","guildId":{"__rl":true,"value":"={{ $json.ctx.event.guild_id }}","mode":"id"},"channelId":{"__rl":true,"value":"={{ $json.ctx.event.channel_id }}","mode":"id"},"messageId":"={{ $json.ctx.event.message_id }}","emoji":"=ðŸ’»"},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[-1360,9424],"id":"e5ebd093-f037-4d4a-94a8-5830869a2dbc","name":"ReactWithðŸ’»","webhookId":"7d6473eb-7f05-4fc7-ba61-8a8ae16deae0","retryOnFail":true,"maxTries":3,"waitBetweenTries":1000,"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Validate GENERATE command\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\nconst args = $('ParseCommandAndArgs').first()?.json?.ctx?.command?.args || [];\nconst generateType = args[0]?.toLowerCase();\n\n// Valid types: summary, nudge, pulse\nconst validTypes = ['summary', 'nudge', 'pulse'];\n\nif (!generateType) {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Missing type. Syntax: \\`::generate <type>\\`\\n\\nValid types:\\n- \\`summary\\` - Generate daily summary now\\n- \\`pulse\\` - Send pulse now`\n      }\n    }\n  };\n}\n\nif (!validTypes.includes(generateType)) {\n  return {\n    ctx: {\n      ...ctx,\n      validation: {\n        valid: false,\n        error_message: `âŒ Invalid type: \\`${generateType}\\`\\n\\nValid types: summary, pulse`\n      }\n    }\n  };\n}\n\nreturn {\n  ctx: {\n    ...ctx,\n    validation: {\n      valid: true,\n      generate_type: generateType === 'pulse' ? 'nudge' : generateType\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-912,9536],"id":"validate-generate","name":"ValidateGenerate"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"valid-check-generate","leftValue":"={{ $json.ctx.validation.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-688,9536],"id":"if-valid-generate","name":"IfValidGenerate"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-nudge","leftValue":"={{ $json.ctx.validation.generate_type }}","rightValue":"nudge","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"nudge"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-summary","leftValue":"={{ $json.ctx.validation.generate_type }}","rightValue":"summary","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"summary"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-464,9536],"id":"switch-generate-type","name":"SwitchGenerateType"},{"parameters":{"workflowId":{"__rl":true,"value":"ujGErhNkQv4hkJxB","mode":"list","cachedResultName":"Generate_Nudge","cachedResultUrl":"/workflow/ujGErhNkQv4hkJxB"},"workflowInputs":{"mappingMode":"defineBelow","value":{"trigger_reason":"manual"},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-240,9472],"id":"execute-nudge","name":"ExecuteGenerateNudge"},{"parameters":{"workflowId":{"__rl":true,"value":"tpkLfvOCAeN5YzMR","mode":"list","cachedResultName":"Generate_Daily_Summary","cachedResultUrl":"/workflow/tpkLfvOCAeN5YzMR"},"workflowInputs":{"mappingMode":"defineBelow","value":{"trigger_reason":"manual"},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-240,9600],"id":"execute-summary","name":"ExecuteGenerateDailySummary"},{"parameters":{"jsCode":"// Format response for generate command\nconst ctx = $('IfValidGenerate').first().json.ctx;\nconst generateType = ctx.validation.generate_type;\nconst typeLabel = generateType === 'summary' ? 'daily summary' : 'pulse';\n\nreturn {\n  ctx: {\n    ...ctx,\n    response: {\n      content: `âœ… Generating ${typeLabel}...`,\n      channel_id: $env.DISCORD_CHANNEL_KAIRON_LOGS\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-16,9536],"id":"format-generate-response","name":"FormatGenerateResponse"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Format validation error for response\nconst ctx = $json.ctx;\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      response: {\n        content: ctx.validation.error_message\n      }\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-16,9856],"id":"send-error-message","name":"SendErrorMessage"},{"parameters":{"operation":"executeQuery","query":"SELECT name, module_type, active, priority, array_length(tags, 1) as tag_count\nFROM prompt_modules\nORDER BY module_type, priority, name","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-464,10576],"id":"query-list-modules","name":"QueryListModules","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Format modules list response\nconst ctx = $('WhenExecutedByAnotherWorkflow').first().json.ctx;\nconst modules = $input.all();\n\nif (!modules || modules.length === 0) {\n  return {\n    ctx: {\n      ...ctx,\n      response: {\n        content: `ðŸ“­ No prompt modules found.`\n      }\n    }\n  };\n}\n\n// Group by module_type\nconst byType = {};\nfor (const mod of modules) {\n  const m = mod.json;\n  const type = m.module_type || 'unknown';\n  if (!byType[type]) byType[type] = [];\n  byType[type].push(m);\n}\n\nconst typeIcons = {\n  persona: 'ðŸŽ­',\n  technique: 'ðŸ§ ',\n  guardrail: 'ðŸ›¡ï¸',\n  format: 'ðŸ“',\n  context: 'ðŸ“Š'\n};\n\nlet response = `ðŸ§© **Prompt Modules (${modules.length})**\\n\\n`;\n\nfor (const [type, mods] of Object.entries(byType)) {\n  const icon = typeIcons[type] || 'â€¢';\n  response += `**${icon} ${type}**\\n`;\n  for (const m of mods) {\n    const status = m.active ? 'âœ…' : 'âŒ';\n    response += `  ${status} \\`${m.name}\\` (priority: ${m.priority})\\n`;\n  }\n  response += '\\n';\n}\n\nresponse += `ðŸ’¡ Use \\`::module <name>\\` to view details\\n`;\nresponse += `ðŸ’¡ Use \\`::module <name> on/off\\` to toggle`;\n\nreturn {\n  ctx: {\n    ...ctx,\n    response: {\n      content: response\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,10576],"id":"format-modules-response","name":"FormatModulesResponse"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-view","leftValue":"={{ $json.ctx.validation.operation }}","rightValue":"view","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"view"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-toggle","leftValue":"={{ $json.ctx.validation.operation }}","rightValue":"toggle","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"toggle"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-update","leftValue":"={{ $json.ctx.validation.operation }}","rightValue":"update","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"update"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-464,10768],"id":"switch-module-operation","name":"SwitchModuleOperation"},{"parameters":{"operation":"executeQuery","query":"SELECT id, name, content, module_type, tags, priority, active, created_at, updated_at\nFROM prompt_modules\nWHERE name = $1","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-240,10672],"id":"query-view-module","name":"QueryViewModule","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE prompt_modules\nSET active = $2, updated_at = NOW()\nWHERE name = $1\nRETURNING name, active","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-240,10864],"id":"query-toggle-module","name":"QueryToggleModule","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE prompt_modules\nSET content = $2, updated_at = NOW()\nWHERE name = $1\nRETURNING name, content","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-240,11056],"id":"query-update-module","name":"QueryUpdateModule","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Format view module response\n// Can be called from ::get module <name> or ::module <name> (if we keep that)\nconst allItems = $input.all();\n\n// Find the ctx - could be from different sources\nlet ctx = null;\nfor (const item of allItems) {\n  if (item.json.ctx) {\n    ctx = item.json.ctx;\n    break;\n  }\n}\n\n// Fallback to input item\nif (!ctx) {\n  ctx = $json.ctx;\n}\n\nconst result = $input.item?.json;\nconst moduleName = ctx?.validation?.module_name || 'unknown';\n\nif (!result || !result.name) {\n  return [{\n    json: {\n        ctx: {\n          ...ctx,\n          response: {\n            content: `âŒ Module \\`${moduleName}\\` not found.\\n\\nUse \\`::modules\\` to see available modules.`\n          }\n        }\n    }\n  };\n}\n\nconst statusIcon = result.active ? 'âœ…' : 'âŒ';\nconst status = result.active ? 'Active' : 'Inactive';\nconst tags = result.tags?.length > 0 ? result.tags.join(', ') : '(none)';\n\n// Truncate content if too long for Discord\nlet content = result.content;\nif (content.length > 1000) {\n  content = content.substring(0, 1000) + '...';\n}\n\nconst response = `ðŸ§© **Module: ${result.name}**\\n\\n` +\n  `**Type:** ${result.module_type}\\n` +\n  `**Status:** ${statusIcon} ${status}\\n` +\n  `**Priority:** ${result.priority}\\n` +\n  `**Tags:** ${tags}\\n\\n` +\n  `**Content:**\\n\\`\\`\\`\\n${content}\\n\\`\\`\\`\\n\\n` +\n  `ðŸ’¡ \\`::set module ${result.name} on/off\\` to toggle\\n` +\n  `ðŸ’¡ \\`::set module ${result.name} <content>\\` to update`;\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      response: {\n        content: response\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-16,10672],"id":"format-view-module-response","name":"FormatViewModuleResponse"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Format toggle module response\nconst ctx = $json.ctx;\nconst result = $json;\nconst moduleName = ctx?.validation?.module_name || 'unknown';\n\nif (!result || !result.name) {\n  return {\n    json: {\n        ctx: {\n          ...ctx,\n          response: {\n            content: `âŒ Module \\`${moduleName}\\` not found.\\n\\nUse \\`::modules\\` to see available modules.`\n          }\n        }\n    }\n  };\n}\n\nconst statusIcon = result.active ? 'âœ…' : 'âŒ';\nconst status = result.active ? 'enabled' : 'disabled';\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      response: {\n        content: `${statusIcon} Module \\`${result.name}\\` ${status}`\n      }\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-16,10864],"id":"format-toggle-module-response","name":"FormatToggleModuleResponse"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Format update module response\nconst ctx = $json.ctx;\nconst result = $json;\nconst moduleName = ctx?.validation?.module_name || 'unknown';\n\nif (!result || !result.name) {\n  return {\n    json: {\n        ctx: {\n          ...ctx,\n          response: {\n            content: `âŒ Module \\`${moduleName}\\` not found.\\n\\nUse \\`::modules\\` to see available modules.`\n          }\n        }\n    }\n  };\n}\n\n// Show preview of new content\nlet preview = result.content;\nif (preview.length > 100) {\n  preview = preview.substring(0, 100) + '...';\n}\n\nreturn {\n  json: {\n    ctx: {\n      ...ctx,\n      response: {\n        content: `âœ… Updated module \\`${result.name}\\`\\n\\n**New content:** ${preview}`\n      }\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-16,11056],"id":"format-update-module-response","name":"FormatUpdateModuleResponse"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-config","leftValue":"={{ $json.ctx.validation.target }}","rightValue":"config","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"config"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-module","leftValue":"={{ $json.ctx.validation.target }}","rightValue":"module","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"module"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-560,8768],"id":"switch-get-target","name":"SwitchGetTarget"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-config","leftValue":"={{ $json.ctx.validation.target }}","rightValue":"config","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"config"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-module","leftValue":"={{ $json.ctx.validation.target }}","rightValue":"module","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"module"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-560,8960],"id":"switch-set-target","name":"SwitchSetTarget"}],"connections":{"WhenExecutedByAnotherWorkflow":{"main":[[{"node":"ParseCommandAndArgs","type":"main","index":0},{"node":"RemoveðŸ”µReaction","type":"main","index":0},{"node":"ReactWithðŸ’»","type":"main","index":0}]]},"ParseCommandAndArgs":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"ValidateGet","type":"main","index":0}],[{"node":"ValidateSet","type":"main","index":0}],[{"node":"ValidateRecent","type":"main","index":0}],[{"node":"ValidateDelete","type":"main","index":0}],[{"node":"QueryStats","type":"main","index":0}],[{"node":"QueryUserStatus","type":"main","index":0}],[{"node":"HandlePing","type":"main","index":0}],[{"node":"ValidateGenerate","type":"main","index":0}],[{"node":"ValidateGenerate","type":"main","index":0}],[{"node":"HandleHelp","type":"main","index":0}],[{"node":"QueryListModules","type":"main","index":0}],[{"node":"HandleUnknownCommand","type":"main","index":0}],[]]},"HandlePing":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"QueryGetConfig":{"main":[[{"node":"FormatGetResponse","type":"main","index":0}]]},"QuerySetConfig":{"main":[[{"node":"FormatSetResponse","type":"main","index":0}]]},"QueryStats":{"main":[[{"node":"FormatStatsResponse","type":"main","index":0}]]},"QueryRecentEvents":{"main":[[{"node":"FormatRecentResponse","type":"main","index":0}]]},"QueryUserStatus":{"main":[[{"node":"FormatStatusResponse","type":"main","index":0}]]},"HandleHelp":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"FormatGetResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"FormatSetResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"FormatStatsResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"FormatRecentResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"FormatStatusResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"HandleUnknownCommand":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"VoidProjections":{"main":[[{"node":"FormatVoidResponse","type":"main","index":0}]]},"FormatVoidResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"ValidateGet":{"main":[[{"node":"IfValidGet","type":"main","index":0}]]},"ValidateSet":{"main":[[{"node":"IfValidSet","type":"main","index":0}]]},"ValidateDelete":{"main":[[{"node":"IfValidDelete","type":"main","index":0}]]},"ValidateRecent":{"main":[[{"node":"IfValidRecent","type":"main","index":0}]]},"IfValidRecent":{"main":[[{"node":"QueryRecentEvents","type":"main","index":0}],[{"node":"SendErrorMessage","type":"main","index":0}]]},"IfValidGet":{"main":[[{"node":"SwitchGetTarget","type":"main","index":0}],[{"node":"SendErrorMessage","type":"main","index":0}]]},"IfValidSet":{"main":[[{"node":"SwitchSetTarget","type":"main","index":0}],[{"node":"SendErrorMessage","type":"main","index":0}]]},"IfValidDelete":{"main":[[{"node":"VoidProjections","type":"main","index":0}],[{"node":"SendErrorMessage","type":"main","index":0}]]},"SendResponse":{"main":[[]]},"SendErrorMessage":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"ValidateGenerate":{"main":[[{"node":"IfValidGenerate","type":"main","index":0}]]},"IfValidGenerate":{"main":[[{"node":"SwitchGenerateType","type":"main","index":0}],[{"node":"SendErrorMessage","type":"main","index":0}]]},"SwitchGenerateType":{"main":[[{"node":"ExecuteGenerateNudge","type":"main","index":0}],[{"node":"ExecuteGenerateDailySummary","type":"main","index":0}]]},"ExecuteGenerateNudge":{"main":[[{"node":"FormatGenerateResponse","type":"main","index":0}]]},"ExecuteGenerateDailySummary":{"main":[[{"node":"FormatGenerateResponse","type":"main","index":0}]]},"FormatGenerateResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"QueryListModules":{"main":[[{"node":"FormatModulesResponse","type":"main","index":0}]]},"FormatModulesResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"SwitchModuleOperation":{"main":[[{"node":"QueryViewModule","type":"main","index":0}],[{"node":"QueryToggleModule","type":"main","index":0}],[{"node":"QueryUpdateModule","type":"main","index":0}]]},"QueryViewModule":{"main":[[{"node":"FormatViewModuleResponse","type":"main","index":0}]]},"QueryToggleModule":{"main":[[{"node":"FormatToggleModuleResponse","type":"main","index":0}]]},"QueryUpdateModule":{"main":[[{"node":"FormatUpdateModuleResponse","type":"main","index":0}]]},"FormatViewModuleResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"FormatToggleModuleResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"FormatUpdateModuleResponse":{"main":[[{"node":"SendResponse","type":"main","index":0}]]},"SwitchGetTarget":{"main":[[{"node":"QueryGetConfig","type":"main","index":0}],[{"node":"QueryViewModule","type":"main","index":0}],[]]},"SwitchSetTarget":{"main":[[{"node":"QuerySetConfig","type":"main","index":0}],[{"node":"SwitchModuleOperation","type":"main","index":0}],[]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"WhenExecutedByAnotherWorkflow":[{"json":{"ctx":{"event":{"event_id":"d9080bbe-958f-452a-a145-ac9481e6e73d","event_type":"discord_message","timestamp":"2025-12-24T10:15:46.039000+00:00","guild_id":"754207117157859388","channel_id":"1450406231146496132","message_id":"1453330303975424101","author_login":"chr15","thread_id":null,"message_url":"https://discord.com/channels/754207117157859388/1450406231146496132/1453330303975424101","raw_text":":: recent","clean_text":"recent","tag":"::","trace_chain":["d9080bbe-958f-452a-a145-ac9481e6e73d"],"trace_chain_pg":"{d9080bbe-958f-452a-a145-ac9481e6e73d}"}}},"pairedItem":{"item":0}}]},"versionId":"cc9a1115-8238-49d1-b88e-10fcb0913cae","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:26.164Z","createdAt":"2025-12-23T09:30:26.164Z","role":"workflow:owner","workflowId":"ZwuxCuNFykFxgD3e","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-24T11:59:48.372Z","createdAt":"2025-12-24T11:59:48.372Z","id":"0T9sU2BKHy29sWsr","name":"Test_Workflow_Updated","active":false,"isArchived":false,"nodes":[{"id":"test-node","name":"Test Node","type":"n8n-nodes-base.code","typeVersion":2,"parameters":{"jsCode":"// test"}}],"connections":{},"settings":{"callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"17288790-18e7-449d-817a-6d09e3768db7","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-24T11:59:48.372Z","createdAt":"2025-12-24T11:59:48.372Z","role":"workflow:owner","workflowId":"0T9sU2BKHy29sWsr","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]},{"updatedAt":"2025-12-26T06:27:54.968Z","createdAt":"2025-12-23T22:21:12.978Z","id":"IdpHzWCchShvArHM","name":"Route_Event","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"={{ $env.WEBHOOK_PATH }}","options":{}},"id":"cd624af2-2b2d-4c54-a6f2-c16f72817ee4","name":"Discord Webhook Entry","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-768,192],"webhookId":"discord-events"},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-768,-128],"id":"cron-nudge","name":"Nudge Cron (Every 15 Min)"},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"*/5 * * * *"}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-768,512],"id":"cron-summary","name":"Summary Cron (Every 5 Min)"},{"parameters":{"workflowId":{"__rl":true,"value":"ujGErhNkQv4hkJxB","mode":"list","cachedResultName":"Generate_Nudge","cachedResultUrl":"/workflow/ujGErhNkQv4hkJxB"},"workflowInputs":{"mappingMode":"defineBelow","value":{"trigger_reason":"cron"},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-544,-128],"id":"execute-nudge-cron","name":"Execute Generate_Nudge"},{"parameters":{"operation":"executeQuery","query":"SELECT key, value FROM config WHERE key IN ('summary_time', 'last_summary_date');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-544,512],"id":"get-summary-config","name":"Get Summary Config","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Check if we should run summary (time matches AND not already run today)\nconst currentHour = $now.hour;\nconst todayDate = $now.toFormat('yyyy-MM-dd');\nconst inputItems = $input.all();\n\n// Extract config values\nlet targetHour = 20; // default\nlet lastSummaryDate = null;\n\nfor (const item of inputItems) {\n  if (item.json.key === 'summary_time') {\n    const configTime = item.json.value;\n    if (configTime.includes(':')) {\n      targetHour = parseInt(configTime.split(':')[0]);\n    } else {\n      targetHour = parseInt(configTime);\n    }\n  } else if (item.json.key === 'last_summary_date') {\n    lastSummaryDate = item.json.value;\n  }\n}\n\n// Check 1: Is it the right hour?\nif (currentHour !== targetHour) {\n  return [];\n}\n\n// Check 2: Already ran today?\nif (lastSummaryDate === todayDate) {\n  return [];\n}\n\n// Continue - time matches and not run today\nreturn [{ json: { should_run: true, today: todayDate, trigger_reason: 'cron' } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,512],"id":"check-summary-time","name":"Check Should Run Summary"},{"parameters":{"workflowId":{"__rl":true,"value":"tpkLfvOCAeN5YzMR","mode":"list","cachedResultName":"Generate_Daily_Summary","cachedResultUrl":"/workflow/tpkLfvOCAeN5YzMR"},"workflowInputs":{"mappingMode":"defineBelow","value":{"trigger_reason":"cron"},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-96,512],"id":"execute-summary-cron","name":"Execute Generate_Daily_Summary"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"condition-message","leftValue":"={{ $json.body.event_type }}","rightValue":"message","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"message"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"condition-reaction","leftValue":"={{ $json.body.event_type }}","rightValue":"reaction","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"reaction"}]},"options":{"fallbackOutput":2}},"id":"1c5b0871-58a8-457f-8b94-c1225e4e38b7","name":"Route by Event Type","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-544,192]},{"parameters":{"jsCode":"const reaction = $input.first().json.body;\nconst emojiMap = {\n  '1ï¸âƒ£': 1, '2ï¸âƒ£': 2, '3ï¸âƒ£': 3,\n  '4ï¸âƒ£': 4, '5ï¸âƒ£': 5, '6ï¸âƒ£': 6,\n  '7ï¸âƒ£': 7, '8ï¸âƒ£': 8, '9ï¸âƒ£': 9, 'ðŸ”Ÿ': 10\n};\n\nconst emoji = reaction.emoji;\nconst extractionIndex = emojiMap[emoji] || null;\nconst messageId = reaction.message_id;\nconst userId = reaction.user?.id || reaction.user_id;\nconst syntheticId = `reaction_${messageId}_${userId}_${emoji}_${extractionIndex}`;\n\nreturn [{\n  json: {\n    ...reaction,\n    synthetic_id: syntheticId,\n    emoji: emoji,\n    extraction_index: extractionIndex\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,288],"id":"1ffa970a-a79d-4d92-ad89-666e68c48276","name":"Parse Reaction"},{"parameters":{"jsCode":"// Initialize ctx.event - all downstream nodes read from $json.ctx.event\n// Reads from Execute_Queries result\nconst ctx = $input.first().json.ctx;\nconst dbResult = ctx.db.message_event.row;\nconst webhook = ctx.webhook_data;\nconst validation_result = ctx.validation?.result;\n\n// Tier 3: Skip projections if 'no_projections' tier was hit\nif (validation_result === 'no_projections') {\n  return [];\n}\n\nreturn [{\n  json: {\n    ctx: {\n      event: {\n        event_id: dbResult.id,\n        event_type: 'discord_message',\n        timestamp: webhook.timestamp,\n        guild_id: webhook.guild_id,\n        channel_id: webhook.channel_id,\n        message_id: webhook.message_id,\n        author_login: webhook.author?.login || webhook.author_login,\n        thread_id: webhook.thread_id || null,\n        message_url: `https://discord.com/channels/${webhook.guild_id}/${webhook.channel_id}/${webhook.message_id}`,\n        raw_text: webhook.content,\n        clean_text: webhook.clean_text,\n        tag: webhook.tag || null,\n        trace_chain: [dbResult.id],\n        trace_chain_pg: `{${dbResult.id}}`\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[352,96],"id":"ebc352f8-4d54-4ecd-9aee-d6e36d191099","name":"Initialize Message Context"},{"parameters":{"jsCode":"// Initialize ctx.event - all downstream nodes read from $json.ctx.event\n// Reads from Execute_Queries result\nconst ctx = $input.first().json.ctx;\nconst dbResult = ctx.db.reaction_event.row;\nconst webhook = ctx.webhook_data;\n\nreturn [{\n  json: {\n    ctx: {\n      event: {\n        event_id: dbResult.id,\n        event_type: 'discord_reaction',\n        timestamp: webhook.timestamp,\n        guild_id: webhook.guild_id,\n        channel_id: webhook.channel_id,\n        message_id: webhook.message_id,\n        author_login: webhook.user?.login || webhook.user_id,\n        thread_id: webhook.thread_id || null,\n        emoji: webhook.emoji,\n        extraction_index: webhook.extraction_index,\n        action: webhook.action,\n        trace_chain: [dbResult.id],\n        trace_chain_pg: `{${dbResult.id}}`\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[352,288],"id":"9377cd32-3d33-458d-9cb9-bca0ffb63490","name":"Initialize Reaction Context"},{"parameters":{"workflowId":{"__rl":true,"value":"TiwH9iJRRV8ZRtrs","mode":"list","cachedResultUrl":"/workflow/TiwH9iJRRV8ZRtrs","cachedResultName":"Route_Reaction"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[576,288],"id":"a03ea0a9-a9d2-4ce7-bb70-3a12397a5719","name":"Route Reaction"},{"parameters":{"workflowId":{"__rl":true,"value":"G0XzfbZiT3P98B4S","mode":"list","cachedResultUrl":"/workflow/G0XzfbZiT3P98B4S","cachedResultName":"Route_Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[576,96],"id":"29f4a14c-4ba5-481b-9ac0-7d8200241a40","name":"Route Message"},{"parameters":{"jsCode":"const json = $input.first().json;\nconst content = (json.body.content || \"\").trim();\nconst lowerContent = content.toLowerCase();\n\nconst TAG_TABLE = [\n  [\"!!\", \"act\"],\n  [\"..\", \"note\"],\n  [\"++\", \"chat\"],\n  [\"--\", \"save\"],\n  [\"::\", \"cmd\"],\n  [\"$$\", \"todo\", \"to-do\"]\n];\n\nlet tag = null;\nlet clean_text = content;\n\nfor (const row of TAG_TABLE) {\n  const normalized = row[0];\n  \n  const match = row.find(alias => {\n    const a = alias.toLowerCase();\n    \n    // Check if alias is strictly symbols (no letters or numbers)\n    const isSymbolOnly = !/[a-z0-9]/i.test(a);\n\n    if (isSymbolOnly) {\n      // Symbols match even if glued to text: \"!!task\"\n      return lowerContent.startsWith(a);\n    } else {\n      // Words require a space or exact match: \"act task\" or \"act\"\n      return lowerContent.startsWith(a + \" \") || lowerContent === a;\n    }\n  });\n\n  if (match) {\n    tag = normalized;\n    clean_text = content.slice(match.length).trim();\n    break;\n  }\n}\n\nreturn [{ json: { ...json.body, tag, clean_text } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,96],"id":"5f108e4e-41d7-4284-be7e-dcd784e855e6","name":"Parse Message"},{"parameters":{"jsCode":"const cleanText = $json.clean_text || \"\";\nconst tag = $json.tag;\n\n// Tier 1: Empty/whitespace (NO TAG)\nif (!cleanText.trim() && !tag) {\n  return {\n    json: {\n      ctx: {\n        webhook_data: $json,\n        validation: { result: \"block\" }\n      }\n    }\n  };\n}\n\n// Tier 2: Tag-only (HAS TAG but no content)\nif (tag && cleanText.trim() === \"\") {\n  return {\n    json: {\n      ctx: {\n        webhook_data: $json,\n        validation: { result: \"warn\" }\n      }\n    }\n  };\n}\n\n// Tier 3: Test keywords\nconst testKeywords = /\\b(test|testing|aaaaa)\\b/i;\nif (testKeywords.test(cleanText)) {\n  return {\n    json: {\n      ctx: {\n        webhook_data: $json,\n        validation: { result: \"no_projections\" }\n      }\n    }\n  };\n}\n\n// Tier 4: Continue\nreturn {\n  json: {\n    ctx: {\n      webhook_data: $json,\n      validation: { result: \"continue\" }\n      }\n  }\n};"},"id":"validate-message","name":"Validate Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-224,-64]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"cond-block","leftValue":"={{ $json.ctx.validation.result }}","rightValue":"block","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"block"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"cond-warn","leftValue":"={{ $json.ctx.validation.result }}","rightValue":"warn","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"warn"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"cond-no-projections","leftValue":"={{ $json.ctx.validation.result }}","rightValue":"no_projections","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"no_projections"}]},"options":{"fallbackOutput":"extra"}},"id":"switch-validation","name":"Switch on Validation","type":"n8n-nodes-base.switch","typeVersion":3,"position":[0,-64]},{"parameters":{"method":"POST","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.webhook_data.channel_id }}/messages/{{ $json.ctx.webhook_data.message_id }}/reactions/%E2%9B%94/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]}},"id":"react-block","name":"React: Block Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,-256],"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"method":"POST","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.webhook_data.channel_id }}/messages/{{ $json.ctx.webhook_data.message_id }}/reactions/%E2%9A%A0%EF%B8%8F/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]}},"id":"react-warn","name":"React: Warn Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,-96],"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"method":"POST","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.webhook_data.channel_id }}/messages/{{ $json.ctx.webhook_data.message_id }}/reactions/%F0%9F%92%80/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]}},"id":"react-no-projections","name":"React: No Projections","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,64],"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"mode":"append","numberInputs":2},"id":"merge-validation","name":"Merge: Continue Paths","type":"n8n-nodes-base.merge","typeVersion":3,"position":[448,64]},{"parameters":{"jsCode":"// Build DB query context for Execute_Queries\n// Prepares INSERT query for discord_message event\nconst parsed = $input.first().json;\nconst webhook_data = parsed.ctx?.webhook_data || parsed;\n\n// Build parameters array\nconst params = [\n    webhook_data.guild_id,\n    webhook_data.channel_id,\n    webhook_data.message_id,\n    `https://discord.com/channels/${webhook_data.guild_id}/${webhook_data.channel_id}/${webhook_data.message_id}`,\n    webhook_data.author?.login || webhook_data.author_login,\n    webhook_data.thread_id || null,\n    webhook_data.content,\n    webhook_data.clean_text,\n    webhook_data.tag || null,\n    webhook_data.timestamp\n];\n\nconst db_queries = [{\n        key: 'message_event',\n        sql: `INSERT INTO events (\n  event_type,\n  payload,\n  idempotency_key\n) VALUES (\n  'discord_message',\n  jsonb_build_object(\n    'content', $7,\n    'clean_text', $8,\n    'tag', $9,\n    'discord_guild_id', $1,\n    'discord_channel_id', $2,\n    'discord_message_id', $3,\n    'message_url', $4,\n    'author_login', $5,\n    'thread_id', $6,\n    'timestamp', $10::timestamptz\n  ),\n  $3\n)\nON CONFLICT (event_type, idempotency_key) DO UPDATE\nSET payload = EXCLUDED.payload\nRETURNING *;`,\n        params: params\n      }];\n\n// Return ctx with db_queries array (Execute_Queries pattern)\nreturn [{\n  json: {\n    ctx: {\n      ...parsed.ctx,\n      db_queries\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[672,96],"id":"1dee35fc-7a2a-4e70-b541-e25450738f82","name":"Build Message DB Query"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[128,96],"id":"execute-queries-message","name":"Execute Store Message Query"},{"parameters":{"jsCode":"// Build DB query context for Execute_Queries\n// Prepares INSERT query for discord_reaction event\nconst parsed = $input.first().json;\n\n// Build parameters array\nconst params = [\n    parsed.guild_id,\n    parsed.channel_id,\n    parsed.message_id,\n    parsed.user?.login || parsed.user_id,\n    parsed.thread_id || null,\n    parsed.emoji,\n    parsed.extraction_index,\n    parsed.action,\n    parsed.synthetic_id\n];\n\n// Return ctx with db_queries array (Execute_Queries pattern)\nreturn [{\n  json: {\n    ctx: {\n      webhook_data: parsed,\n      db_queries: [{\n        key: 'reaction_event',\n        sql: `INSERT INTO events (\n  event_type,\n  payload,\n  idempotency_key\n) VALUES (\n  'discord_reaction',\n  jsonb_build_object(\n    'discord_guild_id', $1,\n    'discord_channel_id', $2,\n    'discord_message_id', $3,\n    'author_login', $4,\n    'thread_id', $5,\n    'emoji', $6,\n    'extraction_index', $7,\n    'action', $8\n  ),\n  $9\n)\nON CONFLICT (event_type, idempotency_key) DO NOTHING\nRETURNING *;`,\n        params: params\n      }]\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-96,288],"id":"1e599c77-83a3-488c-990c-27fda94c4a92","name":"Build Reaction DB Query"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[128,288],"id":"execute-queries-reaction","name":"Execute Store Reaction Query"}],"connections":{"Discord Webhook Entry":{"main":[[{"node":"Route by Event Type","type":"main","index":0}]]},"Nudge Cron (Every 15 Min)":{"main":[[{"node":"Execute Generate_Nudge","type":"main","index":0}]]},"Summary Cron (Every 5 Min)":{"main":[[{"node":"Get Summary Config","type":"main","index":0}]]},"Get Summary Config":{"main":[[{"node":"Check Should Run Summary","type":"main","index":0}]]},"Check Should Run Summary":{"main":[[{"node":"Execute Generate_Daily_Summary","type":"main","index":0}]]},"Route by Event Type":{"main":[[{"node":"Parse Message","type":"main","index":0}],[{"node":"Parse Reaction","type":"main","index":0}]]},"Parse Reaction":{"main":[[{"node":"Build Reaction DB Query","type":"main","index":0}]]},"Initialize Message Context":{"main":[[{"node":"Route Message","type":"main","index":0}]]},"Initialize Reaction Context":{"main":[[{"node":"Route Reaction","type":"main","index":0}]]},"Parse Message":{"main":[[{"node":"Validate Message","type":"main","index":0}]]},"Validate Message":{"main":[[{"node":"Switch on Validation","type":"main","index":0}]]},"Switch on Validation":{"main":[[{"node":"React: Block Message","type":"main","index":0}],[{"node":"React: Warn Message","type":"main","index":0}],[{"node":"React: No Projections","type":"main","index":0}],[{"node":"Merge: Continue Paths","type":"main","index":0}]]},"React: No Projections":{"main":[[{"node":"Merge: Continue Paths","type":"main","index":1}]]},"Merge: Continue Paths":{"main":[[{"node":"Build Message DB Query","type":"main","index":0}]]},"Build Message DB Query":{"main":[[{"node":"Execute Store Message Query","type":"main","index":0}]]},"Build Reaction DB Query":{"main":[[{"node":"Execute Store Reaction Query","type":"main","index":0}]]},"Execute Store Message Query":{"main":[[{"node":"Initialize Message Context","type":"main","index":0}]]},"Execute Store Reaction Query":{"main":[[{"node":"Initialize Reaction Context","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false,"errorWorkflow":""},"staticData":{"node:NudgeCron(every15Min)":{"recurrenceRules":[]},"node:SummaryCron(every5Min)":{"recurrenceRules":[]},"node:Nudge Cron (Every 15 Min)":{"recurrenceRules":[]},"node:Summary Cron (Every 5 Min)":{"recurrenceRules":[]}},"meta":null,"pinData":{"Summary Cron (Every 5 Min)":[{"json":{"timestamp":"2025-12-24T02:20:00.007-08:00","Readable date":"December 24th 2025, 2:20:00 am","Readable time":"2:20:00 am","Day of week":"Wednesday","Year":"2025","Month":"December","Day of month":"24","Hour":"02","Minute":"20","Second":"00","Timezone":"America/Vancouver (UTC-08:00)"},"pairedItem":{"item":0}}]},"versionId":"8a0518fa-cca0-453b-b49c-ba54895cbffe","activeVersionId":"8a0518fa-cca0-453b-b49c-ba54895cbffe","triggerCount":3,"shared":[{"updatedAt":"2025-12-23T22:21:12.978Z","createdAt":"2025-12-23T22:21:12.978Z","role":"workflow:owner","workflowId":"IdpHzWCchShvArHM","projectId":"erM3nntdLL53noWi"}],"activeVersion":{"updatedAt":"2025-12-26T06:27:54.970Z","createdAt":"2025-12-26T06:27:54.970Z","versionId":"8a0518fa-cca0-453b-b49c-ba54895cbffe","workflowId":"IdpHzWCchShvArHM","nodes":[{"parameters":{"httpMethod":"POST","path":"={{ $env.WEBHOOK_PATH }}","options":{}},"id":"cd624af2-2b2d-4c54-a6f2-c16f72817ee4","name":"Discord Webhook Entry","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-768,192],"webhookId":"discord-events"},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-768,-128],"id":"cron-nudge","name":"Nudge Cron (Every 15 Min)"},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"*/5 * * * *"}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-768,512],"id":"cron-summary","name":"Summary Cron (Every 5 Min)"},{"parameters":{"workflowId":{"__rl":true,"value":"ujGErhNkQv4hkJxB","mode":"list","cachedResultName":"Generate_Nudge","cachedResultUrl":"/workflow/ujGErhNkQv4hkJxB"},"workflowInputs":{"mappingMode":"defineBelow","value":{"trigger_reason":"cron"},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-544,-128],"id":"execute-nudge-cron","name":"Execute Generate_Nudge"},{"parameters":{"operation":"executeQuery","query":"SELECT key, value FROM config WHERE key IN ('summary_time', 'last_summary_date');","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-544,512],"id":"get-summary-config","name":"Get Summary Config","alwaysOutputData":true,"credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Check if we should run summary (time matches AND not already run today)\nconst currentHour = $now.hour;\nconst todayDate = $now.toFormat('yyyy-MM-dd');\nconst inputItems = $input.all();\n\n// Extract config values\nlet targetHour = 20; // default\nlet lastSummaryDate = null;\n\nfor (const item of inputItems) {\n  if (item.json.key === 'summary_time') {\n    const configTime = item.json.value;\n    if (configTime.includes(':')) {\n      targetHour = parseInt(configTime.split(':')[0]);\n    } else {\n      targetHour = parseInt(configTime);\n    }\n  } else if (item.json.key === 'last_summary_date') {\n    lastSummaryDate = item.json.value;\n  }\n}\n\n// Check 1: Is it the right hour?\nif (currentHour !== targetHour) {\n  return [];\n}\n\n// Check 2: Already ran today?\nif (lastSummaryDate === todayDate) {\n  return [];\n}\n\n// Continue - time matches and not run today\nreturn [{ json: { should_run: true, today: todayDate, trigger_reason: 'cron' } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,512],"id":"check-summary-time","name":"Check Should Run Summary"},{"parameters":{"workflowId":{"__rl":true,"value":"tpkLfvOCAeN5YzMR","mode":"list","cachedResultName":"Generate_Daily_Summary","cachedResultUrl":"/workflow/tpkLfvOCAeN5YzMR"},"workflowInputs":{"mappingMode":"defineBelow","value":{"trigger_reason":"cron"},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-96,512],"id":"execute-summary-cron","name":"Execute Generate_Daily_Summary"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"condition-message","leftValue":"={{ $json.body.event_type }}","rightValue":"message","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"message"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"condition-reaction","leftValue":"={{ $json.body.event_type }}","rightValue":"reaction","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"reaction"}]},"options":{"fallbackOutput":2}},"id":"1c5b0871-58a8-457f-8b94-c1225e4e38b7","name":"Route by Event Type","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-544,192]},{"parameters":{"jsCode":"const reaction = $input.first().json.body;\nconst emojiMap = {\n  '1ï¸âƒ£': 1, '2ï¸âƒ£': 2, '3ï¸âƒ£': 3,\n  '4ï¸âƒ£': 4, '5ï¸âƒ£': 5, '6ï¸âƒ£': 6,\n  '7ï¸âƒ£': 7, '8ï¸âƒ£': 8, '9ï¸âƒ£': 9, 'ðŸ”Ÿ': 10\n};\n\nconst emoji = reaction.emoji;\nconst extractionIndex = emojiMap[emoji] || null;\nconst messageId = reaction.message_id;\nconst userId = reaction.user?.id || reaction.user_id;\nconst syntheticId = `reaction_${messageId}_${userId}_${emoji}_${extractionIndex}`;\n\nreturn [{\n  json: {\n    ...reaction,\n    synthetic_id: syntheticId,\n    emoji: emoji,\n    extraction_index: extractionIndex\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,288],"id":"1ffa970a-a79d-4d92-ad89-666e68c48276","name":"Parse Reaction"},{"parameters":{"jsCode":"// Initialize ctx.event - all downstream nodes read from $json.ctx.event\n// Reads from Execute_Queries result\nconst ctx = $input.first().json.ctx;\nconst dbResult = ctx.db.message_event.row;\nconst webhook = ctx.webhook_data;\nconst validation_result = ctx.validation?.result;\n\n// Tier 3: Skip projections if 'no_projections' tier was hit\nif (validation_result === 'no_projections') {\n  return [];\n}\n\nreturn [{\n  json: {\n    ctx: {\n      event: {\n        event_id: dbResult.id,\n        event_type: 'discord_message',\n        timestamp: webhook.timestamp,\n        guild_id: webhook.guild_id,\n        channel_id: webhook.channel_id,\n        message_id: webhook.message_id,\n        author_login: webhook.author?.login || webhook.author_login,\n        thread_id: webhook.thread_id || null,\n        message_url: `https://discord.com/channels/${webhook.guild_id}/${webhook.channel_id}/${webhook.message_id}`,\n        raw_text: webhook.content,\n        clean_text: webhook.clean_text,\n        tag: webhook.tag || null,\n        trace_chain: [dbResult.id],\n        trace_chain_pg: `{${dbResult.id}}`\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[352,96],"id":"ebc352f8-4d54-4ecd-9aee-d6e36d191099","name":"Initialize Message Context"},{"parameters":{"jsCode":"// Initialize ctx.event - all downstream nodes read from $json.ctx.event\n// Reads from Execute_Queries result\nconst ctx = $input.first().json.ctx;\nconst dbResult = ctx.db.reaction_event.row;\nconst webhook = ctx.webhook_data;\n\nreturn [{\n  json: {\n    ctx: {\n      event: {\n        event_id: dbResult.id,\n        event_type: 'discord_reaction',\n        timestamp: webhook.timestamp,\n        guild_id: webhook.guild_id,\n        channel_id: webhook.channel_id,\n        message_id: webhook.message_id,\n        author_login: webhook.user?.login || webhook.user_id,\n        thread_id: webhook.thread_id || null,\n        emoji: webhook.emoji,\n        extraction_index: webhook.extraction_index,\n        action: webhook.action,\n        trace_chain: [dbResult.id],\n        trace_chain_pg: `{${dbResult.id}}`\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[352,288],"id":"9377cd32-3d33-458d-9cb9-bca0ffb63490","name":"Initialize Reaction Context"},{"parameters":{"workflowId":{"__rl":true,"value":"TiwH9iJRRV8ZRtrs","mode":"list","cachedResultUrl":"/workflow/TiwH9iJRRV8ZRtrs","cachedResultName":"Route_Reaction"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[576,288],"id":"a03ea0a9-a9d2-4ce7-bb70-3a12397a5719","name":"Route Reaction"},{"parameters":{"workflowId":{"__rl":true,"value":"G0XzfbZiT3P98B4S","mode":"list","cachedResultUrl":"/workflow/G0XzfbZiT3P98B4S","cachedResultName":"Route_Message"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[576,96],"id":"29f4a14c-4ba5-481b-9ac0-7d8200241a40","name":"Route Message"},{"parameters":{"jsCode":"const json = $input.first().json;\nconst content = (json.body.content || \"\").trim();\nconst lowerContent = content.toLowerCase();\n\nconst TAG_TABLE = [\n  [\"!!\", \"act\"],\n  [\"..\", \"note\"],\n  [\"++\", \"chat\"],\n  [\"--\", \"save\"],\n  [\"::\", \"cmd\"],\n  [\"$$\", \"todo\", \"to-do\"]\n];\n\nlet tag = null;\nlet clean_text = content;\n\nfor (const row of TAG_TABLE) {\n  const normalized = row[0];\n  \n  const match = row.find(alias => {\n    const a = alias.toLowerCase();\n    \n    // Check if alias is strictly symbols (no letters or numbers)\n    const isSymbolOnly = !/[a-z0-9]/i.test(a);\n\n    if (isSymbolOnly) {\n      // Symbols match even if glued to text: \"!!task\"\n      return lowerContent.startsWith(a);\n    } else {\n      // Words require a space or exact match: \"act task\" or \"act\"\n      return lowerContent.startsWith(a + \" \") || lowerContent === a;\n    }\n  });\n\n  if (match) {\n    tag = normalized;\n    clean_text = content.slice(match.length).trim();\n    break;\n  }\n}\n\nreturn [{ json: { ...json.body, tag, clean_text } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,96],"id":"5f108e4e-41d7-4284-be7e-dcd784e855e6","name":"Parse Message"},{"parameters":{"jsCode":"const cleanText = $json.clean_text || \"\";\nconst tag = $json.tag;\n\n// Tier 1: Empty/whitespace (NO TAG)\nif (!cleanText.trim() && !tag) {\n  return {\n    json: {\n      ctx: {\n        webhook_data: $json,\n        validation: { result: \"block\" }\n      }\n    }\n  };\n}\n\n// Tier 2: Tag-only (HAS TAG but no content)\nif (tag && cleanText.trim() === \"\") {\n  return {\n    json: {\n      ctx: {\n        webhook_data: $json,\n        validation: { result: \"warn\" }\n      }\n    }\n  };\n}\n\n// Tier 3: Test keywords\nconst testKeywords = /\\b(test|testing|aaaaa)\\b/i;\nif (testKeywords.test(cleanText)) {\n  return {\n    json: {\n      ctx: {\n        webhook_data: $json,\n        validation: { result: \"no_projections\" }\n      }\n    }\n  };\n}\n\n// Tier 4: Continue\nreturn {\n  json: {\n    ctx: {\n      webhook_data: $json,\n      validation: { result: \"continue\" }\n      }\n  }\n};"},"id":"validate-message","name":"Validate Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-224,-64]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"cond-block","leftValue":"={{ $json.ctx.validation.result }}","rightValue":"block","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"block"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"cond-warn","leftValue":"={{ $json.ctx.validation.result }}","rightValue":"warn","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"warn"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"cond-no-projections","leftValue":"={{ $json.ctx.validation.result }}","rightValue":"no_projections","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"no_projections"}]},"options":{"fallbackOutput":"extra"}},"id":"switch-validation","name":"Switch on Validation","type":"n8n-nodes-base.switch","typeVersion":3,"position":[0,-64]},{"parameters":{"method":"POST","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.webhook_data.channel_id }}/messages/{{ $json.ctx.webhook_data.message_id }}/reactions/%E2%9B%94/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]}},"id":"react-block","name":"React: Block Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,-256],"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"method":"POST","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.webhook_data.channel_id }}/messages/{{ $json.ctx.webhook_data.message_id }}/reactions/%E2%9A%A0%EF%B8%8F/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]}},"id":"react-warn","name":"React: Warn Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,-96],"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"method":"POST","url":"=https://discord.com/api/v10/channels/{{ $json.ctx.webhook_data.channel_id }}/messages/{{ $json.ctx.webhook_data.message_id }}/reactions/%F0%9F%92%80/@me","authentication":"predefinedCredentialType","nodeCredentialType":"discordBotApi","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]}},"id":"react-no-projections","name":"React: No Projections","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,64],"credentials":{"discordBotApi":{"id":"HzhURrgtJQZuwPMZ","name":"Discord Bot account"}}},{"parameters":{"mode":"append","numberInputs":2},"id":"merge-validation","name":"Merge: Continue Paths","type":"n8n-nodes-base.merge","typeVersion":3,"position":[448,64]},{"parameters":{"jsCode":"// Build DB query context for Execute_Queries\n// Prepares INSERT query for discord_message event\nconst parsed = $input.first().json;\nconst webhook_data = parsed.ctx?.webhook_data || parsed;\n\n// Build parameters array\nconst params = [\n    webhook_data.guild_id,\n    webhook_data.channel_id,\n    webhook_data.message_id,\n    `https://discord.com/channels/${webhook_data.guild_id}/${webhook_data.channel_id}/${webhook_data.message_id}`,\n    webhook_data.author?.login || webhook_data.author_login,\n    webhook_data.thread_id || null,\n    webhook_data.content,\n    webhook_data.clean_text,\n    webhook_data.tag || null,\n    webhook_data.timestamp\n];\n\nconst db_queries = [{\n        key: 'message_event',\n        sql: `INSERT INTO events (\n  event_type,\n  payload,\n  idempotency_key\n) VALUES (\n  'discord_message',\n  jsonb_build_object(\n    'content', $7,\n    'clean_text', $8,\n    'tag', $9,\n    'discord_guild_id', $1,\n    'discord_channel_id', $2,\n    'discord_message_id', $3,\n    'message_url', $4,\n    'author_login', $5,\n    'thread_id', $6,\n    'timestamp', $10::timestamptz\n  ),\n  $3\n)\nON CONFLICT (event_type, idempotency_key) DO UPDATE\nSET payload = EXCLUDED.payload\nRETURNING *;`,\n        params: params\n      }];\n\n// Return ctx with db_queries array (Execute_Queries pattern)\nreturn [{\n  json: {\n    ctx: {\n      ...parsed.ctx,\n      db_queries\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[672,96],"id":"1dee35fc-7a2a-4e70-b541-e25450738f82","name":"Build Message DB Query"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[128,96],"id":"execute-queries-message","name":"Execute Store Message Query"},{"parameters":{"jsCode":"// Build DB query context for Execute_Queries\n// Prepares INSERT query for discord_reaction event\nconst parsed = $input.first().json;\n\n// Build parameters array\nconst params = [\n    parsed.guild_id,\n    parsed.channel_id,\n    parsed.message_id,\n    parsed.user?.login || parsed.user_id,\n    parsed.thread_id || null,\n    parsed.emoji,\n    parsed.extraction_index,\n    parsed.action,\n    parsed.synthetic_id\n];\n\n// Return ctx with db_queries array (Execute_Queries pattern)\nreturn [{\n  json: {\n    ctx: {\n      webhook_data: parsed,\n      db_queries: [{\n        key: 'reaction_event',\n        sql: `INSERT INTO events (\n  event_type,\n  payload,\n  idempotency_key\n) VALUES (\n  'discord_reaction',\n  jsonb_build_object(\n    'discord_guild_id', $1,\n    'discord_channel_id', $2,\n    'discord_message_id', $3,\n    'author_login', $4,\n    'thread_id', $5,\n    'emoji', $6,\n    'extraction_index', $7,\n    'action', $8\n  ),\n  $9\n)\nON CONFLICT (event_type, idempotency_key) DO NOTHING\nRETURNING *;`,\n        params: params\n      }]\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-96,288],"id":"1e599c77-83a3-488c-990c-27fda94c4a92","name":"Build Reaction DB Query"},{"parameters":{"workflowId":{"__rl":true,"value":"CgUAxK0i4YhrZ2Wp","mode":"list","cachedResultName":"Execute_Queries","cachedResultUrl":"/workflow/CgUAxK0i4YhrZ2Wp"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ctx":"={{ $json.ctx }}"}},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[128,288],"id":"execute-queries-reaction","name":"Execute Store Reaction Query"}],"connections":{"Discord Webhook Entry":{"main":[[{"node":"Route by Event Type","type":"main","index":0}]]},"Nudge Cron (Every 15 Min)":{"main":[[{"node":"Execute Generate_Nudge","type":"main","index":0}]]},"Summary Cron (Every 5 Min)":{"main":[[{"node":"Get Summary Config","type":"main","index":0}]]},"Get Summary Config":{"main":[[{"node":"Check Should Run Summary","type":"main","index":0}]]},"Check Should Run Summary":{"main":[[{"node":"Execute Generate_Daily_Summary","type":"main","index":0}]]},"Route by Event Type":{"main":[[{"node":"Parse Message","type":"main","index":0}],[{"node":"Parse Reaction","type":"main","index":0}]]},"Parse Reaction":{"main":[[{"node":"Build Reaction DB Query","type":"main","index":0}]]},"Initialize Message Context":{"main":[[{"node":"Route Message","type":"main","index":0}]]},"Initialize Reaction Context":{"main":[[{"node":"Route Reaction","type":"main","index":0}]]},"Parse Message":{"main":[[{"node":"Validate Message","type":"main","index":0}]]},"Validate Message":{"main":[[{"node":"Switch on Validation","type":"main","index":0}]]},"Switch on Validation":{"main":[[{"node":"React: Block Message","type":"main","index":0}],[{"node":"React: Warn Message","type":"main","index":0}],[{"node":"React: No Projections","type":"main","index":0}],[{"node":"Merge: Continue Paths","type":"main","index":0}]]},"React: No Projections":{"main":[[{"node":"Merge: Continue Paths","type":"main","index":1}]]},"Merge: Continue Paths":{"main":[[{"node":"Build Message DB Query","type":"main","index":0}]]},"Build Message DB Query":{"main":[[{"node":"Execute Store Message Query","type":"main","index":0}]]},"Build Reaction DB Query":{"main":[[{"node":"Execute Store Reaction Query","type":"main","index":0}]]},"Execute Store Message Query":{"main":[[{"node":"Initialize Message Context","type":"main","index":0}]]},"Execute Store Reaction Query":{"main":[[{"node":"Initialize Reaction Context","type":"main","index":0}]]}},"authors":"Chris Irineo","name":null,"description":null},"tags":[]},{"updatedAt":"2025-12-26T06:27:55.802Z","createdAt":"2025-12-23T09:30:31.551Z","id":"TiwH9iJRRV8ZRtrs","name":"Route_Reaction","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-380,480],"id":"trigger-node","name":"ReceiveEvent"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"is-add-reaction","leftValue":"={{ $json.ctx.event.action }}","rightValue":"add","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2,"position":[-160,480],"id":"check-action","name":"IsAddReaction?"},{"parameters":{"operation":"executeQuery","query":"SELECT value FROM config WHERE key = 'emoji_mapping';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[60,480],"id":"get-emoji-config","name":"GetEmojiConfig","credentials":{"postgres":{"id":"GIpVtzgs3wiCmQBQ","name":"Postgres account"}}},{"parameters":{"jsCode":"// Determine route based on emoji_mapping config\nconst ctx = $('ReceiveEvent').first().json.ctx;\nconst emoji = ctx.event.emoji;\n\n// Parse config - Postgres returns JSON as string\nconst rawValue = $json.value;\nconst config = typeof rawValue === 'string' ? JSON.parse(rawValue) : (rawValue || {});\n\n// Extraction emojis (number selections + dismiss)\n// These are hardcoded because they're tied to display order logic\nconst extractionEmojis = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ðŸ”Ÿ', 'âŒ'];\n\n// Info emojis (show details about the projection)\n// â” = simple view (just projections)\n// â“ = detailed view (full prompts, timing)\nconst infoEmojis = ['â“', 'â”'];\n\n// Quality rating emojis (rate projection quality)\nconst qualityEmojis = ['ðŸ‘', 'ðŸ‘Ž'];\n\n// Get correction emojis from config (type corrections + void)\nconst corrections = config.corrections || [];\n\n// Get todo status emojis from config\nconst statusEmojis = Object.keys(config.status || {});\n\n// Determine route\nlet route = 'unknown';\n\nif (extractionEmojis.includes(emoji)) {\n  route = 'extraction';\n} else if (infoEmojis.includes(emoji)) {\n  route = 'info';\n} else if (qualityEmojis.includes(emoji)) {\n  route = 'quality';\n} else if (corrections.includes(emoji)) {\n  route = 'correction';\n} else if (statusEmojis.includes(emoji)) {\n  route = 'todo_status';\n}\n\nreturn {\n  json: {\n    ctx,\n    route,\n    emoji,\n    config\n  }\n};","mode":"runOnceForEachItem"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[280,480],"id":"determine-route","name":"DetermineRoute"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"is-extraction","leftValue":"={{ $json.route }}","rightValue":"extraction","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Extraction"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"is-info","leftValue":"={{ $json.route }}","rightValue":"info","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Info"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"is-quality","leftValue":"={{ $json.route }}","rightValue":"quality","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Quality"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"is-correction","leftValue":"={{ $json.route }}","rightValue":"correction","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Correction"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"is-todo-status","leftValue":"={{ $json.route }}","rightValue":"todo_status","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Todo Status"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[500,480],"id":"route-by-emoji","name":"RouteByEmoji"},{"parameters":{"workflowId":{"__rl":true,"value":"dzbXvPNPoYdpaXGT","mode":"list","cachedResultName":"Save_Extraction","cachedResultUrl":"/workflow/dzbXvPNPoYdpaXGT"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[720,320],"id":"save-extraction","name":"SaveExtraction"},{"parameters":{"workflowId":{"__rl":true,"value":"baPcss9BKwIpEZQU","mode":"list","cachedResultName":"Handle_Correction","cachedResultUrl":"/workflow/baPcss9BKwIpEZQU"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[720,480],"id":"handle-correction","name":"HandleCorrection"},{"parameters":{"workflowId":{"__rl":true,"value":"NCt9DcriuZwLwFLA","mode":"list","cachedResultName":"Handle_Todo_Status","cachedResultUrl":"/workflow/NCt9DcriuZwLwFLA"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[720,640],"id":"handle-todo-status","name":"HandleTodoStatus"},{"parameters":{"errorMessage":"=Unknown reaction emoji: {{ $json.emoji }}"},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[720,1040],"id":"unknown-emoji-error","name":"UnknownEmojiError"},{"parameters":{"workflowId":{"__rl":true,"value":"wVpslhMBnrsgDaOR","mode":"list","cachedResultName":"Show_Projection_Details","cachedResultUrl":"/workflow/wVpslhMBnrsgDaOR"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[720,800],"id":"show-projection-details","name":"ShowProjectionDetails"},{"parameters":{"workflowId":{"__rl":true,"value":"887fJOHvjP78PQoO","mode":"list","cachedResultName":"Handle_Quality_Rating","cachedResultUrl":"/workflow/887fJOHvjP78PQoO"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{"waitForSubWorkflow":false}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[720,880],"id":"handle-quality-rating","name":"HandleQualityRating"}],"connections":{"ReceiveEvent":{"main":[[{"node":"IsAddReaction?","type":"main","index":0}]]},"IsAddReaction?":{"main":[[{"node":"GetEmojiConfig","type":"main","index":0}]]},"GetEmojiConfig":{"main":[[{"node":"DetermineRoute","type":"main","index":0}]]},"DetermineRoute":{"main":[[{"node":"RouteByEmoji","type":"main","index":0}]]},"RouteByEmoji":{"main":[[{"node":"SaveExtraction","type":"main","index":0}],[{"node":"ShowProjectionDetails","type":"main","index":0}],[{"node":"HandleQualityRating","type":"main","index":0}],[{"node":"HandleCorrection","type":"main","index":0}],[{"node":"HandleTodoStatus","type":"main","index":0}],[{"node":"UnknownEmojiError","type":"main","index":0}]]}},"settings":{"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"NOJ7FqVhVLqw0n8D","availableInMCP":false,"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":null,"versionId":"de33c22c-8f20-453d-ad63-ca0de8a0e63b","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-23T09:30:31.551Z","createdAt":"2025-12-23T09:30:31.551Z","role":"workflow:owner","workflowId":"TiwH9iJRRV8ZRtrs","projectId":"erM3nntdLL53noWi"}],"activeVersion":null,"tags":[]}],"nextCursor":null}
