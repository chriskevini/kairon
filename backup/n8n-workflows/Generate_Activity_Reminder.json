{
  "name": "Generate_Activity_Reminder",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 30
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ],
      "id": "cron-trigger",
      "name": "Every 30 Minutes"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH user_events AS (\n  SELECT \n    payload->>'author_login' as user_login,\n    MAX(received_at) as last_observation_at,\n    EXTRACT(EPOCH FROM (NOW() - MAX(received_at)))/60 as minutes_since_activity\n  FROM events\n  WHERE payload->>'author_login' IS NOT NULL\n  GROUP BY payload->>'author_login'\n),\nlatest_activity AS (\n  SELECT \n    ue.user_login,\n    ue.last_observation_at,\n    p.data->>'category' as last_category,\n    ue.minutes_since_activity\n  FROM user_events ue\n  LEFT JOIN projections p ON p.projection_type = 'activity' \n    AND p.data->>'timestamp' = (\n      SELECT MAX(data->>'timestamp') \n      FROM projections \n      WHERE projection_type = 'activity'\n    )\n  WHERE ue.last_observation_at IS NULL \n    OR ue.last_observation_at < NOW() - INTERVAL '30 minutes'\n  LIMIT 1\n)\nSELECT * \nFROM latest_activity\nWHERE last_category IS NULL OR last_category != 'sleep'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        224,
        0
      ],
      "id": "query-user-state",
      "name": "Check User State",
      "credentials": {
        "postgres": {
          "id": "MdnYzEgjzWRujz2v",
          "name": "Postgres account"
        }
      },
      "notes": "Checks if:\n1. User is awake (last activity != 'sleep')\n2. No activity in last 30 minutes\n\nAll state derived from events and projections.\nNo user_state table needed.\nIf conditions met, returns row and continues.\nIf not met, returns nothing and workflow stops."
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "={{ $env.DISCORD_GUILD_ID }}",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $env.DISCORD_CHANNEL_ARCANE_SHELL }}",
          "mode": "id"
        },
        "content": "=â° **Activity Check**\n\nNo activity detected in the last 30 minutes.\n\nWhat are you currently working on?\nReply with: `!! <what you're doing>`",
        "options": {}
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        448,
        0
      ],
      "id": "send-reminder",
      "name": "Send Activity Reminder",
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      }
    }
  ],
  "connections": {
    "Every 30 Minutes": {
      "main": [
        [
          {
            "node": "Check User State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check User State": {
      "main": [
        [
          {
            "node": "Send Activity Reminder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "errorWorkflow": "JOXLqn9TTznBdo7Q"
  },
  "staticData": {
    "node:Every 30 Minutes": {
      "recurrenceRules": []
    }
  },
  "meta": null,
  "active": false
}
