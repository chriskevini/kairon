#!/bin/bash
# Pre-push hook - comprehensive testing: full deployment pipeline
# Includes functional tests and production deployment validation
#
# Install: ln -sf ../../.githooks/pre-push .git/hooks/pre-push
# Or: git config core.hooksPath .githooks

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"

echo "========================================"
echo "Pre-push: Full deployment pipeline"
echo "========================================"
echo ""

# Check if any workflow files are being pushed
WORKFLOW_CHANGES=$(git diff --name-only HEAD @{upstream} 2>/dev/null | grep -c "n8n-workflows/" || true)

# Check if any migration files are being pushed
MIGRATION_CHANGES=$(git diff --name-only HEAD @{upstream} 2>/dev/null | grep "db/migrations/.*\.sql$" || true)

if [ "$WORKFLOW_CHANGES" -eq 0 ] && [ -z "$MIGRATION_CHANGES" ]; then
    echo "No workflow or migration changes detected, skipping deployment"
    exit 0
fi

# Run migration tests if migrations changed
if [ -n "$MIGRATION_CHANGES" ]; then
    echo "========================================"
    echo "Detected migration file(s) changed"
    echo "========================================"
    echo ""

    for migration in $MIGRATION_CHANGES; do
        if [ -f "$migration" ]; then
            echo "Testing migration: $migration"
            "$REPO_ROOT/scripts/db/test-migration.sh" "$migration" || {
                echo ""
                echo "========================================"
                echo "MIGRATION TEST FAILED: $migration"
                echo "========================================"
                echo ""
                echo "Fix the migration issues and try again."
                exit 1
            }
            echo ""
        fi
    done

    echo "========================================"
    echo "All migration tests passed"
    echo "========================================"
    echo ""
fi

if [ "$WORKFLOW_CHANGES" -eq 0 ]; then
    exit 0
fi

echo "Detected $WORKFLOW_CHANGES workflow file(s) changed"
echo ""

# Full pipeline: dev → smoke tests → prod
"$REPO_ROOT/scripts/deploy.sh"

if [ $? -ne 0 ]; then
    echo ""
    echo "========================================"
    echo "PUSH BLOCKED: Deployment pipeline failed"
    echo "========================================"
    echo ""
    echo "Fix the issues and try again."
    exit 1
fi

echo ""
echo "========================================"
echo "Pre-push deployment complete"
echo "========================================"
