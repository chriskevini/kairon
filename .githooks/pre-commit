#!/bin/bash
# Pre-commit hook for Kairon
# Validates and sanitizes n8n workflow files before commit

set -euo pipefail

# Find repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check if any workflow files are staged
STAGED_WORKFLOWS=$(git diff --cached --name-only --diff-filter=ACM | grep "n8n-workflows/.*\.json$" || true)

if [ -z "$STAGED_WORKFLOWS" ]; then
    # No workflow files staged, nothing to do
    exit 0
fi

echo "üîç Checking staged workflow files..."
echo ""

# Validate JSON syntax
echo "Validating JSON syntax..."
has_errors=0
for file in $STAGED_WORKFLOWS; do
    if ! python3 -c "import json; json.load(open('$REPO_ROOT/$file'))" 2>/dev/null; then
        echo "  ‚ùå Invalid JSON: $file"
        python3 -c "import json; json.load(open('$REPO_ROOT/$file'))" 2>&1 | head -3
        has_errors=1
    else
        echo "  ‚úì $file"
    fi
done

if [ $has_errors -eq 1 ]; then
    echo ""
    echo "‚ùå Commit aborted: Invalid JSON in workflow files"
    exit 1
fi

# Check for pinData (sensitive test data)
echo ""
echo "Checking for sensitive data (pinData)..."
has_pindata=0
for file in $STAGED_WORKFLOWS; do
    if grep -q '"pinData"' "$REPO_ROOT/$file" 2>/dev/null; then
        echo "  ‚ö†Ô∏è  Has pinData: $file"
        has_pindata=1
    fi
done

if [ $has_pindata -eq 1 ]; then
    echo ""
    echo "‚ùå Commit aborted: Workflow files contain pinData (test data with sensitive IDs)"
    echo ""
    echo "Run this command to sanitize:"
    echo "  ./scripts/workflows/sanitize_workflows.sh"
    echo ""
    echo "Then re-stage the files:"
    echo "  git add n8n-workflows/*.json"
    exit 1
fi

# Run Unit Tests (Structural + Functional)
echo ""
echo "üß™ Running Unit Tests..."
has_test_errors=0

# 1. Structural/Pattern tests using unit_test_framework.py
for file in $STAGED_WORKFLOWS; do
    if ! python3 "$REPO_ROOT/scripts/workflows/unit_test_framework.py" "$REPO_ROOT/$file" >/dev/null 2>&1; then
        echo "  ‚ùå Unit test framework failed: $file"
        # Run it again without silencing to show errors
        python3 "$REPO_ROOT/scripts/workflows/unit_test_framework.py" "$REPO_ROOT/$file"
        has_test_errors=1
    else
        echo "  ‚úì $file (Structural)"
    fi
done

# 2. Functional tests using pytest (if they exist for the staged workflows)
if command -v pytest >/dev/null 2>&1 || python3 -m pytest --version >/dev/null 2>&1; then
    PYTEST_CMD="pytest"
    if ! command -v pytest >/dev/null 2>&1; then PYTEST_CMD="python3 -m pytest"; fi

    for file in $STAGED_WORKFLOWS; do
        filename=$(basename "$file" .json)
        test_file="$REPO_ROOT/n8n-workflows/tests/test_$filename.py"
        if [ -f "$test_file" ]; then
            if ! $PYTEST_CMD "$test_file" >/dev/null 2>&1; then
                echo "  ‚ùå Functional tests failed: $filename"
                # Run it again to show specific failures
                $PYTEST_CMD "$test_file" -v
                has_test_errors=1
            else
                echo "  ‚úì $file (Functional)"
            fi
        fi
    done
fi

if [ $has_test_errors -eq 1 ]; then
    echo ""
    echo "‚ùå Commit aborted: Unit tests failed"
    exit 1
fi

echo ""
echo "‚úÖ All workflow checks and tests passed!"
