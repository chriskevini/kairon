#!/bin/bash
# Pre-commit hook for Kairon
# Fast validation: JSON syntax, pinData, and structural tests
# Comprehensive functional testing moved to pre-push hook

set -euo pipefail

# Find repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check if any workflow files are staged
# Exclude regression test directory (those are test payloads, not workflows)
STAGED_WORKFLOWS=$(git diff --cached --name-only --diff-filter=ACM | grep "n8n-workflows/.*\.json$" | grep -v "n8n-workflows/tests/" || true)

if [ -z "$STAGED_WORKFLOWS" ]; then
    # No workflow files staged, nothing to do
    exit 0
fi

echo "üîç Checking staged workflow files..."
echo ""

# Validate JSON syntax
echo "Validating JSON syntax..."
has_errors=0
for file in $STAGED_WORKFLOWS; do
    if ! python3 -c "import json; json.load(open('$REPO_ROOT/$file'))" 2>/dev/null; then
        echo "  ‚ùå Invalid JSON: $file"
        python3 -c "import json; json.load(open('$REPO_ROOT/$file'))" 2>&1 | head -3
        has_errors=1
    else
        echo "  ‚úì $file"
    fi
done

if [ $has_errors -eq 1 ]; then
    echo ""
    echo "‚ùå Commit aborted: Invalid JSON in workflow files"
    exit 1
fi

# Check for pinData (sensitive test data)
echo ""
echo "Checking for sensitive data (pinData)..."
has_pindata=0
for file in $STAGED_WORKFLOWS; do
    if grep -q '"pinData"' "$REPO_ROOT/$file" 2>/dev/null; then
        echo "  ‚ö†Ô∏è  Has pinData: $file"
        has_pindata=1
    fi
done

if [ $has_pindata -eq 1 ]; then
    echo ""
    echo "‚ùå Commit aborted: Workflow files contain pinData (test data with sensitive IDs)"
    echo ""
    echo "Run this command to sanitize:"
    echo "  ./scripts/workflows/sanitize_workflows.sh"
    echo ""
    echo "Then re-stage the files:"
    echo "  git add n8n-workflows/*.json"
    exit 1
fi

# Run Fast Structural Tests (moved functional tests to pre-push)
echo ""
echo "üß™ Running Structural Tests..."
has_test_errors=0

for file in $STAGED_WORKFLOWS; do
    if ! python3 "$REPO_ROOT/scripts/workflows/unit_test_framework.py" "$REPO_ROOT/$file" >/dev/null 2>&1; then
        echo "  ‚ùå Structural tests failed: $file"
        # Run it again without silencing to show errors
        python3 "$REPO_ROOT/scripts/workflows/unit_test_framework.py" "$REPO_ROOT/$file"
        has_test_errors=1
    else
        echo "  ‚úì $file"
    fi
done

if [ $has_test_errors -eq 1 ]; then
    echo ""
    echo "‚ùå Commit aborted: Structural tests failed"
    exit 1
fi

# Run ctx Pattern Compliance Checks
echo ""
echo "üîç Checking ctx pattern compliance..."
has_ctx_errors=0

for file in $STAGED_WORKFLOWS; do
    if ! python3 "$REPO_ROOT/scripts/workflows/lint_workflows.py" "$REPO_ROOT/$file" >/dev/null 2>&1; then
        echo "  ‚ùå ctx pattern issues: $file"
        # Run it again without silencing to show details
        python3 "$REPO_ROOT/scripts/workflows/lint_workflows.py" "$REPO_ROOT/$file"
        has_ctx_errors=1
    else
        echo "  ‚úì $file"
    fi
done

if [ $has_ctx_errors -eq 1 ]; then
    echo ""
    echo "‚ùå Commit aborted: ctx pattern violations found"
    echo ""
    echo "Fix the issues or use --no-verify to bypass:"
    echo "  git commit --no-verify"
    exit 1
fi

echo ""
echo "‚úÖ All workflow checks and tests passed!"
