{
  "name": "Save_Extraction",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1792,
        608
      ],
      "id": "c14595cb-2101-462a-a7f3-8179adcb9a48",
      "name": "execute_workflow_trigger"
    },
    {
      "parameters": {
        "jsCode": "// Parse emoji to determine action type\n// Input is ctx pattern from Route_Reaction\nconst ctx = $input.first().json.ctx;\nconst event = ctx.event;\nconst emoji = event.emoji;\n\n// Number emoji map\nconst emojiMap = {\n  '1ï¸âƒ£': 1, '2ï¸âƒ£': 2, '3ï¸âƒ£': 3, '4ï¸âƒ£': 4, '5ï¸âƒ£': 5,\n  '6ï¸âƒ£': 6, '7ï¸âƒ£': 7, '8ï¸âƒ£': 8, '9ï¸âƒ£': 9, 'ðŸ”Ÿ': 10\n};\n\nconst displayOrder = emojiMap[emoji];\n\nlet actionType = 'unknown';\n\nif (displayOrder) {\n  actionType = 'save_item';\n} else if (emoji === 'âŒ') {\n  actionType = 'dismiss';\n} else if (emoji === 'ðŸ—‘ï¸') {\n  actionType = 'delete_thread';\n}\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      action: {\n        type: actionType,\n        display_order: displayOrder,\n        emoji: emoji\n      }\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1568,
        608
      ],
      "id": "cf81fc06-c1a9-4b0b-9ad6-4b11f4db7f78",
      "name": "parse_emoji_type"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id FROM projections WHERE projection_type = 'thread_extraction' AND data->>'summary_message_id' = $1 AND status = 'pending' LIMIT 1;",
        "options": {
          "queryReplacement": "={{ $json.ctx.event.message_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1344,
        680
      ],
      "id": "check-summary-message",
      "name": "check_if_summary_message",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -1120,
        608
      ],
      "id": "merge-after-check",
      "name": "restore_ctx"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.ctx.action.type }}",
                    "rightValue": "save_item",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "54e06574-e0c8-4af0-a9eb-087988e52cbe"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Save"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "f6c15010-c1d3-4a8c-89eb-46ef5a2eb3a6",
                    "leftValue": "={{ $json.ctx.action.type }}",
                    "rightValue": "dismiss",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Dismiss"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "2f9ef712-182c-40b7-b550-b66951bdecd2",
                    "leftValue": "={{ $json.ctx.action.type }}",
                    "rightValue": "delete_thread",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Delete Thread"
            }
          ]
        },
        "options": {
          "fallbackOutput": "none"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -896,
        592
      ],
      "id": "17c95810-f72f-46ff-8f0e-c84eed006985",
      "name": "what_action"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, data->>'thread_id' AS thread_id, data->>'item_type' AS item_type, data->>'text' AS text FROM projections WHERE projection_type = 'thread_extraction' AND data->>'summary_message_id' = $1 AND (data->>'display_order')::int = $2 AND status = 'pending' LIMIT 1;",
        "options": {
          "queryReplacement": "={{ $json.ctx.event.message_id }},={{ $json.ctx.action.display_order }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -672,
        272
      ],
      "id": "b35330b9-f750-4616-9b84-ce6d19b84ab6",
      "name": "get_extraction_item",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -448,
        296
      ],
      "id": "merge-extraction-ctx",
      "name": "merge_extraction_with_ctx"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.item_type }}",
                    "rightValue": "todo",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "is-todo"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Todo"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -224,
        296
      ],
      "id": "70fe2723-8181-4e57-98e7-d3fc4484f4c7",
      "name": "is_todo?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE projections SET projection_type = 'note', status = 'confirmed', confirmed_at = NOW(), data = data || jsonb_build_object('category', data->>'item_type', 'promoted_from', 'thread_extraction', 'confirmed_via', 'reaction') WHERE id = $1::uuid AND projection_type = 'thread_extraction' RETURNING id, data->>'text' AS text;",
        "options": {
          "queryReplacement": "={{ $json.id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        0,
        272
      ],
      "id": "81de3319-4c05-48cc-9cb8-f4e8278bfad9",
      "name": "promote_to_note",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE projections SET projection_type = 'todo', status = 'confirmed', confirmed_at = NOW(), data = data || jsonb_build_object('promoted_from', 'thread_extraction', 'confirmed_via', 'reaction', 'todo_status', 'pending') WHERE id = $1::uuid AND projection_type = 'thread_extraction' RETURNING id, data->>'text' AS text;",
        "options": {
          "queryReplacement": "={{ $json.id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        0,
        536
      ],
      "id": "87dbb168-a1c3-4e8c-8547-dbcc69a33849",
      "name": "promote_to_todo",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "mode": "append",
        "numberInputs": 2
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        224,
        296
      ],
      "id": "d87f449e-a026-4d48-aa08-e9489c352b51",
      "name": "after_promote"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.EMBEDDING_SERVICE_URL }}/embed",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"texts\": [{{ JSON.stringify($json.text || '') }}]\n}",
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        224,
        80
      ],
      "id": "embed-projection-text",
      "name": "embed_projection_text",
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Insert embedding for the saved projection (fire-and-forget)\nINSERT INTO embeddings (projection_id, model, embedding_data, embedded_text, embedding)\nSELECT \n  $1::uuid,\n  'all-MiniLM-L6-v2',\n  '{}',\n  $2,\n  $3::vector\nWHERE $3 IS NOT NULL\nON CONFLICT DO NOTHING;",
        "options": {
          "queryReplacement": "={{ $('After Promote').first().json.id }},={{ $('After Promote').first().json.text }},={{ $json.embeddings && $json.embeddings[0] ? '[' + $json.embeddings[0].join(',') + ']' : null }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        448,
        80
      ],
      "id": "insert-embedding",
      "name": "insert_embedding",
      "continueOnFail": true,
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://discord.com/api/v10/channels/{{ $('What Action').item.json.ctx.event.channel_id }}/messages/{{ $('What Action').item.json.ctx.event.message_id }}/reactions/{{ encodeURIComponent($('What Action').item.json.ctx.action.emoji) }}/@me",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        448,
        296
      ],
      "id": "51af8a9d-7ace-4b47-a579-4efa1886e799",
      "name": "remove_number_emoji",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) as unsaved FROM projections WHERE projection_type = 'thread_extraction' AND data->>'summary_message_id' = $1 AND status = 'pending' HAVING COUNT(*) = 0;",
        "options": {
          "queryReplacement": "={{ $('What Action').item.json.ctx.event.message_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        672,
        296
      ],
      "id": "6c50df92-a223-416d-87c6-7f7aa5841f48",
      "name": "check_all_saved",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://discord.com/api/v10/channels/{{ $('What Action').item.json.ctx.event.channel_id }}/messages/{{ $('What Action').item.json.ctx.event.message_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"content\": \"âœ… All items saved!\\n\\nðŸ—‘ï¸ Delete thread â€¢ âŒ Dismiss\" } }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        896,
        296
      ],
      "id": "90af10c8-1c74-467e-ae4e-dbd793ddd892",
      "name": "update_summary_(all_saved)",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -672,
        560
      ],
      "id": "8e521696-abc7-42b6-b5fd-74c679809412",
      "name": "delete_summary_(dismiss)",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT data->>'thread_id' AS discord_thread_id FROM projections WHERE projection_type = 'thread_extraction' AND data->>'summary_message_id' = $1 LIMIT 1;",
        "options": {
          "queryReplacement": "={{ $json.ctx.event.message_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -672,
        752
      ],
      "id": "f0bf81d2-b00c-4009-a86b-a7f48ae744fc",
      "name": "get_discord_thread_id",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://discord.com/api/v10/channels/{{ $json.discord_thread_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -448,
        944
      ],
      "id": "1b798d04-8f99-4a90-b37d-81b891a35c8b",
      "name": "delete_discord_thread",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -448,
        752
      ],
      "id": "merge-thread-ctx",
      "name": "restore_ctx_for_thread"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -224,
        944
      ],
      "id": "merge-status-ctx",
      "name": "restore_ctx_for_delete_msg"
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        944
      ],
      "id": "45c43642-ffd9-45a0-9c83-f10fdc226336",
      "name": "delete_summary_message",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    }
  ],
  "connections": {
    "execute_workflow_trigger": {
      "main": [
        [
          {
            "node": "parse_emoji_type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parse_emoji_type": {
      "main": [
        [
          {
            "node": "check_if_summary_message",
            "type": "main",
            "index": 0
          },
          {
            "node": "restore_ctx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_if_summary_message": {
      "main": [
        [
          {
            "node": "restore_ctx",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "restore_ctx": {
      "main": [
        [
          {
            "node": "what_action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "what_action": {
      "main": [
        [
          {
            "node": "get_extraction_item",
            "type": "main",
            "index": 0
          },
          {
            "node": "merge_extraction_with_ctx",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "delete_summary_(dismiss)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get_discord_thread_id",
            "type": "main",
            "index": 0
          },
          {
            "node": "restore_ctx_for_thread",
            "type": "main",
            "index": 1
          },
          {
            "node": "restore_ctx_for_delete_msg",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "get_extraction_item": {
      "main": [
        [
          {
            "node": "merge_extraction_with_ctx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "merge_extraction_with_ctx": {
      "main": [
        [
          {
            "node": "is_todo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is_todo?": {
      "main": [
        [
          {
            "node": "promote_to_todo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "promote_to_note",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "promote_to_note": {
      "main": [
        [
          {
            "node": "after_promote",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "promote_to_todo": {
      "main": [
        [
          {
            "node": "after_promote",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "after_promote": {
      "main": [
        [
          {
            "node": "remove_number_emoji",
            "type": "main",
            "index": 0
          },
          {
            "node": "embed_projection_text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "embed_projection_text": {
      "main": [
        [
          {
            "node": "insert_embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "remove_number_emoji": {
      "main": [
        [
          {
            "node": "check_all_saved",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_all_saved": {
      "main": [
        [
          {
            "node": "update_summary_(all_saved)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_discord_thread_id": {
      "main": [
        [
          {
            "node": "delete_discord_thread",
            "type": "main",
            "index": 0
          },
          {
            "node": "restore_ctx_for_thread",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "delete_discord_thread": {
      "main": [
        []
      ]
    },
    "restore_ctx_for_thread": {
      "main": [
        [
          {
            "node": "restore_ctx_for_delete_msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "restore_ctx_for_delete_msg": {
      "main": [
        [
          {
            "node": "delete_summary_message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "JOXLqn9TTznBdo7Q"
  },
  "staticData": null,
  "meta": null,
  "active": false
}
