{
  "name": "Auto_Backfill",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ],
      "id": "cron-trigger",
      "name": "cron_trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Find projections missing embeddings\nSELECT \n  p.id as projection_id,\n  p.projection_type,\n  p.data->>'description' as description,\n  p.data->>'text' as text\nFROM projections p\nLEFT JOIN embeddings e ON p.id = e.projection_id\nWHERE e.id IS NULL\n  AND p.status IN ('auto_confirmed', 'confirmed')\nLIMIT 20;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        250,
        -100
      ],
      "id": "find-missing-embeddings",
      "name": "find_missing_embeddings",
      "credentials": {
        "postgres": {
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        500,
        -100
      ],
      "id": "loop-embeddings",
      "name": "loop_embeddings",
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.EMBEDDING_SERVICE_URL }}/embed",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"texts\": [{{ JSON.stringify($json.description || $json.text || \"\") }}]\n}",
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        750,
        -100
      ],
      "id": "embed-text",
      "name": "embed_text",
      "continueOnFail": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PLACEHOLDER_WILL_BE_FIXED_BY_DEPLOY",
          "mode": "list",
          "cachedResultName": "Execute_Queries"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        1000,
        -100
      ],
      "id": "insert-embedding",
      "name": "insert_embedding",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const item = $json;\nconst projectionId = item.projection_id;\nconst text = item.description || item.text || \"\";\nconst embeddings = $(\"Embed Text\").item.json.embeddings;\n\nif (!embeddings || !embeddings[0]) return [];\n\nconst vector = \"[\" + embeddings[0].join(\",\") + \"]\";\n\nreturn [{\n  json: {\n    ctx: {\n      db_queries: [{\n        key: \"embedding\",\n        sql: \"INSERT INTO embeddings (projection_id, model, embedding_data, embedded_text, embedding) SELECT $1, \\u0027all-MiniLM-L6-v2\\u0027, \\u0027{}\\u0027, $2, $3::vector WHERE NOT EXISTS (SELECT 1 FROM embeddings WHERE projection_id = $1) ON CONFLICT DO NOTHING;\",\n        params: [projectionId, text, vector]\n      }]\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        875,
        50
      ],
      "id": "prepare-embedding-query",
      "name": "prepare_embedding_query"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Find traces with missing projections\nSELECT \n  t.id as trace_id,\n  t.event_id,\n  t.data->>'completion' as completion,\n  t.trace_chain,\n  e.timezone\nFROM traces t\nJOIN events e ON t.event_id = e.id\nWHERE t.step_name = 'multi_capture'\n  AND (t.data->>'capture_count')::int > (\n    SELECT COUNT(*) FROM projections p WHERE p.trace_id = t.id\n  )\nLIMIT 5;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        250,
        300
      ],
      "id": "find-incomplete-traces",
      "name": "find_incomplete_traces",
      "credentials": {
        "postgres": {
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const trace = item.json;\n  let parsed;\n  try {\n    parsed = JSON.parse(trace.completion);\n  } catch (e) {\n    console.error(`Failed to parse completion for trace ${trace.trace_id}: ${e.message}`);\n    continue;\n  }\n\n  const types = ['activity', 'note', 'todo'];\n  for (const type of types) {\n    const data = parsed[type];\n    if (data && data.confidence >= 0.5) {\n      results.push({\n        json: {\n          trace_id: trace.trace_id,\n          event_id: trace.event_id,\n          trace_chain: trace.trace_chain,\n          timezone: trace.timezone,\n          type: type,\n          data: data\n        }\n      });\n    }\n  }\n}\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        300
      ],
      "id": "parse-missing-projections",
      "name": "parse_missing_projections"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PLACEHOLDER_WILL_BE_FIXED_BY_DEPLOY",
          "mode": "list",
          "cachedResultName": "Execute_Queries"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        750,
        300
      ],
      "id": "insert-missing-projections",
      "name": "insert_missing_projections",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const item = $json;\nreturn [{\n  json: {\n    ctx: {\n      db_queries: [{\n        key: \"projection\",\n        sql: \"INSERT INTO projections (trace_id, event_id, trace_chain, projection_type, data, status, timezone) SELECT $1::uuid, $2::uuid, $3::uuid[], $4, $5::jsonb, \\u0027auto_confirmed\\u0027, $6 WHERE NOT EXISTS (SELECT 1 FROM projections WHERE trace_id = $1 AND projection_type = $4);\",\n        params: [\n          item.trace_id,\n          item.event_id,\n          \"{\" + item.trace_chain.join(\",\") + \"}\",\n          item.type,\n          JSON.stringify(item.data),\n          item.timezone\n        ]\n      }]\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        625,
        450
      ],
      "id": "prepare-projection-query",
      "name": "prepare_projection_query"
    }
  ],
  "connections": {
    "cron_trigger": {
      "main": [
        [
          {
            "node": "find_missing_embeddings",
            "type": "main",
            "index": 0
          },
          {
            "node": "find_incomplete_traces",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "find_missing_embeddings": {
      "main": [
        [
          {
            "node": "loop_embeddings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "loop_embeddings": {
      "main": [
        [],
        [
          {
            "node": "embed_text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "embed_text": {
      "main": [
        [
          {
            "node": "prepare_embedding_query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_embedding_query": {
      "main": [
        [
          {
            "node": "insert_embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "insert_embedding": {
      "main": [
        [
          {
            "node": "loop_embeddings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "find_incomplete_traces": {
      "main": [
        [
          {
            "node": "parse_missing_projections",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parse_missing_projections": {
      "main": [
        [
          {
            "node": "prepare_projection_query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_projection_query": {
      "main": [
        [
          {
            "node": "insert_missing_projections",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}