{
  "name": "Handle_Correction",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -800,
        400
      ],
      "id": "trigger-correction",
      "name": "execute_workflow_trigger"
    },
    {
      "parameters": {
        "jsCode": "// Build lookup query for Execute_Queries\nconst ctx = $json.ctx;\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries: [{\n        key: 'original',\n        sql: `-- Look up the original event that created projections for this message\n-- Also get the emoji mapping config for correction types\nWITH original AS (\n  SELECT \n    e.id as event_id,\n    e.payload->>'discord_message_id' as message_id,\n    e.payload->>'clean_text' as clean_text,\n    e.payload->>'discord_channel_id' as channel_id,\n    e.payload->>'discord_guild_id' as guild_id,\n    e.payload->>'author_login' as author_login,\n    e.payload as original_payload\n  FROM events e\n  WHERE e.payload->>'discord_message_id' = $1\n    AND e.event_type = 'discord_message'\n  ORDER BY e.received_at DESC\n  LIMIT 1\n),\nemoji_config AS (\n  SELECT value FROM config WHERE key = 'emoji_mapping'\n)\nSELECT \n  o.*,\n  ec.value as emoji_mapping\nFROM original o\nCROSS JOIN emoji_config ec;`,\n        params: [ctx.event.message_id]\n      }]\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        400
      ],
      "id": "build-lookup-query",
      "name": "build_lookup_query"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PLACEHOLDER_WILL_BE_FIXED_BY_DEPLOY",
          "mode": "list",
          "cachedResultName": "Execute_Queries"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -352,
        400
      ],
      "id": "lookup-original-event",
      "name": "lookup_original_event"
    },
    {
      "parameters": {
        "jsCode": "// Prepare correction context from lookup result\nconst ctx = $json.ctx;\nconst original = ctx.db?.original?.row;\n\nif (!original || !original.event_id) {\n  return {\n    ctx,\n    has_original: false,\n    error: 'No original event found for this message'\n  };\n}\n\n// Parse emoji mapping - Postgres returns JSON as string\nconst rawMapping = original.emoji_mapping;\nconst emojiMapping = typeof rawMapping === 'string' ? JSON.parse(rawMapping) : (rawMapping || {});\nconst types = emojiMapping.types || {};\nconst actions = emojiMapping.actions || {};\nconst emoji = ctx.event.emoji;\n\n// Determine correction type\nlet correctionType = null;\nlet correctionTag = null;\nlet isVoidOnly = false;\n\nif (types[emoji]) {\n  correctionType = types[emoji].type;\n  correctionTag = types[emoji].tag;\n} else if (actions[emoji] === 'void') {\n  isVoidOnly = true;\n}\n\n// Pre-compute values for Postgres queries to avoid n8n expression parsing issues\nconst messageUrl = `https://discord.com/channels/${original.guild_id}/${original.channel_id}/${original.message_id}`;\nconst idempotencyKey = `correction_${original.message_id}_${Date.now()}`;\n\nreturn {\n  ctx,\n  has_original: true,\n  original: {\n    event_id: original.event_id,\n    message_id: original.message_id,\n    clean_text: original.clean_text,\n    channel_id: original.channel_id,\n    guild_id: original.guild_id,\n    author_login: original.author_login,\n    payload: original.original_payload,\n    message_url: messageUrl\n  },\n  correction: {\n    emoji: emoji,\n    type: correctionType,\n    tag: correctionTag,\n    is_void_only: isVoidOnly,\n    idempotency_key: idempotencyKey\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -128,
        400
      ],
      "id": "prepare-correction",
      "name": "prepare_correction"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-original",
              "leftValue": "={{ $json.has_original }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        96,
        400
      ],
      "id": "has-original-check",
      "name": "has_original?"
    },
    {
      "parameters": {
        "jsCode": "// Build queries for correction event creation and voiding projections\n// Uses $results chaining: correction event id -> void projections\nconst data = $json;\nconst ctx = data.ctx;\nconst original = data.original;\nconst correction = data.correction;\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries: [\n        {\n          key: 'correction_event',\n          sql: `-- Create correction event for audit trail\nINSERT INTO events (idempotency_key, event_type, payload)\nVALUES (\n  $1,\n  'user_correction',\n  jsonb_build_object(\n    'original_event_id', $2,\n    'original_message_id', $3,\n    'correction_emoji', $4,\n    'correction_type', $5,\n    'is_void_only', $6,\n    'triggered_by_event_id', $7\n  )\n)\nON CONFLICT (event_type, idempotency_key) DO NOTHING\nRETURNING id;`,\n          params: [\n            correction.idempotency_key,\n            original.event_id,\n            original.message_id,\n            correction.emoji,\n            correction.type || 'void',\n            correction.is_void_only,\n            ctx.event.event_id\n          ]\n        },\n        {\n          key: 'voided',\n          sql: `-- Void ALL projections for this Discord message (by message_url)\n-- This catches both original projections and any corrected ones\nUPDATE projections\nSET \n  status = 'voided',\n  voided_at = NOW(),\n  voided_reason = 'user_correction',\n  voided_by_event_id = $1::uuid\nWHERE data->>'message_url' = $2\n  AND status IN ('pending', 'auto_confirmed', 'confirmed')\nRETURNING id, projection_type, data->>'description' as description, data->>'text' as text;`,\n          params: [\n            '$results.correction_event.row.id',\n            original.message_url\n          ]\n        }\n      ]\n    },\n    original: original,\n    correction: correction\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        336
      ],
      "id": "build-correction-queries",
      "name": "build_correction_queries"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PLACEHOLDER_WILL_BE_FIXED_BY_DEPLOY",
          "mode": "list",
          "cachedResultName": "Execute_Queries"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        544,
        336
      ],
      "id": "execute-correction-queries",
      "name": "execute_correction_queries"
    },
    {
      "parameters": {
        "jsCode": "// Build list of emojis to remove based on voided projection types\nconst ctx = $json.ctx;\nconst original = $('Build Correction Queries').first().json.original;\nconst channelId = original.channel_id;\nconst messageId = original.message_id;\n\n// Get voided projection types from Execute_Queries result\nconst voidedRows = ctx.db?.voided?.rows || [];\nconst voidedTypes = voidedRows.map(item => item.projection_type).filter(Boolean);\n\n// Map projection types to their emojis\nconst typeToEmoji = {\n  'activity': 'ðŸ”˜',\n  'note': 'ðŸ“',\n  'todo': 'âœ…'\n};\n\n// Only remove emojis for the projection types that were actually voided\nconst emojisToRemove = [...new Set(voidedTypes.map(t => typeToEmoji[t]).filter(Boolean))];\n\nif (emojisToRemove.length === 0) {\n  // No emojis to remove, return skip marker\n  return [{ json: { skip: true, ctx } }];\n}\n\nreturn emojisToRemove.map(emoji => ({\n  json: {\n    channel_id: channelId,\n    message_id: messageId,\n    emoji: emoji,\n    encoded_emoji: encodeURIComponent(emoji),\n    skip: false,\n    ctx\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        336
      ],
      "id": "build-emoji-remove-list",
      "name": "build_emoji_remove_list"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "not-skip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        880,
        336
      ],
      "id": "filter-skip",
      "name": "has_emoji_to_remove?"
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://discord.com/api/v10/channels/{{ $json.channel_id }}/messages/{{ $json.message_id }}/reactions/{{ $json.encoded_emoji }}/@me",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1104,
        272
      ],
      "id": "remove-bot-emojis",
      "name": "remove_bot_emojis",
      "retryOnFail": false,
      "credentials": {
        "discordBotApi": {
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// After removing emojis, check if we need to re-extract or just void\nconst prepareData = $('Build Correction Queries').first().json;\nconst ctx = $('Execute Correction Queries').first().json.ctx;\n\n// Get correction event ID from Execute_Queries result\nconst correctionEventId = ctx.db?.correction_event?.row?.id;\n\n// Collect voided projection IDs for linking to new projection\nconst voidedRows = ctx.db?.voided?.rows || [];\nconst voidedProjectionIds = voidedRows.map(item => item.id).filter(Boolean);\n\nreturn {\n  ctx,\n  original: prepareData.original,\n  correction: prepareData.correction,\n  correction_event_id: correctionEventId,\n  voided_projection_ids: voidedProjectionIds,\n  should_reextract: !prepareData.correction.is_void_only && !!prepareData.correction.type\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        336
      ],
      "id": "check-reextract",
      "name": "check_re_extract"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "should-reextract",
              "leftValue": "={{ $json.should_reextract }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1552,
        336
      ],
      "id": "should-reextract-check",
      "name": "should_re_extract?"
    },
    {
      "parameters": {
        "jsCode": "// Build ctx for Capture_Projection, reusing original event data\nconst data = $json;\nconst original = data.original;\nconst correction = data.correction;\nconst existingCtx = data.ctx || {};\n\n// Map correction type to projection type\nconst typeMap = {\n  'activity': 'activity',\n  'note': 'note',\n  'todo': 'todo'\n};\n\nconst projectionType = typeMap[correction.type] || 'note';\n\n// Build new trace chain starting from correction event\nconst traceChain = [data.correction_event_id];\nconst traceChainPg = '{' + traceChain.join(',') + '}';\n\n// Construct message_url from original data\nconst messageUrl = `https://discord.com/channels/${original.guild_id}/${original.channel_id}/${original.message_id}`;\n\n// Pass voided projection IDs for supersedes linking\nconst voidedProjectionIds = data.voided_projection_ids || [];\n\nreturn {\n  ctx: {\n    ...existingCtx,\n    event: {\n      event_id: data.correction_event_id,\n      event_type: 'user_correction',\n      timestamp: new Date().toISOString(),\n      timezone: existingCtx.event?.timezone,\n      guild_id: original.guild_id,\n      channel_id: original.channel_id,\n      message_id: original.message_id,\n      message_url: messageUrl,\n      author_login: original.author_login,\n      raw_text: original.clean_text,\n      clean_text: original.clean_text,\n      tag: correction.tag,\n      trace_chain: traceChain,\n      trace_chain_pg: traceChainPg\n    },\n    projection: {\n      type: projectionType\n    },\n    correction: {\n      original_event_id: original.event_id,\n      emoji: correction.emoji,\n      voided_projection_ids: voidedProjectionIds\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        272
      ],
      "id": "build-capture-ctx",
      "name": "build_capture_ctx"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PLACEHOLDER_WILL_BE_FIXED_BY_DEPLOY",
          "mode": "list",
          "cachedResultName": "Capture_Projection"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2000,
        272
      ],
      "id": "execute-capture",
      "name": "execute_capture_projection"
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "={{ $('Build Correction Queries').first().json.original.guild_id }}",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $env.DISCORD_CHANNEL_KAIRON_LOGS }}",
          "mode": "id"
        },
        "content": "=**[Correction]** {{ $('Build Correction Queries').first().json.correction.is_void_only ? 'Voided' : 'Re-extracted as ' + $('Build Correction Queries').first().json.correction.type }} for message `{{ $('Build Correction Queries').first().json.original.message_id }}`",
        "options": {}
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        2000,
        464
      ],
      "id": "log-correction",
      "name": "log_correction",
      "webhookId": "correction-log",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "={{ $json.ctx.event.guild_id }}",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $env.DISCORD_CHANNEL_KAIRON_LOGS }}",
          "mode": "id"
        },
        "content": "=**[Correction]** No original event found for message `{{ $json.ctx.event.message_id }}`",
        "options": {}
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        320,
        560
      ],
      "id": "log-no-original",
      "name": "log_no_original",
      "webhookId": "no-original-log",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    }
  ],
  "connections": {
    "execute_workflow_trigger": {
      "main": [
        [
          {
            "node": "build_lookup_query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "build_lookup_query": {
      "main": [
        [
          {
            "node": "lookup_original_event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "lookup_original_event": {
      "main": [
        [
          {
            "node": "prepare_correction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_correction": {
      "main": [
        [
          {
            "node": "has_original?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "has_original?": {
      "main": [
        [
          {
            "node": "build_correction_queries",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "log_no_original",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "build_correction_queries": {
      "main": [
        [
          {
            "node": "execute_correction_queries",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "execute_correction_queries": {
      "main": [
        [
          {
            "node": "build_emoji_remove_list",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "build_emoji_remove_list": {
      "main": [
        [
          {
            "node": "has_emoji_to_remove?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "has_emoji_to_remove?": {
      "main": [
        [
          {
            "node": "remove_bot_emojis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "check_re_extract",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "remove_bot_emojis": {
      "main": [
        [
          {
            "node": "check_re_extract",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_re_extract": {
      "main": [
        [
          {
            "node": "should_re_extract?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "should_re_extract?": {
      "main": [
        [
          {
            "node": "build_capture_ctx",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "log_correction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "build_capture_ctx": {
      "main": [
        [
          {
            "node": "execute_capture_projection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "JOXLqn9TTznBdo7Q"
  },
  "staticData": null,
  "meta": null,
  "active": false
}
