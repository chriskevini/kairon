{
  "name": "Handle_Quality_Rating",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [-400, 300],
      "id": "trigger-quality-rating",
      "name": "Receive Event"
    },
    {
      "parameters": {
        "jsCode": "// Parse quality rating from emoji and prepare db_writes\nconst ctx = $json.ctx;\nconst emoji = ctx.event.emoji;\n\n// Map emoji to quality score\nconst qualityMap = {\n  'ðŸ‘': 1.0,\n  'ðŸ‘Ž': 0.0\n};\n\nconst qualityScore = qualityMap[emoji];\n\nif (qualityScore === undefined) {\n  throw new Error(`Unknown quality emoji: ${emoji}`);\n}\n\n// Prepare quality metadata JSON\nconst metadataUpdate = JSON.stringify({\n  quality_rated_at: new Date().toISOString(),\n  quality_emoji: emoji\n});\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      quality: {\n        score: qualityScore,\n        emoji: emoji\n      }\n    },\n    db_writes: [{\n      key: 'updated_projections',\n      sql: `WITH target_projections AS (\n              SELECT p.id\n              FROM projections p\n              JOIN events e ON p.event_id = e.id\n              WHERE e.payload->>'discord_message_id' = $3\n                AND e.event_type = 'discord_message'\n                AND p.status IN ('auto_confirmed', 'confirmed')\n              UNION\n              SELECT p.id\n              FROM projections p\n              WHERE (p.data->>'discord_message_id' = $3\n                 OR p.metadata->>'message_id' = $3)\n                AND p.status IN ('auto_confirmed', 'confirmed')\n            )\n            UPDATE projections\n            SET \n              quality_score = $1,\n              metadata = COALESCE(metadata, '{}'::jsonb) || $2::jsonb\n            WHERE id IN (SELECT id FROM target_projections)\n            RETURNING id, projection_type, quality_score`,\n      params: [qualityScore, metadataUpdate, ctx.event.message_id]\n    }]\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-180, 300],
      "id": "parse-quality",
      "name": "Parse Quality Rating"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "zgJX3AbUNUvDJa48"
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [40, 300],
      "id": "update-quality-score",
      "name": "Update Quality Write_DB"
    },
    {
      "parameters": {
        "jsCode": "// Format response based on updated projections from Write_DB\nconst ctx = $json.ctx;\nconst qualityScore = ctx.quality.score;\nconst emoji = ctx.quality.emoji;\nconst updated = ctx.db?.updated_projections?.rows || [];\n\nif (!updated || updated.length === 0) {\n  return {\n    ctx,\n    response: {\n      content: `${emoji} No projections found for this message to rate.`\n    },\n    updated_count: 0\n  };\n}\n\nconst count = updated.length;\nconst types = [...new Set(updated.map(u => u.projection_type))];\nconst typeStr = types.join(', ');\nconst scoreLabel = qualityScore === 1.0 ? 'good' : 'poor';\n\nreturn {\n  ctx,\n  response: {\n    content: `${emoji} Marked ${count} projection(s) as **${scoreLabel}** quality (${typeStr})`\n  },\n  updated_count: count\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [260, 300],
      "id": "format-response",
      "name": "Format Response"
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "={{ $json.ctx.event.guild_id }}",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $json.ctx.event.channel_id }}",
          "mode": "id"
        },
        "content": "={{ $json.response.content }}",
        "options": {
          "messageReference": "={{ $json.ctx.event.message_id }}"
        }
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [480, 300],
      "id": "send-response",
      "name": "Send Response",
      "webhookId": "quality-rating-response",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      }
    }
  ],
  "connections": {
    "Receive Event": {
      "main": [
        [
          {
            "node": "Parse Quality Rating",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Quality Rating": {
      "main": [
        [
          {
            "node": "Update Quality Write_DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Quality Write_DB": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Send Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "JOXLqn9TTznBdo7Q"
  },
  "staticData": null,
  "meta": null,
  "active": false
}
