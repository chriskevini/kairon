{
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "event",
              "type": "object"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        9072,
        -2416
      ],
      "id": "51c02930-4e28-4480-94e8-aa4e5fe30136",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "start-time",
              "name": "inference_start",
              "value": "={{ Date.now() }}",
              "type": "number"
            },
            {
              "id": "pass-event",
              "name": "event",
              "value": "={{ $json.event }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9296,
        -2416
      ],
      "id": "set-inference-start",
      "name": "Set Inference Start"
    },
    {
      "parameters": {
        "jsCode": "const event = $json.event;\n\nreturn [{\n  json: {\n    cleanText: event.clean_text,\n    ...event\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9520,
        -2416
      ],
      "id": "4e424566-9cbb-4e44-9050-f9a5391c3fc6",
      "name": "Prepare LLM Context"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are a note classifier for a life-tracking system.\n\nClassify notes into exactly 2 categories. Assign probability scores (0-100) that add up to exactly 100.\n\n# Categories\n\nfact ‚Üí External, objective, declarative knowledge about the world or people (birthdays, preferences, allergies, likes/dislikes, factual statements about others).\n\nreflection ‚Üí Internal, subjective knowledge (insights, decisions, observations, realizations, thoughts, self-analysis, patterns, emotional states, personal commitments).\n\n# The Core Distinction\n- fact = \"Things about the world/others\" (external reality)\n- reflection = \"Things about me/my mind\" (internal experience)\n\n# Key Guidelines\n- Declarative statements about others ‚Üí fact (\"John loves coffee\", \"Sarah is allergic to nuts\")\n- Dates, birthdays, preferences of others ‚Üí fact\n- Personal insights, realizations ‚Üí reflection (\"I work better in mornings\")\n- Decisions, commitments ‚Üí reflection (\"decided to switch to async\")\n- Self-observations ‚Üí reflection (\"I've been more focused lately\")\n- General observations about yourself ‚Üí reflection\n- When in doubt: Is it about THEM or about ME? ‚Üí fact vs reflection\n\nOutput format (only lines with score >5):\ncategory_name|score\n\n(Scores must sum to exactly 100, integers only)\n\n# Examples\n\nJohn loves dark roast coffee\nfact|95\nreflection|5\n\nMom's birthday is June 12\nfact|98\nreflection|2\n\nSarah is allergic to nuts\nfact|96\nreflection|4\n\nDad prefers evening phone calls\nfact|94\nreflection|6\n\nnoticed an interesting pattern in my productivity\nreflection|94\nfact|6\n\nI work better in the mornings\nreflection|88\nfact|12\n\ndecided to switch to async communication\nreflection|92\nfact|8\n\nI've been forgetting people's preferences lately\nreflection|85\nfact|15\n\nreducing context switching improves focus\nreflection|70\nfact|30\n\nfeeling more energized after morning walks\nreflection|92\nfact|8\n\nEmily doesn't drink alcohol\nfact...
        "needsFallback": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        9744,
        -2416
      ],
      "id": "a2434954-254a-4336-946f-0d1ab067cc15",
      "name": "Note Classifier"
    },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        9520,
        -2416
      ],
      "id": "a2434954-254a-4336-946f-0d1ab067cc15",
      "name": "Note Classifier"
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM output in pipe format: \"category|score\" (Option E schema)\nlet text = $input.item.json.text.trim();\n\nconst event = $('Set Inference Start').first().json.event;\nconst inferenceStart = $('Set Inference Start').first().json.inference_start;\nconst durationMs = Date.now() - inferenceStart;\n\ntry {\n  // Parse pipe format: \"fact|95\\nreflection|5\"\n  const lines = text.split('\\n').filter(line => line.includes('|'));\n  const scores = {};\n  const all_scores = {};\n  let topCategory = null;\n  let topScore = 0;\n  \n  lines.forEach(line => {\n    const [category, scoreStr] = line.split('|').map(s => s.trim());\n    const score = parseInt(scoreStr);\n    \n    if (!isNaN(score)) {\n      scores[category] = score;\n      all_scores[category] = score;\n      \n      if (score > topScore) {\n        topScore = score;\n        topCategory = category;\n      }\n    }\n  });\n  \n  // Ensure we have at least one category\n  if (!topCategory) {\n    throw new Error('No valid categories found in LLM response');\n  }\n  \n  // Build full prompt text (filled prompt for Option E)\n  const promptText = `You are a note classifier for a life-tracking system.\n\nClassify notes into exactly 2 categories. Assign probability scores (0-100) that add up to exactly 100.\n\n# Categories\n\nfact ‚Üí External, objective, declarative knowledge about the world or people (birthdays, preferences, allergies, likes/dislikes, factual statements about others).\n\nreflection ‚Üí Internal, subjective knowledge (insights, decisions, observations, realizations, thoughts, self-analysis, patterns, emotional states, personal commitments).\n\n# The Core Distinction\n- fact = \"Things about the world/others\" (external reality)\n- reflection = \"Things about me/my mind\" (internal experience)\n\n# Key Guidelines\n- Declarative statements about others ‚Üí fact (\"John loves coffee\", \"Sarah is allergic to nuts\")\n- Dates, birthdays, preferences of others ‚Üí fact\n- Personal insights, realizations ‚Üí reflection (\"I work better in mornings\")\n- Decisions, commitments ‚Üí reflection (\"decided to switch to async\")\n- Self-observations ‚Üí reflection (\"I've been more focused lately\")\n- General observations about yourself ‚Üí reflection\n- When in doubt: Is it about THEM or about ME? ‚Üí fact vs reflection\n\nOutput format (only lines with score >5):\ncategory_name|score\n\n(Scores must sum to exactly 100, integers only)\n\n# Message to classify:\n${event.clean_text}`;\n  \n  return [{\n    json: {\n      // Option E schema fields for trace\n      input_text: event.clean_text,\n      prompt_text: promptText,\n      completion_text: text,\n      result_category: topCategory,\n      result_all_scores: all_scores,\n      duration_ms: durationMs,\n      \n      // Projection fields\n      category: topCategory,\n      all_scores: all_scores,\n      text: event.clean_text,  // Use original message as note text (pure user thought)\n      ...event  // Pass through all event fields\n    }\n  }];\n} catch (error) {\n  // Fallback: if parsing fails, default to \"reflection\" category\n  return [{\n    json: {\n      input_text: event.clean_text,\n      prompt_text: '',\n      completion_text: text,\n      result_category: \"reflection\",\n      result_all_scores: {},\n      duration_ms: durationMs,\n      \n      category: \"reflection\",\n      all_scores: {},\n      text: event.clean_text,\n      parse_error: error.message,\n      ...event\n    }\n  }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9968,
        -2416
      ],
      "id": "5b98a789-9ad9-4c5a-affb-c21d33d96189",
      "name": "Parse LLM Response"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH new_trace AS (\n  INSERT INTO traces (event_id, parent_trace_id, step_name, step_order, data, trace_chain)\n  VALUES (\n    $1::uuid,\n    ($8::uuid[])[array_upper($8::uuid[], 1)],\n    'note_extraction',\n    2,\n    jsonb_build_object(\n      'input', jsonb_build_object(\n        'text', $2\n      ),\n      'prompt', $3,\n      'completion', $4,\n      'result', jsonb_build_object(\n        'category', $5,\n        'all_scores', $6::jsonb\n      ),\n      'model', 'xiaomi/mimo-v2-flash:free',\n      'duration_ms', $7::integer
    ),
    $8::uuid[]
  )
  RETURNING id, event_id\n)\nINSERT INTO projections (\n  trace_id,\n  event_id,\n  trace_chain,\n  projection_type,\n  data,\n  status\n)\nSELECT\n  new_trace.id,\n  new_trace.event_id,\n  $8::uuid[] || new_trace.id,\n  'note',\n  jsonb_build_object(\n    'timestamp', NOW(),\n    'category', $5,\n    'text', $2\n  ),\n  'auto_confirmed'\nFROM new_trace\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ $('Parse LLM Response').item.json.event_id }},={{ $('Parse LLM Response').item.json.input_text }},={{ $('Parse LLM Response').item.json.prompt_text }},={{ $('Parse LLM Response').item.json.completion_text }},={{ $('Parse LLM Response').item.json.result_category }},={{ JSON.stringify($('Parse LLM Response').item.json.result_all_scores) }},={{ $('Parse LLM Response').item.json.duration_ms }},={{ JSON.stringify($('Parse LLM Response').item.json.trace_chain) }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        10320,
        -2416
      ],
      "id": "cee38a74-3402-4a33-931b-20cac3beae43",
      "name": "Store Note",
      "credentials": {
        "postgres": {
          "id": "MdnYzEgjzWRujz2v",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "react",
        "guildId": {
          "__rl": true,
          "value": "={{ $('Parse LLM Response').item.json.guild_id }}",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $('Parse LLM Response').item.json.channel_id }}",
          "mode": "id"
        },
        "messageId": "={{ $('Parse LLM Response').item.json.message_id }}",
        "emoji": "=üìù"
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        10544,
        -2416
      ],
      "id": "0eaab7df-b380-4053-be65-38055c4b83b6",
      "name": "React with üìù",
      "webhookId": "60c18aeb-3403-429d-8436-05ab229456b7",
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      }
    },
    {
      "parameters": {
        "model": "nvidia/nemotron-nano-9b-v2:free",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        9656,
        -2192
      ],
      "id": "0c141715-cbf6-4603-8bd3-07e33d952686",
      "name": "nemotron-nano-9b",
      "credentials": {
        "openRouterApi": {
          "id": "r79IBN16aZtPIN8T",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "model": "xiaomi/mimo-v2-flash:free",
        "options": {
          "timeout": 10000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        9528,
        -2192
      ],
      "id": "462c48d4-7538-458b-9c7a-1dead992f2dc",
      "name": "mimo-v2-flash",
      "credentials": {
        "openRouterApi": {
          "id": "r79IBN16aZtPIN8T",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "={{ $('Parse LLM Response').item.json.guild_id }}",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $env.DISCORD_CHANNEL_KAIRON_LOGS }}",
          "mode": "id"
        },
        "content": "=**[Note Classification]**\n**Message:** {{ $json.clean_text }}\n**Category:** {{ $json.category }}\n**Confidence:** [ {{ Object.entries($json.all_scores || {}).sort((a, b) => b[1] - a[1]).map(([cat, score]) => `${cat}:${score}%`).join(' | ') }} ]",
        "options": {}
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        10096,
        -2416
      ],
      "id": "2d36fb77-b97d-44a4-9173-104c3d635335",
      "name": "Log to Kairon Logs",
      "webhookId": "dcf1cf1a-eda6-4488-8142-af689fbc76c3",
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      }
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Set Inference Start",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Inference Start": {
      "main": [
        [
          {
            "node": "Prepare LLM Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare LLM Context": {
      "main": [
        [
          {
            "node": "Note Classifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Note Classifier": {
      "main": [
        [
          {
            "node": "Parse LLM Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse LLM Response": {
      "main": [
        [
          {
            "node": "Log to Kairon Logs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Note": {
      "main": [
        [
          {
            "node": "React with üìù",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "nemotron-nano-9b": {
      "ai_languageModel": [
        [
          {
            "node": "Note Classifier",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "mimo-v2-flash": {
      "ai_languageModel": [
        [
          {
            "node": "Note Classifier",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Log to Kairon Logs": {
      "main": [
        [
          {
            "node": "Store Note",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "meta": {
    "instanceId": "71ef632b3ea0984c927b7776c61fb9a372c4b6670ebd74c359a3b7c4a8989adc"
  },
  "name": "Save_Note"
}
