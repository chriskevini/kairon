{
  "name": "Capture_Thread",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -2096,
        640
      ],
      "id": "eab3a9d4-6d3a-4560-8e60-612e6f5c9df3",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "jsCode": "// Prepare thread history query using batch pattern\nconst ctx = $json.ctx;\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      db_queries: [\n        {\n          key: 'history',\n          sql: \"SELECT timestamp, role, text FROM thread_history WHERE thread_id = $1 ORDER BY timestamp ASC\",\n          params: [ctx.event.thread_id]\n        }\n      ]\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1872,
        544
      ],
      "id": "prepare-history-query",
      "name": "Prepare History Query"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "UpiUvzlgVuMdYsnp",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "ctx": "={{ $json.ctx }}"
          }
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -1648,
        544
      ],
      "id": "query-thread-history",
      "name": "Query Thread History"
    },
    {
      "parameters": {
        "jsCode": "// Build context from Query_DB results (batch pattern)\nconst ctx = $json.ctx;\nconst messages = ctx.db?.history?.results || [];\n\n// Format thread history for LLM (reverse to get chronological for display)\nconst threadHistory = messages.toReversed().map(msg => {\n  return `${msg.role.toUpperCase()}: ${msg.text}`;\n}).join('\\n');\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      db: {\n        ...ctx.db,\n        thread_id: ctx.event.thread_id,\n        thread_history: threadHistory,\n        message_count: messages.length\n      }\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1424,
        544
      ],
      "id": "eb096fdc-babc-49e4-9213-36f22ae98b6e",
      "name": "Prepare Context"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are analyzing a conversation thread to extract key insights and actionable items.\n\n## Thread History\n{{ $json.ctx.db.thread_history }}\n\n## Task\nExtract and classify the most important items from the thread into **exactly one** category each:\n\n**reflection** - Internal knowledge about the user (personal insights, patterns, preferences, decisions, or commitments)  \n**fact** - External knowledge about the world, people, events, or things (objective information not tied to the user's internal state)  \n**todo** - Concrete, actionable tasks or next steps (specific and doable)\n\n## Few-Shot Examples\n\n**Example Thread 1:**\n\"I realized I get my best work done in the mornings right after coffee. My mom's birthday is coming up on June 12th, I need to get her a gift. John told me he really likes dark roast with no sugar. I've decided to stop scheduling meetings before noon. Also, I should probably block out 2-hour chunks for deep work. Sarah mentioned she's allergic to peanuts.\"\n\n**Good Extraction:**\nreflection|I get my best work done in the mornings right after coffee\nreflection|I've decided to stop scheduling meetings before noon\ntodo|Get mom a gift for her June 12th birthday\ntodo|Block out 2-hour chunks for deep work\nfact|Mom's birthday is June 12th\nfact|John really likes dark roast with no sugar\nfact|Sarah is allergic to peanuts\n\n**Example Thread 2:**\n\"Maybe I should try walking more, it might help with focus. Dad prefers calls in the evening. I'm going to switch to async updates for the team. Don't forget to send the report by Friday. The office WiFi password is 'guest123'. I tend to lose steam after lunch if I eat carbs.\"\n\n**Good Extraction:**\nreflection|I'm going to switch to async updates for the team\nreflection|I tend to lose steam after lunch if I eat carbs\ntodo|Send the report by Friday\nfact|Dad prefers calls in the evening\nfact|The office WiFi password is 'guest123'\nreflection|Walking more might help with focus\n\n## Response Format\n\nOutput ONLY lines in this format:\ntype|extracted text\n\nOne item per line. No numbers, bullets, or extra formatting.\nOmit any items that are unclear or not worth saving.\n\nNow analyze the thread and extract items:",
        "needsFallback": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -976,
        544
      ],
      "id": "f10c50b2-ae2f-463b-8378-6b36c12d2b21",
      "name": "Extract Items LLM"
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM output in pipe format: \"type|text\"\nlet llmOutput = $input.first().json.text.trim();\nconst ctx = $('Prepare Context').first().json.ctx;\n\ntry {\n  const lines = llmOutput.split('\\n').filter(line => line.includes('|'));\n  const extractions = [];\n  let displayOrder = 1;\n  \n  lines.forEach(line => {\n    const parts = line.split('|');\n    if (parts.length < 2) return;\n    \n    const itemType = parts[0].trim();\n    const text = parts.slice(1).join('|').trim(); // Handle pipes in text\n    \n    // Validate item_type\n    if (!['reflection', 'fact', 'todo'].includes(itemType)) {\n      console.error(`Invalid item_type: ${itemType}`);\n      return;\n    }\n    \n    extractions.push({\n      thread_id: ctx.db.thread_id,\n      item_type: itemType,\n      text: text,\n      display_order: displayOrder++\n    });\n  });\n  \n  // Return ctx with llm namespace added\n  return [{\n    json: {\n      ctx: {\n        ...ctx,\n        llm: {\n          raw_output: llmOutput,\n          extractions: extractions,\n          has_extractions: extractions.length > 0\n        }\n      }\n    }\n  }];\n} catch (error) {\n  // On error, return empty extractions\n  return [{\n    json: {\n      ctx: {\n        ...ctx,\n        llm: {\n          raw_output: llmOutput,\n          extractions: [],\n          has_extractions: false,\n          parse_error: error.message\n        }\n      }\n    }\n  }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        544
      ],
      "id": "93bcf029-9040-466f-957c-2a9c8d87a451",
      "name": "Parse Extractions"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "e3ae6cd9-7b12-406f-b233-afdc77ea403e",
              "leftValue": "={{ $json.ctx.llm.extractions }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -176,
        544
      ],
      "id": "3a3d0695-4532-4b46-bbd1-6fc531e8ad12",
      "name": "Has Extractions?"
    },
    {
      "parameters": {
        "jsCode": "// Build Discord summary message - read from Write_DB results\nconst ctx = $json.ctx;\nconst extractions = ctx.llm.extractions;\n\nconst numberEmojis = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ðŸ”Ÿ'];\n\nconst notes = extractions.filter(e => \n  e.item_type === 'reflection' || e.item_type === 'fact'\n);\nconst todos = extractions.filter(e => e.item_type === 'todo');\n\nlet content = 'ðŸ“Š **Thread Summary**\\n\\n';\n\nif (notes.length > 0) {\n  content += 'ðŸ’¡ **Insights & Facts**\\n';\n  notes.forEach(item => {\n    const emoji = numberEmojis[item.display_order - 1] || 'â€¢';\n    content += `${emoji} ${item.text}\\n`;\n  });\n  content += '\\n';\n}\n\nif (todos.length > 0) {\n  content += 'ðŸ“‹ **Action Items**\\n';\n  todos.forEach(item => {\n    const emoji = numberEmojis[item.display_order - 1] || 'â€¢';\n    content += `${emoji} ${item.text}\\n`;\n  });\n  content += '\\n';\n}\n\ncontent += '---\\n';\ncontent += 'Tap number emoji to save\\n';\ncontent += 'âŒ Dismiss â€¢ ðŸ—‘ï¸ Delete thread';\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      response: {\n        summary_content: content,\n        emoji_count: extractions.length\n      }\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        448
      ],
      "id": "8cfff2da-39dd-4c84-abab-f5a723655499",
      "name": "Build Summary Message"
    },
    {
      "parameters": {
        "jsCode": "// Get summary message ID from Discord response\nconst summaryMessage = $input.first().json;\nconst summaryMessageId = summaryMessage.id;\n\nconst ctx = $('Build Summary Message').first().json.ctx;\nconst extractions = ctx.llm.extractions;\nconst threadId = ctx.event.thread_id;\n\nconst numberEmojis = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ðŸ”Ÿ'];\n\n// Build emoji reaction URLs\nconst reactionUrls = [];\n\n// Add number emojis for each extraction\nextractions.forEach(ext => {\n  const emoji = numberEmojis[ext.display_order - 1];\n  if (emoji) {\n    // URL encode the emoji\n    const encoded = encodeURIComponent(emoji);\n    reactionUrls.push({\n      url: `https://discord.com/api/v10/channels/${ctx.event.channel_id}/messages/${summaryMessageId}/reactions/${encoded}/@me`,\n      emoji: emoji\n    });\n  }\n});\n\n// Add control emojis\nreactionUrls.push(\n  {\n    url: `https://discord.com/api/v10/channels/${ctx.event.channel_id}/messages/${summaryMessageId}/reactions/%E2%9D%8C/@me`,\n    emoji: 'âŒ'\n  },\n  {\n    url: `https://discord.com/api/v10/channels/${ctx.event.channel_id}/messages/${summaryMessageId}/reactions/%F0%9F%97%91%EF%B8%8F/@me`,\n    emoji: 'ðŸ—‘ï¸'\n  }\n);\n\nreturn reactionUrls.map(r => ({\n  json: {\n    ctx: ctx,\n    summary_message_id: summaryMessageId,\n    thread_id: threadId,\n    reaction_url: r.url,\n    emoji: r.emoji\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        448
      ],
      "id": "d7ff0aa4-b3d1-42f5-a10d-37aad4ec2f56",
      "name": "Prepare Emoji Reactions"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "={{ $json.reaction_url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1392,
        448
      ],
      "id": "124efe0a-5911-42ba-bd1f-4478da67fdff",
      "name": "Add Emoji Reactions",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE projections SET data = data || jsonb_build_object('summary_message_id', $1) WHERE projection_type = 'thread_extraction' AND data->>'thread_id' = $2 AND status = 'pending';",
        "options": {
          "queryReplacement": "={{ $('Prepare Emoji Reactions').first().json.summary_message_id }},={{ $('Prepare Emoji Reactions').first().json.thread_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1392,
        256
      ],
      "id": "cc84e221-84fb-49bb-b72b-e0589a531893",
      "name": "Update Summary Message ID",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "MdnYzEgjzWRujz2v",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://discord.com/api/v10/channels/{{ $('Build Summary Message').first().json.ctx.event.channel_id }}/messages/{{ $('Build Summary Message').first().json.ctx.event.message_id }}/reactions/ðŸ’­/@me",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1872,
        928
      ],
      "id": "3a889796-3250-4fef-af78-7b779e545595",
      "name": "Remove ðŸ’­ Reaction",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "={{ $json.ctx.event.guild_id }}",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $json.ctx.event.thread_id }}",
          "mode": "id"
        },
        "content": "âŒ No items extracted from this thread. You must have had quite an interesting conversation.",
        "options": {}
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        48,
        640
      ],
      "id": "db0c5fb7-27f3-460d-b931-d0610a934431",
      "name": "Post No Extractions Message",
      "webhookId": "no-extractions-webhook",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://discord.com/api/v10/channels/{{ $json.ctx.event.channel_id }}/messages/{{ $json.ctx.event.message_id }}/reactions/ðŸ”µ/@me",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "discordBotApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1872,
        736
      ],
      "id": "remove-blue-reaction-save-chat-no-extract",
      "name": "Remove ðŸ”µ Reaction (No Extract)",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "model": "nvidia/nemotron-nano-9b-v2:free",
        "options": {
          "timeout": 10000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -840,
        768
      ],
      "id": "1021e602-7ef3-4c22-bc16-74a99d6e8c30",
      "name": "nemotron-nano-9b",
      "credentials": {
        "openRouterApi": {
          "id": "r79IBN16aZtPIN8T",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "model": "xiaomi/mimo-v2-flash:free",
        "options": {
          "timeout": 10000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -968,
        768
      ],
      "id": "aff3ef03-d804-40a6-98d9-b498298f4b69",
      "name": "mimo-v2-flash",
      "credentials": {
        "openRouterApi": {
          "id": "r79IBN16aZtPIN8T",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "react",
        "guildId": {
          "__rl": true,
          "value": "={{ $json.ctx.event.guild_id }}",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $json.ctx.event.channel_id }}",
          "mode": "id"
        },
        "messageId": "={{ $json.ctx.event.message_id }}",
        "emoji": "ðŸ’­"
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        -1872,
        352
      ],
      "id": "ee2bc94f-b03b-4d5c-a04e-3e80e8e3acf1",
      "name": "React with ðŸ’­",
      "webhookId": "2af02bbb-3f0b-490a-b0c9-234c0e9013ae",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "={{ $json.ctx.event.guild_id }}",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $json.ctx.event.channel_id }}",
          "mode": "id"
        },
        "content": "={{ $json.ctx.response.summary_content }}",
        "options": {}
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        720,
        448
      ],
      "id": "59068362-0e97-4e90-90c3-98373b60e25f",
      "name": "Send a message",
      "webhookId": "b9ec412c-e54b-4542-a3ad-41a388512da2",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "credentials": {
        "discordBotApi": {
          "id": "hvetTjtpeKFB1V0I",
          "name": "Discord Bot account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1168,
        448
      ],
      "id": "ebfeb17a-a211-4a67-adf9-ec9c26e418cc",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1616,
        520
      ],
      "id": "9a504ad1-2ee7-435b-9c81-ff106ef75821",
      "name": "Wait 1 s",
      "webhookId": "1803ab0e-bd94-42cf-8843-a2178b590fa6"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "start-time",
              "name": "ctx.timing.inference_start",
              "value": "={{ Date.now() }}",
              "type": "number"
            }
          ]
        },
        "options": {
          "includeOtherFields": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1200,
        544
      ],
      "id": "set-inference-start-save-chat",
      "name": "Set Inference Start"
    },
    {
      "parameters": {
        "jsCode": "// Prepare trace data for thread extraction (using ctx pattern) with Write_DB batch\nconst ctx = $('Set Inference Start').first().json.ctx;\nconst inferenceStart = ctx.timing?.inference_start || Date.now();\nconst durationMs = Date.now() - inferenceStart;\nconst llmOutput = $('Extract Items LLM').first().json.text;\nconst parsedCtx = $input.first().json.ctx;\n\n// Build filled prompt\nconst promptText = `You are analyzing a conversation thread to extract key insights and actionable items.\n\n## Thread History\n${ctx.db.thread_history}\n\n## Task\nExtract and classify the most important items from the thread...`;\n\n// Format trace_chain for PostgreSQL uuid[] type\nconst traceChain = ctx.event.trace_chain || [];\nconst traceChainPg = '{' + traceChain.join(',') + '}';\n\nconst eventId = ctx.event.event_id;\nconst threadId = ctx.db.thread_id;\nconst timezone = ctx.event.timezone || null;\n\n// Build trace data JSON\nconst traceDataJson = JSON.stringify({\n  input: {\n    thread_history: ctx.db.thread_history,\n    conversation_id: threadId\n  },\n  prompt: promptText,\n  completion: llmOutput,\n  result: {\n    extraction_count: parsedCtx.llm.extractions?.length || 0,\n    has_extractions: parsedCtx.llm.has_extractions\n  },\n  model: 'nvidia/nemotron-nano-9b-v2:free',\n  duration_ms: durationMs\n});\n\nreturn [{\n  json: {\n    ctx: parsedCtx,\n    // Store data needed for building extraction queries later\n    trace_data: {\n      event_id: eventId,\n      thread_id: threadId,\n      trace_chain_pg: traceChainPg,\n      trace_data_json: traceDataJson,\n      timezone: timezone\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        544
      ],
      "id": "prepare-trace-data-save-chat",
      "name": "Prepare Trace Data"
    },
    {
      "parameters": {
        "jsCode": "// Build Write_DB batch for trace, void old, and save extractions\nconst ctx = $json.ctx;\nconst traceData = $json.trace_data;\nconst extractions = ctx.llm.extractions;\n\nconst writes = [];\n\n// Write 1: Insert trace\nwrites.push({\n  key: 'trace',\n  sql: `WITH new_trace AS (\n    INSERT INTO traces (event_id, step_name, data, trace_chain)\n    VALUES ($1::uuid, 'thread_extraction', $2::jsonb, $3::uuid[])\n    RETURNING id\n  )\n  SELECT new_trace.id as trace_id, $3::uuid[] || new_trace.id as updated_trace_chain\n  FROM new_trace`,\n  params: [traceData.event_id, traceData.trace_data_json, traceData.trace_chain_pg]\n});\n\n// Write 2: Void old extractions\nwrites.push({\n  key: 'void_old',\n  sql: `UPDATE projections SET status = 'voided', voided_at = NOW(), voided_reason = 'replaced_by_new_extraction' \n        WHERE projection_type = 'thread_extraction' AND data->>'thread_id' = $1 AND status = 'pending'\n        RETURNING id`,\n  params: [traceData.thread_id]\n});\n\n// Write 3: Insert extractions (dynamic multi-row insert)\nif (extractions && extractions.length > 0) {\n  // Build values and params for multi-row insert\n  const values = extractions.map((ext, idx) => {\n    const offset = idx * 7;\n    return `($${offset + 1}::uuid, $${offset + 2}::uuid, $${offset + 3}::uuid[], $${offset + 4}, $${offset + 5}::jsonb, $${offset + 6}, $${offset + 7})`;\n  }).join(', ');\n  \n  const params = [];\n  extractions.forEach(ext => {\n    params.push(traceData.event_id);                    // event_id\n    params.push('$results.trace.row.trace_id');         // trace_id (chained from trace write)\n    params.push('$results.trace.row.updated_trace_chain'); // trace_chain (chained)\n    params.push('thread_extraction');                   // projection_type\n    params.push(JSON.stringify({                        // data as JSONB\n      thread_id: ext.thread_id,\n      item_type: ext.item_type,\n      text: ext.text,\n      display_order: ext.display_order\n    }));\n    params.push('pending');                             // status\n    params.push(traceData.timezone);                    // timezone\n  });\n  \n  writes.push({\n    key: 'extractions',\n    sql: `INSERT INTO projections (event_id, trace_id, trace_chain, projection_type, data, status, timezone)\n          VALUES ${values}\n          RETURNING *`,\n    params: params\n  });\n}\n\nreturn [{\n  json: {\n    ctx: {\n      ...ctx,\n      db_writes: writes\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        448
      ],
      "id": "build-write-batch",
      "name": "Build Write Batch"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "zgJX3AbUNUvDJa48"
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        272,
        448
      ],
      "id": "write-trace-and-extractions",
      "name": "Write Trace + Extractions"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Prepare History Query",
            "type": "main",
            "index": 0
          },
          {
            "node": "React with ðŸ’­",
            "type": "main",
            "index": 0
          },
          {
            "node": "Remove ðŸ’­ Reaction",
            "type": "main",
            "index": 0
          },
          {
            "node": "Remove ðŸ”µ Reaction (No Extract)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare History Query": {
      "main": [
        [
          {
            "node": "Query Thread History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Thread History": {
      "main": [
        [
          {
            "node": "Prepare Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Context": {
      "main": [
        [
          {
            "node": "Set Inference Start",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Items LLM": {
      "main": [
        [
          {
            "node": "Parse Extractions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Extractions": {
      "main": [
        [
          {
            "node": "Prepare Trace Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Trace Data": {
      "main": [
        [
          {
            "node": "Has Extractions?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Extractions?": {
      "main": [
        [
          {
            "node": "Build Write Batch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Post No Extractions Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Write Batch": {
      "main": [
        [
          {
            "node": "Write Trace + Extractions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Trace + Extractions": {
      "main": [
        [
          {
            "node": "Build Summary Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Summary Message": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Emoji Reactions": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Emoji Reactions": {
      "main": [
        [
          {
            "node": "Wait 1 s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Summary Message ID": {
      "main": [
        []
      ]
    },
    "Remove ðŸ’­ Reaction": {
      "main": [
        []
      ]
    },
    "nemotron-nano-9b": {
      "ai_languageModel": [
        [
          {
            "node": "Extract Items LLM",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "mimo-v2-flash": {
      "ai_languageModel": [
        [
          {
            "node": "Extract Items LLM",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "React with ðŸ’­": {
      "main": [
        []
      ]
    },
    "Send a message": {
      "main": [
        [
          {
            "node": "Prepare Emoji Reactions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Update Summary Message ID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Add Emoji Reactions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 1 s": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Inference Start": {
      "main": [
        [
          {
            "node": "Extract Items LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Post No Extractions Message": {
      "main": [
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "JOXLqn9TTznBdo7Q"
  },
  "staticData": null,
  "meta": null,
  "active": false
}
